<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–ò–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω–æ–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º API Telegram -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–µ—Ä–µ–≤–æ—Ä–æ—Ç–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ */
        .card { perspective: 1000px; }
        .card-inner {
            position: relative;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .card.is-flipped .card-inner {
            transform: rotateY(180deg);
        }
        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            top: 0; left: 0;
        }
        .card-back {
            transform: rotateY(180deg);
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ "—É—Ö–æ–¥–∞" –∏ "–ø–æ—è–≤–ª–µ–Ω–∏—è" –∫–∞—Ä—Ç–æ—á–∫–∏ */
        @keyframes slide-left {
            0% { transform: translateX(0); opacity: 1; }
            100% { transform: translateX(-100%); opacity: 0; }
        }
        @keyframes slide-in-right {
            0% { transform: translateX(100%); opacity: 0; }
            100% { transform: translateX(0); opacity: 1; }
        }

        .card.slide-out {
            animation: slide-left 0.4s ease forwards;
        }
        .card.slide-in {
            animation: slide-in-right 0.4s ease;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω */
        .modal {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
            transform: scale(0.95);
        }
        .modal.is-open {
            opacity: 1;
        }
        .modal.is-open .modal-content {
            transform: scale(1);
        }

        /* –°—Ç–∏–ª—å –¥–ª—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∫–Ω–æ–ø–∫–∏ */
        .button-locked {
            background-color: #e5e7eb; /* gray-200 */
            color: #6b7280; /* gray-500 */
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        /* –ù–æ–≤—ã–π —Å—Ç–∏–ª—å –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ë–∞–∑—ã –ê—Å—Å–æ—Ü–∏–∞—Ü–∏–π */
        .association-button {
            background-image: linear-gradient(to right, #6D28D9 0%, #8B5CF6 100%);
            transition: all 0.3s ease;
        }
        .association-button:hover {
            box-shadow: 0 10px 15px -3px rgba(109, 40, 217, 0.5), 0 4px 6px -2px rgba(109, 40, 217, 0.2);
            transform: translateY(-2px);
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä 16:9 –¥–ª—è –≤–∏–¥–µ–æ */
        .video-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
            height: 0;
            overflow: hidden;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
    </style>
</head>

<body class="min-h-screen bg-gray-100 font-sans p-4">

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
    <div id="app" class="max-w-md mx-auto">
        
        <!-- 1. –≠–∫—Ä–∞–Ω –ó–∞–≥—Ä—É–∑–∫–∏ (–≤–∏–¥–µ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
        <div id="loading-screen" class="text-center py-20">
            <p class="text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
        </div>

        <!-- 2. –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ (Home Screen) -->
        <div id="home-screen" class="hidden">
            <h1 class="text-2xl font-bold text-center mb-8 text-gray-800">–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</h1>
            <div class="space-y-4">
                <!-- –û—Å–Ω–æ–≤–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã -->
                <button onclick="window.App.renderAllSetsScreen()" class="w-full py-4 px-5 bg-white rounded-xl shadow-lg text-left text-lg font-semibold text-gray-800 hover:bg-gray-50 flex justify-between items-center transition duration-150">
                    <span>üìö –í—Å–µ –Ω–∞–±–æ—Ä—ã —Å–ª–æ–≤</span>
                    <span>&rarr;</span>
                </button>
                <button onclick="window.App.renderAllStoriesScreen()" class="w-full py-4 px-5 bg-white rounded-xl shadow-lg text-left text-lg font-semibold text-gray-800 hover:bg-gray-50 flex justify-between items-center transition duration-150">
                    <span>üìñ –í—Å–µ –∏—Å—Ç–æ—Ä–∏–∏</span>
                    <span>&rarr;</span>
                </button>
                <button onclick="window.App.renderWeeklySelections()" class="w-full py-4 px-5 bg-white rounded-xl shadow-lg text-left text-lg font-semibold text-gray-800 hover:bg-gray-50 flex justify-between items-center transition duration-150">
                    <span>üìÖ –ü–æ–¥–±–æ—Ä–∫–∏ –ø–æ –Ω–µ–¥–µ–ª—è–º</span>
                    <span>&rarr;</span>
                </button>
                
                <!-- –ù–û–í–´–ô –†–ê–ó–î–ï–õ: –ë–∞–∑–∞ –ê—Å—Å–æ—Ü–∏–∞—Ü–∏–π -->
                <div class="pt-4 border-t border-gray-200">
                    <button onclick="window.App.renderAssociationBaseScreen()" class="association-button w-full py-4 px-5 text-white rounded-xl shadow-lg text-left text-lg font-bold flex justify-between items-center">
                        <span>üß† –ë–∞–∑–∞ –ê—Å—Å–æ—Ü–∏–∞—Ü–∏–π</span>
                        <span>&rarr;</span>
                    </button>
                </div>

                <!-- –ù–û–í–ê–Ø –°–ï–ö–¶–ò–Ø: –ì–æ—Ä—è—â–∏–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è -->
                <div id="due-today-section" class="hidden pt-6 mt-4 border-t border-gray-200">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <span>üî• –ö –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—é —Å–µ–≥–æ–¥–Ω—è</span>
                    </h2>
                    <div id="due-today-list" class="space-y-3">
                        <!-- –°—é–¥–∞ JS –¥–æ–±–∞–≤–∏—Ç –≥–æ—Ä—è—â–∏–µ —Å–µ—Ç—ã -->
                    </div>
                </div>

            </div>
        </div>
        
        <!-- 3. –≠–ö–†–ê–ù –°–ü–ò–°–ö–ê (–¥–ª—è –Ω–µ–¥–µ–ª—å, —Å–µ—Ç–æ–≤, –∏—Å—Ç–æ—Ä–∏–π –∏–ª–∏ –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–π) -->
        <div id="list-screen" class="hidden">
            <h1 id="list-title" class="text-2xl font-bold text-center mb-6 text-gray-800"></h1>
            
            <!-- –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" -->
            <div id="back-button-container" class="mb-4"></div>
            
            <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã/–ø–æ–∏—Å–∫ -->
            <div id="filter-controls" class="mb-4 space-y-3">
                <!-- –§–∏–ª—å—Ç—Ä—ã –∏–ª–∏ –ø–æ–∏—Å–∫ –±—É–¥—É—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω—ã –∑–¥–µ—Å—å -->
            </div>
            
            <!-- –°–ø–∏—Å–æ–∫ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ -->
            <div id="content-list" class="space-y-4">
                <!-- –°—é–¥–∞ –±—É–¥—É—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω—ã –Ω–∞–±–æ—Ä—ã, –Ω–µ–¥–µ–ª–∏, –∏—Å—Ç–æ—Ä–∏–∏ –∏–ª–∏ –∫–∞—Ä—Ç–æ—á–∫–∏ –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–π -->
            </div>
        </div>

        <!-- 4. –≠–ö–†–ê–ù –î–ï–¢–ê–õ–ï–ô –ò–°–¢–û–†–ò–ò (–ù–û–í–´–ô –≠–ö–†–ê–ù) -->
        <div id="story-detail-screen" class="hidden">
             <!-- –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" -->
             <!-- –û–ë–ù–û–í–õ–ï–ù–û: mb-4 –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç—Å—Ç—É–ø–∞ -->
            <div id="story-back-button-container" class="mb-4"></div>

            <h1 id="story-title" class="text-xl font-bold text-gray-800 mb-4 text-center"></h1>
            
            <!-- –í–∏–¥–µ–æ 16:9 -->
            <div class="video-container mb-6">
                <iframe id="story-video-embed" src="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π (–°–∫—Ä—ã–≤–∞—é—Ç—Å—è –¥–ª—è –≤–∏–¥–µ–æ-–∞—Å—Å–æ—Ü–∏–∞—Ü–∏–π) -->
            <div id="story-actions" class="space-y-4">
                <!-- –ö–Ω–æ–ø–∫–∞ –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è/PDF -->
                <a id="story-pdf-link" href="#" target="_blank" 
                   class="w-full py-4 px-5 bg-white rounded-xl shadow-lg text-left text-lg font-semibold text-gray-800 hover:bg-gray-50 flex justify-between items-center transition duration-150">
                    <span>üìÑ –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è (PDF)</span>
                    <span>&rarr;</span>
                </a>
                
                <!-- –ö–Ω–æ–ø–∫–∞ –ö–≤–∏–∑/–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è -->
                <button onclick="window.App.startStoryQuiz()" 
                        class="w-full py-4 px-5 bg-indigo-500 text-white rounded-xl shadow-lg text-left text-lg font-bold hover:bg-indigo-600 transition duration-150 flex justify-between items-center">
                    <span>‚úÖ –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è (–ö–≤–∏–∑ –ø–æ —Ç–µ–∫—Å—Ç—É)</span>
                    <span>&rarr;</span>
                </button>
                
                <!-- –ö–Ω–æ–ø–∫–∞ –ü—Ä–æ—Ä–∞–±–æ—Ç–∫–∞ –º–∞–Ω—Ç—Ä -->
                <button onclick="window.App.startMantraPractice()" 
                        class="w-full py-4 px-5 bg-yellow-500 text-yellow-900 rounded-xl shadow-lg text-left text-lg font-bold hover:bg-yellow-600 transition duration-150 flex justify-between items-center">
                    <span>üí° –ü—Ä–æ—Ä–∞–±–æ—Ç–∫–∞ –º–∞–Ω—Ç—Ä (–ü–æ–ª–µ–∑–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è)</span>
                    <span>&rarr;</span>
                </button>
            </div>
        </div>

        <!-- 4.1. –≠–ö–†–ê–ù –¢–ï–ö–°–¢–û–í–û–ì–û –ó–ê–î–ê–ù–ò–Ø (–ù–û–í–´–ô –≠–ö–†–ê–ù –î–õ–Ø –ó–ê–î–ê–ù–ò–ô/–ú–ê–ù–¢–†) -->
        <div id="text-detail-screen" class="hidden">
             <!-- –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" -->
             <div id="text-back-button-container" class="mb-4"></div>

             <h1 id="text-title" class="text-2xl font-bold text-gray-800 mb-6 text-center"></h1>
             <div class="bg-white p-6 rounded-xl shadow-lg space-y-4">
                 <p id="text-content" class="text-gray-700 whitespace-pre-wrap"></p>
             </div>
        </div>


        <!-- 5. –≠–∫—Ä–∞–Ω –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è (Study Screen) -->
        <div id="study-screen" class="hidden">
            <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä -->
            <div class="bg-gray-200 rounded-full h-2.5 mb-4">
                <div id="progress-bar" class="bg-blue-500 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
            
            <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ -->
            <div id="card" class="card h-64 w-full mb-4">
                <div id="card-inner" class="card-inner h-full w-full" onclick="window.App.showAnswer()">
                    <!-- –ü–µ—Ä–µ–¥–Ω—è—è —Å—Ç–æ—Ä–æ–Ω–∞ -->
                    <div id="card-front" class="card-front flex items-center justify-center p-6 bg-white rounded-xl shadow-lg text-center">
                        <div id="card-front-text" class="text-2xl font-semibold"></div>
                    </div>
                    <!-- –ó–∞–¥–Ω—è—è —Å—Ç–æ—Ä–æ–Ω–∞ -->
                    <div id="card-back" class="card-back flex items-center justify-center p-6 bg-blue-100 rounded-xl shadow-lg text-center">
                        <div id="card-back-text" class="text-2xl font-semibold"></div>
                    </div>
                </div>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
            <div id="controls-show" class="text-center space-y-3">
                <button onclick="window.App.showAnswer()" class="w-full py-3 px-4 bg-blue-500 text-white font-bold rounded-xl shadow-md hover:bg-blue-600 transition duration-150">
                    –ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç
                </button>
                <button id="hint-button" onclick="window.App.showHint()" class="w-full py-2 px-4 bg-yellow-400 text-yellow-900 font-semibold rounded-xl shadow-md hover:bg-yellow-500 transition duration-150 hidden">
                    üí° –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É
                </button>
            </div>
            
            <div id="controls-rate" class="hidden grid grid-cols-2 gap-4">
                <button onclick="window.App.handleAnswer(false)" class="py-3 px-4 bg-red-500 text-white font-bold rounded-xl shadow-md hover:bg-red-600 transition duration-150">
                    –ù–µ –ø–æ–º–Ω—é ‚ùå
                </button>
                <button onclick="window.App.handleAnswer(true)" class="py-3 px-4 bg-green-500 text-white font-bold rounded-xl shadow-md hover:bg-green-600 transition duration-150">
                    –ü–æ–º–Ω—é ‚úÖ
                </button>
            </div>
             <!-- –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é" –≤–æ –≤—Ä–µ–º—è —Å–µ—Å—Å–∏–∏ -->
            <div class="text-center mt-4">
                <button onclick="window.App.renderHomeScreen()" class="text-gray-500 hover:text-gray-700">
                    &larr; –ù–∞–∑–∞–¥ –≤ –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
                </button>
            </div>
        </div>
        
        <!-- 6. –≠–∫—Ä–∞–Ω –ó–∞–≤–µ—Ä—à–µ–Ω–∏—è (Finish Screen) -->
         <div id="finish-screen" class="hidden text-center py-20">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</h2>
            <p id="finish-screen-text" class="text-gray-600 mb-6">–í—ã –ø—Ä–æ—à–ª–∏ –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏.</p>
            <button onclick="window.App.renderHomeScreen()" class="py-3 px-6 bg-blue-500 text-white font-bold rounded-xl shadow-md hover:bg-blue-600">
                –í –º–µ–Ω—é
            </button>
        </div>

    </div>

    <!-- –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê -->

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ü–æ–¥—Å–∫–∞–∑–∫–∏ -->
    <div id="hint-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 opacity-0" onclick="window.App.closeHintModal()">
        <div id="hint-modal-content" class="modal-content bg-white p-4 rounded-xl shadow-xl max-w-sm w-full" onclick="event.stopPropagation()">
            <h3 class="text-lg font-semibold mb-3">–ü–æ–¥—Å–∫–∞–∑–∫–∞:</h3>
            <img id="hint-image" src="" alt="–ü–æ–¥—Å–∫–∞–∑–∫–∞" class="w-full h-auto rounded-md object-contain max-h-64" onerror="this.onerror=null; this.src='https://placehold.co/400x150/FCA5A5/FFFFFF?text=–ù–µ—Ç+–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è';">
            <button onclick="window.App.closeHintModal()" class="w-full mt-4 py-2 px-4 bg-gray-200 text-gray-700 font-semibold rounded-xl hover:bg-gray-300">
                –ó–∞–∫—Ä—ã—Ç—å
            </button>
        </div>
    </div>
    
    <!-- –ù–û–í–û–ï –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –¥–ª—è –î–µ—Ç–∞–ª–µ–π –ê—Å—Å–æ—Ü–∏–∞—Ü–∏–∏ -->
    <div id="association-detail-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 opacity-0" onclick="window.App.closeAssociationDetailModal()">
        <div id="association-detail-modal-content" class="modal-content bg-white p-6 rounded-xl shadow-xl max-w-md w-full" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold mb-4 text-gray-800">–ö–∞—Ä—Ç–æ—á–∫–∞ –ê—Å—Å–æ—Ü–∏–∞—Ü–∏–∏</h3>
            
            <div class="space-y-4">
                <img id="association-image" src="" alt="–ö–∞—Ä—Ç–∏–Ω–∫–∞-–∞—Å—Å–æ—Ü–∏–∞—Ü–∏—è" 
                     class="w-full h-auto rounded-xl object-contain max-h-48 shadow-lg"
                     onerror="this.onerror=null; this.src='https://placehold.co/400x150/38A169/ffffff?text=–ù–µ—Ç+–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è';">
                
                <div class="bg-gray-50 p-4 rounded-lg">
                    <p class="text-3xl font-extrabold text-blue-600" id="detail-german-word"></p>
                    <p class="text-xl text-gray-700 mt-1" id="detail-russian-word"></p>
                    <p class="text-sm font-mono text-red-500 mt-2" id="detail-transcription"></p>
                </div>
            </div>
            
            <button onclick="window.App.closeAssociationDetailModal()" class="w-full mt-6 py-3 px-4 bg-blue-500 text-white font-bold rounded-xl shadow-md hover:bg-blue-600">
                –ó–∞–∫—Ä—ã—Ç—å
            </button>
        </div>
    </div>


    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –í—ã–±–æ—Ä–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
    <div id="direction-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 opacity-0" onclick="window.App.closeDirectionModal()">
        <div id="direction-modal-content" class="modal-content bg-white p-6 rounded-xl shadow-xl max-w-sm w-full" onclick="event.stopPropagation()">
            <h3 class="text-lg font-semibold mb-4 text-center">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h3>
            <div class="space-y-3">
                <button onclick="window.App.startSessionWithDirection('ru-de')" class="w-full py-3 px-4 bg-blue-500 text-white font-bold rounded-xl shadow-md hover:bg-blue-600">
                    –†—É—Å—Å–∫–∏–π ‚Üí –ù–µ–º–µ—Ü–∫–∏–π
                </button>
                <button onclick="window.App.startSessionWithDirection('de-ru')" class="w-full py-3 px-4 bg-purple-500 text-white font-bold rounded-xl shadow-md hover:bg-purple-600">
                    –ù–µ–º–µ—Ü–∫–∏–π ‚Üí –†—É—Å—Å–∫–∏–π
                </button>
                <button onclick="window.App.closeDirectionModal()" class="w-full mt-2 py-2 px-4 text-gray-600 font-semibold rounded-xl hover:bg-gray-100">
                    –û—Ç–º–µ–Ω–∞
                </button>
            </div>
        </div>
    </div>


    <!-- "–ú–ê–ì–ò–Ø" (JavaScript) -->
    <script type="module">
        // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –º–æ–¥—É–ª–∏ Firebase (v9+)
        // NOTE: –ò—Å–ø–æ–ª—å–∑—É–µ–º v11.0.2 –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å —Ç–µ–∫—É—â–µ–π —Å—Ä–µ–¥–æ–π
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // ==========================================================
        // 1. –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ò –î–ê–ù–ù–´–ï (Conceptual Data Module)
        // ==========================================================
        
        // –ò–Ω—Ç–µ—Ä–≤–∞–ª—ã –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è –≤ –¥–Ω—è—Ö –¥–ª—è –∫–∞–∂–¥–æ–≥–æ "—è—â–∏–∫–∞" (Spaced Repetition System - SRS)
        const REPETITION_INTERVALS = {
            1: 1,  // 1 –¥–µ–Ω—å
            2: 3,  // 3 –¥–Ω—è
            3: 7,  // 7 –¥–Ω–µ–π
            4: 14, // 2 –Ω–µ–¥–µ–ª–∏
            5: 30, // 1 –º–µ—Å—è—Ü
            6: 90  // 3 –º–µ—Å—è—Ü–∞
        };

        /**
         * –î–∞–Ω–Ω—ã–µ –Ω–∞–±–æ—Ä–æ–≤ —Å–ª–æ–≤ (Word Sets)
         */
        const WORD_SETS = [
            // –ù–µ–¥–µ–ª—è 1
            { id: "a1_nouns_1", week: 1, theme: "–°—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ", name: "–°—É—â. A1 (–ß–∞—Å—Ç—å 1)", cards: [
                { id: "der_Tisch", front: "—Å—Ç–æ–ª", back: "der Tisch", hintImage: "https://placehold.co/150x100/505050/ffffff?text=–°—Ç–æ–ª" },
                { id: "die_Frau", front: "–∂–µ–Ω—â–∏–Ω–∞", back: "die Frau" }
            ]},
            { id: "a1_verbs_1", week: 1, theme: "–ì–ª–∞–≥–æ–ª—ã", name: "–ì–ª–∞–≥–æ–ª—ã A1 (–ß–∞—Å—Ç—å 1)", cards: [
                { id: "gehen", front: "–∏–¥—Ç–∏", back: "gehen" },
                { id: "sehen", front: "–≤–∏–¥–µ—Ç—å", back: "sehen" }
            ]},
            // –ù–µ–¥–µ–ª—è 2
            { id: "a1_nouns_2", week: 2, theme: "–°—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ", name: "–°—É—â. A1 (–ß–∞—Å—Ç—å 2)", cards: [
                { id: "das_Auto", front: "–º–∞—à–∏–Ω–∞", back: "das Auto" },
                { id: "das_Haus", front: "–¥–æ–º", back: "das Haus" }
            ]},
            { id: "a1_verbs_2", week: 2, theme: "–ì–ª–∞–≥–æ–ª—ã", name: "–ì–ª–∞–≥–æ–ª—ã A1 (–ß–∞—Å—Ç—å 2)", cards: [
                { id: "sprechen", front: "–≥–æ–≤–æ—Ä–∏—Ç—å", back: "sprechen" },
                { id: "kommen", front: "–ø—Ä–∏—Ö–æ–¥–∏—Ç—å", back: "kommen" }
            ]},
            // –ù–µ–¥–µ–ª—è 3 (–ü–æ–∫–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
            { id: "a1_nouns_3", week: 3, theme: "–°—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ", name: "–°—É—â. A1 (–ß–∞—Å—Ç—å 3)", cards: [
                { id: "der_Mann", front: "–º—É–∂—á–∏–Ω–∞", back: "der Mann" },
                { id: "die_Stadt", front: "–≥–æ—Ä–æ–¥", back: "die Stadt" }
            ]},
            { id: "a1_adj_1", week: 3, theme: "–ü—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω—ã–µ", name: "–ü—Ä–∏–ª. A1 (–ß–∞—Å—Ç—å 1)", cards: [
                { id: "gut", front: "—Ö–æ—Ä–æ—à–∏–π", back: "gut" },
                { id: "schlecht", front: "–ø–ª–æ—Ö–æ–π", back: "schlecht" }
            ]},
        ];

        /**
         * –î–∞–Ω–Ω—ã–µ –∏—Å—Ç–æ—Ä–∏–π (Stories)
         * –î–û–ë–ê–í–õ–ï–ù–û: –ü—Ä–∏–≤—è–∑–∫–∞ –∫ week
         */
        const STORIES = [
            { 
                id: "story_1", week: 1, 
                title: "–í–≤–µ–¥–µ–Ω–∏–µ –≤ –Ω–µ–º–µ—Ü–∫–∏–µ –∞—Ä—Ç–∏–∫–ª–∏ (A1)", 
                level: "A1", 
                videoUrl: "https://www.youtube.com/embed/dQw4w9WgXcQ?autoplay=0&controls=1&showinfo=0&rel=0", 
                pdfUrl: "https://www.africau.edu/images/default/sample.pdf", 
                transcriptTitle: "–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è: –ê—Ä—Ç–∏–∫–ª–∏"
            },
            { 
                id: "story_2", week: 2, 
                title: "–†–µ—Ü–µ–ø—Ç: –ê–ø—Ñ–µ–ª—å—à—Ç—Ä—É–¥–µ–ª—å", 
                level: "A2", 
                videoUrl: "https://www.youtube.com/embed/jNQXAC9IVRw?autoplay=0&controls=1&showinfo=0&rel=0", 
                pdfUrl: "https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf", 
                transcriptTitle: "–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è: –†–µ—Ü–µ–ø—Ç"
            },
            { 
                id: "story_3", week: 3, 
                title: "–ë–µ—Ä–ª–∏–Ω—Å–∫–∞—è —Å—Ç–µ–Ω–∞: –ò—Å—Ç–æ—Ä–∏—è –∏ –∑–Ω–∞—á–µ–Ω–∏–µ", 
                level: "B1", 
                videoUrl: "https://www.youtube.com/embed/2-nFz1WJ3vM?autoplay=0&controls=1&showinfo=0&rel=0", 
                pdfUrl: "https://www.learningcontainer.com/wp-content/uploads/2019/12/PDF-Sample-13-kb.pdf", 
                transcriptTitle: "–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è: –ë–µ—Ä–ª–∏–Ω—Å–∫–∞—è —Å—Ç–µ–Ω–∞"
            },
            { 
                id: "story_4", week: 4, 
                title: "–û–±—Å—É–∂–¥–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–ª–∏–º–∞—Ç–∞", 
                level: "B2", 
                videoUrl: "https://www.youtube.com/embed/M0TfQvX5X1o?autoplay=0&controls=1&showinfo=0&rel=0", 
                pdfUrl: "https://www.ets.org/pdfs/toefl/toefl-ibt-writing-rubrics.pdf", 
                transcriptTitle: "–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è: –ö–ª–∏–º–∞—Ç"
            },
        ];
        
        /**
         * –î–∞–Ω–Ω—ã–µ –ë–∞–∑—ã –ê—Å—Å–æ—Ü–∏–∞—Ü–∏–π (Association Cards)
         * –î–û–ë–ê–í–õ–ï–ù–û: –ü—Ä–∏–≤—è–∑–∫–∞ –∫ week –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –Ω–µ–¥–µ–ª—è–º
         */
        const ASSOCIATION_CARDS = [
            { id: "haus", german: "das Haus", russian: "–¥–æ–º", transcription: "ha äs", imageUrl: "https://placehold.co/400x150/38A169/ffffff?text=–î–æ–º", week: 1 },
            { id: "hund", german: "der Hund", russian: "—Å–æ–±–∞–∫–∞", transcription: "h änt", imageUrl: "https://placehold.co/400x150/9F7AEA/ffffff?text=–°–æ–±–∞–∫–∞", week: 1 },
            { id: "essen", german: "essen", russian: "–µ—Å—Ç—å (–∫—É—à–∞—Ç—å)", transcription: "…õsn", imageUrl: "https://placehold.co/400x150/ED8936/ffffff?text=–ö—É—à–∞—Ç—å", week: 2 },
            { id: "rot", german: "rot", russian: "–∫—Ä–∞—Å–Ω—ã–π", transcription: "roÀêt", imageUrl: "https://placehold.co/400x150/F56565/ffffff?text=–ö—Ä–∞—Å–Ω—ã–π", week: 2 },
            { id: "wasser", german: "das Wasser", russian: "–≤–æ–¥–∞", transcription: "Ààvas…ê", imageUrl: "https://placehold.co/400x150/3498DB/ffffff?text=–í–æ–¥–∞", week: 3 },
            { id: "lernen", german: "lernen", russian: "—É—á–∏—Ç—å", transcription: "Ààl…õ Ån…ôn", imageUrl: "https://placehold.co/400x150/34495E/ffffff?text=–£—á–∏—Ç—å", week: 3 },
        ];
        
        /**
         * –ö–∞—Ä—Ç–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –ø–æ –Ω–µ–¥–µ–ª—è–º (–¥–ª—è –∑–∞–¥–∞–Ω–∏–π –∏ –≤–Ω–µ—à–Ω–∏—Ö —Å—Å—ã–ª–æ–∫)
         * –û–ë–ù–û–í–õ–ï–ù–û: associationVideoUrl –¥–ª—è –≤–∏–¥–µ–æ-–∞—Å—Å–æ—Ü–∏–∞—Ü–∏–π
         */
        const WEEKLY_CONTENT_MAP = {
            1: {
                taskText: "–ù–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ –≤–∞—à–∞ —Ü–µ–ª—å ‚Äî –æ—Å–≤–æ–∏—Ç—å –∞—Ä—Ç–∏–∫–ª–∏ 'der' –∏ 'die', –∞ —Ç–∞–∫–∂–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –≥–ª–∞–≥–æ–ª—ã –¥–≤–∏–∂–µ–Ω–∏—è. –ü–æ–≤—Ç–æ—Ä—è–π—Ç–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ!",
                dialogueLink: "https://www.youtube.com/results?search_query=–Ω–µ–º–µ—Ü–∫–∏–µ+–¥–∏–∞–ª–æ–≥–∏+A1+–Ω–µ–¥–µ–ª—è+1",
                mantraLink: "https://www.youtube.com/watch?v=A_25o-X8y_k&list=PLfT3_Hl2u9eW0p0f4VwYc6Jz-iYf6dK9N",
                associationVideoUrl: "https://www.youtube.com/embed/J1d0T0W469A?autoplay=0&controls=1&showinfo=0&rel=0" // –ü—Ä–∏–º–µ—Ä –≤–∏–¥–µ–æ-–∞—Å—Å–æ—Ü–∏–∞—Ü–∏–∏
            },
            2: {
                taskText: "–§–æ–∫—É—Å –Ω–µ–¥–µ–ª–∏: —Å—Ä–µ–¥–Ω–∏–π —Ä–æ–¥ 'das' –∏ –≥–ª–∞–≥–æ–ª—ã, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –µ–¥–æ–π –∏ –¥–æ–º–æ–º. –ü–æ—Å—Ç—Ä–æ–π—Ç–µ 5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π, –∏—Å–ø–æ–ª—å–∑—É—è –Ω–æ–≤—ã–µ —Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ.",
                dialogueLink: "https://www.youtube.com/results?search_query=–Ω–µ–º–µ—Ü–∫–∏–µ+–¥–∏–∞–ª–æ–≥–∏+A2+–Ω–µ–¥–µ–ª—è+2",
                mantraLink: "https://www.youtube.com/watch?v=B_25o-X8y_k&list=PLfT3_Hl2u9eW0p0f4VwYc6Jz-iYf6dK9N",
                associationVideoUrl: "https://www.youtube.com/embed/3v4g1500_M?autoplay=0&controls=1&showinfo=0&rel=0" // –ü—Ä–∏–º–µ—Ä –≤–∏–¥–µ–æ-–∞—Å—Å–æ—Ü–∏–∞—Ü–∏–∏
            },
            3: {
                 taskText: "–ù–æ–≤–∞—è –ª–µ–∫—Å–∏–∫–∞: –ø—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω—ã–µ –∏ —Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ, –æ–ø–∏—Å—ã–≤–∞—é—â–∏–µ –ª—é–¥–µ–π –∏ –º–µ—Å—Ç–∞. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ —Å–ø—Ä—è–∂–µ–Ω–∏–µ –≥–ª–∞–≥–æ–ª–æ–≤!",
                dialogueLink: "https://www.youtube.com/results?search_query=–Ω–µ–º–µ—Ü–∫–∏–µ+–¥–∏–∞–ª–æ–≥–∏+B1+–Ω–µ–¥–µ–ª—è+3",
                mantraLink: "https://www.youtube.com/watch?v=C_25o-X8y_k&list=PLfT3_Hl2u9eW0p0f4VwYc6Jz-iYf6dK9N",
                associationVideoUrl: "https://www.youtube.com/embed/ABCDEFG1234?autoplay=0&controls=1&showinfo=0&rel=0" // –ü—Ä–∏–º–µ—Ä –≤–∏–¥–µ–æ-–∞—Å—Å–æ—Ü–∏–∞—Ü–∏–∏
            },
            // –î–æ–±–∞–≤—å—Ç–µ –±–æ–ª—å—à–µ –Ω–µ–¥–µ–ª—å –ø–æ –º–µ—Ä–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
        };


        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–∞—Å—Å–∏–≤—ã –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
        const ALL_THEMES = Array.from(new Set(WORD_SETS.map(s => s.theme)));
        const ALL_WEEKS = Array.from(new Set(WORD_SETS.map(s => s.week))).sort((a, b) => a - b);
        const ALL_LEVELS = Array.from(new Set(STORIES.map(s => s.level))).sort();


        // ==========================================================
        // 2. –õ–û–ì–ò–ö–ê –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø (Conceptual App Module)
        // ==========================================================

        window.App = {
            db: null,
            userId: null,
            userProgress: {}, 
            unlockedWeek: 1, 
            sessionCards: [], 
            currentCardIndex: 0,
            isPracticeMode: false, 
            isAdvancing: false, 
            currentDirection: 'ru-de', 
            tempSetId: null, 
            tempMode: null, 
            currentScreenId: 'loading-screen', 
            
            // –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
            currentWeekFilter: 'All', 
            currentThemeFilter: 'All', 
            currentLevelFilter: 'All', 
            currentAssociationSearch: '',

            async init() {
                try {
                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è —á–∞—Å—Ç—å –¥–ª—è Canvas)
                    const firebaseConfigStr = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
                    const firebaseConfig = JSON.parse(firebaseConfigStr);

                    if (Object.keys(firebaseConfig).length > 0) {
                        const app = initializeApp(firebaseConfig);
                        this.db = getFirestore(app);
                    } else {
                         console.warn("Firebase configuration not found. Running in local mode.");
                    }
                    
                    // –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (Telegram –∏–ª–∏ Web)
                    if (window.Telegram && window.Telegram.WebApp) {
                         window.Telegram.WebApp.ready();
                         this.userId = Telegram.WebApp.initDataUnsafe?.user?.id?.toString() || "test_user_123";
                    } else {
                         this.userId = "web_user_" + Math.random().toString(36).substring(7);
                    }

                    if (this.db) {
                        await this.loadProgress();
                    } else {
                        this.renderHomeScreen();
                    }

                } catch (error) {
                    this.showError(`–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ${error.message}`);
                    console.error(error);
                }
            },

            async loadProgress() {
                this.showScreen('loading-screen');
                if (!this.db) return; 

                try {
                    const docRef = doc(this.db, 'userProgress', this.userId); 
                    const docSnap = await getDoc(docRef);

                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        this.userProgress = data.cards || {};
                        this.unlockedWeek = data.unlockedWeek || 1; 
                    } else {
                        this.userProgress = {};
                        this.unlockedWeek = 1; 
                        await this.saveProgress(); 
                    }
                } catch (error) {
                    console.error("Error loading progress:", error);
                } finally {
                    this.renderHomeScreen();
                }
            },
            
            async saveProgress() {
                if (!this.db) return; 

                try {
                    const docRef = doc(this.db, 'userProgress', this.userId);
                    await setDoc(docRef, { 
                        cards: this.userProgress,
                        unlockedWeek: this.unlockedWeek 
                    }, { merge: true });
                    console.log('–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ Firebase');
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:', error);
                }
            },

            // ==================== –†–ï–ù–î–ï–†–ò–ù–ì –≠–ö–†–ê–ù–û–í ====================

            renderHomeScreen() {
                this.showScreen('home-screen');
                this.renderDueTodaySection();
            },

            renderDueTodaySection() {
                const section = document.getElementById('due-today-section');
                const list = document.getElementById('due-today-list');
                if (!section || !list) return;

                const today = this.getTodayDateString();
                let dueSetsCount = 0;

                list.innerHTML = '';

                WORD_SETS.forEach(set => {
                    if (set.week > this.unlockedWeek) return;

                    let dueCount = 0;
                    set.cards.forEach(card => {
                        const progress = this.userProgress[card.id];
                        if (!progress || (progress.nextReview && progress.nextReview <= today)) {
                            dueCount++;
                        }
                    });

                    if (dueCount > 0) {
                        dueSetsCount++;
                        const setEl = document.createElement('div');
                        setEl.className = "bg-white p-4 rounded-xl shadow-md border-l-4 border-orange-500 flex justify-between items-center transform transition hover:-translate-y-1";
                        setEl.innerHTML = `
                            <div>
                                <span class="font-bold text-gray-800">${set.name}</span>
                                <span class="text-sm text-orange-600 font-medium block">–î–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è: ${dueCount}</span>
                            </div>
                            <button onclick="window.App.promptForDirection('${set.id}', 'review')"
                                    class="py-2 px-4 bg-orange-100 text-orange-700 font-bold rounded-xl hover:bg-orange-200 transition duration-150 flex items-center">
                                –ù–∞—á–∞—Ç—å
                                <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            </button>
                        `;
                        list.appendChild(setEl);
                    }
                });

                if (dueSetsCount > 0) {
                    section.classList.remove('hidden');
                } else {
                    section.classList.add('hidden');
                }
            },

            renderWeeklySelections() {
                document.getElementById('list-title').innerText = 'üìÖ –ü–æ–¥–±–æ—Ä–∫–∏ –ø–æ –Ω–µ–¥–µ–ª—è–º';
                this.renderBackButton('home-screen');
                document.getElementById('filter-controls').innerHTML = '';

                const contentListDiv = document.getElementById('content-list');
                contentListDiv.innerHTML = '';
                
                ALL_WEEKS.forEach(i => {
                    const isUnlocked = i <= this.unlockedWeek;
                    const weekSets = WORD_SETS.filter(s => s.week === i);
                    
                    const button = document.createElement('button');
                    button.className = `w-full text-left p-4 rounded-xl shadow-md flex justify-between items-center transition duration-150 ${isUnlocked ? 'bg-white hover:bg-gray-50' : 'button-locked'}`;
                    
                    if (isUnlocked) {
                        button.onclick = () => this.renderWeekContent(i);
                    } else {
                         button.onclick = () => console.log(`–ù–µ–¥–µ–ª—è ${i} –ø–æ–∫–∞ –∑–∞–∫—Ä—ã—Ç–∞.`);
                    }

                    button.innerHTML = `
                        <div>
                            <span class="font-semibold text-lg ${isUnlocked ? 'text-gray-800' : 'text-gray-500'}">–ù–µ–¥–µ–ª—è ${i}</span>
                            <span class="block text-sm text-gray-500">${weekSets.length} –Ω–∞–±–æ—Ä–∞</span>
                        </div>
                        ${!isUnlocked ? '<span>üîí</span>' : '<span>&rarr;</span>'}
                    `;
                    contentListDiv.appendChild(button);
                });
                
                this.showScreen('list-screen');
            },
            
            renderMenuCard(container, title, subtitle, onClickAction) {
                const button = document.createElement('button');
                button.className = "w-full text-left p-4 bg-white rounded-xl shadow-md hover:bg-gray-50 flex justify-between items-center transition duration-150";
                button.setAttribute('onclick', onClickAction);
                
                button.innerHTML = `
                    <div>
                        <span class="font-semibold text-lg text-gray-800">${title}</span>
                        <span class="block text-sm text-gray-500">${subtitle}</span>
                    </div>
                    <span>&rarr;</span>
                `;
                container.appendChild(button);
            },
            
            /**
             * –†–ï–ù–î–ï–†–ò–ù–ì –ö–û–ù–¢–ï–ù–¢–ê –ù–ï–î–ï–õ–ò –ü–û –ù–û–í–û–ô –°–¢–†–£–ö–¢–£–†–ï
             */
            renderWeekContent(weekNum) {
                document.getElementById('list-title').innerText = `–ö–æ–Ω—Ç–µ–Ω—Ç –ù–µ–¥–µ–ª–∏ ${weekNum}`;
                this.renderBackButton('weekly-selections'); // –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É –Ω–µ–¥–µ–ª—å
                document.getElementById('filter-controls').innerHTML = '';

                const contentListDiv = document.getElementById('content-list');
                contentListDiv.innerHTML = '';
                
                const weekData = WEEKLY_CONTENT_MAP[weekNum] || {};
                // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –Ω–∞ –æ–¥–Ω—É –Ω–µ–¥–µ–ª—é –ø—Ä–∏—Ö–æ–¥–∏—Ç—Å—è –û–î–ò–ù –Ω–∞–±–æ—Ä —Å–ª–æ–≤ –¥–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è
                const weekSets = WORD_SETS.filter(s => s.week === weekNum); 

                // --- 1. –ó–∞–¥–∞–Ω–∏–µ –Ω–∞ –Ω–µ–¥–µ–ª—é (Weekly Task) ---
                this.renderMenuCard(contentListDiv, 
                    `üìú –ó–∞–¥–∞–Ω–∏–µ –Ω–∞ –Ω–µ–¥–µ–ª—é`, 
                    `–¶–µ–ª–∏ –∏ —Ñ–æ–∫—É—Å –Ω–µ–¥–µ–ª–∏`,
                    `window.App.renderTextDetailScreen('–ó–∞–¥–∞–Ω–∏–µ –Ω–∞ –Ω–µ–¥–µ–ª—é ${weekNum}', '${weekData.taskText || "–ó–∞–¥–∞–Ω–∏–µ –ø–æ–∫–∞ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ."}', 'week-content', ${weekNum})`
                );

                // --- 2. –ê—Å—Å–æ—Ü–∏–∞—Ü–∏–∏ –Ω–∞ –Ω–µ–¥–µ–ª—é (Video/Gallery) - –û–ë–ù–û–í–õ–ï–ù–û: –í–∏–¥–µ–æ ---
                const associationVideoLink = weekData.associationVideoUrl;
                this.renderMenuCard(contentListDiv, 
                    `üß† –ê—Å—Å–æ—Ü–∏–∞—Ü–∏–∏ –Ω–∞ –Ω–µ–¥–µ–ª—é (–í–∏–¥–µ–æ)`, 
                    `–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤–∏–¥–µ–æ-–∞—Å—Å–æ—Ü–∏–∞—Ü–∏—é`,
                    // New action: open the story detail screen for video content
                    `window.App.renderVideoContentScreen('–í–∏–¥–µ–æ-–∞—Å—Å–æ—Ü–∏–∞—Ü–∏—è –Ω–µ–¥–µ–ª–∏ ${weekNum}', '${associationVideoLink || "https://www.youtube.com/embed/NoVideoId"}', 'week-content', ${weekNum})` 
                );
                
                // --- 3. –ò—Å—Ç–æ—Ä–∏—è –Ω–µ–¥–µ–ª–∏ (Weekly Story) ---
                const weeklyStory = STORIES.find(s => s.week === weekNum);
                if (weeklyStory) {
                    this.renderMenuCard(contentListDiv, 
                        `üìñ –ò—Å—Ç–æ—Ä–∏—è –Ω–µ–¥–µ–ª–∏: ${weeklyStory.title}`, 
                        `–£—Ä–æ–≤–µ–Ω—å ${weeklyStory.level}`,
                        // –ü—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –ø–æ–ø–∞–¥–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ –≤ –º–µ–Ω—é –Ω–µ–¥–µ–ª–∏
                        `window.App.renderStoryDetailScreen('${weeklyStory.id}', 'week-content', ${weekNum})` 
                    );
                } else {
                    this.renderMenuCard(contentListDiv, 
                        `üìñ –ò—Å—Ç–æ—Ä–∏—è –Ω–µ–¥–µ–ª–∏`, 
                        `–ü–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞`,
                        `window.App.renderTextDetailScreen('–ò—Å—Ç–æ—Ä–∏—è –Ω–µ–¥–µ–ª–∏', '–ò—Å—Ç–æ—Ä–∏—è –Ω–∞ —ç—Ç—É –Ω–µ–¥–µ–ª—é –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.', 'week-content', ${weekNum})`
                    );
                }

                // --- 4. –ü–æ–ª–µ–∑–Ω—ã–µ —Ñ—Ä–∞–∑—ã / –î–∏–∞–ª–æ–≥–∏ –Ω–∞ —Ç–µ–º—É (Useful Phrases / Dialogues) ---
                this.renderMenuCard(contentListDiv, 
                    `üó£Ô∏è –ü–æ–ª–µ–∑–Ω—ã–µ —Ñ—Ä–∞–∑—ã / –î–∏–∞–ª–æ–≥–∏ –Ω–∞ —Ç–µ–º—É`, 
                    `–û—Ç–∫—Ä—ã—Ç—å –≤–Ω–µ—à–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã (YouTube, PDF)`,
                    `window.App.renderExternalLinkScreen('–ü–æ–ª–µ–∑–Ω—ã–µ —Ñ—Ä–∞–∑—ã / –î–∏–∞–ª–æ–≥–∏ –Ω–∞ —Ç–µ–º—É', '${weekData.dialogueLink || "https://google.com"}', 'week-content', ${weekNum})`
                );

                // --- 5. –°–ª–æ–≤–∞ –Ω–∞ –Ω–µ–¥–µ–ª—é (Word Exercises renamed) - –û–ë–ù–û–í–õ–ï–ù–û: –ü—Ä—è–º–æ–π –ø–µ—Ä–µ—Ö–æ–¥ –∫ —Å–µ—Å—Å–∏–∏ ---
                if (weekSets.length > 0) {
                    const primarySet = weekSets[0];
                    this.renderMenuCard(contentListDiv, 
                        `üìù –°–ª–æ–≤–∞ –Ω–∞ –Ω–µ–¥–µ–ª—é: ${primarySet.name}`, 
                        `–ù–∞—á–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ (${primarySet.cards.length} —Å–ª–æ–≤)`,
                        // –ü—Ä—è–º–æ–π –≤—ã–∑–æ–≤ –æ–∫–Ω–∞ –≤—ã–±–æ—Ä–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –Ω–∞–±–æ—Ä–∞, –º–∏–Ω—É—è —ç–∫—Ä–∞–Ω —Å–ø–∏—Å–∫–∞
                        `window.App.promptForDirection('${primarySet.id}', 'review')`
                    );
                } else {
                    this.renderMenuCard(contentListDiv, 
                        `üìù –°–ª–æ–≤–∞ –Ω–∞ –Ω–µ–¥–µ–ª—é`, 
                        `–ù–µ—Ç –Ω–∞–±–æ—Ä–æ–≤ —Å–ª–æ–≤ –¥–ª—è —ç—Ç–æ–π –Ω–µ–¥–µ–ª–∏`,
                        `window.App.renderTextDetailScreen('–°–ª–æ–≤–∞ –Ω–∞ –Ω–µ–¥–µ–ª—é', '–ù–∞–±–æ—Ä—ã —Å–ª–æ–≤ –¥–ª—è —ç—Ç–æ–π –Ω–µ–¥–µ–ª–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.', 'week-content', ${weekNum})`
                    );
                }

                // --- 6. –ú–∞–Ω—Ç—Ä—ã (Mantras) ---
                this.renderMenuCard(contentListDiv, 
                    `üí° –ú–∞–Ω—Ç—Ä—ã (–ü–æ–ª–µ–∑–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è)`, 
                    `–û—Ç–∫—Ä—ã—Ç—å –≤–Ω–µ—à–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã (YouTube, PDF)`,
                    `window.App.renderExternalLinkScreen('–ú–∞–Ω—Ç—Ä—ã', '${weekData.mantraLink || "https://google.com"}', 'week-content', ${weekNum})`
                );

                this.showScreen('list-screen');
            },
            
            /**
             * –ù–û–í–´–ô –ú–ï–¢–û–î: –†–µ–Ω–¥–µ—Ä–∏—Ç —ç–∫—Ä–∞–Ω —Å –≤–∏–¥–µ–æ-–∫–æ–Ω—Ç–µ–Ω—Ç–æ–º.
             * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É story-detail-screen, –Ω–æ —Å–∫—Ä—ã–≤–∞–µ—Ç –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π.
             */
            renderVideoContentScreen(title, videoUrl, target, param = null) {
                this.showScreen('story-detail-screen'); 

                // 1. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥"
                this.renderBackButton(target, param, 'story-detail-screen'); 

                // 2. –ó–∞–ø–æ–ª–Ω—è–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
                document.getElementById('story-title').textContent = title;
                document.getElementById('story-video-embed').src = videoUrl;

                // 3. –°–∫—Ä—ã–≤–∞–µ–º –Ω–µ–Ω—É–∂–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã (–∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π –∏ PDF-—Å—Å—ã–ª–∫—É)
                const actionButtons = document.getElementById('story-actions');
                const pdfLink = document.getElementById('story-pdf-link');
                
                if (actionButtons) actionButtons.classList.add('hidden');
                if (pdfLink) pdfLink.classList.add('hidden');

                // 4. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω
                this.showScreen('story-detail-screen');
            },

            /**
             * –ù–û–í–´–ô –ú–ï–¢–û–î: –†–µ–Ω–¥–µ—Ä–∏—Ç —ç–∫—Ä–∞–Ω —Å —Ç–µ–∫—Å—Ç–æ–≤—ã–º –∑–∞–¥–∞–Ω–∏–µ–º –∏–ª–∏ –¥—Ä—É–≥–∏–º —Ç–µ–∫—Å—Ç–æ–º/—Å—Å—ã–ª–∫–æ–π.
             */
            renderTextDetailScreen(title, content, target, param = null) {
                this.showScreen('text-detail-screen');
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä text-back-button-container
                this.renderBackButton(target, param, 'text-detail-screen'); 
                
                document.getElementById('text-title').textContent = title;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç ‚Äî —ç—Ç–æ URL, –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –µ–≥–æ –∫–∞–∫ —Å—Å—ã–ª–∫—É
                if (content.startsWith('http')) {
                    document.getElementById('text-content').innerHTML = `
                        <p class="text-blue-600 break-all">
                            <a href="${content}" target="_blank" class="hover:underline font-semibold">${content}</a>
                        </p>
                        <p class="mt-4 text-gray-500 text-sm">–°—Å—ã–ª–∫–∞ –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ. –ï—Å–ª–∏ –≤—ã –≤ Telegram, —Å—Å—ã–ª–∫–∞ –º–æ–∂–µ—Ç –æ—Ç–∫—Ä—ã—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</p>
                    `;
                } else {
                    document.getElementById('text-content').textContent = content;
                }
            },

            /**
             * –ù–û–í–´–ô –ú–ï–¢–û–î: –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤–Ω–µ—à–Ω–∏–µ —Å—Å—ã–ª–∫–∏ (–¥–∏–∞–ª–æ–≥–∏, –º–∞–Ω—Ç—Ä—ã).
             */
            renderExternalLinkScreen(title, link, target, param = null) {
                 if (link.startsWith('http') && window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.openLink) {
                     window.Telegram.WebApp.openLink(link);
                 } else if (link.startsWith('http')) {
                     // –ï—Å–ª–∏ –Ω–µ Telegram WebApp, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–π —ç–∫—Ä–∞–Ω –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Å—ã–ª–∫–∏
                     this.renderTextDetailScreen(title, link, target, param);
                 } else {
                     // –ï—Å–ª–∏ —Å—Å—ã–ª–∫–∏ –Ω–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
                     this.renderTextDetailScreen(title, "–ö–æ–Ω—Ç–µ–Ω—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω. –°—Å—ã–ª–∫–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞.", target, param);
                 }
            },

            /**
             * –ù–û–í–´–ô –ú–ï–¢–û–î: –†–µ–Ω–¥–µ—Ä–∏—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–π –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –Ω–µ–¥–µ–ª–∏.
             */
            renderWeeklyAssociationCards(weekNum) {
                const associations = ASSOCIATION_CARDS.filter(c => c.week === weekNum);
                
                document.getElementById('list-title').innerText = `üß† –ê—Å—Å–æ—Ü–∏–∞—Ü–∏–∏ –ù–µ–¥–µ–ª–∏ ${weekNum}`;
                this.renderBackButton('week-content', weekNum);
                document.getElementById('filter-controls').innerHTML = ''; // –°–∫—Ä—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã

                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–µ—Ç–æ–¥ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –∫–∞—Ä—Ç–æ—á–µ–∫
                this.renderAssociationCards(associations);
                this.showScreen('list-screen');
            },
            
            renderWordSetsForWeek(weekNum) {
                // –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∏–∑ '–í—Å–µ –Ω–∞–±–æ—Ä—ã —Å–ª–æ–≤'
                document.getElementById('list-title').innerText = `üìù –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –Ω–∞ —Å–ª–æ–≤–∞: –ù–µ–¥–µ–ª—è ${weekNum}`;
                this.renderBackButton('week-content', weekNum); 
                document.getElementById('filter-controls').innerHTML = ''; 

                const setsForWeek = WORD_SETS.filter(set => set.week === weekNum);
                this.renderSetCards(setsForWeek); 
                
                this.showScreen('list-screen');
            },
            
            // ... (–æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ - renderAllSetsScreen, renderAllStoriesScreen, renderAssociationBaseScreen, –∏ —Ç.–¥. - –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ...

            /**
             * –†–µ–Ω–¥–µ—Ä–∏—Ç –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥" —Å —É—á–µ—Ç–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
             */
            renderBackButton(target, param = null, screenOverride = null) {
                const screenId = screenOverride || this.currentScreenId;
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥"
                let containerId;
                if (screenId === 'story-detail-screen') {
                    containerId = 'story-back-button-container';
                } else if (screenId === 'text-detail-screen') {
                    containerId = 'text-back-button-container';
                } else {
                    containerId = 'back-button-container';
                }
                
                const backBtnContainer = document.getElementById(containerId);
                
                if (!backBtnContainer) return; 

                let targetFunction;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ param —Å—Ç—Ä–æ–∫–æ–π 'null' –∏ –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º
                const normalizedParam = (typeof param === 'string' && param === 'null') ? null : param;

                switch (target) {
                    case 'home-screen':
                        targetFunction = 'window.App.renderHomeScreen()';
                        break;
                    case 'weekly-selections':
                        targetFunction = 'window.App.renderWeeklySelections()';
                        break;
                    case 'week-content':
                        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –º–µ–Ω—é –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –Ω–µ–¥–µ–ª–∏
                        targetFunction = `window.App.renderWeekContent(${normalizedParam})`; 
                        break;
                    case 'all-stories':
                        targetFunction = 'window.App.renderAllStoriesScreen()';
                        break;
                    default:
                        targetFunction = 'window.App.renderHomeScreen()';
                }

                backBtnContainer.innerHTML = `
                    <button onclick="${targetFunction}" class="text-blue-500 hover:text-blue-700 font-semibold flex items-center">
                        <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                        –ù–∞–∑–∞–¥
                    </button>
                `;
            },
            
            renderSetFilterControls() {
                const filterControls = document.getElementById('filter-controls');
                filterControls.innerHTML = `
                    <div class="grid grid-cols-2 gap-3">
                        <!-- –§–∏–ª—å—Ç—Ä –ø–æ –ù–µ–¥–µ–ª–µ -->
                        <select id="week-filter" onchange="window.App.updateSetFilter('week', this.value)" 
                                class="p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="All">–í—Å–µ –ù–µ–¥–µ–ª–∏</option>
                            ${ALL_WEEKS.map(w => `<option value="${w}" ${this.currentWeekFilter === w.toString() ? 'selected' : ''}>–ù–µ–¥–µ–ª—è ${w}</option>`).join('')}
                        </select>
                        
                        <!-- –§–∏–ª—å—Ç—Ä –ø–æ –¢–µ–º–µ -->
                        <select id="theme-filter" onchange="window.App.updateSetFilter('theme', this.value)" 
                                class="p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="All">–í—Å–µ –¢–µ–º—ã</option>
                            ${ALL_THEMES.map(t => `<option value="${t}" ${this.currentThemeFilter === t ? 'selected' : ''}>${t}</option>`).join('')}
                        </select>
                    </div>
                `;
            },
            
            updateSetFilter(filterType, value) {
                if (filterType === 'week') {
                    this.currentWeekFilter = value;
                } else if (filterType === 'theme') {
                    this.currentThemeFilter = value;
                }
                this.renderAllSetsScreen();
            },

            renderStoryFilterControls() {
                const filterControls = document.getElementById('filter-controls');
                filterControls.innerHTML = `
                    <div class="flex flex-wrap gap-2">
                        <!-- –§–∏–ª—å—Ç—Ä –ø–æ –£—Ä–æ–≤–Ω—é -->
                        <button onclick="window.App.updateStoryFilter('All')" class="py-2 px-4 rounded-full text-sm font-medium transition duration-150 ${this.currentLevelFilter === 'All' ? 'bg-blue-500 text-white shadow-md' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">–í—Å–µ</button>
                        ${ALL_LEVELS.map(l => `
                            <button onclick="window.App.updateStoryFilter('${l}')" class="py-2 px-4 rounded-full text-sm font-medium transition duration-150 ${this.currentLevelFilter === l ? 'bg-blue-500 text-white shadow-md' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">
                                ${l}
                            </button>
                        `).join('')}
                    </div>
                `;
            },
            
            updateStoryFilter(value) {
                this.currentLevelFilter = value;
                this.renderAllStoriesScreen();
            },
            
            renderSetCards(setsToRender) {
                const contentListDiv = document.getElementById('content-list');
                contentListDiv.innerHTML = '';
                const today = this.getTodayDateString();

                if (setsToRender.length === 0) {
                    contentListDiv.innerHTML = '<p class="text-gray-500 text-center py-6">–ù–µ—Ç –Ω–∞–±–æ—Ä–æ–≤, —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—è—é—â–∏—Ö —É—Å–ª–æ–≤–∏—è–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏.</p>';
                    return;
                }

                setsToRender.forEach(set => {
                    let dueCount = 0;
                    set.cards.forEach(card => {
                        const progress = this.userProgress[card.id];
                        // –°—á–∏—Ç–∞–µ–º –Ω–æ–≤—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –∏ –∫–∞—Ä—Ç–æ—á–∫–∏, —Ç—Ä–µ–±—É—é—â–∏–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è
                        if (!progress || (progress.nextReview && progress.nextReview <= today)) {
                            dueCount++; 
                        }
                    });

                    const setContainer = document.createElement('div');
                    setContainer.className = "w-full p-4 bg-white rounded-xl shadow-md";
                    
                    setContainer.innerHTML = `
                        <div class="flex justify-between items-center mb-3">
                            <div>
                                <span class="font-semibold text-gray-800 text-lg">${set.name}</span>
                                <span class="block text-sm text-gray-500">–ù–µ–¥–µ–ª—è ${set.week} | ${set.cards.length} —Å–ª–æ–≤</span>
                            </div>
                            ${dueCount > 0 ? 
                                `<span class="bg-blue-500 text-white text-xs font-bold px-3 py-1 rounded-full shadow-md">${dueCount} –∫ –ø–æ–≤—Ç–æ—Ä—É</span>` :
                                `<span class="text-green-500 font-semibold">‚úì</span>`
                            }
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <button class="w-full py-2 px-3 bg-blue-500 text-white font-semibold rounded-xl text-sm hover:bg-blue-600 transition duration-150" 
                                    onclick="window.App.promptForDirection('${set.id}', 'review')">
                                –ü–æ–≤—Ç–æ—Ä–∏—Ç—å (${dueCount})
                            </button>
                            <button class="w-full py-2 px-3 bg-gray-200 text-gray-700 font-semibold rounded-xl text-sm hover:bg-gray-300 transition duration-150" 
                                    onclick="window.App.promptForDirection('${set.id}', 'practice')">
                                –ü—Ä–∞–∫—Ç–∏–∫–∞ (–í—Å–µ)
                            </button>
                        </div>
                    `;
                    contentListDiv.appendChild(setContainer);
                });
            },

            /**
             * –†–µ–Ω–¥–µ—Ä–∏—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ –∏—Å—Ç–æ—Ä–∏–π. 
             */
            renderStoryCards(storiesToRender, fromScreen = 'all-stories', fromParam = null) {
                const contentListDiv = document.getElementById('content-list');
                contentListDiv.innerHTML = '';

                if (storiesToRender.length === 0) {
                    contentListDiv.innerHTML = '<p class="text-gray-500 text-center py-6">–ù–µ—Ç –∏—Å—Ç–æ—Ä–∏–π, —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—è—é—â–∏—Ö —É—Å–ª–æ–≤–∏—è–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏.</p>';
                    return;
                }

                storiesToRender.forEach(story => {
                    const storyContainer = document.createElement('div');
                    storyContainer.className = "w-full p-4 bg-white rounded-xl shadow-md flex justify-between items-center";
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥"
                    const paramString = fromParam === null ? 'null' : fromParam;
                    
                    storyContainer.innerHTML = `
                        <div>
                            <span class="font-semibold text-gray-800 text-lg">${story.title}</span>
                            <span class="block text-sm font-bold mt-1 text-purple-600">–£—Ä–æ–≤–µ–Ω—å: ${story.level}</span>
                        </div>
                        <button onclick="window.App.renderStoryDetailScreen('${story.id}', '${fromScreen}', ${paramString})" 
                                class="py-2 px-4 bg-green-500 text-white font-semibold rounded-xl text-sm hover:bg-green-600 transition duration-150 shadow-md flex items-center">
                            –ù–∞—á–∞—Ç—å &rarr;
                        </button>
                    `;
                    contentListDiv.appendChild(storyContainer);
                });
            },
            
            /**
             * –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–µ—Ç–∞–ª–µ–π –∏—Å—Ç–æ—Ä–∏–∏ (–û–ë–ù–û–í–õ–ï–ù–û: –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏)
             */
            renderStoryDetailScreen(storyId, fromScreen, fromParam) {
                const story = STORIES.find(s => s.id === storyId);
                if (!story) {
                    console.error("Story not found:", storyId);
                    this.renderHomeScreen();
                    return;
                }
                
                this.showScreen('story-detail-screen');

                // 1. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥"
                let target = fromScreen;
                let param = fromParam;

                // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É 'null' –æ–±—Ä–∞—Ç–Ω–æ –≤ null
                if (param === 'null') {
                    param = null;
                }

                if (fromScreen === 'week' && param !== null) {
                    // –ï—Å–ª–∏ –ø—Ä–∏—à–ª–∏ –∏–∑ –Ω–æ–≤–æ–≥–æ –º–µ–Ω—é –Ω–µ–¥–µ–ª–∏, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ —ç—Ç–æ –º–µ–Ω—é
                    target = 'week-content';
                    param = param; // param - —ç—Ç–æ weekNum
                } else if (fromScreen === 'all-stories') {
                    target = 'all-stories';
                    param = null;
                }
                
                // 2. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥"
                this.renderBackButton(target, param, 'story-detail-screen'); 

                // 3. –ó–∞–ø–æ–ª–Ω—è–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
                document.getElementById('story-title').textContent = story.title;
                document.getElementById('story-video-embed').src = story.videoUrl;
                
                const pdfLink = document.getElementById('story-pdf-link');
                pdfLink.href = story.pdfUrl;
                pdfLink.querySelector('span').textContent = `üìÑ –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è (${story.level})`;

                // 4. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º ID —Ç–µ–∫—É—â–µ–π –∏—Å—Ç–æ—Ä–∏–∏
                document.getElementById('story-detail-screen').dataset.currentStoryId = storyId;
                
                // 5. –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π –∏ PDF-—Å—Å—ã–ª–∫–∏ (–î–ª—è –∏—Å—Ç–æ—Ä–∏–π –æ–Ω–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤–∏–¥–Ω—ã)
                const actionButtons = document.getElementById('story-actions');
                
                if (actionButtons) actionButtons.classList.remove('hidden');
                if (pdfLink) pdfLink.classList.remove('hidden');
            },

            // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ü–æ–ª–µ –ø–æ–∏—Å–∫–∞ –¥–ª—è –ë–∞–∑—ã –ê—Å—Å–æ—Ü–∏–∞—Ü–∏–π
            renderAssociationSearchControl() {
                const filterControls = document.getElementById('filter-controls');
                filterControls.innerHTML = `
                    <div class="flex space-x-2">
                        <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ -->
                        <div class="relative flex-grow">
                            <input type="text" id="association-search-input-field" 
                                   value="${this.currentAssociationSearch}"
                                   placeholder="–ò—Å–∫–∞—Ç—å –ø–æ —Ä—É—Å—Å–∫–æ–º—É –∏–ª–∏ –Ω–µ–º–µ—Ü–∫–æ–º—É —Å–ª–æ–≤—É..."
                                   class="w-full p-3 pl-10 border border-gray-300 rounded-xl shadow-sm focus:ring-purple-500 focus:border-purple-500 transition duration-150">
                            <svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                        </div>
                        
                        <!-- –ö–Ω–æ–ø–∫–∞ "–ò—Å–∫–∞—Ç—å" -->
                        <button onclick="window.App.executeAssociationSearch()"
                                class="flex-shrink-0 py-3 px-4 bg-purple-600 text-white font-semibold rounded-xl shadow-md hover:bg-purple-700 transition duration-150">
                            –ò—Å–∫–∞—Ç—å
                        </button>
                    </div>
                `;
            },
            
            executeAssociationSearch() {
                const searchInput = document.getElementById('association-search-input-field');
                if (searchInput) {
                    this.currentAssociationSearch = searchInput.value;
                }
                this.renderAssociationBaseScreen();
            },
            
            getFilteredAssociationCards() {
                const search = this.currentAssociationSearch.toLowerCase().trim();
                if (!search) return ASSOCIATION_CARDS;
                
                return ASSOCIATION_CARDS.filter(card => 
                    card.german.toLowerCase().includes(search) || 
                    card.russian.toLowerCase().includes(search)
                );
            },

            /**
             * –†–µ–Ω–¥–µ—Ä–∏—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ –∏–∑ –ë–∞–∑—ã –ê—Å—Å–æ—Ü–∏–∞—Ü–∏–π.
             */
            renderAssociationCards(cardsToRender) {
                const contentListDiv = document.getElementById('content-list');
                contentListDiv.innerHTML = '';

                if (cardsToRender.length === 0) {
                    contentListDiv.innerHTML = '<p class="text-gray-500 text-center py-6">–ù–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–∏—Å–∫—É.</p>';
                    return;
                }
                
                cardsToRender.forEach(card => {
                    const cardEl = document.createElement('button');
                    cardEl.className = "w-full text-left p-4 bg-white rounded-xl shadow-md hover:shadow-lg transition duration-300 border-l-4 border-purple-500 flex justify-between items-center";
                    cardEl.onclick = () => this.showAssociationDetailModal(card);
                    
                    cardEl.innerHTML = `
                        <div>
                            <span class="font-bold text-xl text-gray-800">${card.german}</span>
                            <span class="block text-md text-gray-600">${card.russian}</span>
                        </div>
                        <span class="text-lg text-purple-600">&rarr;</span>
                    `;
                    contentListDiv.appendChild(cardEl);
                });
            },
            
            /**
             * –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –¥–µ—Ç–∞–ª—è–º–∏ –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–∏.
             */
            showAssociationDetailModal(card) {
                document.getElementById('association-image').src = card.imageUrl;
                document.getElementById('detail-german-word').textContent = card.german;
                document.getElementById('detail-russian-word').textContent = card.russian;
                document.getElementById('detail-transcription').textContent = `/${card.transcription}/`;
                this.openModal('association-detail-modal');
            },

            closeAssociationDetailModal() {
                this.closeModal('association-detail-modal');
            },
            
            // ==================== –õ–û–ì–ò–ö–ê –ü–û–í–¢–û–†–ï–ù–ò–Ø ====================

            startStoryQuiz() {
                const storyId = document.getElementById('story-detail-screen').dataset.currentStoryId;
                console.log(`–ù–∞—á–∏–Ω–∞–µ–º –∫–≤–∏–∑ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏: ${storyId}`);
                // TODO: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ª–æ–≥–∏–∫–∏ –∫–≤–∏–∑–∞
                // –í—Ä–µ–º–µ–Ω–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–Ω—Å–æ–ª—å
                console.log("–ö–≤–∏–∑ –ø–æ —Ç–µ–∫—Å—Ç—É –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω.");
            },

            startMantraPractice() {
                const storyId = document.getElementById('story-detail-screen').dataset.currentStoryId;
                console.log(`–ù–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ—Ä–∞–±–æ—Ç–∫—É –º–∞–Ω—Ç—Ä –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏: ${storyId}`);
                // TODO: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Ä–∞–±–æ—Ç–∫–∏ –º–∞–Ω—Ç—Ä
                console.log("–ü—Ä–æ—Ä–∞–±–æ—Ç–∫–∞ –º–∞–Ω—Ç—Ä –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞.");
            },

            /**
             * –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤—ã–±–æ—Ä–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è.
             */
            promptForDirection(setId, mode) {
                this.tempSetId = setId;
                this.tempMode = mode;
                this.openModal('direction-modal');
            },

            closeDirectionModal() {
                this.closeModal('direction-modal');
            },

            startSessionWithDirection(direction) {
                this.currentDirection = direction;
                this.closeDirectionModal();
                this.startSession(this.tempSetId, this.tempMode);
            },
            
            /**
             * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç —Å–µ—Å—Å–∏—é –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è.
             */
            startSession(setId, mode) {
                const set = WORD_SETS.find(s => s.id === setId);
                if (!set) return;

                this.isPracticeMode = (mode === 'practice');
                
                if (this.isPracticeMode) {
                    // –†–µ–∂–∏–º "–ü—Ä–∞–∫—Ç–∏–∫–∞": –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ –Ω–∞–±–æ—Ä–µ
                    this.sessionCards = set.cards.map(card => ({...card})); 
                } else {
                    // –†–µ–∂–∏–º "–ü–æ–≤—Ç–æ—Ä–∏—Ç—å": —Ç–æ–ª—å–∫–æ –∫–∞—Ä—Ç–æ—á–∫–∏, —Ç—Ä–µ–±—É—é—â–∏–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è
                    const today = this.getTodayDateString();
                    this.sessionCards = set.cards.filter(card => {
                        const progress = this.userProgress[card.id];
                        return !progress || (progress.nextReview && progress.nextReview <= today);
                    });
                }
                
                if (this.sessionCards.length === 0) {
                    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —ç–∫—Ä–∞–Ω –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º
                    document.getElementById('finish-screen-text').textContent = this.isPracticeMode ? 
                        "–í —ç—Ç–æ–º —Ä–µ–∂–∏–º–µ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Ä–µ–∂–∏–º '–ü—Ä–∞–∫—Ç–∏–∫–∞ (–í—Å–µ)'." : 
                        "–î–ª—è —ç—Ç–æ–≥–æ –Ω–∞–±–æ—Ä–∞ –Ω–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫, —Ç—Ä–µ–±—É—é—â–∏—Ö –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è —Å–µ–≥–æ–¥–Ω—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Ä–µ–∂–∏–º '–ü—Ä–∞–∫—Ç–∏–∫–∞ (–í—Å–µ)'!";
                    this.showScreen('finish-screen');
                    return;
                }
                
                // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏
                this.sessionCards.sort(() => Math.random() - 0.5);
                this.currentCardIndex = 0;
                
                this.showScreen('study-screen');
                this.showNextCard();
            },

            /**
             * –ü–µ—Ä–µ–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç –∫–∞—Ä—Ç–æ—á–∫—É, –ø–æ–∫–∞–∑—ã–≤–∞—è –æ—Ç–≤–µ—Ç.
             */
            showAnswer() {
                document.getElementById('card').classList.add('is-flipped');
                document.getElementById('controls-show').classList.add('hidden');
                document.getElementById('controls-rate').classList.remove('hidden');
            },
            
            /**
             * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ª–µ–¥—É—é—â—É—é –∫–∞—Ä—Ç–æ—á–∫—É –≤ —Å–µ—Å—Å–∏–∏.
             */
            showNextCard() {
                if (this.currentCardIndex >= this.sessionCards.length) {
                    // –°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞
                    document.getElementById('finish-screen-text').textContent = "–í—ã –ø—Ä–æ—à–ª–∏ –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏.";
                    this.showScreen('finish-screen');
                    return;
                }
                
                const cardEl = document.getElementById('card');
                
                // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏
                cardEl.classList.remove('is-flipped');
                cardEl.classList.add('slide-in');
                setTimeout(() => cardEl.classList.remove('slide-in'), 400);

                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
                const totalCards = this.sessionCards.length;
                const currentCount = this.currentCardIndex + 1;
                const percent = (currentCount / totalCards) * 100;
                document.getElementById('progress-bar').style.width = `${percent}%`;

                // –°–±—Ä–æ—Å –∫–Ω–æ–ø–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                document.getElementById('controls-show').classList.remove('hidden');
                document.getElementById('controls-rate').classList.add('hidden');

                const card = this.sessionCards[this.currentCardIndex];
                
                // –ò–∫–æ–Ω–∫–∞ –¥–∏–Ω–∞–º–∏–∫–∞ —Å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–º
                const speakerIconSvg = `
                    <svg class="w-6 h-6 text-blue-500 hover:text-blue-700 inline-block ml-2 cursor-pointer" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707A1 1 0 0112 6v12a1 1 0 01-1.707.707L5.586 15z"></path>
                    </svg>
                `;
                
                // –ù–µ–º–µ—Ü–∫–æ–µ —Å–ª–æ–≤–æ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏—è
                const germanHtml = `
                    <div class="flex items-center justify-center gap-2">
                        <span>${card.back}</span>
                        <span onclick="window.App.speakGerman('${card.back}', event)">
                            ${speakerIconSvg}
                        </span>
                    </div>
                `;

                // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                if (this.currentDirection === 'ru-de') {
                    document.getElementById('card-front-text').textContent = card.front;
                    document.getElementById('card-back-text').innerHTML = germanHtml;
                } else {
                    document.getElementById('card-front-text').innerHTML = germanHtml;
                    document.getElementById('card-back-text').textContent = card.front;
                }
                
                // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –ø–æ–¥—Å–∫–∞–∑–∫–∏
                const hintButton = document.getElementById('hint-button');
                if (card.hintImage) {
                    hintButton.classList.remove('hidden');
                } else {
                    hintButton.classList.add('hidden');
                }
            },
            
            /**
             * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ø–æ–º–Ω—é/–Ω–µ –ø–æ–º–Ω—é).
             */
            async handleAnswer(knewIt) {
                if (this.isAdvancing) return; 
                this.isAdvancing = true;

                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —Ç–æ–ª—å–∫–æ –≤ —Ä–µ–∂–∏–º–µ "–ü–æ–≤—Ç–æ—Ä–∏—Ç—å"
                if (!this.isPracticeMode) {
                    const card = this.sessionCards[this.currentCardIndex];
                    let progress = this.userProgress[card.id] || { box: 0 };

                    if (knewIt) {
                        // –ï—Å–ª–∏ –ø–æ–º–Ω—é, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —è—â–∏–∫—É (–º–∞–∫—Å 6)
                        progress.box = Math.min(6, (progress.box || 0) + 1);
                    } else {
                        // –ï—Å–ª–∏ –Ω–µ –ø–æ–º–Ω—é, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ —è—â–∏–∫—É 1
                        progress.box = 1;
                    }
                    
                    const interval = REPETITION_INTERVALS[progress.box];
                    progress.nextReview = this.getFutureDateString(interval);
                    
                    this.userProgress[card.id] = progress;
                    if (this.db) {
                        this.saveProgress(); // –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
                    }
                }
                
                // –ê–Ω–∏–º–∞—Ü–∏—è —É—Ö–æ–¥–∞ –∫–∞—Ä—Ç–æ—á–∫–∏
                document.getElementById('card').classList.add('slide-out');
                setTimeout(() => {
                    document.getElementById('card').classList.remove('slide-out'); 
                    this.currentCardIndex++; 
                    this.isAdvancing = false; 
                    this.showNextCard(); 
                }, 400); 
            },
            
            /**
             * –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç –Ω–µ–º–µ—Ü–∫–∏–π —Ç–µ–∫—Å—Ç —Å –ø–æ–º–æ—â—å—é —Å–∏–Ω—Ç–µ–∑–∞ —Ä–µ—á–∏.
             */
            speakGerman(textToSpeak, event) {
                if (event) {
                    event.stopPropagation(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≤–æ—Ä–∞—á–∏–≤–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É
                }
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                    const utterance = new SpeechSynthesisUtterance(textToSpeak);
                    utterance.lang = 'de-DE'; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–µ–º–µ—Ü–∫–∏–π —è–∑—ã–∫
                    // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –Ω–µ–º–µ—Ü–∫–∏–π –≥–æ–ª–æ—Å
                    const voices = window.speechSynthesis.getVoices().filter(v => v.lang.includes('de-'));
                    if (voices.length > 0) {
                        // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: Anna, Google German, –∏–ª–∏ –ø–µ—Ä–≤—ã–π –Ω–∞–π–¥–µ–Ω–Ω—ã–π
                        utterance.voice = voices.find(v => v.name.includes('Anna')) || voices.find(v => v.name.includes('Google')) || voices[0];
                    }
                    window.speechSynthesis.speak(utterance);
                } else {
                    console.log('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–∏–Ω—Ç–µ–∑ —Ä–µ—á–∏.');
                }
            },

            // ==================== –£–¢–ò–õ–ò–¢–´ ====================

            /**
             * –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π.
             */
            openModal(modalId) {
                const modal = document.getElementById(modalId);
                // –ò—â–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç-–±–ª–æ–∫ –ø–æ ID
                const modalContent = document.getElementById(`${modalId}-content`) || document.getElementById(`${modalId}-modal-content`);
                
                if (modal) {
                    modal.classList.remove('hidden');
                    // –î–∞–µ–º CSS –≤—Ä–µ–º—è –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é 'display: block'
                    setTimeout(() => {
                        modal.classList.add('is-open', 'opacity-100');
                        if (modalContent) {
                            modalContent.classList.add('is-open');
                        }
                    }, 10);
                }
            },
            
            /**
             * –ó–∞–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π.
             */
            closeModal(modalId) {
                const modal = document.getElementById(modalId);
                const modalContent = document.getElementById(`${modalId}-content`) || document.getElementById(`${modalId}-modal-content`);
                
                if (modal) {
                    // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞—Ç–Ω—É—é –∞–Ω–∏–º–∞—Ü–∏—é
                    modal.classList.remove('is-open', 'opacity-100');
                    if (modalContent) {
                        modalContent.classList.remove('is-open');
                    }
                    // –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ —Å–∫—Ä—ã–≤–∞–µ–º
                    setTimeout(() => {
                        modal.classList.add('hidden');
                    }, 300);
                }
            },
            
            /**
             * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –ø–æ–¥—Å–∫–∞–∑–∫–æ–π.
             */
            showHint() {
                const card = this.sessionCards[this.currentCardIndex];
                if (!card || !card.hintImage) return;
                const img = document.getElementById('hint-image');
                img.src = card.hintImage; 
                this.openModal('hint-modal');
            },

            closeHintModal() {
                this.closeModal('hint-modal');
            },
            
            /**
             * –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –≤–∏–¥–∏–º–æ—Å—Ç—å —ç–∫—Ä–∞–Ω–æ–≤.
             */
            showScreen(screenId) {
                this.currentScreenId = screenId;
                // –í–∫–ª—é—á–µ–Ω –Ω–æ–≤—ã–π —ç–∫—Ä–∞–Ω 'text-detail-screen'
                ['loading-screen', 'home-screen', 'list-screen', 'study-screen', 'finish-screen', 'story-detail-screen', 'text-detail-screen'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.classList.add('hidden');
                });
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—ã–π —ç–∫—Ä–∞–Ω
                const screen = document.getElementById(screenId);
                if (screen) {
                    screen.classList.remove('hidden');
                }
            },
            
            showError(message) {
                this.showScreen('loading-screen');
                const loadingScreen = document.getElementById('loading-screen');
                if (loadingScreen) {
                    loadingScreen.innerHTML = `<p class="text-red-500 font-semibold">${message}</p>`;
                }
            },
            
            /**
             * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ 'YYYY-MM-DD'.
             */
            getTodayDateString() {
                return new Date().toISOString().split('T')[0];
            },

            /**
             * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞—Ç—É —á–µ—Ä–µ–∑ daysToAdd –¥–Ω–µ–π –≤ —Ñ–æ—Ä–º–∞—Ç–µ 'YYYY-MM-DD'.
             */
            getFutureDateString(daysToAdd) {
                const date = new Date();
                date.setDate(date.getDate() + daysToAdd);
                return date.toISOString().split('T')[0];
            }
        };
        
        // ==========================================================
        // 3. –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø (Conceptual Bootstrap)
        // ==========================================================

        window.addEventListener('load', () => {
            // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –≥–æ–ª–æ—Å–æ–≤ –¥–ª—è —Å–∏–Ω—Ç–µ–∑–∞ —Ä–µ—á–∏ –¥–ª—è –ª—É—á—à–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
            if ('speechSynthesis' in window) {
                window.speechSynthesis.getVoices(); 
                if (window.speechSynthesis.onvoiceschanged !== undefined) {
                    window.speechSynthesis.onvoiceschanged = () => window.speechSynthesis.getVoices();
                }
            }
            window.App.init();
        });

    </script>
</body>
</html>