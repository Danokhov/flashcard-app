<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>–ò–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω–æ–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º API Telegram -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        /* ===== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –°–¢–ò–õ–ò ===== */
        * {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: #ffffff;
            min-height: 100vh;
            user-select: none;
            -webkit-user-select: none;
            overflow-x: hidden;
            width: 100%;
            touch-action: pan-y;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–µ—Ä–µ–≤–æ—Ä–æ—Ç–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ */
        .card { 
            perspective: 1000px; 
            min-height: 300px;
            max-height: 400px;
        }
        .card-inner {
            position: relative;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            min-height: 300px;
        }
        .card.is-flipped .card-inner {
            transform: rotateY(180deg);
        }
        .card-front, .card-back {
            position: absolute;
            width: 100%;
            min-height: 300px;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            top: 0; left: 0;
        }
        .card-front {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .card-back {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            transform: rotateY(180deg);
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ "—É—Ö–æ–¥–∞" –∏ "–ø–æ—è–≤–ª–µ–Ω–∏—è" –∫–∞—Ä—Ç–æ—á–∫–∏ */
        @keyframes slide-left {
            0% { transform: translateX(0); opacity: 1; }
            100% { transform: translateX(-100%); opacity: 0; }
        }
        @keyframes slide-in-right {
            0% { transform: translateX(100%); opacity: 0; }
            100% { transform: translateX(0); opacity: 1; }
        }

        .card.slide-out {
            animation: slide-left 0.4s ease forwards;
        }
        .card.slide-in {
            animation: slide-in-right 0.4s ease;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω */
        .modal {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
            transform: scale(0.95);
            background: linear-gradient(135deg, #ffffff 0%, #f8f9ff 100%);
            border-radius: 20px;
        }
        .modal.is-open {
            opacity: 1;
        }
        .modal.is-open .modal-content {
            transform: scale(1);
        }

        /* –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ */
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            border-radius: 12px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
        }
        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            font-weight: 600;
            border-radius: 12px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(17, 153, 142, 0.4);
        }
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(17, 153, 142, 0.6);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%);
            color: white;
            font-weight: 600;
            border-radius: 12px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(245, 87, 108, 0.4);
        }
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(245, 87, 108, 0.6);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #333;
            font-weight: 600;
            border-radius: 12px;
            transition: all 0.3s ease;
        }
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        /* –ö–∞—Ä—Ç–æ—á–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ */
        .card-content {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        .card-content:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }

        /* –ì–ª–∞–≤–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ */
        .main-content {
            background: #ffffff;
            min-height: 100vh;
            padding-bottom: 80px;
        }

        /* –°—Ç–∏–ª—å –¥–ª—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∫–Ω–æ–ø–∫–∏ */
        .button-locked {
            background-color: #e5e7eb;
            color: #6b7280;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä 16:9 –¥–ª—è –≤–∏–¥–µ–æ */
        .video-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
            height: 0;
            overflow: hidden;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Ä—É—Å–µ–ª–∏ */
        .carousel-card {
            min-height: 250px;
        }

        /* --- –°—Ç–∏–ª–∏, –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–∑ text1.html --- */
        .quiz-option { transition: all 0.15s ease; outline: none; }
        .quiz-option:hover { transform: translateY(-2px); box-shadow: 0 6px 10px -2px rgba(0,0,0,0.1); }
        .quiz-selected {
          background-color:#A5B4FC!important;
          color:#1E3A8A!important;
          border-color:#6366F1!important;
          box-shadow:0 4px 6px -1px rgba(99,102,241,0.3)!important;
        }
        .next-button-disabled {
          background-color:#D1D5DB!important;
          color:#6B7280!important;
          cursor:not-allowed;
          box-shadow:none!important;
        }
        .next-button-active {
          background:linear-gradient(to right,#4F46E5,#6366F1)!important;
          color:#fff!important;
          box-shadow:0 4px 10px -2px rgba(79,70,229,0.5);
          transition:all 0.2s ease;
        }
        .next-button-active:hover { opacity:.9; transform:translateY(-1px); }
        #question-box { border-left:5px solid #6366F1; }

        .story-visual-container img {
          width:100%;
          height:auto;
          display:block;
        }

        /* –§–ò–ö–°–ò–†–û–í–ê–ù–ù–ê–Ø –ü–ê–ù–ï–õ–¨ –ü–†–û–ò–ì–†–´–í–ê–¢–ï–õ–Ø */
        #audio-bar.fixed-audio-bar {
            position: fixed;
            top: env(safe-area-inset-top, 0px); /* –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –ø–æ–¥ —à–∞–ø–∫—É TG */
            left: 0;
            right: 0;
            z-index: 999;
            background: rgba(243, 244, 246, 0.97);
            backdrop-filter: blur(6px);
            padding-top: 0.5rem;
            padding-bottom: 0.75rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        #audio-bar.fixed-audio-bar {
            width: 100% !important;
            left: 0 !important;
            right: 0 !important;
            padding: 0.5rem 1rem !important;
            box-sizing: border-box;
        }

        #audio-bar.fixed-audio-bar > div {
            max-width: none !important;
            width: 100% !important;
            margin: 0 auto;
        }
        /* –ß—Ç–æ–±—ã –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–µ –ø—Ä—ã–≥–∞–ª ‚Äî –æ—Ç—Å—Ç—É–ø –ø–æ–¥ –ø–∞–Ω–µ–ª—å */
        #audio-bar-placeholder.fixed-visible {
            height: 120px; /* –ø–æ–¥–±–µ—Ä–∏ –ø–æ–¥ —Ä–µ–∞–ª—å–Ω—É—é –≤—ã—Å–æ—Ç—É —Ç–≤–æ–µ–≥–æ –±–∞—Ä–∞ (–ø—Ä–∏–º–µ—Ä–Ω–æ 100-130px) */
        }

        .audio-main-button {
          transition: transform 0.15s ease, box-shadow 0.15s ease, opacity 0.15s ease;
        }
        .audio-main-button:hover {
          transform: translateY(-1px);
          box-shadow: 0 8px 18px rgba(37,99,235,0.55);
          opacity:.95;
        }

        input[type="range"] { width:100%; cursor:pointer; }

        .accordion-content {
          max-height:0;
          overflow:hidden;
          transition:max-height 0.4s ease-in-out,opacity 0.4s ease-in-out;
          opacity:0;
          visibility:hidden;
        }
        .accordion-content.is-open {
          max-height:90vh;
          opacity:1;
          visibility:visible;
          overflow-y:auto;
        }
        /* --- –ö–æ–Ω–µ—Ü –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å—Ç–∏–ª–µ–π --- */
        /* --- –°—Ç–∏–ª–∏ –¥–ª—è –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ --- */
        #transcript-scroll-area {
            /* –í–æ—Ç –≤–∞—à —à—Ä–∏—Ñ—Ç. 
              1rem = 16px (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
              1.125rem = 18px (–∫–∞–∫ text-lg –≤ Tailwind)
              1.25rem = 20px (–∫–∞–∫ text-xl –≤ Tailwind)
            */
            font-size: 1.125rem; 
        }
        
        #transcript-scroll-area p {
            /* –í–æ—Ç –≤–∞—à–∏ –æ—Ç—Å—Ç—É–ø—ã. 
              –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —É –≤–∞—Å 'mb-3', —á—Ç–æ —Ä–∞–≤–Ω–æ 0.75rem (12px).
              mb-2 = 0.5rem (8px)
              mb-1 = 0.25rem (4px)
            */
            margin-bottom: 0.5rem; 

            /* –ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ —É–º–µ–Ω—å—à–∏—Ç—å –Ω–µ –æ—Ç—Å—Ç—É–ø –ú–ï–ñ–î–£ –∞–±–∑–∞—Ü–∞–º–∏, 
              –∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª –ú–ï–ñ–î–£ —Å—Ç—Ä–æ–∫–∞–º–∏ –í–ù–£–¢–†–ò –∞–±–∑–∞—Ü–∞ (–º–µ–∂—Å—Ç—Ä–æ—á–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª), 
              –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ 'line-height':
            */
            /* line-height: 1.4; */ /* (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—Ä–∏–º–µ—Ä–Ω–æ 1.5 –∏–ª–∏ 1.6) */
        }
        /* --- –ö–æ–Ω–µ—Ü —Å—Ç–∏–ª–µ–π –¥–ª—è –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ --- */
    </style>
</head>

<body class="min-h-screen bg-white font-sans p-4 pb-28" style="overflow-y: auto; overflow-x: hidden;">

<div id="word-detail-screen" class="hidden fixed inset-0 z-50 flex flex-col items-center justify-start bg-white overflow-y-auto" style="padding-top: 32px;">
    <div class="w-full max-w-xl mx-auto p-4">
        <div class="flex flex-col items-center gap-4">
            <!-- –ù–µ–º–µ—Ü–∫–æ–µ —Å–ª–æ–≤–æ —Å –∞—Ä—Ç–∏–∫–ª–µ–º (–µ—Å–ª–∏ noun) -->
            <div id="word-detail-german" class="text-3xl font-bold text-gray-900 text-center"></div>
            <!-- –ú–∏–∫—Ä–æ—Ñ–æ–Ω -->
            <button id="word-detail-speak" class="p-2 bg-blue-100 hover:bg-blue-200 rounded-full">
                <svg class="w-8 h-8 text-blue-600" fill="currentColor" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
            </button>
            <!-- –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –∏ –ø–µ—Ä–µ–≤–æ–¥ -->
            <div id="word-detail-transcription" class="text-lg text-gray-500 text-center"></div>
            <div id="word-detail-translation" class="text-xl text-gray-700 text-center font-semibold"></div>
            <!-- –ß–∞—Å—Ç—å —Ä–µ—á–∏ -->
            <div id="word-detail-pos" class="text-base text-gray-500 text-center"></div>
            <!-- –¢–µ–º—ã -->
            <div id="word-detail-topics" class="text-base text-gray-400 text-center"></div>
            <!-- –ü—Ä–∏–º–µ—Ä -->
            <div id="word-detail-example" class="text-base text-gray-600 text-center italic"></div>
            <!-- –ö–Ω–æ–ø–∫–∏ -->
            <div class="flex gap-4 justify-center mt-4">
                <button id="word-detail-association" class="btn-secondary">–ê—Å—Å–æ—Ü–∏–∞—Ü–∏—è</button>
                <button id="word-detail-study" class="btn-success">–£—á–∏—Ç—å</button>
            </div>
            <button onclick="window.App.closeWordDetailScreen()" class="mt-6 text-gray-400 hover:text-gray-700">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
</div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
    <div id="app" class="max-w-xl mx-auto" style="touch-action: pan-y;">
        
        <!-- 1. –≠–∫—Ä–∞–Ω –ó–∞–≥—Ä—É–∑–∫–∏ (–≤–∏–¥–µ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
        <div id="loading-screen" class="text-center py-20">
            <p class="text-blue-600 text-lg font-semibold">–ó–∞–≥—Ä—É–∂–∞–µ–º –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–∏...</p>
        </div>

        <!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û: –ú–ê–ù–¢–†–´ –ü–û–õ–ï–ó–ù–´–• –§–†–ê–ó -->
        <div id="mantra-modal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
            <div class="modal-content bg-white p-4 max-w-lg w-full rounded-2xl">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-lg font-semibold">–ú–∞–Ω—Ç—Ä—ã –ø–æ–ª–µ–∑–Ω—ã—Ö —Ñ—Ä–∞–∑</h3>
                    <button onclick="window.App.closeModal('mantra-modal')" class="text-gray-500">‚úï</button>
                </div>
                <div id="mantra-modal-body">
                    <div id="mantra-card-area">
                        <div id="mantra-progress" class="text-sm text-gray-500 mb-4 text-center">0 / 0</div>
                        
                        <!-- –í–µ—Ä—Ö–Ω–∏–π –±–ª–æ–∫: –†—É—Å—Å–∫–∏–π (–≤—Å–µ–≥–¥–∞ –≤–∏–¥–∏–º) -->
                        <div class="bg-blue-50 p-6 rounded-xl shadow-md mb-3">
                            <p class="text-sm text-gray-500 mb-2">–†—É—Å—Å–∫–∏–π:</p>
                            <div id="mantra-russian" class="text-xl font-semibold text-gray-900">...</div>
                        </div>

                        <!-- –ù–∏–∂–Ω–∏–π –±–ª–æ–∫: –ù–µ–º–µ—Ü–∫–∏–π (–∑–∞–∫—Ä—ã—Ç/–æ—Ç–∫—Ä—ã—Ç) -->
                        <div class="bg-green-50 p-6 rounded-xl shadow-md">
                            <div id="mantra-german-hidden">
                                <button onclick="window.App.showMantraAnswer()" class="btn-secondary w-full">–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç</button>
                            </div>
                            <div id="mantra-german-shown" class="hidden">
                                <p class="text-sm text-gray-500 mb-2">–ù–µ–º–µ—Ü–∫–∏–π:</p>
                                <div id="mantra-german" class="text-xl font-semibold text-gray-900 mb-3">...</div>
                                <button onclick="window.App.speakMantra(document.getElementById('mantra-german').textContent)" class="btn-primary w-full mb-3">üîä –û–∑–≤—É—á–∏—Ç—å</button>
                            </div>
                        </div>

                        <!-- –û—Ü–µ–Ω–∫–∞ -->
                        <div class="mt-4 text-center text-sm text-gray-600 mb-3">–û—Ü–µ–Ω–∏ —Å–≤–æ–π –æ—Ç–≤–µ—Ç:</div>
                        <div class="mt-4 flex gap-2" id="mantra-controls">
                            <button onclick="window.App.handleMantraAnswer(false)" class="btn-danger flex-1">–ù–µ –≤–µ—Ä–Ω–æ</button>
                            <button onclick="window.App.handleMantraAnswer(true)" class="btn-success flex-1">–í–µ—Ä–Ω–æ</button>
                        </div>
                    </div>

                    <div id="mantra-summary" class="hidden text-center p-4">
                        <!-- –°—é–¥–∞ –±—É–¥–µ—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω –∏—Ç–æ–≥ -->
                    </div>

                    <div id="mantra-summary-actions" class="mt-2"></div>
                </div>
            </div>
        </div>

        <!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û: –ö–∞—Ä—É—Å–µ–ª—å –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–π -->
        <div id="associations-modal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
            <div class="modal-content bg-white p-6 max-w-2xl w-full rounded-2xl relative">
                <!-- –ö—Ä–µ—Å—Ç–∏–∫ –∑–∞–∫—Ä—ã—Ç—å –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É -->
                <button onclick="window.App.closeModal('associations-modal')" class="absolute top-4 right-4 text-gray-500 text-2xl hover:text-gray-700">‚úï</button>
                
                <div id="associations-modal-body">
                    <div id="associations-progress" class="text-sm text-gray-500 mb-4 text-center">–ö–∞—Ä—Ç–æ—á–∫–∞ 1 / 10</div>
                    
                    <!-- –ö–∞—Ä—Ç–∏–Ω–∫–∞ –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–∏ -->
                    <div class="mb-4">
                        <img id="association-image" src="" alt="Association" class="w-full h-64 object-cover rounded-xl shadow-md">
                    </div>
                    
                    <!-- –ù–µ–º–µ—Ü–∫–æ–µ —Å–ª–æ–≤–æ -->
                    <div class="text-center mb-4">
                        <h3 id="association-word" class="text-2xl font-bold text-gray-800">das Wort</h3>
                        <p id="association-translation" class="text-lg text-gray-600">–ø–µ—Ä–µ–≤–æ–¥</p>
                    </div>
                    
                    <!-- –¢–µ–∫—Å—Ç –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–∏ -->
                    <div class="bg-yellow-50 p-4 rounded-xl shadow-md mb-4">
                        <p id="association-text" class="text-gray-700 leading-relaxed">–¢–µ–∫—Å—Ç –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–∏ –±—É–¥–µ—Ç –∑–¥–µ—Å—å...</p>
                    </div>
                    
                    <!-- –ö–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ -->
                    <div class="flex gap-3 justify-center">
                        <button onclick="window.App.showPrevAssociation()" class="btn-secondary px-6 py-2 rounded-lg">‚Üê –ù–∞–∑–∞–¥</button>
                        <button onclick="window.App.showNextAssociation()" class="btn-primary px-6 py-2 rounded-lg">–í–ø–µ—Ä–µ–¥ ‚Üí</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ (Home Screen) -->
        <div id="home-screen" class="hidden main-content">
            <div class="px-4 pt-2 pb-4 max-w-2xl mx-auto">
                <div class="text-center mb-5">
                    <div class="text-5xl mb-1">üá©üá™</div>
                    <h1 class="text-3xl font-bold bg-gradient-to-r from-orange-500 via-yellow-500 to-red-500 bg-clip-text text-transparent mb-0.5">–ú–Ω–µ–º–æ Deutsch</h1>
                    <p class="text-gray-600 text-sm font-semibold">–ö–ª—É–± –∏–∑—É—á–µ–Ω–∏—è –Ω–µ–º–µ—Ü–∫–æ–≥–æ —è–∑—ã–∫–∞</p>
                </div>

                <div class="space-y-2">
                    <!-- –î–ò–ù–ê–ú–ò–ß–ï–°–ö–ò–ô –ë–õ–û–ö: –ü—Ä–æ–±–Ω—ã–π —É—Ä–æ–∫ –ò–õ–ò –ê–∫—Ç–∏–≤–Ω–∞—è –Ω–µ–¥–µ–ª—è/–£—Ä–æ–∫–∏ –ø–æ –Ω–µ–¥–µ–ª—è–º -->
                    <div id="main-content-block">
                        <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JS (–≤–∫–ª—é—á–∞–µ—Ç –ü—Ä–æ–±–Ω—ã–π, –ü–æ–¥–±–æ—Ä–∫–∏ –∑–∞ –Ω–µ–¥–µ–ª—é –∏ –í—Å–µ –Ω–∞–±–æ—Ä—ã —Å–ª–æ–≤) -->
                    </div>
                    
                    <!-- –ù–û–í–ê–Ø –°–ï–ö–¶–ò–Ø: –ì–æ—Ä—è—â–∏–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è -->
                    <div id="due-today-section" class="hidden pt-6 mt-6 border-t-2 border-purple-200">
                        <h2 class="text-xl font-bold bg-gradient-to-r from-orange-500 to-red-500 bg-clip-text text-transparent mb-4 flex items-center">
                            <span class="mr-2">üî•</span>
                            <span>–ö –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—é —Å–µ–≥–æ–¥–Ω—è</span>
                        </h2>
                        <div id="due-today-list" class="space-y-3">
                            <!-- –°—é–¥–∞ JS –¥–æ–±–∞–≤–∏—Ç –≥–æ—Ä—è—â–∏–µ —Å–µ—Ç—ã -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 3. –≠–ö–†–ê–ù –°–ü–ò–°–ö–ê (–¥–ª—è –Ω–µ–¥–µ–ª—å, —Å–µ—Ç–æ–≤) -->
        <div id="list-screen" class="hidden main-content">
            <div class="max-w-2xl mx-auto px-4 pt-6">
                <h1 id="list-title" class="text-3xl font-bold text-center mb-2 bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent"></h1>
                <p id="list-subtitle" class="text-center text-gray-600 mb-6">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–±–æ—Ä –¥–ª—è –Ω–∞—á–∞–ª–∞</p>
                
                <!-- –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" –£–î–ê–õ–ï–ù–ê. –ë—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è Telegram.WebApp.BackButton -->
                <div id="back-button-container" class="mb-4"></div>
                
                <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã/–ø–æ–∏—Å–∫ -->
                <div id="filter-controls" class="mb-4 space-y-3">
                    <select id="topic-dropdown" class="p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 mb-2 w-full">
                        <option value="all">–í—Å–µ —Ç–µ–º—ã</option>
                    </select>
                    <div id="search-container" class="flex gap-2 mb-4 relative">
                        <div class="relative flex-1">
                            <input type="text" id="search-input-weekly" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Å–ª–æ–≤—É (–Ω–µ–º/—Ä—É—Å)" class="p-2 pr-10 border border-gray-300 rounded-lg w-full">
                            <button id="clear-search-button" class="absolute right-2 top-1/2 transform -translate-y-1/2 w-6 h-6 bg-gray-800 rounded-full flex items-center justify-center hover:bg-gray-700 transition hidden">
                                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <button id="search-button" class="px-4 py-2 bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-600 transition flex items-center justify-center">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </button>
                        <div id="autocomplete-list" class="absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-lg shadow-lg mt-1 max-h-60 overflow-y-auto z-50 hidden"></div>
                    </div>
                </div>
                
                <!-- –°–ø–∏—Å–æ–∫ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ -->
                <div id="content-list" class="space-y-4 pb-20">
                    <!-- –°—é–¥–∞ –±—É–¥—É—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω—ã –Ω–∞–±–æ—Ä—ã, –Ω–µ–¥–µ–ª–∏ -->
                </div>
            </div>
        </div>
        
        <!-- 4. –≠–ö–†–ê–ù –í–ò–î–ï–û –ö–û–ù–¢–ï–ù–¢–ê (–¥–ª—è –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–π –Ω–µ–¥–µ–ª–∏) -->
        <div id="video-content-screen" class="hidden main-content">
            <!-- –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" –£–î–ê–õ–ï–ù–ê. -->
            <div id="video-back-button-container" class="mb-2"></div> 
            
            <div class="max-w-2xl mx-auto px-4 pt-2 pb-20">
                <h1 id="video-title" class="text-2xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent mb-3 text-center"></h1>
                
                <!-- –í–∏–¥–µ–æ 16:9 -->
                <div class="video-container mb-3 rounded-2xl overflow-hidden shadow-2xl">
                    <iframe id="video-embed" src="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                </div>

                <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç (–¥–ª—è –∑–∞–¥–∞–Ω–∏–π –Ω–µ–¥–µ–ª–∏) -->
                <div id="video-extra-text" class="card-content p-4 text-gray-700 mb-4 text-sm max-h-32 overflow-y-auto">
                    <!-- –°—é–¥–∞ –±—É–¥–µ—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω —Ç–µ–∫—Å—Ç –∑–∞–¥–∞–Ω–∏—è -->
                </div>

                <!-- –ö–Ω–æ–ø–∫–∞ –ö–∞—Ä—É—Å–µ–ª—å –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–π -->
                <div id="video-carousel-button-container" class="mt-4">
                    <!-- –ö–Ω–æ–ø–∫–∞ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>
        </div>

        <!-- 5. –≠–ö–†–ê–ù –í–ù–ï–®–ù–ï–ô –°–°–´–õ–ö–ò -->
        <div id="external-link-screen" class="hidden text-center py-10">
           <!-- –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" –£–î–ê–õ–ï–ù–ê. -->
           <div id="external-link-back-button-container" class="mb-4 text-left"></div>

            <h2 id="external-link-title" class="text-xl font-bold text-gray-800 mb-4"></h2>
            <p id="external-link-text" class="text-gray-600 mb-6 px-4">–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É (–∏–ª–∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É).</p>
            
            <a id="external-link-button" href="#" target="_blank" 
               class="py-3 px-6 bg-blue-500 text-white font-bold rounded-xl shadow-md hover:bg-blue-600 inline-block transition duration-150">
                –û—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É
            </a>
            
            <p id="external-link-url-display" class="mt-4 text-sm text-gray-500 break-all px-4"></p>
        </div>

        <!-- 6. –≠–ö–†–ê–ù –ü–†–û–°–ú–û–¢–†–ê –°–¢–†–ê–ù–ò–¶–´ (–¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ HTML-–∫–æ–Ω—Ç–µ–Ω—Ç–∞, –∫–∞–∫ text1.html) -->
        <div id="content-viewer-screen" class="hidden">
             <!-- –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" –£–î–ê–õ–ï–ù–ê. -->
             <div id="content-viewer-back-button-container" class="mb-4"></div>        
            <h2 id="content-viewer-title" class="text-xl font-bold text-gray-800 mb-4 text-center"></h2>
            
            <!-- 
              --- –ù–ê–ß–ê–õ–û –ò–ù–¢–ï–ì–†–ê–¶–ò–ò text1.html ---
              HTML-–∫–æ–Ω—Ç–µ–Ω—Ç –∏–∑ text1.html —Ç–µ–ø–µ—Ä—å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –∑–¥–µ—Å—å
            -->
            <div id="content-viewer-body" class="p-4 bg-gray-100 rounded-xl">
                
                <!-- –∫–∞—Ä—Ç–∏–Ω–∫–∞ + –∞—É–¥–∏–æ -->
                <div class="story-visual-container rounded-xl shadow-xl overflow-hidden">
                  <img src="Woche1_text.png"
                       alt="–ò–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—è –∫ –∏—Å—Ç–æ—Ä–∏–∏"
                       onclick="event.preventDefault();event.stopPropagation();">
                  <audio id="story-audio-player" src="Woche1_text.mp3"></audio>
                </div>

                <!-- –∑–∞–≥–æ–ª–æ–≤–æ–∫ -->
                <h1 class="text-2xl font-bold text-center text-gray-900">
                  Der Termin beim Arzt
                </h1>

                <!-- –û–ë–Å–†–¢–ö–ê –ü–ê–ù–ï–õ–ò: —Å–Ω–∞—á–∞–ª–∞ –æ–±—ã—á–Ω–∞—è, –ø–æ—Ç–æ–º —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è fixed -->
                <div id="audio-bar-wrapper">
                  <div id="audio-bar">
                    <div class="max-w-md mx-auto">
                      <div class="bg-white rounded-2xl px-4 py-3 shadow-lg border border-gray-200 flex flex-col gap-2">
                        <div class="flex items-center justify-center">
                          <button id="audio-main-button"
                                  class="audio-main-button rounded-full btn-primary px-6 py-3 flex items-center justify-center shadow-lg transition duration-150 hover:scale-110 active:scale-95">
                            <svg id="play-icon" class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                              <path d="M8 5v14l11-7z"></path>
                            </svg>
                            <svg id="pause-icon" class="w-8 h-8 hidden" fill="currentColor" viewBox="0 0 24 24">
                              <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"></path>
                            </svg>
                          </button>
                        </div>

                        <div class="flex flex-col gap-1">
                          <input id="audio-progress" type="range" min="0" max="100" value="0">
                          <div class="flex justify-between text-xs text-gray-500">
                            <span id="audio-current-time">0:00</span>
                            <span id="audio-duration">0:00</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä, —á—Ç–æ–±—ã —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ ‚Äú–ø—Ä—ã–≥–∞–ª–∞‚Äù, –∫–æ–≥–¥–∞ –±–∞—Ä —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è fixed -->
                <div id="audio-bar-placeholder" style="height: 0;"></div>

                <!-- –ê–ö–ö–û–†–î–ï–û–ù–´ -->
                <div class="space-y-4">

                  <!-- —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è (—Ç–µ–ø–µ—Ä—å –∫–Ω–æ–ø–∫–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞) -->
                  <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
                    <button id="transcript-button"
                            onclick="window.App.openModal('transcript-modal')"
                            class="w-full py-4 px-5 text-left text-lg font-semibold text-gray-700 hover:bg-gray-50 flex justify-between items-center transition">
                      <span><span class="mr-3 text-green-500">üìñ</span>–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è</span>
                      <span>&rarr;</span>
                    </button>
                    <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∞ <div id="transcript-content">...</div> –±—ã–ª–æ —É–¥–∞–ª–µ–Ω–æ –∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–æ –≤ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
                  </div>

                  <!-- [–ò–ó–ú–ï–ù–ï–ù–û] –∫–Ω–æ–ø–∫–∞ –∫–≤–∏–∑–∞ (–ü–ï–†–ï–ú–ï–©–ï–ù–ê –°–Æ–î–ê) -->
                  <button onclick="window.StoryApp.startStoryQuiz()"
                          class="w-full py-4 px-5 bg-indigo-500 text-white rounded-xl shadow-xl text-left text-lg font-bold 
                                 hover:bg-indigo-600 transition flex justify-between items-center 
                                 bg-indigo-600 transform hover:scale-[1.01] hover:shadow-2xl">
                    <span><span class="mr-3 text-yellow-300">üß†</span>–ö–≤–∏–∑ –Ω–∞ –ø–æ–º–Ω–Ω–∏–º–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞</span>
                    <span>&rarr;</span>
                  </button>
                  
                  <!-- [–ò–ó–ú–ï–ù–ï–ù–û] —Ä–∞–∑–±–æ—Ä —Ç–µ–∫—Å—Ç–∞ -->
                  <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
                    <button id="analysis-button"
                            onclick="window.StoryApp.toggleAccordion('analysis-content')"
                            class="w-full py-4 px-5 text-left text-lg font-semibold text-gray-700 hover:bg-gray-50 flex justify-between items-center transition">
                      <span><span class="mr-3 text-blue-500">üìù</span>–†–∞–∑–±–æ—Ä —Ç–µ–∫—Å—Ç–∞</span>
                      <span id="analysis-arrow">&darr;</span>
                    </button>
                    <div id="analysis-content"
                         class="accordion-content bg-gray-50 border-t border-gray-200 hidden p-4">
                      <div id="analysis-carousel" class="space-y-4">
                        <div id="analysis-slide" class="space-y-3"></div>

                        <div class="flex items-center justify-between mt-4">
                          <button onclick="window.StoryApp.prevAnalysisSlide()"
                                  class="py-2 px-4 bg-gray-200 text-gray-700 rounded-lg text-sm font-semibold hover:bg-gray-300 transition">
                            ‚Üê –ù–∞–∑–∞–¥
                          </button>

                          <span id="analysis-progress"
                                class="text-xs text-gray-500 mx-2 flex-1 text-center">
                            1 / 1
                          </span>

                          <button onclick="window.StoryApp.nextAnalysisSlide()"
                                  class="py-2 px-4 bg-indigo-500 text-white rounded-lg text-sm font-semibold hover:bg-indigo-600 transition">
                            –í–ø–µ—Ä—ë–¥ ‚Üí
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- [–ò–ó–ú–ï–ù–ï–ù–û] –∫–Ω–æ–ø–∫–∞ –∫–≤–∏–∑–∞ –£–î–ê–õ–ï–ù–ê –û–¢–°–Æ–î–ê -->
                
            </div>
            <!-- --- –ö–û–ù–ï–¶ –ò–ù–¢–ï–ì–†–ê–¶–ò–ò text1.html --- -->
        </div>
        
        <!-- 7. –≠–ö–†–ê–ù –°–ü–ò–°–ö–ê –ö–ê–†–£–°–ï–õ–ï–ô (–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –µ—Å–ª–∏ –Ω–µ—Ç —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –Ω–∞–±–æ—Ä–∞) -->
        <div id="carousel-list-screen" class="hidden">
         
            <h1 id="carousel-list-title" class="text-2xl font-bold text-center mb-6 text-gray-800">–ö–∞—Ä—É—Å–µ–ª—å –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–π</h1>
            <!-- –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" –£–î–ê–õ–ï–ù–ê. -->
            <div id="carousel-list-back-button-container" class="mb-4"></div>
            <div id="carousel-sets-list" class="space-y-4">
                <!-- –°—é–¥–∞ JS –≤—Å—Ç–∞–≤–∏—Ç –∫–Ω–æ–ø–∫–∏ –Ω–∞–±–æ—Ä–æ–≤ -->
            </div>
        </div>

        <!-- 8. –≠–ö–†–ê–ù –ö–ê–†–£–°–ï–õ–ò (–ü—Ä–æ—Å–º–æ—Ç—Ä —Å–ª–æ–≤ —Å –∫–∞—Ä—Ç–∏–Ω–∫–∞–º–∏) -->
        <div id="image-carousel-screen" class="hidden">
            <!-- –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" –£–î–ê–õ–ï–ù–ê. -->
            <div id="carousel-back-button-container" class="mb-4"></div>
                 <h2 id="carousel-word-count" class="text-lg font-semibold text-gray-800 mb-4 text-center"></h2>

            <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –∫–∞—Ä—É—Å–µ–ª–∏ -->
            <div class="carousel-card bg-white rounded-xl shadow-lg p-4 mb-6 relative">
                <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ -->
                <img id="carousel-image" src="" alt="–ò–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—è" class="w-full h-auto object-contain rounded-lg max-h-48 mb-4" 
                     onerror="this.onerror=null; this.src='https://placehold.co/400x200/FCA5A5/FFFFFF?text=–ù–µ—Ç+–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è';">
                
                <!-- –ù–µ–º–µ—Ü–∫–æ–µ —Å–ª–æ–≤–æ -->
                <div class="text-center mb-4">
                    <span id="carousel-word" class="text-2xl font-bold text-gray-800"></span>
                    <button onclick="window.App.speakGerman(window.App.carouselCards[window.App.currentCarouselIndex].word, event)" 
                            class="ml-2 text-blue-500 hover:text-blue-700">
                        <svg class="w-6 h-6 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707A1 1 0 0112 6v12a1 1 0 01-1.707.707L5.586 15z"></path>
                        </svg>
                    </button>
                </div>
                
                <!-- –ü–µ—Ä–µ–≤–æ–¥ (—Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
                <div id="carousel-translation" class="text-center text-xl text-gray-600 font-semibold mb-4 hidden"></div>

                <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
                <div class="flex justify-center space-x-4">
                    <button onclick="window.App.showPrevWord()" class="py-2 px-4 bg-gray-200 text-gray-700 font-bold rounded-xl hover:bg-gray-300 transition duration-150">
                        &larr; –ù–∞–∑–∞–¥
                    </button>
                    <button id="toggle-translation-button" onclick="window.App.toggleTranslation()" 
                            class="py-2 px-4 bg-yellow-400 text-yellow-900 font-bold rounded-xl shadow-md hover:bg-yellow-500 transition duration-150">
                        –ü–æ–∫–∞–∑–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥
                    </button>
                    <button onclick="window.App.showNextWord()" class="py-2 px-4 bg-blue-500 text-white font-bold rounded-xl shadow-md hover:bg-blue-600 transition duration-150">
                        –î–∞–ª–µ–µ &rarr;
                    </button>
                </div>
            </div>
             <!-- –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥ –∫ –°–ø–∏—Å–∫—É –ö–∞—Ä—É—Å–µ–ª–µ–π" –£–î–ê–õ–ï–ù–ê. -->
        </div>

        <!-- 9. –≠–∫—Ä–∞–Ω –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è (Study Screen) -->
        <div id="study-screen" class="hidden main-content">
            <!-- –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" –£–î–ê–õ–ï–ù–ê. -->
            <div id="study-back-button-container" class="mt-4"></div>
            
            <div class="max-w-2xl mx-auto px-4 pt-6">
                <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä -->
                <div class="bg-gray-300 rounded-full h-2.5 mb-6 shadow-lg">
                    <div id="progress-bar" class="bg-purple-500 h-2.5 rounded-full transition-all duration-500 shadow-lg" style="width: 0%"></div>
                </div>
                
                <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ -->
                <div id="card" class="card w-full mb-6">
                    <div id="card-inner" class="card-inner h-full w-full" onclick="window.App.showAnswer()">
                        <!-- –ü–µ—Ä–µ–¥–Ω—è—è —Å—Ç–æ—Ä–æ–Ω–∞ -->
                        <div id="card-front" class="card-front flex flex-col items-center justify-center p-6 rounded-2xl shadow-2xl text-center cursor-pointer hover:shadow-xl transition-shadow">
                            <img id="card-front-image" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="–ö–∞—Ä—Ç–∏–Ω–∫–∞ —Å–ª–æ–≤–∞" class="w-full h-auto object-contain rounded-lg mb-4 max-h-64 hidden" style="display: none;">
                            <div id="card-front-text" class="text-3xl font-bold"></div>
                        </div>
                        <!-- –ó–∞–¥–Ω—è—è —Å—Ç–æ—Ä–æ–Ω–∞ -->
                        <div id="card-back" class="card-back flex flex-col items-center justify-center p-6 rounded-2xl shadow-2xl text-center cursor-pointer hover:shadow-xl transition-shadow">
                            <img id="card-back-image" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="–ö–∞—Ä—Ç–∏–Ω–∫–∞ —Å–ª–æ–≤–∞" class="w-full h-auto object-contain rounded-lg mb-4 max-h-64 hidden" style="display: none;">
                            <div id="card-back-text" class="text-3xl font-bold"></div>
                        </div>
                    </div>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
            <div id="controls-show" class="text-center space-y-3">
                <button onclick="window.App.showAnswer()" class="btn-primary w-full py-3 px-4 flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                    –ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç
                </button>
                <button id="hint-button" onclick="window.App.showHint()" class="btn-secondary w-full py-2 px-4 flex items-center justify-center gap-2 hidden">
                    üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞
                </button>
            </div>
            
            <div id="controls-rate" class="hidden grid grid-cols-2 gap-4">
                <button onclick="window.App.handleAnswer(false)" class="btn-danger py-3 px-4 flex items-center justify-center gap-2 font-bold">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"></path></svg>
                    –£—á–∏—Ç—å
                </button>
                <button onclick="window.App.handleAnswer(true)" class="btn-success py-3 px-4 flex items-center justify-center gap-2 font-bold">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"></path></svg>
                    –ó–Ω–∞—é
                </button>
            </div>
            
            <div id="controls-practice-all" class="hidden flex justify-center gap-3">
                <button onclick="window.App.prevCard()" class="btn-secondary py-3 px-6 flex items-center justify-center gap-2 font-bold">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12l4.58-4.59z"></path></svg>
                    –ù–∞–∑–∞–¥
                </button>
                <button id="hint-button-practice-all" onclick="window.App.showHint()" class="btn-secondary py-3 px-6 flex items-center justify-center gap-2 font-bold">
                    –ü–æ–¥—Å–∫–∞–∑–∫–∞
                </button>
                <button onclick="window.App.nextCard()" class="btn-primary py-3 px-6 flex items-center justify-center gap-2 font-bold">
                    –í–ø–µ—Ä–µ–¥
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6-6-6z"></path></svg>
                </button>
            </div>
             <!-- –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é" –≤–æ –≤—Ä–µ–º—è —Å–µ—Å—Å–∏–∏ –£–î–ê–õ–ï–ù–ê. -->
        </div>
        
        <!-- 10. –≠–∫—Ä–∞–Ω –ó–∞–≤–µ—Ä—à–µ–Ω–∏—è (Finish Screen) -->
         <div id="finish-screen" class="hidden main-content">
            <div class="max-w-2xl mx-auto px-4 py-20">
                <div class="card-content p-8 text-center">
                    <svg class="w-20 h-20 mx-auto mb-4 text-green-500" fill="currentColor" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"></path></svg>
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">–û—Ç–ª–∏—á–Ω–æ! üéâ</h2>
                    <p id="finish-screen-text" class="text-gray-600 mb-6 text-lg">–í—ã –ø—Ä–æ—à–ª–∏ –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏.</p>
                    <div class="flex flex-col gap-3">
                        <button id="finish-return-to-sets-btn" onclick="window.App.renderAllSetsScreen()" class="hidden btn-secondary py-3 px-8 inline-flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"></path></svg>
                            –ö –Ω–∞–±–æ—Ä–∞–º —Å–ª–æ–≤
                        </button>
                        <button onclick="window.App.renderHomeScreen(false, true)" class="btn-primary py-3 px-8 inline-flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V20a2 2 0 002 2h12a2 2 0 002-2v-9.586l.707.707a1 1 0 001.414-1.414l-7-7z"></path></svg>
                            –í –º–µ–Ω—é
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div>

<div id="navigation-footer" class="fixed bottom-0 left-0 right-0 bg-blue-500 border-t border-blue-700 shadow-2xl z-40 max-w-xl mx-auto">
    <div id="nav-content-container" class="flex justify-around items-center h-16">

        <!-- –ò–ó–ú–ï–ù–ï–ù–û: onclick –≤—ã–∑—ã–≤–∞–µ—Ç renderHomeScreen —Å clearStack=true, —á—Ç–æ–±—ã —Å–±—Ä–æ—Å–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ -->
        <button onclick="window.App.renderHomeScreen(false, true)" class="flex flex-col items-center justify-center text-white hover:text-blue-100 transition-colors w-1/3 py-2 group">
            <svg class="w-7 h-7 group-hover:scale-110 transition-transform" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V20a2 2 0 002 2h12a2 2 0 002-2v-9.586l.707.707a1 1 0 001.414-1.414l-7-7z"></path></svg>
            <span class="text-xs mt-1 font-semibold">–ì–ª–∞–≤–Ω–∞—è</span>
        </button>

        <button onclick="window.App.renderAllSetsScreen()" class="flex flex-col items-center justify-center text-white hover:text-blue-100 transition-colors w-1/3 py-2 group">
            <img src="assets/icons/carrds.png" alt="" class="w-7 h-7 group-hover:scale-110 transition-transform">
            <span class="text-xs mt-1 font-semibold">–í —É—á–µ–±–µ</span>
        </button>

        <button onclick="window.App.renderTopicSelection()" class="flex flex-col items-center justify-center text-white hover:text-blue-100 transition-colors w-1/3 py-2 group bg-purple-600 rounded-lg">
            <svg class="w-7 h-7 group-hover:scale-110 transition-transform" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11z"></path></svg>
            <span class="text-xs mt-1 font-semibold">–í—Å–µ –¢–µ–º—ã</span>
        </button>

    </div>
</div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ü–æ–¥—Å–∫–∞–∑–∫–∏ -->
    <div id="hint-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 opacity-0" onclick="window.App.closeModal('hint-modal')">
        <div id="hint-modal-content" class="modal-content bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full" onclick="event.stopPropagation()">
            <h3 class="text-2xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent mb-4">üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞</h3>
            <img id="hint-image" src="" alt="–ü–æ–¥—Å–∫–∞–∑–∫–∞" class="w-full h-auto rounded-lg object-contain max-h-64 mb-4" onerror="this.onerror=null; this.src='https://placehold.co/400x150/FCA5A5/FFFFFF?text=–ù–µ—Ç+–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è';">
            <button onclick="window.App.closeModal('hint-modal')" class="btn-primary w-full py-2 px-4">
                –ó–∞–∫—Ä—ã—Ç—å
            </button>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ö–∞—Ä—Ç–æ—á–∫–∏ —Å–ª–æ–≤–∞ -->
    <div id="word-card-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 opacity-0 overflow-y-auto" onclick="window.App.closeModal('word-card-modal')">
        <div id="word-card-modal-content" class="modal-content bg-white p-6 rounded-2xl shadow-2xl max-w-lg w-full my-8" onclick="event.stopPropagation()">
            <img id="word-card-image" src="" alt="" class="w-full h-48 object-contain rounded-lg mb-4">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-baseline gap-2">
                    <span id="word-card-article" class="text-2xl font-semibold text-blue-600"></span>
                    <h3 id="word-card-word" class="text-3xl font-bold text-gray-800"></h3>
                </div>
                <div class="flex gap-2">
                    <button id="word-card-study-btn" onclick="window.App.toggleWordForStudyFromModal()" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white font-semibold rounded-lg transition">
                        –£—á–∏—Ç—å
                    </button>
                    <button id="word-card-speak" class="p-2 bg-blue-100 hover:bg-blue-200 rounded-lg transition">
                        <svg class="w-6 h-6 text-blue-600" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div id="word-card-transcription-ru" class="text-lg text-gray-600 mb-3"></div>
            <div id="word-card-translation" class="text-xl text-gray-700 mb-3"></div>
            <div class="flex items-center gap-2 mb-3">
                <div id="word-card-part-of-speech" class="text-sm text-blue-600 font-semibold"></div>
                <div id="word-card-plural" class="text-sm text-gray-600 italic"></div>
            </div>
            <div id="word-card-topics" class="flex flex-wrap gap-2 mb-3"></div>
            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-3 mb-3">
                <p class="text-sm font-semibold text-yellow-800 mb-1">üí° –ê—Å—Å–æ—Ü–∏–∞—Ü–∏—è:</p>
                <p id="word-card-association" class="text-sm text-yellow-700"></p>
            </div>
            <div class="bg-green-50 border-l-4 border-green-400 p-3 mb-4">
                <p class="text-sm font-semibold text-green-800 mb-1">üìù –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:</p>
                <p id="word-card-example" class="text-sm text-green-700"></p>
            </div>
            <div class="flex gap-2">
                <button id="word-card-prev" onclick="window.App.navigateWordCard(-1)" class="flex-1 py-3 px-4 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed">
                    ‚Üê –ù–∞–∑–∞–¥
                </button>
                <button onclick="window.App.closeModal('word-card-modal')" class="px-6 py-3 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-lg transition">
                    ‚úï
                </button>
                <button id="word-card-next" onclick="window.App.navigateWordCard(1)" class="flex-1 py-3 px-4 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed">
                    –í–ø–µ—Ä–µ–¥ ‚Üí
                </button>
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –í—ã–±–æ—Ä–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
    <div id="direction-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 opacity-0" onclick="window.App.closeDirectionModal()">
        <div id="direction-modal-content" class="modal-content bg-white p-8 rounded-2xl shadow-2xl max-w-sm w-full relative" onclick="event.stopPropagation()">
            <button onclick="window.App.closeDirectionModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-2xl leading-none">
                ‚úï
            </button>
            <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h3>
            <div class="space-y-3">
                <button onclick="window.App.startSessionWithDirection('de-ru')" class="w-full py-4 px-4 bg-blue-500 text-white font-semibold rounded-xl shadow hover:bg-blue-600 transition">
                    DE ‚Üí RU
                </button>
                <button onclick="window.App.startSessionWithDirection('ru-de')" class="w-full py-4 px-4 bg-blue-500 text-white font-semibold rounded-xl shadow hover:bg-blue-600 transition">
                    RU ‚Üí DE
                </button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π –Ω–µ–¥–µ–ª–∏ -->
    <div id="week-details-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 opacity-0" onclick="window.App.closeModal('week-details-modal')">
        <div id="week-details-modal-content" class="modal-content bg-white p-6 rounded-xl shadow-xl max-w-sm w-full" onclick="event.stopPropagation()">
            <h3 id="week-details-title" class="text-xl font-bold mb-3 text-center text-gray-800"></h3>
            <p id="week-details-body" class="text-gray-700 mb-5"></p>
            <button onclick="window.App.closeModal('week-details-modal')" class="w-full py-3 px-4 bg-blue-500 text-white font-bold rounded-xl shadow-md hover:bg-blue-600">
                –ü–æ–Ω—è—Ç–Ω–æ
            </button>
        </div>
    </div>

    <!-- ===== –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø: –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫–≤–∏–∑–∞ ===== -->
    <div id="quiz-modal"
         class="modal hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 opacity-0"
         onclick="window.StoryApp.closeModal('quiz-modal')" role="dialog" aria-modal="true">
      <div id="quiz-modal-content"
           class="modal-content bg-white p-6 rounded-xl shadow-xl max-w-sm w-full"
           onclick="event.stopPropagation()">
        <h3 id="quiz-modal-title"
            class="text-xl font-bold mb-4 text-gray-800 text-center border-b pb-2">–ö–≤–∏–∑ –ø–æ –∏—Å—Ç–æ—Ä–∏–∏</h3>

        <div class="text-sm text-gray-500 mb-4 text-center">
          <span id="quiz-progress">–í–æ–ø—Ä–æ—Å 1 –∏–∑ 3</span>
        </div>

        <div id="quiz-scroll-area" class="max-h-[65vh] overflow-y-auto pr-2">
          <div id="question-box" class="bg-indigo-50 p-4 rounded-lg mb-4 shadow-inner">
            <p id="quiz-question" class="text-xl font-bold text-gray-800"></p>
          </div>
          <div id="quiz-options" class="space-y-3"></div>
          <p id="quiz-feedback" class="mt-4 text-center text-xl font-extrabold hidden"></p>
        </div>

        <button id="quiz-next-button"
                onclick="window.StoryApp.nextQuizQuestion()"
                class="w-full mt-6 py-3 px-4 font-bold rounded-xl shadow-md transition next-button-disabled"
                disabled>
          –°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å
        </button>

        <div id="quiz-end-controls" class="space-y-3 mt-6 hidden">
          <button onclick="window.StoryApp.startStoryQuiz()"
                  class="w-full py-3 px-4 bg-blue-500 text-white font-bold rounded-xl shadow-md hover:bg-blue-600 transition">
            –ü—Ä–æ–π—Ç–∏ –µ—â—ë —Ä–∞–∑
          </button>
          <button onclick="window.StoryApp.showCorrectAnswers()"
                  class="w-full py-3 px-4 bg-yellow-500 text-yellow-900 font-bold rounded-xl shadow-md hover:bg-yellow-600 transition">
            –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
          </button>
          <button onclick="window.App.closeModal('quiz-modal')"
                  class="w-full py-3 px-4 bg-gray-500 text-white font-bold rounded-xl shadow-md hover:bg-gray-600 transition">
            –ó–∞–≤–µ—Ä—à–∏—Ç—å
          </button>
        </div>
      </div>
    </div>
    <!-- ===== –ö–û–ù–ï–¶ –ò–ù–¢–ï–ì–†–ê–¶–ò–ò: –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫–≤–∏–∑–∞ ===== -->

    <!-- ===== –ù–û–í–û–ï: –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ ===== -->
    <div id="transcript-modal"
         class="modal hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 opacity-0"
         onclick="window.App.closeModal('transcript-modal')" role="dialog" aria-modal="true">
      <div id="transcript-modal-content"
           class="modal-content bg-white p-6 rounded-xl shadow-xl max-w-sm w-full"
           onclick="event.stopPropagation()">
        
        <!-- [–ò–ó–ú–ï–ù–ï–ù–û] –ó–∞–≥–æ–ª–æ–≤–æ–∫ "–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è" —É–¥–∞–ª–µ–Ω -->
        <!-- <h3 id="transcript-modal-title" ...></h3> -->

        <!-- [–ù–û–í–û–ï] –ú–µ—Å—Ç–æ –¥–ª—è –ø–ª–µ–µ—Ä–∞ -->
        <div id="transcript-audio-player-placeholder" class="mb-4">
            <!-- –ê—É–¥–∏–æ-–ø–ª–µ–µ—Ä –±—É–¥–µ—Ç –ø–µ—Ä–µ–º–µ—â–µ–Ω —Å—é–¥–∞ —Å –ø–æ–º–æ—â—å—é JS -->
        </div>

        <!-- –°–∫—Ä–æ–ª–ª–∏—Ä—É–µ–º—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
        <div id="transcript-scroll-area" class="max-h-[60vh] overflow-y-auto pr-2 text-gray-700">
            <!-- [–ò–ó–ú–ï–ù–ï–ù–û] –ó–∞–≥–æ–ª–æ–≤–æ–∫ "Der Termin beim Arzt" —É–¥–∞–ª–µ–Ω -->
            <!-- <p class="mb-4 font-bold text-gray-800">Der Termin beim Arzt</p> -->
            <p class="mb-3">Als Thomas an einem Montagmorgen aufwacht, merkt er sofort, dass etwas –Ω–µ stimmt.</p>
            <p class="mb-3">Er ist v√∂llig verschwitzt, sein Kopf tut weh, der R√ºcken ist steif, und er hat Schmerzen im Magen.</p>
            <p class="mb-3">Au√üerdem f√ºhlt er sich m√ºde und schwach.</p>
            <p class="mb-3">Seine Frau schaut ihn besorgt an:</p>
            <p class="mb-3">‚ÄûThomas, du siehst gar nicht gut aus. Ich mache mir Sorgen. Du solltest lieber zum Arzt gehen.‚Äú</p>
            <p class="mb-3">Thomas nickt, aber er hat Angst, dass es etwas Schlimmes sein k√∂nnte.</p>
            <p class="mb-3">‚ÄûVielleicht ist es nur Stress‚Äú, murmelt er.</p>
            <p class="mb-3">‚ÄûVielleicht‚Äú, antwortet sie ruhig, ‚Äûaber deine Gesundheit ist wichtiger.‚Äú</p>
            <p class="mb-3">Er ruft an der Rezeption der Praxis an.</p>
            <p class="mb-3">Die Mitarbeiterin h√∂rt ihm aufmerksam zu, als er seine Beschwerden beschreibt.</p>
            <p class="mb-3">‚ÄûKommen Sie heute Nachmittag vorbei‚Äú, sagt sie. ‚ÄûWenn Sie Schmerzen haben, bekommen Sie nat√ºrlich schnell einen Termin.‚Äú</p>
            <p class="mb-3">Am Nachmittag sitzt Thomas im Wartezimmer.</p>
            <p class="mb-3">Es ist stickig, und er beginnt wieder zu schwitzen.</p>
            <p class="mb-3">Viele Menschen warten. Eine √§ltere Frau hustet, ein Kind h√§lt sich das Auge, und jemand st√∂hnt le–ª–µise vor Schmerzen.</p>
            <p class="mb-3">Thomas versucht ruhig zu atmen, doch der Magen brennt st√§rker, und ihm wird schwindlig.</p>
            <p class="mb-3">Endlich ruft die Arzthelferin: ‚ÄûHerr Berger, bitte!‚Äú</p>
            <p class="mb-3">Dr. Keller, ein freundlicher Hausarzt, begr√º√üt ihn:</p>
            <p class="mb-3">‚ÄûWas fehlt Ihnen?‚Äú</p>
            <p class="mb-3">Thomas erz√§hlt, dass er seit zwei Tagen kaum essen kann, sich schwach f√ºhlt und nachts leidet.</p>
            <p class="mb-3">Der Arzt misst den Blutdruck, h√∂rt den K√∂rper ab und erkl√§rt:</p>
            <p class="mb-3">‚ÄûSie haben wahrscheinlich eine Magenentz√ºndung. Ich verschreibe Ihnen starke Antibiotika. Sie m√ºssen sie regelm√§√üig einnehmen ‚Äì drei Mal am Tag nach dem Essen. Hier ist au√üerdem ein Rezept, damit Sie die Medikamente in der Apotheke bekommen.‚Äú</p>
            <p class="mb-3">Dann f√ºgt er hinzu:</p>
            <p class="mb-3">‚ÄûSie sollen die Antibiotika immer nach dem Essen einnehmen, damit der Magen sie besser vertr√§gt. Und Sie sollen mindestens drei Tage zu Hause bleiben und sich ausruhen.‚Äú</p>
            <p class="mb-3">Thomas fragt:</p>
            <p class="mb-3">‚ÄûWie lange soll ich die Tabletten nehmen?‚Äú</p>
            <p class="mb-3">Dr. Keller antwortet:</p>
            <p class="mb-3">‚ÄûF√ºnf Tage, dann sollte es Ihnen deutlich besser gehen.‚Äú</p>
            <p class="mb-3">‚ÄûDie Antibiotika wirken schnell, aber Sie brauchen Ruhe. Vermeiden Sie Kaffee und Alkohol.‚Äú</p>
            <p class="mb-3">Dann fragt er:</p>
            <p class="mb-3">‚ÄûBrauchen Sie auch ein Attest f√ºr die Arbeit?‚Äú</p>
            <p class="mb-3">Thomas antwortet:</p>
            <p class="mb-3">‚ÄûJa, bitte ‚Äì f√ºr drei Tage.‚Äú</p>
            <p class="mb-3">Dr. Keller notiert es und l√§chelt:</p>
            <p class="mb-3">‚ÄûIn Ordnung. Dann ruhen Sie sich gut aus.‚Äú</p>
            <p class="mb-3">Zu Hause hilft ihm seine Frau, das Fenster zu √∂ffnen, bringt Tee und Suppe ans Bett:</p>
            <p class="mb-3">‚ÄûIch werde dich gut pflegen, bis es dir besser geht.‚Äú</p>
            <p class="mb-3">Nach zwei Tagen geht es ihm schon besser.</p>
            <p class="mb-3">Die Schmerzen sind fast weg, das Brennen im Magen ist vorbei, und er kann wieder schlafen.</p>
            <p class="mb-3">Am dritten Tag f√ºhlt sich Thomas stark und –∏–∑geruht.</p>
            <p class="mb-3">Er beschlie√üt, am n√§chsten Morgen wieder zur Arbeit zu gehen ‚Äì froh, dass alles harmlos war und die Medikamente gut wirken.</p>
        </div>

        <button onclick="window.App.closeModal('transcript-modal')"
                class="w-full mt-6 py-3 px-4 bg-gray-500 text-white font-bold rounded-xl shadow-md hover:bg-gray-600 transition">
          –ó–∞–∫—Ä—ã—Ç—å
        </button>
      </div>
    </div>
    <!-- ===== –ö–û–ù–ï–¶: –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ ===== -->


    <!-- "–ú–ê–ì–ò–Ø" (JavaScript) -->
<script type="module">
        // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –º–æ–¥—É–ª–∏ Firebase (v9+)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        
        // ==========================================================
        // !!! –í–ê–®–ò –ù–ê–°–¢–†–û–ô–ö–ò FIREBASE !!!
        // –ó–ê–ú–ï–ù–ò–¢–ï –≠–¢–ò –ó–ê–ì–õ–£–®–ö–ò –ù–ê –í–ê–®–ò –†–ï–ê–õ–¨–ù–´–ï –î–ê–ù–ù–´–ï
        // ==========================================================
        
        // 1. –í–ê–® –û–ë–™–ï–ö–¢ –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò
        // –ï—Å–ª–∏ —É –≤–∞—Å –Ω–µ—Ç –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö Canvas, –≤—ã –¥–æ–ª–∂–Ω—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–≤–æ—é:
        const MY_FIREBASE_CONFIG = {
apiKey: "AIzaSyAyKS1QWLlIaq_WtpNO0J5RbWAguDd5y-0",
  authDomain: "flash-app-19ddb.firebaseapp.com",
  projectId: "flash-app-19ddb",
  storageBucket: "flash-app-19ddb.firebasestorage.app",
  messagingSenderId: "779096518661",
  appId: "1:779096518661:web:397ba47299418261d56c6c"
        };
        
        // 2. –í–ê–® ID –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø—É—Ç–∏ –∫ –¥–æ–∫—É–º–µ–Ω—Ç—É, –µ—Å–ª–∏ —É –≤–∞—Å —Å–≤–æ—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
        const MY_APP_ID = "flash-app-19ddb"; // <-- –ó–ê–ú–ï–ù–ò–¢–¨ (–ú–æ–∂–µ—Ç –±—ã—Ç—å –ª—é–±—ã–º ID, –µ—Å–ª–∏ –≤—ã –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É Canvas)

        // 3. –ò–º—è –≤–∞—à–µ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏/–ø—É—Ç—å: –ï—Å–ª–∏ –≤—ã –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –ø—É—Ç—å Canvas (artifacts/{appId}/users/{userId}/progress/data),
        //    –£–∫–∞–∂–∏—Ç–µ –∑–¥–µ—Å—å –∏–º—è –≤–∞—à–µ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä: 'user_progress'
        const MY_COLLECTION_NAME = "userProgress"; // <-- –ó–ê–ú–ï–ù–ò–¢–¨ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 'user_progress')

        // –ò—Å–ø–æ–ª—å–∑—É–µ–º Telegram ID –∫–∞–∫ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Ç.–∫. –º—ã –æ—Ç–∫–∞–∑—ã–≤–∞–µ–º—Å—è –æ—Ç Auth Canvas
        const MY_USER_ID_SOURCE = (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe?.user?.id?.toString()) 
                                ? window.Telegram.WebApp.initDataUnsafe.user.id.toString()
                                : "fallback_web_user_" + Math.random().toString(36).substring(7);

        // ==========================================================
        // –ö–û–ù–ï–¶ –í–ê–®–ò–• –ù–ê–°–¢–†–û–ï–ö
        // ==========================================================

        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É—é—Ç –≤–∞—à–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        const firebaseConfig = MY_FIREBASE_CONFIG;
        const appId = MY_APP_ID; 
        const initialAuthToken = null; // –û—Ç–∫–ª—é—á–∞–µ–º Auth Canvas
        
        // ==========================================================
        // 1. –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ò –î–ê–ù–ù–´–ï (Conceptual Data Module)
        // ==========================================================
        
        // –ò–Ω—Ç–µ—Ä–≤–∞–ª—ã –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è –≤ –¥–Ω—è—Ö (–æ—Ç 1 –¥–æ 6 –±–æ–∫—Å–æ–≤)
        const REPETITION_INTERVALS = {
            0: 0,  // Box 0: —Å–µ–≥–æ–¥–Ω—è (–¥–ª—è —Ç–æ–ª—å–∫–æ —á—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å–ª–æ–≤)
            1: 1,  // Box 1: 1 –¥–µ–Ω—å
            2: 3,  // Box 2: 3 –¥–Ω—è
            3: 7,  // Box 3: 7 –¥–Ω–µ–π
            4: 14, // Box 4: 2 –Ω–µ–¥–µ–ª–∏
            5: 30, // Box 5: 1 –º–µ—Å—è—Ü
            6: 60  // Box 6: 2 –º–µ—Å—è—Ü–∞
        };
        
        /**
         * –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –±–∞–∑–æ–≤–æ–≥–æ URL (–∫–æ—Ä–Ω–µ–≤–æ–π –ø–∞–ø–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)
         */
        function getBaseUrl() {
            // Memoized ‚Äî compute once per page load to avoid repeated work
            if (getBaseUrl._cached) return getBaseUrl._cached;
            const path = window.location.pathname.split('/');
            // –£–¥–∞–ª—è–µ–º –∏–º—è —Ñ–∞–π–ª–∞ (index.html)
            path.pop(); 
            // –ü–æ–ª—É—á–∞–µ–º –ø—É—Ç—å –∫ –ø–∞–ø–∫–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, '/subfolder/')
            const folderPath = path.join('/') + (path.length > 1 ? '/' : ''); 
            // –°–æ–±–∏—Ä–∞–µ–º –ø–æ–ª–Ω—ã–π –±–∞–∑–æ–≤—ã–π URL
            const base = window.location.origin + folderPath;
            getBaseUrl._cached = base.endsWith('/') ? base : base + '/';
            return getBaseUrl._cached;
        }

        /**
         * –î–∞–Ω–Ω—ã–µ –Ω–∞–±–æ—Ä–æ–≤ —Å–ª–æ–≤
         */
        const WORD_SETS = [
            // –ù–µ–¥–µ–ª—è 1
            { id: "a1_nouns_1", week: 1, name: "–°—É—â. A1 (–ß–∞—Å—Ç—å 1)", cards: [
                { id: "die_Beschwerde", front: "–∂–∞–ª–æ–±–∞, –Ω–µ–¥–æ–º–æ–≥–∞–Ω–∏–µ", back: "die Beschwerde", hintImage: "images/beschwerden.png" },
                { id: "brennen", front: "–≥–æ—Ä–µ—Ç—å, –∂–µ—á—å", back: "brennen", hintImage: null },
                { id: "das_Geschaeft", front: "–º–∞–≥–∞–∑–∏–Ω", back: "das Gesch√§ft", hintImage: "https://placehold.co/300x200/22C55E/FFFFFF?text=Geschaeft" },
                { id: "der_Park", front: "–ø–∞—Ä–∫", back: "der Park", hintImage: "https://placehold.co/300x200/059669/FFFFFF?text=Park" },
                { id: "die_Bruecke", front: "–º–æ—Å—Ç", back: "die Br√ºcke", hintImage: "https://placehold.co/300x200/4F46E5/FFFFFF?text=Bruecke" },
                { id: "das_Rathaus", front: "–º—ç—Ä–∏—è, —Ä–∞—Ç—É—à–∞", back: "das Rathaus", hintImage: "https://placehold.co/300x200/3B82F6/FFFFFF?text=Rathaus" },
                { id: "die_Kirche", front: "—Ü–µ—Ä–∫–æ–≤—å", back: "die Kirche", hintImage: "https://placehold.co/300x200/A855F7/FFFFFF?text=Kirche" },
                { id: "der_Supermarkt", front: "—Å—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç", back: "der Supermarkt", hintImage: "https://placehold.co/300x200/EC4899/FFFFFF?text=Supermarkt" },
                { id: "das_Krankenhaus", front: "–±–æ–ª—å–Ω–∏—Ü–∞", back: "das Krankenhaus", hintImage: "https://placehold.co/300x200/F97316/FFFFFF?text=Krankenhaus" },
                { id: "die_Apotheke", front: "–∞–ø—Ç–µ–∫–∞", back: "die Apotheke", hintImage: "https://placehold.co/300x200/10B981/FFFFFF?text=Apotheke" },
                { id: "das_Museum", front: "–º—É–∑–µ–π", back: "das Museum", hintImage: "https://placehold.co/300x200/6B7280/FFFFFF?text=Museum" },
                { id: "der_Platz", front: "–ø–ª–æ—â–∞–¥—å", back: "der Platz", hintImage: "https://placehold.co/300x200/EF4444/FFFFFF?text=Platz" },
                { id: "die_Haltestelle", front: "–æ—Å—Ç–∞–Ω–æ–≤–∫–∞", back: "die Haltestelle", hintImage: "https://placehold.co/300x200/374151/FFFFFF?text=Haltestelle" },
                { id: "das_Cafe", front: "–∫–∞—Ñ–µ", back: "das Caf√©", hintImage: "https://placehold.co/300x200/FBBF24/FFFFFF?text=Cafe" },
                { id: "der_Flughafen", front: "–∞—ç—Ä–æ–ø–æ—Ä—Ç", back: "der Flughafen", hintImage: "https://placehold.co/300x200/6366F1/FFFFFF?text=Flughafen" }
            ]},
            // –ù–µ–¥–µ–ª—è 2
            { id: "a1_nouns_2", week: 2, name: "–°—É—â. A1 (–ß–∞—Å—Ç—å 2)", cards: [
                { id: "das_Auto", front: "–º–∞—à–∏–Ω–∞", back: "das Auto" },
                { id: "das_Haus", front: "–¥–æ–º", back: "das Haus" }
            ]},
            // –ù–µ–¥–µ–ª—è 3 (–ü–æ–∫–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
            { id: "a1_nouns_3", week: 3, name: "–°—É—â. A1 (–ß–∞—Å—Ç—å 3)", cards: [
                { id: "der_Mann", front: "–º—É–∂—á–∏–Ω–∞", back: "der Mann" },
                { id: "die_Stadt", front: "–≥–æ—Ä–æ–¥", back: "die Stadt" }
            ]},
            // –ù–µ–¥–µ–ª—è 4 (–ù–æ–≤—ã–π –Ω–∞–±–æ—Ä)
            { id: "a1_verbs_1", week: 4, name: "–ì–ª–∞–≥–æ–ª—ã A1 (–ß–∞—Å—Ç—å 1)", cards: [
                { id: "machen", front: "–¥–µ–ª–∞—Ç—å", back: "machen" },
                { id: "gehen", front: "–∏–¥—Ç–∏", back: "gehen" }
            ]},
        ];

        /**
         * –ö–∞—Ä—Ç–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–ª—è –∫–∞–∂–¥–æ–π –Ω–µ–¥–µ–ª–∏. 
         * –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ 'description' –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ "–ü–æ–¥—Ä–æ–±–Ω–µ–µ".
         */
        const WEEKLY_CONTENT_MAP = {
            1: {
                associationVideo: "https://www.youtube.com/embed/jNQXAC9IVRw?autoplay=0&controls=1&showinfo=0&rel=0",
                associationTitle: "–ê—Å—Å–æ—Ü–∏–∞—Ü–∏–∏ –¥–ª—è –∑–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è —Å–ª–æ–≤ –ø–æ —Ç–µ–º–µ –≠–º–æ—Ü–∏–∏",
                storyLink: "text1.html",
                wordSetId: "a1_nouns_1",
                carouselId: "week1", 
                description: "–ß—É–≤—Å—Ç–≤–∞, —ç–º–æ—Ü–∏–∏, –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ, —Å—Ç—Ä–∞—Ö, –∑–ª–æ—Å—Ç—å, —Å—Ç—ã–¥, —Å—Ç—Ä–µ—Å—Å, –º–æ—Ç–∏–≤–∞—Ü–∏—è, –ø—Å–∏—Ö–∏—á–µ—Å–∫–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è",
                dialoguesTitle: "–î–∏–∞–ª–æ–≥–∏: –≠–º–æ—Ü–∏–∏",
                dialoguesVideo: "https://www.youtube.com/embed/R-p9lq-E_OQ?autoplay=0&controls=1&showinfo=0&rel=0",
                dialoguesText: "<b>–î–∏–∞–ª–æ–≥ 1:</b><br>- Wie f√ºhlst du dich?<br>- Ich bin gl√ºcklich!<br><br><b>–ü–æ–ª–µ–∑–Ω—ã–µ —Ñ—Ä–∞–∑—ã:</b><br>Ich bin traurig.<br>Das macht mich w√ºtend."
            },
            2: {
                associationVideo: "https://www.youtube.com/embed/2-nFz1WJ3vM?autoplay=0&controls=1&showinfo=0&rel=0",
                associationTitle: "–ê—Å—Å–æ—Ü–∏–∞—Ü–∏–∏ –¥–ª—è —Ç–µ–º—ã –û–±—â–µ–Ω–∏–µ",
                storyLink: "https://your-domain.com/story/week2",
                wordSetId: "a1_nouns_2",
                carouselId: "week1", 
                description: "–î—Ä—É–∑—å—è, –∑–Ω–∞–∫–æ–º—ã–µ, –∫–æ–ª–ª–µ–≥–∏, —Ä–æ–ª–∏, –≤–µ–∂–ª–∏–≤–æ—Å—Ç—å, –ø–æ–¥–¥–µ—Ä–∂–∫–∞, –∫–æ–Ω—Ñ–ª–∏–∫—Ç, —Å–æ–≥–ª–∞—Å–∏–µ –∏ –Ω–µ—Å–æ–≥–ª–∞—Å–∏–µ",
                dialoguesTitle: "–î–∏–∞–ª–æ–≥–∏: –û–±—â–µ–Ω–∏–µ",
                dialoguesVideo: "https://www.youtube.com/embed/example2?autoplay=0&controls=1&showinfo=0&rel=0",
                dialoguesText: "<b>–î–∏–∞–ª–æ–≥ 2:</b><br>- Darf ich dir helfen?<br>- Ja, bitte!<br><br><b>–ü–æ–ª–µ–∑–Ω—ã–µ —Ñ—Ä–∞–∑—ã:</b><br>Entschuldigung.<br>Das stimmt."
            },
            3: {
                associationVideo: "https://www.youtube.com/embed/M0TfQvX5X1o?autoplay=0&controls=1&showinfo=0&rel=0",
                associationTitle: "–ê—Å—Å–æ—Ü–∏–∞—Ü–∏–∏ –¥–ª—è —Ç–µ–º—ã –ñ–∏–ª—å—ë",
                storyLink: "https://your-domain.com/story/week3",
                wordSetId: "a1_nouns_3",
                carouselId: "week1", 
                description: "–ñ–∏–ª—å—ë, –∫–æ–º–Ω–∞—Ç—ã, –º–µ–±–µ–ª—å, –±—ã—Ç, –¥–æ–º–∞—à–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç—ã",
                dialoguesTitle: "–î–∏–∞–ª–æ–≥–∏: –ñ–∏–ª—å—ë",
                dialoguesVideo: "https://www.youtube.com/embed/example3?autoplay=0&controls=1&showinfo=0&rel=0",
                dialoguesText: "<b>–î–∏–∞–ª–æ–≥ 3:</b><br>- Wo ist die K√ºche?<br>- Die K√ºche ist hier.<br><br><b>–ü–æ–ª–µ–∑–Ω—ã–µ —Ñ—Ä–∞–∑—ã:</b><br>Das Zimmer ist gro√ü.<br>Ich brauche einen Tisch."
            },
            4: {
                associationVideo: "https://www.youtube.com/embed/example4?autoplay=0&controls=1&showinfo=0&rel=0",
                associationTitle: "–ê—Å—Å–æ—Ü–∏–∞—Ü–∏–∏ –¥–ª—è —Ç–µ–º—ã –ö–∞—Ä—å–µ—Ä–∞",
                storyLink: "https://your-domain.com/story/week4",
                wordSetId: "a1_verbs_1", 
                carouselId: "week1",
                description: "–ü—Ä–æ—Ñ–µ—Å—Å–∏–∏, –¥–æ–ª–∂–Ω–æ—Å—Ç–∏, –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏, –Ω–∞–≤—ã–∫–∏, –ø–æ–∏—Å–∫ —Ä–∞–±–æ—Ç—ã, —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–µ, –∫–æ–Ω—Ç—Ä–∞–∫—Ç, –∫–∞—Ä—å–µ—Ä–Ω—ã–π —Ä–æ—Å—Ç",
                dialoguesTitle: "–î–∏–∞–ª–æ–≥–∏: –ö–∞—Ä—å–µ—Ä–∞",
                dialoguesVideo: "https://www.youtube.com/embed/example4_dialog?autoplay=0&controls=1&showinfo=0&rel=0",
                dialoguesText: "<b>–î–∏–∞–ª–æ–≥ 4:</b><br>- Was sind Sie von Beruf?<br>- Ich bin Lehrer.<br><br><b>–ü–æ–ª–µ–∑–Ω—ã–µ —Ñ—Ä–∞–∑—ã:</b><br>Ich suche Arbeit.<br>Wann kann ich anfangen?"
            },
            5: {
                associationVideo: "https://www.youtube.com/embed/example5?autoplay=0&controls=1&showinfo=0&rel=0",
                associationTitle: "–ê—Å—Å–æ—Ü–∏–∞—Ü–∏–∏ –¥–ª—è —Ç–µ–º—ã –ë–æ–ª–µ–∑–Ω–∏",
                storyLink: "https://your-domain.com/story/week5",
                wordSetId: "a1_health",
                carouselId: "week1",
                description: "–°–∏–º–ø—Ç–æ–º—ã, –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è, –æ–±—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è, –∞–Ω–∞–ª–∏–∑—ã, –ª–µ—á–µ–Ω–∏–µ, –≤—Ä–∞—á–∏, –ª–µ–∫–∞—Ä—Å—Ç–≤–∞, —Ä–µ—Ü–µ–ø—Ç—ã",
                dialoguesTitle: "–î–∏–∞–ª–æ–≥–∏: –ë–æ–ª–µ–∑–Ω–∏",
                dialoguesVideo: "https://www.youtube.com/embed/example5_dialog?autoplay=0&controls=1&showinfo=0&rel=0",
                dialoguesText: "<b>–î–∏–∞–ª–æ–≥ 5:</b><br>- Mir geht es nicht gut.<br>- Was fehlt Ihnen?<br><br><b>–ü–æ–ª–µ–∑–Ω—ã–µ —Ñ—Ä–∞–∑—ã:</b><br>Ich habe Fieber.<br>Ich brauche ein Rezept."
            },
            6: {
                associationVideo: "https://www.youtube.com/embed/example6?autoplay=0&controls=1&showinfo=0&rel=0",
                associationTitle: "–ê—Å—Å–æ—Ü–∏–∞—Ü–∏–∏ –¥–ª—è —Ç–µ–º—ã –£—á—ë–±–∞",
                storyLink: "https://your-domain.com/story/week6",
                wordSetId: "a1_study",
                carouselId: "week1",
                description: "–£—á–µ–±–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã, —à–∫–æ–ª–∞, —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç, –∫—É—Ä—Å—ã, —ç–∫–∑–∞–º–µ–Ω—ã, –æ—Ü–µ–Ω–∏–≤–∞–Ω–∏–µ",
                dialoguesTitle: "–î–∏–∞–ª–æ–≥–∏: –£—á—ë–±–∞",
                dialoguesVideo: "https://www.youtube.com/embed/example6_dialog?autoplay=0&controls=1&showinfo=0&rel=0",
                dialoguesText: "<b>–î–∏–∞–ª–æ–≥ 6:</b><br>- Wann ist die Pr√ºfung?<br>- Am Montag.<br><br><b>–ü–æ–ª–µ–∑–Ω—ã–µ —Ñ—Ä–∞–∑—ã:</b><br>Ich lerne Deutsch.<br>Hast du das verstanden?"
            },
            7: {
                associationVideo: "https://www.youtube.com/embed/example7?autoplay=0&controls=1&showinfo=0&rel=0",
                associationTitle: "–ê—Å—Å–æ—Ü–∏–∞—Ü–∏–∏ –¥–ª—è —Ç–µ–º—ã –¢–µ–ª–æ",
                storyLink: "https://your-domain.com/story/week7",
                wordSetId: "a1_body",
                carouselId: "week1",
                description: "–ß–∞—Å—Ç–∏ —Ç–µ–ª–∞, –æ—Ä–≥–∞–Ω—ã, –¥–≤–∏–∂–µ–Ω–∏—è, —Ñ–∏–∑–∏–æ–ª–æ–≥–∏—è",
                dialoguesTitle: "–î–∏–∞–ª–æ–≥–∏: –¢–µ–ª–æ",
                dialoguesVideo: "https://www.youtube.com/embed/example7_dialog?autoplay=0&controls=1&showinfo=0&rel=0",
                dialoguesText: "<b>–î–∏–∞–ª–æ–≥ 7:</b><br>- Mein Kopf tut weh.<br>- Du sollst Pause machen.<br><br><b>–ü–æ–ª–µ–∑–Ω—ã–µ —Ñ—Ä–∞–∑—ã:</b><br>Das ist meine Hand.<br>Ich bewege den Arm."
            },
            8: {
                associationVideo: "https://www.youtube.com/embed/example8?autoplay=0&controls=1&showinfo=0&rel=0",
                associationTitle: "–ê—Å—Å–æ—Ü–∏–∞—Ü–∏–∏ –¥–ª—è —Ç–µ–º—ã –ü—Ä–∏—Ä–æ–¥–∞ –∏ –ø–æ–≥–æ–¥–∞",
                storyLink: "https://your-domain.com/story/week8",
                wordSetId: "a1_nature",
                carouselId: "week1",
                description: "–õ–∞–Ω–¥—à–∞—Ñ—Ç—ã, —Ä–µ–∫–∏, –º–æ—Ä—è, –∫–ª–∏–º–∞—Ç, –ø—Ä–∏—Ä–æ–¥–Ω—ã–µ —è–≤–ª–µ–Ω–∏—è, –≤—Ä–µ–º—è –≥–æ–¥–∞, –ø–æ–≥–æ–¥–∞",
                dialoguesTitle: "–î–∏–∞–ª–æ–≥–∏: –ü—Ä–∏—Ä–æ–¥–∞ –∏ –ø–æ–≥–æ–¥–∞",
                dialoguesVideo: "https://www.youtube.com/embed/example8_dialog?autoplay=0&controls=1&showinfo=0&rel=0",
                dialoguesText: "<b>–î–∏–∞–ª–æ–≥ 8:</b><br>- Wie ist das Wetter?<br>- Es regnet.<br><br><b>–ü–æ–ª–µ–∑–Ω—ã–µ —Ñ—Ä–∞–∑—ã:</b><br>Die Sonne scheint.<br>Es ist kalt."
            },
            9: {
                associationVideo: "https://www.youtube.com/embed/example9?autoplay=0&controls=1&showinfo=0&rel=0",
                associationTitle: "–ê—Å—Å–æ—Ü–∏–∞—Ü–∏–∏ –¥–ª—è —Ç–µ–º—ã –õ–∏—á–Ω–æ—Å—Ç—å, —Ö–∞—Ä–∞–∫—Ç–µ—Ä",
                storyLink: "https://your-domain.com/story/week9",
                wordSetId: "a1_personality",
                carouselId: "week1",
                description: "–ß–µ—Ä—Ç—ã —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞, –ø–æ–≤–µ–¥–µ–Ω–∏–µ, –ø—Ä–∏–≤—ã—á–∫–∏, –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –ª–∏—á–Ω–æ—Å—Ç–∏",
                dialoguesTitle: "–î–∏–∞–ª–æ–≥–∏: –õ–∏—á–Ω–æ—Å—Ç—å, —Ö–∞—Ä–∞–∫—Ç–µ—Ä",
                dialoguesVideo: "https://www.youtube.com/embed/example9_dialog?autoplay=0&controls=1&showinfo=0&rel=0",
                dialoguesText: "<b>–î–∏–∞–ª–æ–≥ 9:</b><br>- Sie ist sehr freundlich.<br>- Ja, das stimmt!<br><br><b>–ü–æ–ª–µ–∑–Ω—ã–µ —Ñ—Ä–∞–∑—ã:</b><br>Er ist lustig.<br>Sie ist flei√üig."
            },
            10: {
                associationVideo: "https://www.youtube.com/embed/example10?autoplay=0&controls=1&showinfo=0&rel=0",
                associationTitle: "–ê—Å—Å–æ—Ü–∏–∞—Ü–∏–∏ –¥–ª—è —Ç–µ–º—ã –í–Ω–µ—à–Ω–æ—Å—Ç—å",
                storyLink: "https://your-domain.com/story/week10",
                wordSetId: "a1_appearance",
                carouselId: "week1",
                description: "–í–Ω–µ—à–Ω–æ—Å—Ç—å, —Ä–æ—Å—Ç, –≤–µ—Å, –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ç–µ–ª–∞, —Å—Ç–∏–ª—å",
                dialoguesTitle: "–î–∏–∞–ª–æ–≥–∏: –í–Ω–µ—à–Ω–æ—Å—Ç—å",
                dialoguesVideo: "https://www.youtube.com/embed/example10_dialog?autoplay=0&controls=1&showinfo=0&rel=0",
                dialoguesText: "<b>–î–∏–∞–ª–æ–≥ 10:</b><br>- Wie siehst du aus?<br>- Ich bin gro√ü und schlank.<br><br><b>–ü–æ–ª–µ–∑–Ω—ã–µ —Ñ—Ä–∞–∑—ã:</b><br>Er hat blaue Augen.<br>Sie tr√§gt eine Brille."
            }
        };

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–∞—Å—Å–∏–≤—ã –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
        const ALL_WEEKS = Object.keys(WEEKLY_CONTENT_MAP).map(Number).sort((a, b) => a - b);
        
        // –ú–∞–ø–ø–∏–Ω–≥ –Ω–µ–¥–µ–ª—å –Ω–∞ —Ç–µ–º—ã –∏–∑ topics.json
        const WEEK_TO_TOPIC_MAP = {
            1: "emotions",          // –≠–º–æ—Ü–∏–∏
            2: "social_relations",  // –û–±—â–µ–Ω–∏–µ
            3: "home",              // –ñ–∏–ª—å—ë
            4: "work",              // –ö–∞—Ä—å–µ—Ä–∞
            5: "health",            // –ë–æ–ª–µ–∑–Ω–∏
            6: "study",             // –£—á—ë–±–∞
            7: "body",              // –¢–µ–ª–æ
            8: "nature",            // –ü—Ä–∏—Ä–æ–¥–∞ –∏ –ø–æ–≥–æ–¥–∞
            9: "personality",       // –õ–∏—á–Ω–æ—Å—Ç—å, —Ö–∞—Ä–∞–∫—Ç–µ—Ä
            10: "appearance"        // –í–Ω–µ—à–Ω–æ—Å—Ç—å
        };
        
        // –¢–µ–º—ã, –¥–ª—è –∫–æ—Ç–æ—Ä—ã—Ö —Å—É—â–µ—Å—Ç–≤—É—é—Ç —Ñ–∞–π–ª—ã word_topic{N}.json (deprecated, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
        const AVAILABLE_WORD_TOPICS = [1]; // –î–æ–±–∞–≤–ª—è–π—Ç–µ —Å—é–¥–∞ –Ω–æ–º–µ—Ä–∞ —Ç–µ–º –ø–æ –º–µ—Ä–µ —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤


        // ===== –ù–ê–ß–ê–õ–û –ò–ù–¢–ï–ì–†–ê–¶–ò–ò text1.html (JavaScript) =====
        
        // [–ò–ó–ú–ï–ù–ï–ù–û] 
        // –†–∞–Ω—å—à–µ –∑–¥–µ—Å—å –±—ã–ª–∏ –∂–µ—Å—Ç–∫–æ –∑–∞–¥–∞–Ω—ã QUIZ_DATA –∏ ANALYSIS_SLIDES.
        // –¢–µ–ø–µ—Ä—å –æ–Ω–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—Ç—Å—è –∫–∞–∫ –ø—É—Å—Ç—ã–µ –∏ –±—É–¥—É—Ç –∑–∞–ø–æ–ª–Ω—è—Ç—å—Å—è –∏–∑ JSON.
        window.StoryApp = {
          quizData: [], // [–ò–ó–ú–ï–ù–ï–ù–û] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞–∫ –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤
          currentIndex: 0,
          userAnswers: [],
          analysisSlides: [], // [–ò–ó–ú–ï–ù–ï–ù–û] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞–∫ –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤
          currentAnalysisIndex: 0,
          
          // [–ù–û–í–û–ï] –•—Ä–∞–Ω–∏–ª–∏—â–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
          audioPlayHandler: null,
          audioProgressHandler: null,

          init() {
            this.initAudioPlayback();
            this.initAnalysisCarousel(); // –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Ç–µ–ø–µ—Ä—å –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ quizData
            this.initStickyAudioBar();
            // ‚Üê –î–æ–±–∞–≤—å—Ç–µ —ç—Ç—É —Å—Ç—Ä–æ–∫—É:
            if (window.Telegram?.WebApp?.BackButton) {
                window.Telegram.WebApp.BackButton.show();
             }   
          },

          /* ====== –ê–£–î–ò–û ====== */
          initAudioPlayback() {
            const audio = document.getElementById('story-audio-player');
            const playBtn = document.getElementById('audio-main-button');
            const progress = document.getElementById('audio-progress');
            const curTimeEl = document.getElementById('audio-current-time');
            const durEl = document.getElementById('audio-duration');

            if (!audio) return;

            // [–ò–ó–ú–ï–ù–ï–ù–û] –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫, –ø—Ä–µ–∂–¥–µ —á–µ–º –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π
            if (playBtn) {
              // 1. –£–¥–∞–ª—è–µ–º *—Å—Ç–∞—Ä—ã–π* –æ–±—Ä–∞–±–æ—Ç—á–∏–∫, –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
              if (this.audioPlayHandler) {
                playBtn.removeEventListener('click', this.audioPlayHandler);
              }
              // 2. –°–æ–∑–¥–∞–µ–º –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º *–Ω–æ–≤—ã–π* –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
              this.audioPlayHandler = (e) => {
                e.stopPropagation();
                this.toggleAudioPlay();
              };
              // 3. –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
              playBtn.addEventListener('click', this.audioPlayHandler);
            }

            audio.addEventListener('loadedmetadata', () => {
              if (durEl && isFinite(audio.duration)) {
                durEl.textContent = this.formatTime(audio.duration);
              }
            });

            audio.addEventListener('timeupdate', () => {
              if (progress && isFinite(audio.duration) && audio.duration > 0) {
                progress.value = (audio.currentTime / audio.duration) * 100;
              }
              if (curTimeEl) {
                curTimeEl.textContent = this.formatTime(audio.currentTime);
              }
            });

            // [–ò–ó–ú–ï–ù–ï–ù–û] –¢–∞ –∂–µ –ª–æ–≥–∏–∫–∞ –¥–ª—è –ø–æ–ª–∑—É–Ω–∫–∞
            if (progress) {
              // 1. –£–¥–∞–ª—è–µ–º *—Å—Ç–∞—Ä—ã–π* –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
              if (this.audioProgressHandler) {
                progress.removeEventListener('input', this.audioProgressHandler);
              }
              // 2. –°–æ–∑–¥–∞–µ–º –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º *–Ω–æ–≤—ã–π*
              this.audioProgressHandler = (e) => {
                if (!isFinite(audio.duration) || audio.duration <= 0) return;
                const val = Number(e.target.value) || 0;
                audio.currentTime = (val / 100) * audio.duration;
              };
              // 3. –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π
              progress.addEventListener('input', this.audioProgressHandler);
            }

            audio.onplay = () => this.updateAudioUi(true);
            audio.onpause = () => this.updateAudioUi(false);
            audio.onended = () => this.updateAudioUi(false);
          },

          formatTime(sec) {
            const s = Math.floor(sec % 60);
            const m = Math.floor(sec / 60);
            return `${m}:${s.toString().padStart(2, '0')}`;
          },

          toggleAudioPlay() {
            const audio = document.getElementById('story-audio-player');
            if (!audio) return;
            if (audio.paused) audio.play(); else audio.pause();
          },

          updateAudioUi(isPlaying) {
            const playIcon = document.getElementById('play-icon');
            const pauseIcon = document.getElementById('pause-icon');
            if (!playIcon || !pauseIcon) return;

            if (isPlaying) {
              playIcon.classList.add('hidden');
              pauseIcon.classList.remove('hidden');
            } else {
              playIcon.classList.remove('hidden');
              pauseIcon.classList.add('hidden');
            }
          },

          /* ====== FIXED AUDIO BAR ====== */
        initStickyAudioBar() {
            const wrapper     = document.getElementById('audio-bar-wrapper');
            const bar         = document.getElementById('audio-bar');
            const placeholder = document.getElementById('audio-bar-placeholder');
            if (!wrapper || !bar || !placeholder) return;

            // –í—ã—á–∏—Å–ª—è–µ–º –≤—ã—Å–æ—Ç—É —à–∞–ø–∫–∏ Telegram
            const getTelegramHeaderHeight = () => {
                if (window.Telegram?.WebApp?.viewportStableHeight) {
                    return window.innerHeight - window.Telegram.WebApp.viewportStableHeight;
                }
                return 56; // –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
            };

            let barHeight = 0;
            const headerHeight = getTelegramHeaderHeight();

            const checkPosition = () => {
                if (!wrapper || !bar || !placeholder) return; // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ null
                
                const wrapperRect = wrapper.getBoundingClientRect();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–ª–µ–µ—Ä –Ω–µ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
                const isInModal = bar.closest('#transcript-modal');
                if (isInModal) {
                    if (bar.classList.contains('fixed-audio-bar')) {
                        bar.classList.remove('fixed-audio-bar');
                        placeholder.style.height = '0px';
                        bar.style.top = '';
                    }
                    return; // –ù–µ –¥–µ–ª–∞–µ–º "–ª–∏–ø–∫–∏–º" –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
                }


                // –ö–æ–≥–¥–∞ –≤–µ—Ä—Ö–Ω—è—è –≥—Ä–∞–Ω–∏—Ü–∞ –æ–±—ë—Ä—Ç–∫–∏ –¥–æ—à–ª–∞ –¥–æ –Ω–∏–∂–Ω–µ–π –≥—Ä–∞–Ω–∏—Ü—ã —à–∞–ø–∫–∏ TG
                if (wrapperRect.top <= headerHeight) {
                    if (!bar.classList.contains('fixed-audio-bar')) {
                        barHeight = bar.offsetHeight;
                        bar.classList.add('fixed-audio-bar');
                        placeholder.style.height = barHeight + 'px';
                        bar.style.top = headerHeight + 'px';
                    }
                } else {
                    if (bar.classList.contains('fixed-audio-bar')) {
                        bar.classList.remove('fixed-audio-bar');
                        placeholder.style.height = '0px';
                        bar.style.top = '';
                    }
                }
            };

            // Throttle scroll/resize using requestAnimationFrame to reduce work
            let ticking = false;
            const requestCheck = () => {
                if (!ticking) {
                    ticking = true;
                    requestAnimationFrame(() => {
                        checkPosition();
                        ticking = false;
                    });
                }
            };
            window.addEventListener('scroll', requestCheck, { passive: true });
            window.addEventListener('resize', requestCheck);
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ä–∞–∑—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ —É–∂–µ –ø—Ä–æ—Å–∫—Ä–æ–ª–ª–µ–Ω–æ)
            setTimeout(checkPosition, 100);
        },

          /* ====== –ê–ö–ö–û–†–î–ï–û–ù–´ ====== */
          toggleAccordion(contentId) {
            const content = document.getElementById(contentId);
            const arrow = document.getElementById(contentId.replace('-content', '-arrow'));
            if (!content || !arrow) return;

            const isOpen = content.classList.contains('is-open');
            if (isOpen) {
              content.classList.remove('is-open');
              arrow.innerHTML = '&darr;';
              setTimeout(() => content.classList.add('hidden'), 400);
            } else {
              content.classList.remove('hidden');
              setTimeout(() => content.classList.add('is-open'), 10);
              arrow.innerHTML = '&uarr;';
            }
          },

          /* ====== –ö–ê–†–£–°–ï–õ–¨ –†–ê–ó–ë–û–†–ê ====== */
          initAnalysisCarousel() {
            // [–ò–ó–ú–ï–ù–ï–ù–û] –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ –≤ this.analysisSlides
            if (!this.analysisSlides || !this.analysisSlides.length) {
                const slideContainer = document.getElementById('analysis-slide');
                if (slideContainer) slideContainer.innerHTML = '<p class="text-gray-500 text-center">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–∞–∑–±–æ—Ä–∞.</p>';
                return;
            }
            this.currentAnalysisIndex = 0;
            this.renderAnalysisSlide();
          },

          renderAnalysisSlide() {
            const slideContainer = document.getElementById('analysis-slide');
            const progressEl = document.getElementById('analysis-progress');
            if (!slideContainer) return;

            const slide = this.analysisSlides[this.currentAnalysisIndex];
            if (!slide) return;

            slideContainer.innerHTML = `
              <p class="mb-1 text-xs font-semibold uppercase tracking-wide text-indigo-600">
                ${slide.title || '–†–∞–∑–±–æ—Ä'}
              </p>
              <p class="mb-2 font-semibold text-gray-800">${slide.original}</p>
              <p class="mb-3 text-gray-700">${slide.translation}</p>
              ${
                slide.notes && slide.notes.length
                  ? `<ul class="list-disc list-inside text-sm text-gray-600 space-y-1">
                       ${slide.notes.map(n => `<li>${n}</li>`).join('')}
                     </ul>`
                  : ''
              }
            `;

            if (progressEl) {
              const total = this.analysisSlides.length;
              const current = this.currentAnalysisIndex + 1;
              progressEl.textContent = `${current} / ${total}`;
            }
          },

          nextAnalysisSlide() {
            if (!this.analysisSlides || !this.analysisSlides.length) return;
            this.currentAnalysisIndex =
              (this.currentAnalysisIndex + 1) % this.analysisSlides.length;
            this.renderAnalysisSlide();
          },

          prevAnalysisSlide() {
            if (!this.analysisSlides || !this.analysisSlides.length) return;
            this.currentAnalysisIndex =
              (this.currentAnalysisIndex - 1 + this.analysisSlides.length) % this.analysisSlides.length;
            this.renderAnalysisSlide();
          },

          /* ====== –ö–í–ò–ó ====== */
          startStoryQuiz() {
            // [–ò–ó–ú–ï–ù–ï–ù–û] –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ –≤ this.quizData
            if (!this.quizData || !this.quizData.length) {
                console.error("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–≤–∏–∑–∞!");
                // –ú–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å alert –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –º–æ–¥–∞–ª–∫—É
                return;
            }
            this.currentIndex = 0;
            this.userAnswers = [];
            this.renderCurrentQuestion();
            this.updateProgress();
            this.resetControls();
            window.App.openModal('quiz-modal'); // [–ò–ó–ú–ï–ù–ï–ù–û] –ò—Å–ø–æ–ª—å–∑—É–µ–º App.openModal
          },

          renderCurrentQuestion() {
            const q = this.quizData[this.currentIndex];
            if (!q) return;

            const questionEl = document.getElementById('quiz-question');
            const optionsContainer = document.getElementById('quiz-options');
            const feedbackEl = document.getElementById('quiz-feedback');
            const questionBox = document.getElementById('question-box'); 

            if (!questionEl || !optionsContainer || !feedbackEl || !questionBox) return; 

            // --- –ò–ó–ú–ï–ù–ï–ù–û: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –ø—Ä–∏ —Ä–µ–Ω–¥–µ—Ä–µ –≤–æ–ø—Ä–æ—Å–∞ ---
            questionBox.classList.remove('hidden');
            optionsContainer.classList.remove('hidden');
            // --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–Ø ---

            questionEl.textContent = q.question;
            optionsContainer.innerHTML = '';

            q.options.forEach((opt, idx) => {
              const btn = document.createElement('button');
              btn.className =
                'quiz-option w-full py-2 px-3 border border-gray-300 rounded-lg text-sm text-left bg-white text-gray-800 font-medium hover:bg-indigo-100';
              btn.textContent = opt;
              btn.onclick = () => this.selectOption(idx);
              optionsContainer.appendChild(btn);
            });

            feedbackEl.classList.add('hidden');
            feedbackEl.textContent = '';

            const endControls = document.getElementById('quiz-end-controls');
            if (endControls) endControls.classList.add('hidden');

            const nextBtn = document.getElementById('quiz-next-button');
            if (nextBtn) {
              nextBtn.disabled = true;
              nextBtn.classList.add('next-button-disabled');
              nextBtn.classList.remove('next-button-active', 'hidden');
            }
          },

          selectOption(idx) {
            const q = this.quizData[this.currentIndex];
            if (!q) return;

            const chosen = q.options[idx];
            this.userAnswers[this.currentIndex] = chosen;

            document.querySelectorAll('#quiz-options .quiz-option').forEach(btn => {
              btn.classList.remove('quiz-selected');
              if (btn.textContent.trim() === chosen.trim()) {
                btn.classList.add('quiz-selected');
              }
            });

            const nextBtn = document.getElementById('quiz-next-button');
            if (nextBtn) {
              nextBtn.disabled = false;
              nextBtn.classList.remove('next-button-disabled');
              nextBtn.classList.add('next-button-active');
            }
          },

          nextQuizQuestion() {
            if (this.currentIndex < this.quizData.length - 1) {
              this.currentIndex++;
              this.renderCurrentQuestion();
              this.updateProgress();
            } else {
              this.finishQuiz();
            }
          },

          updateProgress() {
            const progressEl = document.getElementById('quiz-progress');
            if (!progressEl) return;

            // --- –ò–ó–ú–ï–ù–ï–ù–û: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å ---
            progressEl.classList.remove('hidden');
            // --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–Ø ---

            const total = this.quizData.length;
            const current = this.currentIndex + 1;
            progressEl.textContent = `–í–æ–ø—Ä–æ—Å ${current} –∏–∑ ${total}`;
          },

          resetControls() {
            const endControls = document.getElementById('quiz-end-controls');
            if (endControls) endControls.classList.add('hidden');

            const nextBtn = document.getElementById('quiz-next-button');
            if (nextBtn) {
              nextBtn.disabled = true;
              nextBtn.classList.add('next-button-disabled');
              nextBtn.classList.remove('next-button-active', 'hidden');
            }

            const feedbackEl = document.getElementById('quiz-feedback');
            if (feedbackEl) {
              feedbackEl.classList.add('hidden');
              feedbackEl.textContent = '';
            }
          },

          finishQuiz() {
            const total = this.quizData.length;
            let correct = 0;

            this.quizData.forEach((q, i) => {
              if (this.userAnswers[i] === q.answer) correct++;
            });

            const feedbackEl = document.getElementById('quiz-feedback');
            if (feedbackEl) {
              feedbackEl.textContent = `–í—ã –æ—Ç–≤–µ—Ç–∏–ª–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞ ${correct} –∏–∑ ${total} –≤–æ–ø—Ä–æ—Å–æ–≤.`;
              feedbackEl.classList.remove('hidden');
            }

            const nextBtn = document.getElementById('quiz-next-button');
            if (nextBtn) nextBtn.classList.add('hidden');

            const endControls = document.getElementById('quiz-end-controls');
            if (endControls) endControls.classList.remove('hidden');

            // --- –ò–ó–ú–ï–ù–ï–ù–û: –°–∫—Ä—ã–≤–∞–µ–º –≤–æ–ø—Ä–æ—Å, –æ–ø—Ü–∏–∏ –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ ---
            const questionBox = document.getElementById('question-box');
            if (questionBox) questionBox.classList.add('hidden');
            
            const optionsContainer = document.getElementById('quiz-options');
            if (optionsContainer) optionsContainer.classList.add('hidden');
            
            const progressEl = document.getElementById('quiz-progress');
            if (progressEl) progressEl.classList.add('hidden');
            // --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–Ø ---
          },

          showCorrectAnswers() {
            const optionsContainer = document.getElementById('quiz-options');
            const feedbackEl = document.getElementById('quiz-feedback');
            if (!optionsContainer) return;

            // --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–µ—Ä–µ–¥ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ–º ---
            optionsContainer.classList.remove('hidden');
            // --- –ö–û–ù–ï–¶ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø ---

            optionsContainer.innerHTML = '';

            this.quizData.forEach((q, i) => {
              const block = document.createElement('div');
              block.className = 'mb-3 p-3 bg-indigo-50 rounded-lg';
              block.innerHTML = `
                <p class="font-semibold mb-1">${i + 1}. ${q.question}</p>
                <p class="text-green-700 font-bold">–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: ${q.answer}</p>
              `;
              optionsContainer.appendChild(block);
            });

            if (feedbackEl) feedbackEl.classList.add('hidden');
          },

          /* ====== –ú–û–î–ê–õ–ö–ò (–í–ù–£–¢–†–ò StoryApp) ====== */
          // [–ò–ó–ú–ï–ù–ï–ù–û] –≠—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏ —Ç–µ–ø–µ—Ä—å –≤—ã–∑—ã–≤–∞—é—Ç—Å—è –∏–∑ App.openModal / App.closeModal
          // –ø–æ—ç—Ç–æ–º—É –º—ã –º–æ–∂–µ–º –∏—Ö –£–î–ê–õ–ò–¢–¨ –∏–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å (–ø–æ–∫–∞ –æ—Å—Ç–∞–≤–∏–º, –Ω–æ –æ–Ω–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è)
          openModal(id) {
            // ... (–≠—Ç–æ—Ç –∫–æ–¥ –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è App.openModal)
          },

          closeModal(id) {
            // ... (–≠—Ç–æ—Ç –∫–æ–¥ –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è App.closeModal)
          }
        };
        // ===== –ö–û–ù–ï–¶ –ò–ù–¢–ï–ì–†–ê–¶–ò–ò text1.html =====


        // ==========================================================
        // 2. –õ–û–ì–ò–ö–ê –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø (Conceptual App Module)
        // ==========================================================

        window.App = {
            db: null,
            auth: null, 
            userId: null,
            isAuthReady: false, 
            userProgress: {}, 
            audioPlayerOriginalParent: null, // [–ù–û–í–û–ï] –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–æ–¥–∏—Ç–µ–ª—è –ø–ª–µ–µ—Ä–∞
            allStoryContent: {}, // [–ù–û–í–û–ï] –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ JSON
            
            // –ü–û–õ–Ø –î–õ–Ø –ü–û–î–ü–ò–°–ö–ò –ò –ê–ö–¢–ò–í–ê–¶–ò–ò
            isSubscriber: false, 
            activationDate: null, 
            selectedWeek: 0, 
            
            unlockedWeek: 1, 
            sessionCards: [], 
            currentCardIndex: 0,
            isPracticeMode: false,
            isAdvancing: false,
            currentDirection: 'ru-de', 
            tempSetId: null, 
            tempMode: null,
            tempSource: null,
            currentScreenId: 'loading-screen', 
            
            // –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
            currentWeekFilter: 'All', 
            currentThemeFilter: 'All', 
            
            // --- –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê –ù–ê–í–ò–ì–ê–¶–ò–ò ---
            tg: null, // –û–±—ä–µ–∫—Ç Telegram Web App
            navigationHistory: [], // –°—Ç–µ–∫ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏
            // { renderFunc: 'renderHomeScreen', param: null }
            // { renderFunc: 'renderWeekContent', param: 1 }
            // { renderFunc: 'renderVideoContentScreen', param: { title: '...', videoUrl: '...' } }
            // -------------------------------

            // –î–∞–Ω–Ω—ã–µ –∫–∞—Ä—É—Å–µ–ª–∏
            carouselSetsMetadata: [],
            carouselCards: [],
            currentCarouselIndex: 0,
            
            // –ù–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞: –≤—Å–µ —Å–ª–æ–≤–∞ –∏ —Ç–µ–º—ã
            wrongExercises: [], // –ú–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ—Ç–≤–µ—á–µ–Ω–Ω—ã—Ö —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π
            allWords: [],
            allTopics: [],
            allExercises: [],
            tempSelectedWords: [], // –î–ª—è –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å–ª–æ–≤
            
            /**
             * –í–ê–ñ–ù–û: –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø—É—Ç—å –∫ –¥–æ–∫—É–º–µ–Ω—Ç—É –≤ Firestore, –∏—Å–ø–æ–ª—å–∑—É—è –í–ê–®–£ –ö–û–õ–õ–ï–ö–¶–ò–Æ –ò ID
             */
            getUserDocRef() {
                 if (!this.db || !this.userId) return null;
                 // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –í–ê–®–ï–ô –ö–û–õ–õ–ï–ö–¶–ò–ò (MY_COLLECTION_NAME) –∏ Telegram ID (this.userId)
                 return doc(this.db, MY_COLLECTION_NAME, this.userId);
            },


            // [–ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø] –¥–ª—è (–ø–µ—Ä–µ)—É—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ Telegram
            setupTelegramHandlers() {
                if (!this.tg) {
                    this.tg = window.Telegram.WebApp;
                    this.tg.ready(); 
                }
                // (–ü–µ—Ä–µ)–Ω–∞–∑–Ω–∞—á–∞–µ–º –Ω–∞—à –≥–ª–∞–≤–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ "–ù–∞–∑–∞–¥"
                this.tg.BackButton.onClick(() => this.handleTelegramBackClick());
            },

            async init() {
                try {
                    // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø TELEGRAM API ---
                    // –î–µ–ª–∞–µ–º —ç—Ç–æ *–ø–µ—Ä–≤—ã–º*, —á—Ç–æ–±—ã API –±—ã–ª–æ –¥–æ—Å—Ç—É–ø–Ω–æ
                    // [–ò–ó–ú–ï–ù–ï–ù–û] –í—ã–∑—ã–≤–∞–µ–º –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é
                    this.setupTelegramHandlers();
                    // ------------------------------------

                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
                    if (Object.keys(firebaseConfig).length > 0 && firebaseConfig.apiKey !== "YOUR_FIREBASE_CONFIG_HERE") {
                        const app = initializeApp(firebaseConfig);
                        this.db = getFirestore(app);
                        this.userId = MY_USER_ID_SOURCE;
                        this.isAuthReady = true;
                    } else {
                         console.error("Firebase configuration not found or not set. Progress will not be saved.");
                         this.isAuthReady = false;
                         this.userId = MY_USER_ID_SOURCE; 
                    }

                    this.disableZoom();
                    this.loadSelectedWords(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Å–ª–æ–≤–∞
                    await this.loadWordsAndTopics(); // [–ù–û–í–û–ï] –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ª–æ–≤–∞ –∏ —Ç–µ–º—ã
                    await this.loadExercises(); // [–ù–û–í–û–ï] –ó–∞–≥—Ä—É–∂–∞–µ–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
                    await this.loadCarouselMetadata(); 
                    await this.loadStoryContent(); // [–ù–û–í–û–ï] –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –∏—Å—Ç–æ—Ä–∏–π

                    if (this.isAuthReady) {
                        await this.loadProgress();
                    } else {
                        // –í –ª–æ–∫–∞–ª—å–Ω–æ–º —Ä–µ–∂–∏–º–µ
                        this.isSubscriber = false; 
                        this.selectedWeek = 0; 
                        this.unlockedWeek = this.getMaxAvailableWeek(); 
                        this.renderHomeScreen(); // <-- –ü–µ—Ä–≤—ã–π –≤—ã–∑–æ–≤, –∫–æ—Ç–æ—Ä—ã–π –∑–∞–ø—É—Å—Ç–∏—Ç showScreen
                    }

                } catch (error) {
                    this.showError(`–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏/–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏: ${error.message}`);
                    console.error(error);
                }
            },
            
            disableZoom() {
                document.addEventListener('touchstart', (event) => {
                    if (event.touches.length > 1) {
                        event.preventDefault();
                    }
                }, { passive: false });

                let lastTouchEnd = 0;
                document.addEventListener('touchend', function (event) {
                    const now = (new Date()).getTime();
                    if (now - lastTouchEnd <= 300) {
                        event.preventDefault();
                    }
                    lastTouchEnd = now;
                }, false);
            },


            // [–ù–û–í–û–ï] –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –∏—Å—Ç–æ—Ä–∏–π (—Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç—ã, –∫–≤–∏–∑—ã –∏ —Ç.–¥.)
            async loadStoryContent() {
                try {
                    const response = await fetch(getBaseUrl() + 'story_content.json');
                    if (!response.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å story_content.json');
                    this.allStoryContent = await response.json();
                    console.log('–ö–æ–Ω—Ç–µ–Ω—Ç –∏—Å—Ç–æ—Ä–∏–π –∑–∞–≥—Ä—É–∂–µ–Ω:', this.allStoryContent);
                } catch (error) {
                    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –∏—Å—Ç–æ—Ä–∏–π:", error);
                    this.showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç –∏—Å—Ç–æ—Ä–∏–π.');
                }
            },

            // [–ù–û–í–û–ï] –ó–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ —Å–ª–æ–≤–∞ –∏ —Ç–µ–º—ã –∏–∑ –µ–¥–∏–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
            async loadWordsAndTopics() {
                try {
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º words.json
                    const wordsResponse = await fetch(getBaseUrl() + 'words.json');
                    if (!wordsResponse.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å words.json');
                    this.allWords = await wordsResponse.json();
                    console.log('–ó–∞–≥—Ä—É–∂–µ–Ω–æ —Å–ª–æ–≤:', this.allWords.length);
                    
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º topics.json
                    const topicsResponse = await fetch(getBaseUrl() + 'topics.json');
                    if (!topicsResponse.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å topics.json');
                    this.allTopics = await topicsResponse.json();
                    console.log('–ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ç–µ–º:', this.allTopics.length);
                } catch (error) {
                    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–æ–≤ –∏ —Ç–µ–º:", error);
                    this.showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ª–æ–≤–∞—Ä—å.');
                }
            },

            // [–ù–û–í–û–ï] –ó–∞–≥—Ä—É–∂–∞–µ—Ç —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
            async loadExercises() {
                try {
                    const response = await fetch(getBaseUrl() + 'exercises.json');
                    if (!response.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å exercises.json');
                    this.allExercises = await response.json();
                    console.log('–ó–∞–≥—Ä—É–∂–µ–Ω–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π:', this.allExercises.length);
                } catch (error) {
                    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π:", error);
                    this.allExercises = [];
                }
            },

            async loadProgress() {
                this.showScreen('loading-screen'); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
                if (!this.isAuthReady) {
                    // –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –∏–∑ localStorage –∫–æ–≥–¥–∞ Firebase –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
                    try {
                        this.loadLocalProgress();
                    } catch (err) {
                        console.warn('Local progress load failed:', err);
                    }
                    return;
                }

                try {
                    const docRef = this.getUserDocRef();
                    if (!docRef) {
                        console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç Firestore.");
                        return;
                    }
                    const docSnap = await getDoc(docRef);

                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        this.userProgress = data.cards || {};
                        this.isSubscriber = data.isSubscriber || false;
                        this.activationDate = data.activationDate; 
                        this.selectedWeek = data.selectedWeek || 0; 
                        this.unlockedWeek = this.getMaxAvailableWeek(); 
                    } else {
                        // –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                        this.userProgress = {};
                        this.isSubscriber = false;
                        this.selectedWeek = 0; 
                        this.unlockedWeek = 1; 
                        await this.saveProgress(); 
                    }
                } catch (error) {
                    console.error("Error loading progress:", error);
                } finally {
                    this.renderHomeScreen(); // <-- –ü–µ—Ä–≤—ã–π —Ä–µ–Ω–¥–µ—Ä –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
                }
            },
            
            async saveProgress() {
                // –ï—Å–ª–∏ Firebase –¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firestore, –∏–Ω–∞—á–µ ‚Äî –≤ localStorage
                if (this.isAuthReady) {
                    try {
                        const docRef = this.getUserDocRef();
                        if (!docRef) {
                            console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç Firestore.");
                            return;
                        }
                        await setDoc(docRef, { 
                            cards: this.userProgress,
                            isSubscriber: this.isSubscriber,
                            activationDate: this.activationDate,
                            selectedWeek: this.selectedWeek
                        }, { merge: true });
                        console.log('–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ Firebase');
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:', error);
                    }
                } else {
                    try {
                        this.saveLocalProgress();
                        console.log('–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ localStorage');
                    } catch (err) {
                        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:', err);
                    }
                }
            },

            // Local storage helpers for offline / no-Firebase mode
            loadLocalProgress() {
                try {
                    const raw = localStorage.getItem('flash_app_progress_v1');
                    if (!raw) return;
                    const data = JSON.parse(raw);
                    this.userProgress = data.cards || {};
                    this.isSubscriber = data.isSubscriber || false;
                    this.activationDate = data.activationDate || null;
                    this.selectedWeek = data.selectedWeek || 0;
                    this.unlockedWeek = this.getMaxAvailableWeek();
                    this.renderHomeScreen();
                } catch (err) {
                    console.error('Failed to parse local progress:', err);
                }
            },

            saveLocalProgress() {
                try {
                    const payload = {
                        cards: this.userProgress || {},
                        isSubscriber: this.isSubscriber || false,
                        activationDate: this.activationDate || null,
                        selectedWeek: this.selectedWeek || 0
                    };
                    localStorage.setItem('flash_app_progress_v1', JSON.stringify(payload));
                } catch (err) {
                    console.error('Failed to save local progress:', err);
                }
            },

            getMaxAvailableWeek() {
                if (!this.isSubscriber || !this.activationDate) {
                    return 1; 
                }
                const activationTime = new Date(this.activationDate).getTime();
                const currentTime = new Date().getTime();
                const daysDiff = Math.floor((currentTime - activationTime) / (1000 * 60 * 60 * 24));
                let maxWeek = Math.floor(daysDiff / 7) + 1;
                return Math.min(ALL_WEEKS.length, Math.max(1, maxWeek));
            },
            
            async activateSubscription() {
                if (this.isSubscriber) return; 
                this.isSubscriber = true;
                this.activationDate = this.getTodayDateString();
                this.selectedWeek = 1; 
                this.unlockedWeek = this.getMaxAvailableWeek(); 
                await this.saveProgress();
                this.renderHomeScreen(false, true); // –†–µ–Ω–¥–µ—Ä–∏–º —Å –æ—á–∏—Å—Ç–∫–æ–π —Å—Ç–µ–∫–∞
            },

            // ==================== –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê –ù–ê–í–ò–ì–ê–¶–ò–ò ====================

            /**
             * [–ù–û–í–´–ô] –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ "Zur√ºck" –≤ —Ö–µ–¥–µ—Ä–µ Telegram.
             */
            handleTelegramBackClick() {
                // –í —Å—Ç–µ–∫–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–Ω—å—à–µ 2 —ç–∫—Ä–∞–Ω–æ–≤ (home + —Ç–µ–∫—É—â–∏–π)
                if (this.navigationHistory.length < 2) {
                    // –≠—Ç–æ–≥–æ –Ω–µ –¥–æ–ª–∂–Ω–æ —Å–ª—É—á–∏—Ç—å—Å—è, —Ç–∞–∫ –∫–∞–∫ –∫–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å–∫—Ä—ã—Ç–∞ –Ω–∞ home-screen
                    return; 
                }
                
                // 1. –£–¥–∞–ª—è–µ–º *—Ç–µ–∫—É—â–∏–π* —ç–∫—Ä–∞–Ω –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
                this.navigationHistory.pop();
                
                // 2. –ü–æ–ª—É—á–∞–µ–º *–ø—Ä–µ–¥—ã–¥—É—â–µ–µ* —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                const prevState = this.navigationHistory[this.navigationHistory.length - 1];
                
                // 3. –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                // true = "—ç—Ç–æ –Ω–∞–≤–∏–≥–∞—Ü–∏—è –Ω–∞–∑–∞–¥", –Ω–µ –Ω—É–∂–Ω–æ —Å–Ω–æ–≤–∞ –ø—É—à–∏—Ç—å –≤ –∏—Å—Ç–æ—Ä–∏—é
                this.reRenderState(prevState, true);
            },

            /**
             * [–ù–û–í–´–ô] "–†–æ—É—Ç–µ—Ä", –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ—Ç —ç–∫—Ä–∞–Ω –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ –∏—Å—Ç–æ—Ä–∏–∏.
             */
            reRenderState(state, isBackNavigation = false) {
                if (!state) {
                    this.renderHomeScreen(isBackNavigation); // –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç
                    return;
                }

                const { renderFunc, param } = state;
                
                // –í—ã–∑—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
                switch (renderFunc) {
                    case 'renderHomeScreen':
                        this.renderHomeScreen(isBackNavigation);
                        break;
                    case 'renderTopicSelection':
                        this.renderTopicSelection(isBackNavigation);
                        break;
                    case 'renderWeekContent':
                        this.renderWeekContent(param, isBackNavigation);
                        break;
                    case 'renderAllSetsScreen':
                        this.renderAllSetsScreen(isBackNavigation);
                        break;
                    case 'renderVideoContentScreen':
                        this.renderVideoContentScreen(param.title, param.videoUrl, param.textContent, isBackNavigation);
                        break;
                    case 'renderExternalLinkScreen':
                        this.renderExternalLinkScreen(param.title, param.url, isBackNavigation);
                        break;
                    case 'renderStoryScreen':
                        // [–ò–ó–ú–ï–ù–ï–ù–û] param.url -> param.weekId
                        this.renderStoryScreen(param.title, param.weekId, isBackNavigation);
                        break;
                    case 'renderCarouselListScreen':
                        this.renderCarouselListScreen(isBackNavigation);
                        break;
                    case 'startCarouselSession':
                        this.startCarouselSession(param.setId, param.setTitle, param.filepath, isBackNavigation);
                        break;
                    case 'startSession':
                        this.startSession(param.setId, param.mode, isBackNavigation, param.source);
                        break;
                    default:
                        this.renderHomeScreen(isBackNavigation); // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
                }
            },


            // ==================== –†–ï–ù–î–ï–†–ò–ù–ì –≠–ö–†–ê–ù–û–í (–ò–ó–ú–ï–ù–ï–ù–û) ====================

            // isBack - —Ñ–ª–∞–≥, —á—Ç–æ –º—ã –ø—Ä–∏—à–ª–∏ —Å—é–¥–∞ –ø–æ –∫–Ω–æ–ø–∫–µ "–ù–∞–∑–∞–¥"
            // clearStack - —Ñ–ª–∞–≥, —á—Ç–æ –Ω—É–∂–Ω–æ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é (–Ω–∞–ø—Ä. –ø—Ä–∏ –∫–ª–∏–∫–µ "–î–æ–º–æ–π" –≤ —Ñ—É—Ç–µ—Ä–µ)
            renderHomeScreen(isBack = false, clearStack = false) {
                this.renderDueTodaySection();
                
                const mainBlock = document.getElementById('main-content-block');
                mainBlock.innerHTML = '';
                
                if (!this.isSubscriber && this.selectedWeek === 0) { 
                    mainBlock.innerHTML += `
                        <button onclick="window.App.renderTopicSelection()" class="w-full py-4 px-5 rounded-xl shadow-xl bg-green-500 text-white text-left text-lg font-bold flex justify-between items-center transition duration-150 hover:shadow-2xl transform hover:-translate-y-1">
                            <span>üöÄ –ü—Ä–æ–±–Ω–∞—è –¢–µ–º–∞</span>
                            <span>–£—á–∏—Ç—å &rarr;</span>
                        </button>
                    `;
                } else {
                    const activeWeek = this.selectedWeek;
                    
                    // –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–º—ã
                    const topicId = WEEK_TO_TOPIC_MAP[activeWeek];
                    const topic = this.allTopics?.find(t => t.id === topicId);
                    const weekTitle = topic ? topic.name : `–¢–µ–º–∞ ${activeWeek}`;
                    
                    if (activeWeek >= 1 && activeWeek <= ALL_WEEKS.length) {
                        mainBlock.innerHTML += `
                            <button onclick="window.App.renderWeekContent(${activeWeek})" class="w-full py-4 px-5 rounded-xl shadow-xl bg-orange-500 text-white text-left flex flex-col transition duration-150 hover:shadow-2xl transform hover:-translate-y-1">
                                <span class="text-lg font-bold">üìÖ –ê–∫—Ç—É–∞–ª—å–Ω–∞—è —Ç–µ–º–∞</span>
                                <span class="text-sm mt-1">${weekTitle}</span>
                            </button>
                        `;
                    }
                }
                
                mainBlock.innerHTML += `
                    <button onclick="window.App.renderTopicSelection()" class="w-full py-4 px-5 bg-indigo-50 rounded-xl shadow-md text-left text-lg font-semibold text-indigo-900 hover:bg-indigo-100 transition duration-150 mt-3 border-2 border-indigo-200">
                        <span>üìö –í—Å–µ —Ç–µ–º—ã</span>
                    </button>
                `;

                mainBlock.innerHTML += `
                    <button onclick="window.App.renderAllSetsScreen()" class="w-full py-4 px-5 bg-purple-50 rounded-xl shadow-md text-left text-lg font-semibold text-purple-900 hover:bg-purple-100 transition duration-150 mt-3 border-2 border-purple-200">
                        <span class="flex items-center gap-2"><img src="assets/icons/carrds.png" alt="" class="w-6 h-6"> –í —É—á–µ–±–µ</span>
                    </button>
                `;
                
                this.renderDueTodaySection();
                
                // [–ò–ó–ú–ï–ù–ï–ù–û] –í—ã–∑—ã–≤–∞–µ–º showScreen —Å —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
                this.showScreen('home-screen', isBack, { renderFunc: 'renderHomeScreen', param: null }, clearStack);
            },
            
            renderDueTodaySection() {
                const section = document.getElementById('due-today-section');
                const list = document.getElementById('due-today-list');
                if (!section || !list) return;

                const today = this.getTodayDateString();
                let dueSetsCount = 0;
                list.innerHTML = '';

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –Ω–∞–±–æ—Ä—ã WORD_SETS
                WORD_SETS.forEach(set => {
                    if (this.isSubscriber && set.week > this.unlockedWeek) return;
                    if (!this.isSubscriber && set.week > 1) return;

                    let dueCount = 0;
                    set.cards.forEach(card => {
                        const progress = this.userProgress[card.id];
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∫–∞—Ä—Ç–æ—á–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –∏–∑—É—á–∞–ª–∏—Å—å –ò –≥–æ—Ç–æ–≤—ã –∫ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—é
                        if (progress && progress.isLearning && progress.nextReview && progress.nextReview <= today) {
                            dueCount++;
                        }
                    });

                    if (dueCount > 0) {
                        dueSetsCount++;
                        const setEl = document.createElement('div');
                        setEl.className = "bg-white p-4 rounded-xl shadow-md border-l-4 border-orange-500 flex justify-between items-center transform transition hover:-translate-y-1";

                        const left = document.createElement('div');
                        const title = document.createElement('span');
                        title.className = 'font-bold text-gray-800';
                        title.textContent = `${set.name}: ${dueCount} —Å–ª–æ–≤ –∫ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—é`;
                        left.appendChild(title);

                        const btn = document.createElement('button');
                        btn.className = 'py-2 px-4 bg-orange-100 text-orange-700 font-bold rounded-xl hover:bg-orange-200 transition duration-150 flex items-center';
                        btn.type = 'button';
                        btn.textContent = '–ù–∞—á–∞—Ç—å';
                        btn.addEventListener('click', () => this.promptForDirection(set.id, 'review', 'allsets'));

                        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                        svg.setAttribute('class', 'w-4 h-4 ml-1');
                        svg.setAttribute('fill', 'none');
                        svg.setAttribute('stroke', 'currentColor');
                        svg.setAttribute('viewBox', '0 0 24 24');
                        const p1 = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                        p1.setAttribute('stroke-linecap', 'round');
                        p1.setAttribute('stroke-linejoin', 'round');
                        p1.setAttribute('stroke-width', '2');
                        p1.setAttribute('d', 'M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z');
                        const p2 = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                        p2.setAttribute('stroke-linecap', 'round');
                        p2.setAttribute('stroke-linejoin', 'round');
                        p2.setAttribute('stroke-width', '2');
                        p2.setAttribute('d', 'M21 12a9 9 0 11-18 0 9 9 0 0118 0z');
                        svg.appendChild(p1);
                        svg.appendChild(p2);
                        btn.appendChild(svg);

                        setEl.appendChild(left);
                        setEl.appendChild(btn);
                        list.appendChild(setEl);
                    }
                });

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –Ω–∞–±–æ—Ä—ã —Å–ª–æ–≤
                const selectedSets = this.createSelectedWordsSets();
                selectedSets.forEach(set => {
                    let dueCount = 0;
                    set.cards.forEach(card => {
                        const progress = this.userProgress[card.id];
                        if (progress && progress.isLearning && progress.nextReview && progress.nextReview <= today) {
                            dueCount++;
                        }
                    });

                    if (dueCount > 0) {
                        dueSetsCount++;
                        const setEl = document.createElement('div');
                        setEl.className = "bg-white p-4 rounded-xl shadow-md border-l-4 border-orange-500 flex justify-between items-center transform transition hover:-translate-y-1";

                        const left = document.createElement('div');
                        const title = document.createElement('span');
                        title.className = 'font-bold text-gray-800';
                        title.textContent = `${set.name}: ${dueCount} —Å–ª–æ–≤ –∫ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—é`;
                        left.appendChild(title);

                        const btn = document.createElement('button');
                        btn.className = 'py-2 px-4 bg-orange-100 text-orange-700 font-bold rounded-xl hover:bg-orange-200 transition duration-150 flex items-center';
                        btn.type = 'button';
                        btn.textContent = '–ù–∞—á–∞—Ç—å';
                        btn.addEventListener('click', () => this.promptForDirection(set.id, 'review', 'allsets'));

                        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                        svg.setAttribute('class', 'w-4 h-4 ml-1');
                        svg.setAttribute('fill', 'none');
                        svg.setAttribute('stroke', 'currentColor');
                        svg.setAttribute('viewBox', '0 0 24 24');
                        const p1 = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                        p1.setAttribute('stroke-linecap', 'round');
                        p1.setAttribute('stroke-linejoin', 'round');
                        p1.setAttribute('stroke-width', '2');
                        p1.setAttribute('d', 'M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z');
                        const p2 = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                        p2.setAttribute('stroke-linecap', 'round');
                        p2.setAttribute('stroke-linejoin', 'round');
                        p2.setAttribute('stroke-width', '2');
                        p2.setAttribute('d', 'M21 12a9 9 0 11-18 0 9 9 0 0118 0z');
                        svg.appendChild(p1);
                        svg.appendChild(p2);
                        btn.appendChild(svg);

                        setEl.appendChild(left);
                        setEl.appendChild(btn);
                        list.appendChild(setEl);
                    }
                });

                if (dueSetsCount > 0) {
                    section.classList.remove('hidden');
                } else {
                    section.classList.add('hidden');
                }
            },

            renderTopicSelection(isBack = false) {
                console.log('üîç renderTopicSelection called');
                document.getElementById('list-title').innerText = '';
                const subtitleEl = document.getElementById('list-subtitle');
                if (subtitleEl) subtitleEl.style.display = 'none';
                
                const contentListDiv = document.getElementById('content-list');
                contentListDiv.innerHTML = '';
                
                this.unlockedWeek = this.getMaxAvailableWeek();
                
                // –í–ê–ñ–ù–û: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –°–†–ê–ó–£
                this.showScreen('list-screen', isBack, { renderFunc: 'renderTopicSelection', param: null });

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º filter-controls
                const filterControls = document.getElementById('filter-controls');
                if (filterControls) filterControls.style.display = 'block';

                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã
                const dropdown = document.getElementById('topic-dropdown');
                const searchInput = document.getElementById('search-input-weekly');
                const searchBtn = document.getElementById('search-button');
                const autocompleteList = document.getElementById('autocomplete-list');
                const searchDiv = document.getElementById('search-container');
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                if (!dropdown || !searchInput || !searchBtn || !autocompleteList || !searchDiv) {
                    console.error('Search elements not found!', {dropdown, searchInput, searchBtn, autocompleteList, searchDiv});
                    return;
                }
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º dropdown –æ–ø—Ü–∏—è–º–∏
                dropdown.innerHTML = `<option value="all">–í—Å–µ —Ç–µ–º—ã</option>` +
                    ALL_WEEKS.map(w => {
                        const topicId = WEEK_TO_TOPIC_MAP[w];
                        const topic = this.allTopics.find(t => t.id === topicId);
                        const topicName = topic ? topic.name : `–¢–µ–º–∞ ${w}`;
                        return `<option value="week-${w}">${topicName}</option>`;
                    }).join('');

                // 3. Load all carousel data (for search)
                const allCarouselData = {};
                let loadedCount = 0;
                let selectedFilter = 'all';
                
                // Autocomplete logic
                let allWords = [];
                
                function updateAutocomplete(value) {
                    const term = value.trim().toLowerCase();
                    autocompleteList.innerHTML = '';
                    
                    if (!term || term.length < 2) {
                        autocompleteList.classList.add('hidden');
                        return;
                    }
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Å–ª–æ–≤–∞, –Ω–∞—á–∏–Ω–∞—é—â–∏–µ—Å—è —Å term
                    const matches = window.App.allWords.filter(item => {
                        const wordLower = item.word.toLowerCase();
                        const translationText = Array.isArray(item.translation) ? item.translation.join(' ') : item.translation;
                        const translationLower = translationText.toLowerCase();
                        
                        return wordLower.startsWith(term) || translationLower.startsWith(term);
                    }).slice(0, 10); // Limit to 10 suggestions
                    
                    if (matches.length === 0) {
                        autocompleteList.classList.add('hidden');
                        return;
                    }
                    // Display matches
                    matches.forEach(item => {
                        const suggestionDiv = document.createElement('div');
                        suggestionDiv.className = 'p-3 hover:bg-blue-50 cursor-pointer border-b border-gray-100 flex items-center gap-3';
                        // Highlight matching part
                        const translationText = Array.isArray(item.translation) ? item.translation.join(', ') : item.translation;
                        const wordHtml = highlightMatch(item.word, term);
                        const translationHtml = highlightMatch(translationText, term);
                        suggestionDiv.innerHTML = `
                            <div class="flex-1">
                                <div class="font-semibold text-gray-800">${wordHtml}</div>
                                <div class="text-sm text-gray-500">${translationHtml}</div>
                            </div>
                            <div class="text-xs text-gray-400">${item.themeName || ''}</div>
                        `;
                        suggestionDiv.addEventListener('click', () => {
                            searchInput.value = item.word;
                            autocompleteList.classList.add('hidden');
                            renderContent(selectedFilter, item.word);
                        });
                        autocompleteList.appendChild(suggestionDiv);
                    });
                    autocompleteList.classList.remove('hidden');
                }
                
                function highlightMatch(text, term) {
                    const index = text.toLowerCase().indexOf(term.toLowerCase());
                    if (index === -1) return text;
                    
                    const before = text.substring(0, index);
                    const match = text.substring(index, index + term.length);
                    const after = text.substring(index + term.length);
                    
                    return `${before}<span class="bg-yellow-200 font-bold">${match}</span>${after}`;
                }
                
                
                // Clear button functionality
                const clearBtn = document.getElementById('clear-search-button');
                
                searchInput.addEventListener('input', (e) => {
                    updateAutocomplete(e.target.value);
                    // Show/hide clear button
                    if (clearBtn) {
                        if (e.target.value.length > 0) {
                            clearBtn.classList.remove('hidden');
                        } else {
                            clearBtn.classList.add('hidden');
                        }
                    }
                });
                
                if (clearBtn) {
                    clearBtn.addEventListener('click', () => {
                        searchInput.value = '';
                        clearBtn.classList.add('hidden');
                        autocompleteList.classList.add('hidden');
                        renderContent(selectedFilter, '');
                    });
                }
                
                searchInput.addEventListener('focus', (e) => {
                    if (e.target.value.length >= 2) {
                        updateAutocomplete(e.target.value);
                    }
                });
                
                // Close autocomplete when clicking outside
                document.addEventListener('click', (e) => {
                    if (!searchDiv.contains(e.target)) {
                        autocompleteList.classList.add('hidden');
                    }
                });

                // Render weeks (standard themes)
                function renderWeeks(searchTerm, weekFilter) {
                    contentListDiv.innerHTML = '';
                    const term = (searchTerm || '').trim().toLowerCase();
                    
                    ALL_WEEKS.forEach(i => {
                        // Filter by selected week
                        if (weekFilter && weekFilter !== 'all' && i !== weekFilter) {
                            return;
                        }
                        
                        const isSubscriber = window.App.isSubscriber;
                        const maxAvailableWeek = window.App.unlockedWeek;
                        const isCurrentSelected = i === window.App.selectedWeek;
                        const freeWeeks = [1, 2, 3, 5, 6, 8]; // emotions, social_relations, home, health, study, nature
                        const isAvailable = isSubscriber ? (i <= maxAvailableWeek) : freeWeeks.includes(i);
                        
                        // If search term exists, skip weeks without matching words
                        if (term && window.App.allWords) {
                            // –ü–æ–ª—É—á–∞–µ–º topicId –¥–ª—è —ç—Ç–æ–π –Ω–µ–¥–µ–ª–∏
                            const topicId = WEEK_TO_TOPIC_MAP[i];
                            if (!topicId) return;
                            
                            // –§–∏–ª—å—Ç—Ä—É–µ–º —Å–ª–æ–≤–∞ –ø–æ —Ç–µ–º–µ –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å –ø–æ–∏—Å–∫–æ–≤—ã–º —Ç–µ—Ä–º–∏–Ω–æ–º
                            const wordsInTopic = window.App.allWords.filter(word => 
                                word.topics && word.topics.includes(topicId)
                            );
                            const hasMatch = wordsInTopic.some(word => {
                                const displayWord = word.article ? `${word.article} ${word.word}` : word.word;
                                const translation = Array.isArray(word.translation) ? word.translation.join(' ') : word.translation;
                                return displayWord.toLowerCase().includes(term) || 
                                       translation.toLowerCase().includes(term);
                            });
                            if (!hasMatch) return;
                        }
                        
                        let statusText = '–î–æ—Å—Ç—É–ø–Ω–æ';
                        let buttonClass = 'bg-white hover:bg-gray-50';

                        if (!isAvailable) {
                            buttonClass = 'button-locked';
                            if (!isSubscriber) {
                                statusText = 'üîí –û—Ñ–æ—Ä–º–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É';
                            } else {
                                const activationTime = new Date(window.App.activationDate).getTime();
                                const currentTime = new Date().getTime();
                                const daysDiff = Math.floor((currentTime - activationTime) / (1000 * 60 * 60 * 24));
                                const daysNeeded = (i - 1) * 7;
                                const daysLeft = daysNeeded - daysDiff;
                                statusText = `üîí –î–æ—Å—Ç—É–ø–Ω–æ —á–µ—Ä–µ–∑ ${daysLeft} –¥–Ω.`;
                            }
                        } else if ((i === 1 || i === 5) && !isSubscriber) {
                            buttonClass = 'bg-green-100 border-2 border-green-500';
                            statusText = '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ';
                        } else if (isCurrentSelected) {
                            buttonClass = 'bg-yellow-100 border-2 border-yellow-500';
                            statusText = '–ê–∫—Ç–∏–≤–Ω–æ';
                        }

                        const weekContainer = document.createElement('div');
                        weekContainer.className = `w-full p-4 rounded-xl shadow-md ${buttonClass} flex justify-between items-center transition-transform hover:scale-105 ${isAvailable ? 'cursor-pointer' : 'cursor-not-allowed'}`;

                        const leftCol = document.createElement('div');
                        leftCol.className = 'flex-1';
                        
                        // –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–º—ã
                        const topicId = WEEK_TO_TOPIC_MAP[i];
                        const topic = window.App.allTopics?.find(t => t.id === topicId);
                        const topicName = topic ? topic.name : `–¢–µ–º–∞ ${i}`;
                        
                        const titleSpan = document.createElement('span');
                        titleSpan.className = `font-bold text-lg ${!isAvailable ? 'text-gray-500' : 'text-gray-800'}`;
                        titleSpan.textContent = topicName;
                        const statusSpan = document.createElement('span');
                        statusSpan.className = `block text-sm ${!isAvailable ? 'text-orange-600' : 'text-gray-500'}`;
                        statusSpan.textContent = statusText;
                        leftCol.appendChild(titleSpan);
                        leftCol.appendChild(statusSpan);

                        // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–µ–ª–∫—É –≤–ø—Ä–∞–≤–æ
                        const arrowSpan = document.createElement('span');
                        arrowSpan.className = `text-2xl ${!isAvailable ? 'text-gray-400' : 'text-blue-500'}`;
                        arrowSpan.innerHTML = '&rarr;';

                        weekContainer.appendChild(leftCol);
                        weekContainer.appendChild(arrowSpan);
                        
                        // –í–µ—Å—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–º
                        if (isAvailable) {
                            weekContainer.addEventListener('click', () => window.App.selectAndRenderWeek(i));
                        }
                        
                        contentListDiv.appendChild(weekContainer);
                    });
                }

                // Render word list from carousel data (for search results)
                function renderCarouselWordsTab(searchTerm, topicFilter) {
                    contentListDiv.innerHTML = '<p class="text-gray-500 text-center py-6">–ó–∞–≥—Ä—É–∑–∫–∞...</p>';
                    const term = (searchTerm || '').trim().toLowerCase();
                    
                    if (!term) {
                        contentListDiv.innerHTML = '<p class="text-gray-500 text-center py-6">–í–≤–µ–¥–∏—Ç–µ —Å–ª–æ–≤–æ –¥–ª—è –ø–æ–∏—Å–∫–∞.</p>';
                        return;
                    }
                    
                    console.log('Searching for:', term);
                    console.log('Total words in allWords:', window.App.allWords.length);
                    
                    // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
                    contentListDiv.innerHTML = '';
                    
                    // –§–∏–ª—å—Ç—Ä—É–µ–º —Å–ª–æ–≤–∞ –∏–∑ allWords
                    let filteredWords = window.App.allWords.filter(wordData => {
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞—Ä—Ç–∏–∫–ª—å —Ç–æ–ª—å–∫–æ –¥–ª—è —Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –∏ –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ —Ç–∏—Ä–µ
                        const displayWord = (wordData.article && wordData.article !== '‚Äî' && wordData.partOfSpeech && wordData.partOfSpeech.toLowerCase().includes('noun')) 
                            ? `${wordData.article} ${wordData.word}` 
                            : wordData.word;
                        const translation = Array.isArray(wordData.translation) ? wordData.translation.join(' ') : wordData.translation;
                        
                        // –§–∏–ª—å—Ç—Ä –ø–æ —Ç–µ–º–µ –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω
                        if (topicFilter && topicFilter !== 'all') {
                            const topicId = window.App.allTopics.find(t => t.name === `–¢–µ–º–∞ ${topicFilter}`)?.id;
                            if (topicId && (!wordData.topics || !wordData.topics.includes(topicId))) {
                                return false;
                            }
                        }
                        
                        // –ü–æ–∏—Å–∫ –ø–æ –Ω–∞—á–∞–ª—É —Å–ª–æ–≤–∞ (–∏—â–µ–º –∏ –≤ –ø–æ–ª–Ω–æ–º displayWord, –∏ —Ç–æ–ª—å–∫–æ –≤ —Å–∞–º–æ–º —Å–ª–æ–≤–µ –±–µ–∑ –∞—Ä—Ç–∏–∫–ª—è)
                        const wordLower = wordData.word.toLowerCase();
                        const displayLower = displayWord.toLowerCase();
                        const translationLower = translation.toLowerCase();
                        
                        const matches = displayLower.startsWith(term) || 
                               wordLower.startsWith(term) ||
                               translationLower.startsWith(term);
                               
                        if (matches) {
                            console.log('Match found:', wordData.word, 'wordLower:', wordLower, 'term:', term);
                        }
                        
                        return matches;
                    });
                    
                    console.log('Filtered words count:', filteredWords.length);
                    
                    if (filteredWords.length === 0) {
                        contentListDiv.innerHTML = '<p class="text-gray-500 text-center py-6">–ù–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π –ø–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É.</p>';
                        return;
                    }
                    
                    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —Å–ª–æ–≤–∞
                    {
                        const words = filteredWords;
                        
                        // –£–±—Ä–∞–Ω–∞ –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å –∫–Ω–æ–ø–∫–æ–π "–£—á–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ"
                        // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –¥–æ–±–∞–≤–∏—Ç—å —Å–ª–æ–≤–∞ –≤ —É—á–µ–±—É —á–µ—Ä–µ–∑ –¥–µ—Ç–∞–ª—å–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
                        
                        // Word list
                        words.forEach(wordData => {
                            const wordId = wordData.id;
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞—Ä—Ç–∏–∫–ª—å —Ç–æ–ª—å–∫–æ –¥–ª—è —Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –∏ –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ —Ç–∏—Ä–µ
                            const displayWord = (wordData.article && wordData.article !== '‚Äî' && wordData.partOfSpeech && wordData.partOfSpeech.toLowerCase().includes('noun')) 
                                ? `${wordData.article} ${wordData.word}` 
                                : wordData.word;
                            const translation = Array.isArray(wordData.translation) ? wordData.translation.join(', ') : wordData.translation;
                            
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤ –∫–∞–∫–æ–π —Ç–µ–º–µ —ç—Ç–æ —Å–ª–æ–≤–æ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è (–±–µ—Ä–µ–º –ø–µ—Ä–≤—É—é)
                            const topicId = wordData.topics && wordData.topics.length > 0 ? wordData.topics[0] : null;
                            const isInStudy = topicId && window.App.selectedWordsForStudy[topicId] && 
                                              window.App.selectedWordsForStudy[topicId].some(w => w.id === wordId);
                            
                            const wordItem = document.createElement('div');
                            wordItem.className = 'p-4 bg-white rounded-xl shadow-md flex items-center gap-3 hover:bg-gray-50 transition';
                            wordItem.dataset.wordId = wordId;
                            
                            // –ß–µ–∫–±–æ–∫—Å —É–¥–∞–ª—ë–Ω –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞
                            
                            // –õ–µ–≤–∞—è —á–∞—Å—Ç—å: –Ω–µ–º–µ—Ü–∫–æ–µ —Å–ª–æ–≤–æ –∏ –ø–µ—Ä–µ–≤–æ–¥
                            const wordInfo = document.createElement('div');
                            wordInfo.className = 'flex-1 cursor-pointer';
                            wordInfo.innerHTML = `
                                <div class="font-bold text-lg text-gray-800">${displayWord}</div>
                                <div class="text-sm text-gray-500">${translation}</div>
                            `;
                            
            
            // –ö–ª–∏–∫ –Ω–∞ —Ç–µ–∫—Å—Ç –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω
                            const currentIndex = words.indexOf(wordData);
                            wordInfo.addEventListener('click', () => {
                                window.App.openWordDetailScreen(wordData, topicId, wordId, words, currentIndex);
                            });                            // –ö–Ω–æ–ø–∫–∞ –æ–∑–≤—É—á–∫–∏
                            const speakBtn = document.createElement('button');
                            speakBtn.className = 'p-2 bg-blue-100 hover:bg-blue-200 rounded-lg transition';
                            speakBtn.innerHTML = `
                                <svg class="w-6 h-6 text-blue-600" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                                </svg>
                            `;
                            speakBtn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                const utterance = new SpeechSynthesisUtterance(wordData.word); // –±–µ–∑ –∞—Ä—Ç–∏–∫–ª—è
                                utterance.lang = 'de-DE';
                                window.speechSynthesis.speak(utterance);
                            });
                            
                            wordItem.appendChild(wordInfo);
                            wordItem.appendChild(speakBtn);
                            
                            // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä "–í —É—á–µ–±–µ" - —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–ª–æ–≤–æ –≤ —É—á–µ–±–µ
                            if (isInStudy) {
                                const studyIndicator = document.createElement('div');
                                studyIndicator.className = 'px-4 py-2 bg-yellow-500 text-white text-sm font-bold rounded-lg shadow-sm';
                                studyIndicator.innerHTML = '<img src="assets/icons/carrds.png" alt="" class="inline-block w-5 h-5 mr-1 align-text-bottom">–í —É—á–µ–±–µ';
                                wordItem.appendChild(studyIndicator);
                            }
                            contentListDiv.appendChild(wordItem);
                        });
                    }
                }

                // Main render function
                function renderContent(filter, searchTerm) {
                    const term = (searchTerm || '').trim().toLowerCase();
                    
                    // If search term exists, show word list tab
                    if (term) {
                        const weekNum = filter.startsWith('week-') ? parseInt(filter.replace('week-', '')) : null;
                        renderCarouselWordsTab(searchTerm, weekNum);
                    } else {
                        // Show week themes
                        const weekNum = filter.startsWith('week-') ? parseInt(filter.replace('week-', '')) : null;
                        renderWeeks(searchTerm, weekNum);
                    }
                }

                // Load all carousel files for search
                function loadAllCarouselFiles() {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Å–ª–æ–≤–∞ –∏–∑ window.App.allWords
                    if (window.App.allWords && window.App.allWords.length > 0) {
                        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –∞–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç–∞
                        window.App.allWords.forEach(wordData => {
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞—Ä—Ç–∏–∫–ª—å —Ç–æ–ª—å–∫–æ –¥–ª—è —Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –∏ –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ —Ç–∏—Ä–µ
                            const displayWord = (wordData.article && wordData.article !== '‚Äî' && wordData.partOfSpeech && wordData.partOfSpeech.toLowerCase().includes('noun')) 
                                ? `${wordData.article} ${wordData.word}` 
                                : wordData.word;
                            const translation = Array.isArray(wordData.translation) ? wordData.translation.join(', ') : wordData.translation;
                            const topicNames = wordData.topics ? wordData.topics.map(topicId => {
                                const topic = window.App.allTopics.find(t => t.id === topicId);
                                return topic ? topic.name : topicId;
                            }).join(', ') : '';
                            
                            allWords.push({
                                word: displayWord,
                                translation: translation,
                                image: wordData.image || null,
                                themeName: topicNames,
                                topicIds: wordData.topics || []
                            });
                        });
                        console.log('Loaded', allWords.length, 'words for autocomplete');
                        renderContent(selectedFilter, '');
                    } else {
                        console.error('Words not loaded yet');
                        contentListDiv.innerHTML = '<p class="text-red-500 text-center py-6">–û—à–∏–±–∫–∞: —Å–ª–æ–≤–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã</p>';
                    }
                }
                
                // Start loading word topic files
                loadAllCarouselFiles();

                // Dropdown change
                dropdown.addEventListener('change', e => {
                    selectedFilter = e.target.value;
                    renderContent(selectedFilter, searchInput.value);
                });
                
                // Search button click
                searchBtn.addEventListener('click', () => {
                    renderContent(selectedFilter, searchInput.value);
                });
                
                // Enter key in search
                searchInput.addEventListener('keydown', e => {
                    if (e.key === 'Enter') {
                        renderContent(selectedFilter, searchInput.value);
                    }
                }); 
            },

            async selectAndRenderWeek(weekNum) {
                this.selectedWeek = weekNum;
                await this.saveProgress();
                this.renderWeekContent(weekNum); // –≠—Ç–æ —É–∂–µ –Ω–µ 'isBack'
            },
            
            renderMenuCard(container, title, subtitle, onClickAction, style = 'bg-white hover:bg-gray-50') {
                const button = document.createElement('button');
                button.className = `w-full text-left p-4 ${style} rounded-xl shadow-md flex justify-between items-center transition duration-150`;
                button.setAttribute('onclick', onClickAction);
                button.innerHTML = `
                    <div>
                        <span class="font-semibold text-lg text-gray-800">${title}</span>
                    </div>
                    <span>&rarr;</span>
                `;
                container.appendChild(button);
            },
            
            renderWeekContent(weekNum, isBack = false) {
                const weekData = WEEKLY_CONTENT_MAP[weekNum];
                if (!weekData) return;
                
                // –ü–æ–ª—É—á–∞–µ–º ID —Ç–µ–º—ã –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ
                const topicId = WEEK_TO_TOPIC_MAP[weekNum] || 'health';
                const topic = this.allTopics?.find(t => t.id === topicId);
                const topicName = topic ? topic.name : `–¢–µ–º–∞ ${weekNum}`;
                
                document.getElementById('list-title').innerText = `üìö ${topicName}`;

                // [–ò–ó–ú–ï–ù–ï–ù–û] –£–±—Ä–∞–Ω—ã this.returnContext –∏ this.renderBackButton
                const filterControls = document.getElementById('filter-controls');
                if (filterControls) filterControls.style.display = 'none';
                const contentListDiv = document.getElementById('content-list');
                contentListDiv.innerHTML = '';
                
                // –ú–∞–Ω—Ç—Ä—ã –ø–æ–ª–µ–∑–Ω—ã—Ö —Ñ—Ä–∞–∑ ‚Äî –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏
                
                // 1. –°–ª–æ–≤–∞ –ø–æ —Ç–µ–º–µ
                // –°—á–∏—Ç–∞–µ–º —Ä–µ–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª–æ–≤ –∏–∑ allWords –ø–æ —ç—Ç–æ–π —Ç–µ–º–µ
                const topicWordsCount = this.allWords?.filter(w => w.topics && w.topics.includes(topicId)).length || 0;
                this.renderMenuCard(contentListDiv, 
                    `üìö –°–ª–æ–≤–∞ –ø–æ —Ç–µ–º–µ (${topicWordsCount})`, 
                    ``,
                    `window.App.renderWordList('${weekData.wordSetId}', '${topicId}')`,
                    'bg-green-100 hover:bg-green-200'
                );
                
                // 2. –ê—Å—Å–æ—Ü–∏–∞—Ü–∏–∏
                this.renderMenuCard(contentListDiv,
                    `üñºÔ∏è –ê—Å—Å–æ—Ü–∏–∞—Ü–∏–∏`,
                    '',
                    `window.App.startAssociationsCarousel('${topicId}')`,
                    'bg-indigo-100 hover:bg-indigo-200'
                );
                
                // 3. –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è —Å gap_fill
                this.renderMenuCard(contentListDiv,
                    `‚úèÔ∏è –£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è`,
                    '',
                    `window.App.renderExercisesMenu('${topicId}', ${weekNum})`,
                    'bg-blue-100 hover:bg-blue-200'
                );
                
                // 3. –ú–∞–Ω—Ç—Ä—ã –ø–æ–ª–µ–∑–Ω—ã—Ö —Ñ—Ä–∞–∑
                this.renderMenuCard(contentListDiv,
                    `üïØÔ∏è –ú–∞–Ω—Ç—Ä—ã –ø–æ–ª–µ–∑–Ω—ã—Ö —Ñ—Ä–∞–∑`,
                    '',
                    `window.App.startMantraSessionFromExercises('${topicId}', ${weekNum})`,
                    'bg-yellow-100 hover:bg-yellow-200'
                );
                
                // 4. –§—Ä–∞–∑—ã –∏ –¥–∏–∞–ª–æ–≥–∏
                // [–ò–ó–ú–ï–ù–ï–ù–û]
                const dialoguesTextEscaped = (weekData.dialoguesText || '').replace(/'/g, "\\'").replace(/"/g, '&quot;').replace(/\r\n|\r|\n/g, '<br>');
                const dialoguesTitleEscaped = (weekData.dialoguesTitle || `–î–∏–∞–ª–æ–≥–∏ –ù–µ–¥–µ–ª–∏ ${weekNum}`).replace(/'/g, "\\'");

                this.renderMenuCard(contentListDiv, 
                    `üó£Ô∏è –§—Ä–∞–∑—ã –∏ –¥–∏–∞–ª–æ–≥–∏`, 
                    '',
                    `window.App.renderVideoContentScreen('${dialoguesTitleEscaped}', '${weekData.dialoguesVideo || ''}', '${dialoguesTextEscaped}')`,
                    'bg-pink-100 hover:bg-pink-200'
                );
                
                // 5. –ò—Å—Ç–æ—Ä–∏–∏ –ø–æ —Ç–µ–º–µ
                let storyAction;
                // [–ò–ó–ú–ï–ù–ï–ù–û] –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ ID, –∞ –Ω–µ –ø–æ storyLink
                const storyId = `week_${weekNum}`;
                if (this.allStoryContent[storyId]) {
                    storyAction = `window.App.renderStoryScreen('üìñ –ò—Å—Ç–æ—Ä–∏–∏ –ø–æ —Ç–µ–º–µ', '${storyId}')`; 
                } else if (weekData.storyLink) {
                    // –û—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö —Å—Å—ã–ª–æ–∫
                    storyAction = `window.App.renderExternalLinkScreen('üìñ –ò—Å—Ç–æ—Ä–∏–∏ –ø–æ —Ç–µ–º–µ', '${weekData.storyLink}')`; 
                } else {
                    storyAction = `void(0)`; // –ë–ª–æ–∫–∏—Ä—É–µ–º, –µ—Å–ª–∏ –Ω–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç–∞
                }
                
                this.renderMenuCard(contentListDiv, 
                    `üìñ –ò—Å—Ç–æ—Ä–∏–∏ –ø–æ —Ç–µ–º–µ`, 
                    '',
                    storyAction,
                    (this.allStoryContent[storyId] || weekData.storyLink) ? 'bg-orange-100 hover:bg-orange-200' : 'button-locked'
                );

                // [–ò–ó–ú–ï–ù–ï–ù–û] –í—ã–∑—ã–≤–∞–µ–º showScreen —Å —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
                this.showScreen('list-screen', isBack, { renderFunc: 'renderWeekContent', param: weekNum });
                
                if (this.carouselSetsMetadata.length === 0) {
                     this.loadCarouselMetadata().then(() => {
                         this.renderWeekContent(weekNum, true); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º, –Ω–æ –æ—Ç–º–µ—á–∞–µ–º –∫–∞–∫ isBack, —á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é
                     });
                }
            },
            
            renderVideoContentScreen(title, videoUrl, textContent, isBack = false, carouselData = null) {
                // [–ò–ó–ú–ï–ù–ï–ù–û] –£–±—Ä–∞–Ω—ã this.returnContext –∏ this.renderBackButton
                document.getElementById('video-title').textContent = title;
                const videoIframe = document.getElementById('video-embed');
                const extraTextDiv = document.getElementById('video-extra-text');
                const carouselButtonContainer = document.getElementById('video-carousel-button-container');

                videoIframe.src = videoUrl ? videoUrl : '';
                
                // [–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï] –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤–∏–¥–µ–æ
                const videoContainer = videoIframe.closest('.video-container');
                if(videoContainer) {
                    videoContainer.style.display = videoUrl ? 'block' : 'none';
                }

                extraTextDiv.innerHTML = textContent ? textContent : ''; // –ò—Å–ø–æ–ª—å–∑—É–µ–º innerHTML –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ <b>
                extraTextDiv.style.display = textContent ? 'block' : 'none';
                
                // [–ù–û–í–û–ï] –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –∫–∞—Ä—É—Å–µ–ª–∏ –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –¥–∞–Ω–Ω—ã–µ
                carouselButtonContainer.innerHTML = '';
                const carouselDataToUse = carouselData || this.currentWeekCarouselData;
                if (carouselDataToUse && carouselDataToUse.setId && carouselDataToUse.setTitle && carouselDataToUse.filepath) {
                    const btn = document.createElement('button');
                    btn.className = 'btn-success w-full py-4 px-6 text-lg font-semibold flex items-center justify-center gap-3 rounded-2xl shadow-lg hover:shadow-xl transition duration-150 hover:scale-105';
                    btn.innerHTML = 'üñºÔ∏è –ö–∞—Ä—É—Å–µ–ª—å –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–π';
                    btn.onclick = () => this.startCarouselSession(carouselDataToUse.setId, carouselDataToUse.setTitle, carouselDataToUse.filepath);
                    carouselButtonContainer.appendChild(btn);
                }
                
                // [–ò–ó–ú–ï–ù–ï–ù–û] –í—ã–∑—ã–≤–∞–µ–º showScreen —Å —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
                this.showScreen('video-content-screen', isBack, { 
                    renderFunc: 'renderVideoContentScreen', 
                    param: {title, videoUrl, textContent, carouselData} 
                });
            },
            
            renderExternalLinkScreen(title, url, isBack = false) {
                // [–ò–ó–ú–ï–ù–ï–ù–û] –£–±—Ä–∞–Ω—ã this.returnContext –∏ this.renderBackButton
                document.getElementById('external-link-title').textContent = title;
                document.getElementById('external-link-button').href = url;
                document.getElementById('external-link-url-display').textContent = url;
                
                // [–ò–ó–ú–ï–ù–ï–ù–û] –í—ã–∑—ã–≤–∞–µ–º showScreen —Å —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
                this.showScreen('external-link-screen', isBack, { 
                    renderFunc: 'renderExternalLinkScreen', 
                    param: {title, url} 
                });

                if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.openLink) {
                    window.Telegram.WebApp.openLink(url);
                }
            },

            // [–°–ò–õ–¨–ù–û –ò–ó–ú–ï–ù–ï–ù–û] 
            // –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –±–æ–ª—å—à–µ –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç HTML. –û–Ω–∞ —á–∏—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑
            // 'this.allStoryContent' –∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É.
            async renderStoryScreen(title, weekId, isBack = false) { // weekId = 'week_1'
                
                // 1. –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –∏–∑ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                const content = this.allStoryContent[weekId];
                if (!content) {
                    this.showError(`–ö–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è '${weekId}' –Ω–µ –Ω–∞–π–¥–µ–Ω.`);
                    console.error(`–ö–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è '${weekId}' –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ this.allStoryContent`);
                    return; // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω, –µ—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö
                }

                // 2. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —ç–∫—Ä–∞–Ω–∞
                document.getElementById('content-viewer-title').textContent = title;
                
                // 3. –ó–∞–ø–æ–ª–Ω—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –∏—Å—Ç–æ—Ä–∏–∏ (–∑–∞–≥–æ–ª–æ–≤–æ–∫, –∞—É–¥–∏–æ, –∫–∞—Ä—Ç–∏–Ω–∫–∞)
                const storyBody = document.getElementById('content-viewer-body');
                storyBody.querySelector('h1').textContent = content.title;
                // (–ï—Å–ª–∏ –ø—É—Ç–∏ –∫ –∞—É–¥–∏–æ/–∫–∞—Ä—Ç–∏–Ω–∫–∞–º —Ç–æ–∂–µ –≤ JSON, –∏—Ö –º–æ–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–¥–µ—Å—å)
                // [–ò–ó–ú–ï–ù–ï–ù–û] –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—É—Ç–∏ –∫ –º–µ–¥–∏–∞ –∏–∑ JSON
                const imgEl = storyBody.querySelector('.story-visual-container img');
                const audioEl = storyBody.querySelector('#story-audio-player');
                
                if (imgEl && content.imageSrc) imgEl.src = content.imageSrc;
                if (audioEl && content.audioSrc) audioEl.src = content.audioSrc;


                // 4. [–ù–û–í–û–ï] –ó–∞–ø–æ–ª–Ω—è–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏
                const transcriptContainer = document.getElementById('transcript-scroll-area');
                transcriptContainer.innerHTML = ''; // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ
                
                if (content.transcript && Array.isArray(content.transcript)) {
                    content.transcript.forEach(paragraph => {
                        const p = document.createElement('p');
                        p.className = 'mb-3';
                        p.innerHTML = paragraph;
                        transcriptContainer.appendChild(p);
                    });
                }

                // 5. [–ù–û–í–û–ï] –ü–µ—Ä–µ–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –∫–≤–∏–∑–µ –∏ —Ä–∞–∑–±–æ—Ä–µ –≤ 'StoryApp'
                window.StoryApp.quizData = content.quiz || [];
                window.StoryApp.analysisSlides = content.analysis || [];
                
                // 6. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
                this.showScreen('content-viewer-screen', isBack, { 
                    renderFunc: 'renderStoryScreen', 
                    param: {title, weekId} 
                });

                try {
                    // 7. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º StoryApp (–æ–Ω –ø–æ–¥—Ö–≤–∞—Ç–∏—Ç –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ)
                    if (window.StoryApp && typeof window.StoryApp.init === 'function') {
                         await window.StoryApp.init();
                    } else {
                        console.error("StoryApp –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ –∏–º–µ–µ—Ç .init()");
                    }
                    
                    // 8. –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥"
                    this.setupTelegramHandlers();

                } catch (error) {
                    console.error('Error initializing story content:', error);
                }
            },

            renderAllSetsScreen(isBack = false) {
                // [–ò–ó–ú–ï–ù–ï–ù–û] –£–±—Ä–∞–Ω—ã this.returnContext –∏ this.renderBackButton
                document.getElementById('list-title').innerHTML = '<img src="assets/icons/carrds.png" alt="" class="inline-block w-7 h-7 mr-2 align-text-bottom">–í —É—á–µ–±–µ';
                
                // –°–∫—Ä—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
                const filterControls = document.getElementById('filter-controls');
                if (filterControls) filterControls.style.display = 'none';
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–∞–±–æ—Ä—ã –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å–ª–æ–≤
                const selectedSets = this.createSelectedWordsSets();
                
                this.renderSetCards(selectedSets);
                
                // [–ò–ó–ú–ï–ù–ï–ù–û] –í—ã–∑—ã–≤–∞–µ–º showScreen —Å —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
                this.showScreen('list-screen', isBack, { renderFunc: 'renderAllSetsScreen', param: null });
            },

            createAllWordsSets() {
                const sets = [];
                
                // –°–æ–∑–¥–∞–µ–º –Ω–∞–±–æ—Ä—ã —Å–æ –í–°–ï–ú–ò —Å–ª–æ–≤–∞–º–∏ –ø–æ —Ç–µ–º–∞–º –∏–∑ allWords
                if (this.allWords && this.allTopics) {
                    this.allTopics.forEach(topic => {
                        const topicWords = this.allWords.filter(w => w.topics && w.topics.includes(topic.id));
                        if (topicWords.length > 0) {
                            sets.push({
                                id: `all_topic_${topic.id}`,
                                week: 1,
                                name: topic.name,
                                cards: topicWords.map(w => ({
                                    id: w.id,
                                    front: Array.isArray(w.translation) ? w.translation.join(', ') : w.translation,
                                    back: w.article ? `${w.article} ${w.word}` : w.word,
                                    hintImage: w.image || null
                                })),
                                isAllWords: true
                            });
                        }
                    });
                }
                
                return sets;
            },

            createSelectedWordsSets() {
                const sets = [];
                if (!this.selectedWordsForStudy) return sets;
                
                // –°–æ–∑–¥–∞–µ–º –Ω–∞–±–æ—Ä—ã –∏–∑ –í–´–ë–†–ê–ù–ù–´–• —Å–ª–æ–≤ (—Ç–µ, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–∏–ª –≤ —É—á–µ–±—É)
                Object.keys(this.selectedWordsForStudy).forEach(topicId => {
                    const words = this.selectedWordsForStudy[topicId];
                    if (words && words.length > 0) {
                        const topic = this.allTopics.find(t => t.id === topicId);
                        const topicName = topic ? topic.name : topicId;
                        sets.push({
                            id: `selected_topic_${topicId}`,
                            week: 1,
                            name: `${topicName}: ${words.length} —Å–ª–æ–≤`,
                            cards: words.map(w => ({
                                id: w.id,
                                front: w.translation,
                                back: w.word,
                                hintImage: w.image || null
                            })),
                            isSelected: true
                        });
                    }
                });
                
                return sets;
            },

            // ==================== –§–ò–õ–¨–¢–†–´ –ò –ö–ê–†–¢–û–ß–ö–ò (–ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ====================

            renderSetFilterControls() {
                const filterControls = document.getElementById('filter-controls');
                filterControls.innerHTML = `
                    <div class="grid grid-cols-2 gap-3">
                        <select id="week-filter" onchange="window.App.updateSetFilter('week', this.value)" 
                                class="p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="All">–í—Å–µ –ù–µ–¥–µ–ª–∏</option>
                            ${ALL_WEEKS.map(w => `<option value="${w}" ${this.currentWeekFilter === w.toString() ? 'selected' : ''}>–ù–µ–¥–µ–ª—è ${w}</option>`).join('')}
                        </select>
                    </div>
                `;
            },
            
            updateSetFilter(filterType, value) {
                if (filterType === 'week') {
                    this.currentWeekFilter = value;
                }
                this.renderAllSetsScreen(true); // true = isBack, –Ω–µ –¥—É–±–ª–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é
            },

            renderSetCards(setsToRender) {
                const contentListDiv = document.getElementById('content-list');
                contentListDiv.innerHTML = '';
                const today = this.getTodayDateString();

                if (setsToRender.length === 0) {
                    contentListDiv.innerHTML = '<p class="text-gray-500 text-center py-6">–ù–µ—Ç –Ω–∞–±–æ—Ä–æ–≤, —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—è—é—â–∏—Ö —É—Å–ª–æ–≤–∏—è–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏.</p>';
                    return;
                }

                setsToRender.forEach(set => {
                    // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∫–∞—Ä—Ç–æ—á–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –∏–∑—É—á–∞–ª–∏—Å—å –ò –≥–æ—Ç–æ–≤—ã –∫ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—é
                    let dueCount = 0;
                    set.cards.forEach(card => {
                        const progress = this.userProgress[card.id];
                        // –ö–∞—Ä—Ç–æ—á–∫–∞ –∫ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—é –µ—Å–ª–∏: —É–∂–µ –∏–∑—É—á–∞–ª–∞—Å—å –ò –ø—Ä–∏—à–ª–æ –≤—Ä–µ–º—è –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è
                        if (progress && progress.isLearning && progress.nextReview && progress.nextReview <= today) {
                            dueCount++;
                        }
                    });
                    
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫: –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å–ª–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–º—É, –¥–ª—è –æ–±—ã—á–Ω—ã—Ö - –Ω–µ–¥–µ–ª—é
                    let subtitle = '';
                    if (set.isSelected) {
                        // –î–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å–ª–æ–≤ - –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–∂–µ –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏)
                        subtitle = '';
                    } else {
                        // –î–ª—è –æ–±—ã—á–Ω—ã—Ö –Ω–∞–±–æ—Ä–æ–≤ - —Ç–æ–ª—å–∫–æ –Ω–µ–¥–µ–ª—è
                        subtitle = `–ù–µ–¥–µ–ª—è ${set.week}`;
                    }

                    const setContainer = document.createElement('div');
                    setContainer.className = "w-full p-4 bg-white rounded-xl shadow-md";
                    setContainer.innerHTML = `
                        <div class="mb-3">
                            <div>
                                <span class="font-semibold text-gray-800 text-lg">${set.name}</span>
                                ${subtitle ? `<span class="block text-sm text-gray-500">${subtitle}</span>` : ''}
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            ${dueCount > 0 ? 
                                `<button class="w-full py-2 px-3 bg-blue-500 text-white font-semibold rounded-xl text-sm hover:bg-blue-600 transition duration-150" 
                                        onclick="window.App.promptForDirection('${set.id}', 'review', 'allsets')">
                                    –ö –ø–æ–≤—Ç–æ—Ä—É (${dueCount})
                                </button>` :
                                `<button class="w-full py-2 px-3 bg-gray-300 text-gray-500 font-semibold rounded-xl text-sm cursor-not-allowed" disabled>
                                    –ö –ø–æ–≤—Ç–æ—Ä—É (0)
                                </button>`
                            }
                            <button class="w-full py-2 px-3 bg-gray-200 text-gray-700 font-semibold rounded-xl text-sm hover:bg-gray-300 transition duration-150" 
                                    onclick="window.App.promptForDirection('${set.id}', 'practice-all', 'allsets')">
                                –ü—Ä–∞–∫—Ç–∏–∫–∞ –≤—Å–µ—Ö —Å–ª–æ–≤
                            </button>
                        </div>
                    `;
                    contentListDiv.appendChild(setContainer);
                });
            },
            
            // ==================== –õ–û–ì–ò–ö–ê –ö–ê–†–£–°–ï–õ–ò (–ò–ó–ú–ï–ù–ï–ù–û) ====================
            
            async loadCarouselMetadata() {
                try {
                    const response = await fetch(getBaseUrl() + 'carousel_sets.json');
                    if (!response.ok) {
                        throw new Error(`–û—à–∏–±–∫–∞ HTTP: ${response.status} ${response.statusText}`);
                    }
                    let rawResponseText = await response.text(); 
                    this.carouselSetsMetadata = JSON.parse(rawResponseText);
                    return true;
                } catch (error) {
                    console.error('Carousel Metadata Load Error:', error);
                    return false;
                }
            },

            async renderCarouselListScreen(isBack = false) {
                // [–ò–ó–ú–ï–ù–ï–ù–û] –£–±—Ä–∞–Ω—ã this.carouselReturnContext –∏ this.renderBackButton
                document.getElementById('carousel-list-title').innerText = '–ö–∞—Ä—É—Å–µ–ª—å –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–π';
                const listDiv = document.getElementById('carousel-sets-list');
                listDiv.innerHTML = '<p class="text-center text-gray-500 py-6">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –Ω–∞–±–æ—Ä–æ–≤...</p>';
                
                // [–ò–ó–ú–ï–ù–ï–ù–û] –í—ã–∑—ã–≤–∞–µ–º showScreen —Å —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
                this.showScreen('carousel-list-screen', isBack, { renderFunc: 'renderCarouselListScreen', param: null });
                
                if (this.carouselSetsMetadata.length === 0) {
                   await this.loadCarouselMetadata();
                }

                if (this.carouselSetsMetadata.length === 0) {
                     listDiv.innerHTML = '<p class="text-red-500 text-center py-6">–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –Ω–∞–±–æ—Ä–æ–≤ –∫–∞—Ä—É—Å–µ–ª–µ–π.</p>';
                     return;
                }
                
                listDiv.innerHTML = '';
                this.carouselSetsMetadata.forEach(set => {
                    const button = document.createElement('button');
                    button.className = 'w-full py-4 px-5 bg-white rounded-xl shadow-md text-left text-lg font-semibold text-gray-800 hover:bg-gray-50 flex justify-between items-center transition duration-150';
                    button.innerHTML = `
                        <span>${set.title}</span>
                        <span class="text-sm text-gray-500">${set.wordCount} —Å–ª–æ–≤ &rarr;</span>
                    `;
                    button.onclick = () => this.startCarouselSession(set.id, set.title, set.filepath);
                    listDiv.appendChild(button);
                });
            },
            
            async startCarouselSession(setId, setTitle, filepath, isBack = false) {
                // [–ò–ó–ú–ï–ù–ï–ù–û] –£–±—Ä–∞–Ω—ã this.carouselReturnContext
                this.showScreen('loading-screen', isBack); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É (isBack, —á—Ç–æ–±—ã –Ω–µ –∑–∞–ø–∏—Å–∞—Ç—å 'loading' –≤ –∏—Å—Ç–æ—Ä–∏—é)
                
                try {
                    const response = await fetch(getBaseUrl() + filepath);
                    if (!response.ok) throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –Ω–∞–±–æ—Ä–∞: ${filepath}`);
                    
                    let rawResponseText = await response.text(); 
                    this.carouselCards = JSON.parse(rawResponseText);

                    if (this.carouselCards.length === 0) {
                        throw new Error('–ù–∞–±–æ—Ä –ø—É—Å—Ç.');
                    }

                    this.currentCarouselIndex = 0;
                    this.showCarouselCard();
                    
                    // [–ò–ó–ú–ï–ù–ï–ù–û] –í—ã–∑—ã–≤–∞–µ–º showScreen —Å —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
                    this.showScreen('image-carousel-screen', isBack, { 
                        renderFunc: 'startCarouselSession', 
                        param: {setId, setTitle, filepath} 
                    });
                    
                } catch (error) {
                    this.showScreen('loading-screen', true); // true = –Ω–µ –ø–∏—à–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
                    document.getElementById('loading-screen').innerHTML = `<p class="text-red-500 text-center py-6">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—É—Å–µ–ª–∏: ${error.message}</p>`;
                    console.error('Carousel Data Load Error:', error);
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–µ—Ä–Ω–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞–∑–∞–¥ —á–µ—Ä–µ–∑ 2 —Å–µ–∫
                    setTimeout(() => this.handleTelegramBackClick(), 2000);
                }
            },

            showCarouselCard() {
                const card = this.carouselCards[this.currentCarouselIndex];
                document.getElementById('carousel-word-count').textContent = `–°–ª–æ–≤–æ ${this.currentCarouselIndex + 1} –∏–∑ ${this.carouselCards.length}`;
                document.getElementById('carousel-image').src = card.image;
                document.getElementById('carousel-word').textContent = card.word;
                document.getElementById('carousel-translation').textContent = card.translation;
                
                document.getElementById('carousel-translation').classList.add('hidden');
                document.getElementById('toggle-translation-button').textContent = '–ü–æ–∫–∞–∑–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥';
                // [–ò–ó–ú–ï–ù–ï–ù–û] –£–±—Ä–∞–Ω –≤—ã–∑–æ–≤ renderBackButton
            },

            showNextWord() {
                this.currentCarouselIndex = (this.currentCarouselIndex + 1) % this.carouselCards.length;
                this.showCarouselCard();
            },

            showPrevWord() {
                this.currentCarouselIndex = (this.currentCarouselIndex - 1 + this.carouselCards.length) % this.carouselCards.length;
                this.showCarouselCard();
            },
            
            toggleTranslation() {
                const translationEl = document.getElementById('carousel-translation');
                const button = document.getElementById('toggle-translation-button');
                const isHidden = translationEl.classList.contains('hidden');
                
                if (isHidden) {
                    translationEl.classList.remove('hidden');
                    button.textContent = '–°–∫—Ä—ã—Ç—å –ø–µ—Ä–µ–≤–æ–¥';
                    this.speakGerman(this.carouselCards[this.currentCarouselIndex].word); 
                } else {
                    translationEl.classList.add('hidden');
                    button.textContent = '–ü–æ–∫–∞–∑–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥';
                }
            },

            // ==================== –õ–û–ì–ò–ö–ê –ú–ê–ù–¢–† (–ù–û–í–´–ô –ë–õ–û–ö) ====================
            async startMantraSession(setId, setTitle, filepath, isBack = false) {
                this.openModal('mantra-modal');
                try {
                    const response = await fetch(getBaseUrl() + filepath);
                    if (!response.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–∞–Ω—Ç—Ä—ã.');
                    const raw = await response.text();
                    this.mantraCards = JSON.parse(raw);
                    if (!Array.isArray(this.mantraCards) || this.mantraCards.length === 0) {
                        document.getElementById('mantra-modal-body').innerHTML = '<p class="text-center text-gray-500 py-6">–ù–∞–±–æ—Ä –º–∞–Ω—Ç—Ä –ø—É—Å—Ç.</p>';
                        return;
                    }
                    this.currentMantraIndex = 0;
                    this.mantraKnownCount = 0;
                    this.mantraUnknownCount = 0;
                    this.mantraSeen = [];
                    // Reset UI: show card area, hide summary, clear actions
                    document.getElementById('mantra-card-area').classList.remove('hidden');
                    document.getElementById('mantra-summary').classList.add('hidden');
                    document.getElementById('mantra-summary-actions').innerHTML = '';
                    this.showMantraCard();
                } catch (err) {
                    console.error('Mantra load error', err);
                    document.getElementById('mantra-modal-body').innerHTML = `<p class="text-red-500 text-center py-6">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞–Ω—Ç—Ä: ${err.message}</p>`;
                }
            },

            startMantraSessionFromExercises(topicId, weekNum) {
                this.openModal('mantra-modal');
                try {
                    // –ü–æ–ª—É—á–∞–µ–º —Å–ª–æ–≤–∞ —Ç–µ–º—ã
                    const topicWords = this.allWords.filter(word => word.topics && word.topics.includes(topicId));
                    const wordIds = topicWords.map(w => w.id);
                    
                    // –§–∏–ª—å—Ç—Ä—É–µ–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è —Ç–∏–ø–∞ useful_phrase –¥–ª—è —Å–ª–æ–≤ —ç—Ç–æ–π —Ç–µ–º—ã
                    const usefulPhrases = this.allExercises.filter(ex => 
                        ex.type === 'useful_phrase' && wordIds.includes(ex.wordId)
                    );
                    
                    if (usefulPhrases.length === 0) {
                        document.getElementById('mantra-modal-body').innerHTML = '<p class="text-center text-gray-500 py-6">–ù–µ—Ç –ø–æ–ª–µ–∑–Ω—ã—Ö —Ñ—Ä–∞–∑ –¥–ª—è —ç—Ç–æ–π —Ç–µ–º—ã.</p>';
                        return;
                    }
                    
                    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç –º–∞–Ω—Ç—Ä
                    this.mantraCards = usefulPhrases.map(ex => ({
                        ru: ex.explanation || '',
                        de: ex.phrase || ''
                    }));
                    
                    this.currentMantraIndex = 0;
                    this.mantraKnownCount = 0;
                    this.mantraUnknownCount = 0;
                    this.mantraSeen = [];
                    
                    // Reset UI: show card area, hide summary, clear actions
                    document.getElementById('mantra-card-area').classList.remove('hidden');
                    document.getElementById('mantra-summary').classList.add('hidden');
                    document.getElementById('mantra-summary-actions').innerHTML = '';
                    this.showMantraCard();
                } catch (err) {
                    console.error('Mantra load error', err);
                    document.getElementById('mantra-modal-body').innerHTML = `<p class="text-red-500 text-center py-6">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞–Ω—Ç—Ä: ${err.message}</p>`;
                }
            },

            showMantraCard() {
                const card = this.mantraCards[this.currentMantraIndex];
                if (!card) return;
                // Russian always visible
                document.getElementById('mantra-russian').textContent = card.ru || '';
                // German hidden by default
                document.getElementById('mantra-german').textContent = card.de || '';
                document.getElementById('mantra-german-hidden').classList.remove('hidden');
                document.getElementById('mantra-german-shown').classList.add('hidden');
                document.getElementById('mantra-progress').textContent = `${this.currentMantraIndex + 1} / ${this.mantraCards.length}`;
            },

            showMantraAnswer() {
                document.getElementById('mantra-german-hidden').classList.add('hidden');
                document.getElementById('mantra-german-shown').classList.remove('hidden');
            },

            flipMantraCard() {
                // Deprecated - no longer used in new design
            },

            speakMantra(text) {
                if (!text) return;
                if (window.speechSynthesis) {
                    const utter = new SpeechSynthesisUtterance(text);
                    utter.lang = 'de-DE';
                    window.speechSynthesis.cancel();
                    window.speechSynthesis.speak(utter);
                }
            },

            handleMantraAnswer(known) {
                // record answer
                if (known) this.mantraKnownCount++;
                else this.mantraUnknownCount++;
                this.mantraSeen.push({ index: this.currentMantraIndex, known });

                // advance to next card or show summary
                this.currentMantraIndex++;
                if (this.currentMantraIndex >= this.mantraCards.length) {
                    // finished session
                    this.showMantraSummary();
                } else {
                    // reset UI for next card
                    this.showMantraCard();
                }
            },

            showMantraSummary() {
                // hide card area, show summary
                document.getElementById('mantra-card-area').classList.add('hidden');
                const summaryEl = document.getElementById('mantra-summary');
                summaryEl.classList.remove('hidden');
                summaryEl.innerHTML = `
                    <p class="text-lg font-semibold">–†–µ–∑—É–ª—å—Ç–∞—Ç</p>
                    <p class="mt-2">–ü—Ä–æ–π–¥–µ–Ω–æ: <b>${this.mantraKnownCount}</b></p>
                    <p>–ù–µ –ø—Ä–æ–π–¥–µ–Ω–æ: <b>${this.mantraUnknownCount}</b></p>
                `;
                // options: repeat not-known, retry all, close
                document.getElementById('mantra-summary-actions').innerHTML = `
                    <div class="flex gap-2 mt-4">
                        <button class="btn-success flex-1" onclick="window.App.restartMantraWithFilter(false)">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –Ω–µ–ø—Ä–æ—Ö–æ–¥–Ω—ã–µ</button>
                        <button class="btn-primary flex-1" onclick="window.App.restartMantraWithFilter(true)">–ü—Ä–æ–π—Ç–∏ –∑–∞–Ω–æ–≤–æ –≤—Å–µ</button>
                    </div>
                    <div class="mt-3 text-center">
                        <button class="py-2 px-4 text-sm text-gray-600" onclick="window.App.closeModal('mantra-modal')">–ó–∞–∫—Ä—ã—Ç—å</button>
                    </div>
                `;
            },

            restartMantraWithFilter(restartAll) {
                // rebuild mantraCards view
                if (restartAll) {
                    this.currentMantraIndex = 0;
                    this.mantraKnownCount = 0;
                    this.mantraUnknownCount = 0;
                    document.getElementById('mantra-summary').classList.add('hidden');
                    document.getElementById('mantra-summary-actions').innerHTML = '';
                    document.getElementById('mantra-card-area').classList.remove('hidden');
                    this.showMantraCard();
                } else {
                    // filter to unknowns
                    const unknownIndexes = this.mantraSeen.filter(s => !s.known).map(s => s.index);
                    if (unknownIndexes.length === 0) {
                        // nothing to repeat
                        alert('–ù–µ—Ç –Ω–µ–ø—Ä–æ—Ö–æ–¥–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è.');
                        return;
                    }
                    this.mantraCards = unknownIndexes.map(i => this.mantraCards[i]);
                    this.currentMantraIndex = 0;
                    this.mantraKnownCount = 0;
                    this.mantraUnknownCount = 0;
                    this.mantraSeen = [];
                    document.getElementById('mantra-summary').classList.add('hidden');
                    document.getElementById('mantra-summary-actions').innerHTML = '';
                    document.getElementById('mantra-card-area').classList.remove('hidden');
                    this.showMantraCard();
                }
            },

            // [–ò–ó–ú–ï–ù–ï–ù–û] –§—É–Ω–∫—Ü–∏—è –£–î–ê–õ–ï–ù–ê, —Ç–∞–∫ –∫–∞–∫ HTML –∫–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∞
            // returnToCarouselList() { ... }

            // ==================== –õ–û–ì–ò–ö–ê –ö–ê–†–£–°–ï–õ–ò –ê–°–°–û–¶–ò–ê–¶–ò–ô ====================
            startAssociationsCarousel(topicId) {
                this.openModal('associations-modal');
                try {
                    // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Å–ª–æ–≤–∞ —Ç–µ–º—ã —Å mnemo = 1
                    const associationWords = this.allWords.filter(word => 
                        word.topics && 
                        word.topics.includes(topicId) && 
                        word.mnemo === 1 &&
                        word.association && 
                        word.association.trim() !== ''
                    );
                    
                    if (associationWords.length === 0) {
                        document.getElementById('associations-modal-body').innerHTML = '<p class="text-center text-gray-500 py-6">–ù–µ—Ç –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–π –¥–ª—è —ç—Ç–æ–π —Ç–µ–º—ã.</p>';
                        return;
                    }
                    
                    this.associationCards = associationWords;
                    this.currentAssociationIndex = 0;
                    this.showAssociationCard();
                } catch (err) {
                    console.error('Associations load error', err);
                    document.getElementById('associations-modal-body').innerHTML = `<p class="text-red-500 text-center py-6">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–π: ${err.message}</p>`;
                }
            },

            showAssociationCard() {
                if (!this.associationCards || this.associationCards.length === 0) return;
                
                const card = this.associationCards[this.currentAssociationIndex];
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
                document.getElementById('associations-progress').textContent = 
                    `–ö–∞—Ä—Ç–æ—á–∫–∞ ${this.currentAssociationIndex + 1} / ${this.associationCards.length}`;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É
                const imgElement = document.getElementById('association-image');
                imgElement.src = card.image || '/images/placeholder.jpg';
                imgElement.alt = card.word;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ª–æ–≤–æ —Å –∞—Ä—Ç–∏–∫–ª–µ–º
                const displayWord = (card.article && card.article !== '‚Äî' && card.partOfSpeech && card.partOfSpeech.toLowerCase().includes('noun')) 
                    ? `${card.article} ${card.word}` 
                    : card.word;
                document.getElementById('association-word').textContent = displayWord;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–µ—Ä–µ–≤–æ–¥
                const translation = Array.isArray(card.translation) 
                    ? card.translation.join(', ') 
                    : card.translation;
                document.getElementById('association-translation').textContent = translation;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–∏
                document.getElementById('association-text').textContent = card.association || '–ù–µ—Ç —Ç–µ–∫—Å—Ç–∞ –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–∏';
            },

            showNextAssociation() {
                if (!this.associationCards || this.associationCards.length === 0) return;
                this.currentAssociationIndex = (this.currentAssociationIndex + 1) % this.associationCards.length;
                this.showAssociationCard();
            },

            showPrevAssociation() {
                if (!this.associationCards || this.associationCards.length === 0) return;
                this.currentAssociationIndex = (this.currentAssociationIndex - 1 + this.associationCards.length) % this.associationCards.length;
                this.showAssociationCard();
            },


            // ==================== –õ–û–ì–ò–ö–ê –ü–û–í–¢–û–†–ï–ù–ò–Ø (–ò–ó–ú–ï–ù–ï–ù–û) ====================

            renderWordList(setId, topicId) {
                // topicId —Ç–µ–ø–µ—Ä—å —ç—Ç–æ ID —Ç–µ–º—ã –∏–∑ topics.json (–Ω–∞–ø—Ä–∏–º–µ—Ä "health")
                const topic = this.allTopics.find(t => t.id === topicId);
                if (!topic) {
                    console.error('Topic not found:', topicId);
                    document.getElementById('list-title').innerText = `üìö –°–ª–æ–≤–∞ –ø–æ —Ç–µ–º–µ`;
                } else {
                    document.getElementById('list-title').innerText = `üìö ${topic.name}`;
                }
                
                const subtitleEl = document.getElementById('list-subtitle');
                if (subtitleEl) subtitleEl.style.display = 'none';
                
                const filterControls = document.getElementById('filter-controls');
                if (filterControls) filterControls.style.display = 'none';
                
                const contentListDiv = document.getElementById('content-list');
                contentListDiv.innerHTML = '<p class="text-gray-500 text-center py-6">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ª–æ–≤...</p>';
                
                this.showScreen('list-screen', false, { renderFunc: 'renderWordList', param: {setId, topicId} });
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
                if (!this.selectedWordsForStudy) {
                    this.selectedWordsForStudy = {};
                }
                
                // –í—Ä–µ–º–µ–Ω–Ω—ã–π –º–∞—Å—Å–∏–≤ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å–ª–æ–≤ (—Ç–æ–ª—å–∫–æ –¥–ª—è —ç—Ç–æ–≥–æ —ç–∫—Ä–∞–Ω–∞)
                if (!this.tempSelectedWords) {
                    this.tempSelectedWords = [];
                }
                this.tempSelectedWords = [];
                
                // –§–∏–ª—å—Ç—Ä—É–µ–º —Å–ª–æ–≤–∞ –ø–æ —Ç–µ–º–µ –∏–∑ allWords
                const words = this.allWords.filter(word => word.topics && word.topics.includes(topicId));
                
                if (words.length === 0) {
                    contentListDiv.innerHTML = '<p class="text-gray-500 text-center py-6">–ù–µ—Ç —Å–ª–æ–≤ –≤ —ç—Ç–æ–π —Ç–µ–º–µ.</p>';
                    return;
                }
                
                contentListDiv.innerHTML = '';
                
                // –°–æ–∑–¥–∞–µ–º –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å –≥–∞–ª–æ—á–∫–æ–π "–í—ã–±—Ä–∞—Ç—å –≤—Å–µ" –∏ –∫–Ω–æ–ø–∫–æ–π "–£—á–∏—Ç—å"
                const controlPanel = document.createElement('div');
                controlPanel.id = 'word-selection-controls';
                controlPanel.className = 'mb-4 p-4 bg-white rounded-xl shadow-md flex items-center justify-between gap-3';
                controlPanel.innerHTML = `
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="select-all-words" class="w-5 h-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span class="font-semibold text-gray-700">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ</span>
                    </label>
                    <button id="add-selected-to-study" class="px-6 py-2 bg-blue-500 text-white font-semibold rounded-lg shadow hover:bg-blue-600 transition hidden">
                        –£—á–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ
                    </button>
                `;
                contentListDiv.appendChild(controlPanel);
                
                const selectAllCheckbox = controlPanel.querySelector('#select-all-words');
                const addToStudyBtn = controlPanel.querySelector('#add-selected-to-study');
                
                // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–Ω–æ–ø–∫–∏ "–£—á–∏—Ç—å"
                const updateStudyButton = () => {
                    if (this.tempSelectedWords.length > 0) {
                        addToStudyBtn.textContent = `–£—á–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ (${this.tempSelectedWords.length})`;
                        addToStudyBtn.classList.remove('hidden');
                    } else {
                        addToStudyBtn.classList.add('hidden');
                    }
                };
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ "–í—ã–±—Ä–∞—Ç—å –≤—Å–µ"
                selectAllCheckbox.addEventListener('change', (e) => {
                    const isChecked = e.target.checked;
                    const checkboxes = contentListDiv.querySelectorAll('.word-checkbox');
                    checkboxes.forEach(cb => {
                        cb.checked = isChecked;
                    });
                    
                    if (isChecked) {
                        this.tempSelectedWords = words.map(w => w.id);
                    } else {
                        this.tempSelectedWords = [];
                    }
                    updateStudyButton();
                });
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–£—á–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ"
                addToStudyBtn.addEventListener('click', () => {
                    if (this.tempSelectedWords.length === 0) return;
                    
                    const selectedCount = this.tempSelectedWords.length;
                    const today = this.getTodayDateString();
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Å–ª–æ–≤–∞ –≤ selectedWordsForStudy
                    if (!this.selectedWordsForStudy[topicId]) {
                        this.selectedWordsForStudy[topicId] = [];
                    }
                    
                    let addedCount = 0;
                    this.tempSelectedWords.forEach(wordId => {
                        const wordData = words.find(w => w.id === wordId);
                        if (wordData && !this.selectedWordsForStudy[topicId].some(w => w.id === wordId)) {
                            this.selectedWordsForStudy[topicId].push(wordData);
                            addedCount++;
                            
                            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –¥–ª—è —Å–∏—Å—Ç–µ–º—ã –∏–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω–æ–≥–æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è
                            if (!this.userProgress[wordId]) {
                                this.userProgress[wordId] = {
                                    isLearning: true,
                                    box: 0, // –ù–∞—á–∏–Ω–∞–µ–º —Å Box 0
                                    nextReview: today, // –î–æ—Å—Ç—É–ø–Ω–æ –∫ –ø–æ–≤—Ç–æ—Ä—É —Å–µ–≥–æ–¥–Ω—è
                                    lastReviewed: today
                                };
                            } else if (!this.userProgress[wordId].isLearning) {
                                // –ï—Å–ª–∏ —Å–ª–æ–≤–æ –±—ã–ª–æ, –Ω–æ –Ω–µ –≤ –æ–±—É—á–µ–Ω–∏–∏ - –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º
                                this.userProgress[wordId].isLearning = true;
                                this.userProgress[wordId].box = 0;
                                this.userProgress[wordId].nextReview = today;
                                this.userProgress[wordId].lastReviewed = today;
                            }
                        }
                    });
                    
                    this.saveProgress();
                    
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä
                    this.tempSelectedWords = [];
                    selectAllCheckbox.checked = false;
                    
                    // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫
                    this.renderWordList(setId, topicId);
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    alert(`–î–æ–±–∞–≤–ª–µ–Ω–æ ${addedCount} —Å–ª–æ–≤ –≤ –æ–±—É—á–µ–Ω–∏–µ!`);
                });
                
                // –°–æ–∑–¥–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤
                words.forEach(wordData => {
                    const wordId = wordData.id;
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞—Ä—Ç–∏–∫–ª—å —Ç–æ–ª—å–∫–æ –¥–ª—è —Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –∏ –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ —Ç–∏—Ä–µ
                    const displayWord = (wordData.article && wordData.article !== '‚Äî' && wordData.partOfSpeech && wordData.partOfSpeech.toLowerCase().includes('noun')) 
                        ? `${wordData.article} ${wordData.word}` 
                        : wordData.word;
                    const translation = Array.isArray(wordData.translation) ? wordData.translation.join(', ') : wordData.translation;
                    const isInStudy = this.selectedWordsForStudy[topicId] && 
                                      this.selectedWordsForStudy[topicId].some(w => w.id === wordId);
                    
                    const wordItem = document.createElement('div');
                    wordItem.className = 'p-4 bg-white rounded-xl shadow-md flex items-center gap-3 hover:bg-gray-50 transition';
                    wordItem.dataset.wordId = wordId;
                    
                    // –ß–µ–∫–±–æ–∫—Å –¥–ª—è –≤—ã–±–æ—Ä–∞
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'word-checkbox w-5 h-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500';
                    checkbox.checked = this.tempSelectedWords.includes(wordId);
                    checkbox.addEventListener('change', (e) => {
                        e.stopPropagation();
                        if (e.target.checked) {
                            if (!this.tempSelectedWords.includes(wordId)) {
                                this.tempSelectedWords.push(wordId);
                            }
                        } else {
                            this.tempSelectedWords = this.tempSelectedWords.filter(id => id !== wordId);
                            selectAllCheckbox.checked = false;
                        }
                        updateStudyButton();
                    });

                    // –õ–µ–≤–∞—è —á–∞—Å—Ç—å: –Ω–µ–º–µ—Ü–∫–æ–µ —Å–ª–æ–≤–æ –∏ –ø–µ—Ä–µ–≤–æ–¥ (–±–µ–∑ –∫–∞—Ä—Ç–∏–Ω–∫–∏)
                    const wordInfo = document.createElement('div');
                    wordInfo.className = 'flex-1 cursor-pointer';
                    wordInfo.innerHTML = `
                        <div class="font-bold text-lg text-gray-800">${displayWord}</div>
                        <div class="text-sm text-gray-500">${translation}</div>
                    `;
                    
                    // –ö–ª–∏–∫ –Ω–∞ —Ç–µ–∫—Å—Ç –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –Ω–æ–≤—ã–π —ç–∫—Ä–∞–Ω —Å–ª–æ–≤–∞
                    const currentIndex = words.indexOf(wordData);
                    wordInfo.addEventListener('click', () => {
                        this.openWordDetailScreen(wordData, topicId, wordId, words, currentIndex);
                    });

                    // –ö–Ω–æ–ø–∫–∞ –æ–∑–≤—É—á–∫–∏
                    const speakBtn = document.createElement('button');
                    speakBtn.className = 'p-2 bg-blue-100 hover:bg-blue-200 rounded-lg transition';
                    speakBtn.innerHTML = `
                        <svg class="w-6 h-6 text-blue-600" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                        </svg>
                    `;
                    speakBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const utterance = new SpeechSynthesisUtterance(wordData.word); // –±–µ–∑ –∞—Ä—Ç–∏–∫–ª—è
                        utterance.lang = 'de-DE';
                        window.speechSynthesis.speak(utterance);
                    });

                    wordItem.appendChild(checkbox);
                    wordItem.appendChild(wordInfo);
                    wordItem.appendChild(speakBtn);
                    
                    // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä "–í —É—á–µ–±–µ" - —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–ª–æ–≤–æ –≤ —É—á–µ–±–µ
                    if (isInStudy) {
                        const studyIndicator = document.createElement('div');
                        studyIndicator.className = 'px-4 py-2 bg-yellow-500 text-white text-sm font-bold rounded-lg shadow-sm';
                        studyIndicator.innerHTML = '<img src="assets/icons/carrds.png" alt="" class="inline-block w-5 h-5 mr-1 align-text-bottom">–í —É—á–µ–±–µ';
                        wordItem.appendChild(studyIndicator);
                    }
                    contentListDiv.appendChild(wordItem);
                });
            },

            renderExercisesMenu(topicId, weekNum) {
                const topic = this.allTopics.find(t => t.id === topicId);
                const topicName = topic ? topic.name : '–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è';
                
                document.getElementById('list-title').innerText = `‚úèÔ∏è ${topicName}: –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø`;
                
                const filterControls = document.getElementById('filter-controls');
                if (filterControls) filterControls.style.display = 'none';
                
                const contentListDiv = document.getElementById('content-list');
                contentListDiv.innerHTML = '';
                
                this.showScreen('list-screen', false, { renderFunc: 'renderExercisesMenu', param: {topicId, weekNum} });
                
                // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–∏–ø–æ–≤ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π
                this.renderMenuCard(contentListDiv,
                    'üìù –ó–∞–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–æ–±–µ–ª',
                    '–í—Å—Ç–∞–≤—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–ª–æ–≤–æ –≤ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ',
                    `window.App.renderExercises('${topicId}', ${weekNum})`,
                    'bg-blue-100 hover:bg-blue-200'
                );
                
                this.renderMenuCard(contentListDiv,
                    'üîä –£–≥–∞–¥–∞–π –ø–æ –∑–≤—É—á–∞–Ω–∏—é',
                    '–ü—Ä–æ—Å–ª—É—à–∞–π—Ç–µ —Å–ª–æ–≤–æ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç',
                    `window.App.renderAudioExercises('${topicId}', ${weekNum})`,
                    'bg-green-100 hover:bg-green-200'
                );
                
                this.renderMenuCard(contentListDiv,
                    'üìö –£–≥–∞–¥–∞–π –∞—Ä—Ç–∏–∫–ª—å',
                    '–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∞—Ä—Ç–∏–∫–ª—å –¥–ª—è —Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–≥–æ',
                    `window.App.renderArticleExercises('${topicId}', ${weekNum})`,
                    'bg-purple-100 hover:bg-purple-200'
                );
                
                this.renderMenuCard(contentListDiv,
                    'üñºÔ∏è –£–≥–∞–¥–∞–π –ø–æ –∫–∞—Ä—Ç–∏–Ω–∫–µ',
                    '–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–ª–æ–≤–æ',
                    `window.App.renderImageMatchExercises('${topicId}', ${weekNum})`,
                    'bg-yellow-100 hover:bg-yellow-200'
                );
                
                this.renderMenuCard(contentListDiv,
                    'üî§ –°–æ–±–µ—Ä–∏ —Å–ª–æ–≤–æ',
                    '–°–æ—Å—Ç–∞–≤—å—Ç–µ —Å–ª–æ–≤–æ –∏–∑ –ø–µ—Ä–µ–º–µ—à–∞–Ω–Ω—ã—Ö –±—É–∫–≤',
                    `window.App.renderWordBuildingExercises('${topicId}', ${weekNum})`,
                    'bg-pink-100 hover:bg-pink-200'
                );
                
                // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∏–µ —Ç–∏–ø—ã —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –ø–æ–∑–∂–µ
                // this.renderMenuCard(contentListDiv,
                //     'üó£Ô∏è –ü—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏–µ',
                //     '–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏—è',
                //     `window.App.renderPronunciationExercises('${topicId}', ${weekNum})`,
                //     'bg-green-100 hover:bg-green-200'
                // );
            },

            // –ó–≤—É–∫–æ–≤—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã
            playCorrectSound() {
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    
                    // iOS —Ç—Ä–µ–±—É–µ—Ç resume –ø–æ—Å–ª–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –∂–µ—Å—Ç–∞
                    if (audioContext.state === 'suspended') {
                        audioContext.resume();
                    }
                    
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.value = 800;
                    oscillator.type = 'sine';
                    
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.3);
                    
                    // –í—Ç–æ—Ä–æ–π —Ç–æ–Ω –¥–ª—è –ø—Ä–∏—è—Ç–Ω–æ–≥–æ –∑–≤—É–∫–∞
                    setTimeout(() => {
                        const osc2 = audioContext.createOscillator();
                        const gain2 = audioContext.createGain();
                        osc2.connect(gain2);
                        gain2.connect(audioContext.destination);
                        osc2.frequency.value = 1000;
                        osc2.type = 'sine';
                        gain2.gain.setValueAtTime(0.2, audioContext.currentTime);
                        gain2.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                        osc2.start(audioContext.currentTime);
                        osc2.stop(audioContext.currentTime + 0.2);
                    }, 50);
                } catch (error) {
                    console.log('Sound not supported:', error);
                }
            },
            
            playIncorrectSound() {
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    
                    // iOS —Ç—Ä–µ–±—É–µ—Ç resume –ø–æ—Å–ª–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –∂–µ—Å—Ç–∞
                    if (audioContext.state === 'suspended') {
                        audioContext.resume();
                    }
                    
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.value = 200;
                    oscillator.type = 'sawtooth';
                    
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.4);
                } catch (error) {
                    console.log('Sound not supported:', error);
                }
            },

            renderExercises(topicId, weekNum, exercisesToShow = null) {
                const topic = this.allTopics.find(t => t.id === topicId);
                const topicName = topic ? topic.name : '–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è';
                
                const isRetry = exercisesToShow !== null;
                const titleText = isRetry ? `üìù ${topicName}: –ü–æ–≤—Ç–æ—Ä –æ—à–∏–±–æ–∫` : `üìù ${topicName}: –ó–∞–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–æ–±–µ–ª`;
                document.getElementById('list-title').innerText = titleText;
                
                const filterControls = document.getElementById('filter-controls');
                if (filterControls) filterControls.style.display = 'none';
                
                const contentListDiv = document.getElementById('content-list');
                contentListDiv.innerHTML = '<p class="text-gray-500 text-center py-6">–ó–∞–≥—Ä—É–∑–∫–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π...</p>';
                
                this.showScreen('list-screen', false, { renderFunc: 'renderExercises', param: {topicId, weekNum} });
                
                let exercises;
                
                if (isRetry) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
                    exercises = exercisesToShow;
                    this.wrongExercises = []; // –û—á–∏—â–∞–µ–º –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø—Ä–æ—Ö–æ–¥–∞
                } else {
                    // –û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º - –∑–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è —Ç–µ–º—ã
                    this.wrongExercises = []; // –û—á–∏—â–∞–µ–º –ø—Ä–∏ –Ω–æ–≤–æ–º –∑–∞–ø—É—Å–∫–µ
                    
                    // –ü–æ–ª—É—á–∞–µ–º —Å–ª–æ–≤–∞ —Ç–µ–º—ã
                    const topicWords = this.allWords.filter(word => word.topics && word.topics.includes(topicId));
                    const wordIds = topicWords.map(w => w.id);
                    
                    // –§–∏–ª—å—Ç—Ä—É–µ–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è —Ç–∏–ø–∞ gap_fill –¥–ª—è —Å–ª–æ–≤ —ç—Ç–æ–π —Ç–µ–º—ã
                    exercises = this.allExercises.filter(ex => 
                        ex.type === 'gap_fill' && wordIds.includes(ex.wordId)
                    );
                }
                
                if (exercises.length === 0) {
                    contentListDiv.innerHTML = '<p class="text-gray-500 text-center py-6">–ù–µ—Ç —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –¥–ª—è —ç—Ç–æ–π —Ç–µ–º—ã.</p>';
                    return;
                }

                // –ù–æ–≤—ã–π –ø–æ–∫–∞—Ä—Ç–æ—á–Ω—ã–π —Ä–µ–∂–∏–º –¥–ª—è gap fill
                this.gapFillExercises = exercises;
                this.currentGapFillIndex = 0;
                this.gapFillResults = {};
                this.showGapFillExerciseCard();
            },

            showGapFillExerciseCard() {
                const exercises = this.gapFillExercises;
                const idx = this.currentGapFillIndex;
                const exercise = exercises[idx];
                const total = exercises.length;
                const progress = Math.round(((idx + 1) / total) * 100);
                const contentListDiv = document.getElementById('content-list');
                contentListDiv.innerHTML = `
                    <div class="mb-4">
                        <div class="flex items-center justify-between text-sm text-gray-600 mb-2">
                            <span>${idx + 1} / ${total}</span>
                            <span>${progress}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div class="bg-blue-500 h-2.5 rounded-full transition-all duration-300" style="width: ${progress}%"></div>
                        </div>
                    </div>
                    <div class="carousel-card bg-white rounded-xl shadow-lg p-6 mb-4">
                        <div class="text-center mb-6">
                            <p class="text-xl font-bold text-gray-800 mb-4">${exercise.question || '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø—Ä–æ–ø—É—Å–∫'}</p>
                            <p class="text-lg text-gray-700 font-mono mb-2">${exercise.sentence.replace('___', '<span class=\'underline\'>___</span>')}</p>
                            ${exercise.sentence_ru ? `<p class='text-gray-500 text-sm italic'>${exercise.sentence_ru}</p>` : ''}
                        </div>
                        <div class="grid grid-cols-2 gap-3 mb-4 max-w-lg mx-auto" id="gapfill-options">${exercise.options.map(option => `
                                <button onclick="window.App.checkGapFillAnswer('${option}', this)" class="py-4 px-4 bg-gray-100 hover:bg-gray-200 rounded-lg transition text-gray-800 font-medium text-center">${option}</button>
                            `).join('')}
                        </div>
                        <div id="gapfill-explanation" class="hidden bg-blue-50 border-l-4 border-blue-400 p-4 rounded">
                            <p class="text-sm text-blue-800">üí° ${exercise.explanation || ''}</p>
                        </div>
                    </div>
                    <div class="flex justify-center space-x-4">
                        ${idx > 0 ? `<button onclick="window.App.prevGapFillExercise()" class="py-2 px-4 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition">&larr; –ù–∞–∑–∞–¥</button>` : ''}
                        ${idx < total - 1 ? `<button onclick="window.App.nextGapFillExercise()" class="py-2 px-5 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 transition">–î–∞–ª–µ–µ &rarr;</button>` : `<button onclick="window.App.finishGapFillExercises()" class="py-2 px-5 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 transition">–ó–∞–≤–µ—Ä—à–∏—Ç—å ‚úì</button>`}
                        <button onclick="window.App.handleTelegramBackClick()" class="py-2 px-4 bg-gray-500 text-white font-semibold rounded-lg hover:bg-gray-600 transition">‚úï –ó–∞–∫—Ä—ã—Ç—å</button>
                    </div>
                `;
            },

            checkGapFillAnswer(selected, button) {
                const exercise = this.gapFillExercises[this.currentGapFillIndex];
                if (this.gapFillResults[exercise.id]) return;
                if (button.disabled) return;
                const isCorrect = selected === exercise.answer;
                this.gapFillResults[exercise.id] = isCorrect;
                const explanationDiv = document.getElementById('gapfill-explanation');
                const optionsDiv = document.getElementById('gapfill-options');
                const allButtons = optionsDiv.querySelectorAll('button');
                allButtons.forEach(btn => {
                    btn.disabled = true;
                    btn.style.pointerEvents = 'none';
                });
                if (isCorrect) {
                    button.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                    button.classList.add('bg-green-500', 'text-white', 'font-bold');
                    this.playCorrectSound();
                } else {
                    button.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                    button.classList.add('bg-red-500', 'text-white', 'font-bold');
                    allButtons.forEach(btn => {
                        if (btn.textContent.trim() === exercise.answer) {
                            btn.classList.remove('bg-gray-100');
                            btn.classList.add('bg-green-500', 'text-white', 'font-bold');
                        }
                    });
                    this.playIncorrectSound();
                }
                explanationDiv.classList.remove('hidden');
            },

            prevGapFillExercise() {
                if (this.currentGapFillIndex > 0) {
                    this.currentGapFillIndex--;
                    this.showGapFillExerciseCard();
                }
            },

            nextGapFillExercise() {
                if (this.currentGapFillIndex < this.gapFillExercises.length - 1) {
                    this.currentGapFillIndex++;
                    this.showGapFillExerciseCard();
                }
            },

            finishGapFillExercises() {
                const total = this.gapFillExercises.length;
                const correct = Object.values(this.gapFillResults).filter(r => r).length;
                const percentage = Math.round((correct / total) * 100);
                const contentListDiv = document.getElementById('content-list');
                contentListDiv.innerHTML = `
                    <div class="max-w-2xl mx-auto px-4 py-20">
                        <div class="bg-white p-8 rounded-2xl shadow-2xl text-center">
                            <svg class="w-20 h-20 mx-auto mb-4 text-green-500" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"></path>
                            </svg>
                            <h2 class="text-3xl font-bold text-gray-800 mb-4">–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ! üéâ</h2>
                            <div class="text-xl text-gray-700 mb-6">
                                <p class="mb-2">–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: <span class="font-bold text-green-600">${correct}</span> –∏–∑ ${total}</p>
                                <p class="text-2xl font-bold ${percentage >= 80 ? 'text-green-600' : percentage >= 60 ? 'text-yellow-600' : 'text-red-600'}">
                                    ${percentage}%
                                </p>
                            </div>
                            <button onclick="window.App.handleTelegramBackClick()" class="btn-primary py-3 px-8 inline-flex items-center gap-2">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V20a2 2 0 002 2h12a2 2 0 002-2v-9.586l.707.707a1 1 0 001.414-1.414l-7-7z"></path>
                                </svg>
                                –í –º–µ–Ω—é
                            </button>
                        </div>
                    </div>
                `;
            },

            renderAudioExercises(topicId, weekNum) {
                const topic = this.allTopics.find(t => t.id === topicId);
                const topicName = topic ? topic.name : '–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è';
                
                this.showScreen('loading-screen', false);
                
                // –ü–æ–ª—É—á–∞–µ–º —Å–ª–æ–≤–∞ —Ç–µ–º—ã
                const topicWords = this.allWords.filter(word => word.topics && word.topics.includes(topicId));
                const wordIds = topicWords.map(w => w.id);
                
                // –§–∏–ª—å—Ç—Ä—É–µ–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è —Ç–∏–ø–∞ guess_by_audio –¥–ª—è —Å–ª–æ–≤ —ç—Ç–æ–π —Ç–µ–º—ã
                const exercises = this.allExercises.filter(ex => 
                    ex.type === 'guess_by_audio' && wordIds.includes(ex.wordId)
                );
                
                if (exercises.length === 0) {
                    document.getElementById('loading-screen').innerHTML = '<p class="text-gray-500 text-center py-6">–ù–µ—Ç –∞—É–¥–∏–æ-—É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –¥–ª—è —ç—Ç–æ–π —Ç–µ–º—ã.</p>';
                    return;
                }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–∞—Ä—É—Å–µ–ª–∏
                this.audioExercises = exercises.map(ex => {
                    const word = this.allWords.find(w => w.id === ex.wordId);
                    // –°–æ–∑–¥–∞–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤ –∏–∑ –ø–µ—Ä–µ–≤–æ–¥–æ–≤ —Å–ª–æ–≤
                    const optionsWithTranslations = ex.options.map(opt => {
                        const optWord = this.allWords.find(w => {
                            const fullWord = w.article ? `${w.article} ${w.word}` : w.word;
                            return fullWord === opt;
                        });
                        return {
                            german: opt,
                            russian: optWord ? optWord.translation.join(', ') : opt
                        };
                    });
                    
                    const correctWord = this.allWords.find(w => {
                        const fullWord = w.article ? `${w.article} ${w.word}` : w.word;
                        return fullWord === ex.answer;
                    });
                    
                    return {
                        ...ex,
                        word: word,
                        correctTranslation: correctWord ? correctWord.translation.join(', ') : ex.answer,
                        optionsWithTranslations: optionsWithTranslations
                    };
                });
                
                this.currentAudioExerciseIndex = 0;
                this.audioExerciseResults = {};
                this.showAudioExerciseCard();
                
                this.showScreen('image-carousel-screen', false, { 
                    renderFunc: 'renderAudioExercises', 
                    param: {topicId, weekNum} 
                });
            },

            showAudioExerciseCard() {
                const exercise = this.audioExercises[this.currentAudioExerciseIndex];
                const carouselScreen = document.getElementById('image-carousel-screen');
                const progress = Math.round(((this.currentAudioExerciseIndex + 1) / this.audioExercises.length) * 100);
                
                carouselScreen.innerHTML = `
                    <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä -->
                    <div class="mb-4">
                        <div class="flex items-center justify-between text-sm text-gray-600 mb-2">
                            <span>${this.currentAudioExerciseIndex + 1} / ${this.audioExercises.length}</span>
                            <span>${progress}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div class="bg-blue-500 h-2.5 rounded-full transition-all duration-300" style="width: ${progress}%"></div>
                        </div>
                    </div>

                    <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è -->
                    <div class="carousel-card bg-white rounded-xl shadow-lg p-6 mb-4">
                        <!-- –í–æ–ø—Ä–æ—Å -->
                        <div class="text-center mb-6">
                            <p class="text-xl font-bold text-gray-800 mb-4">${exercise.question}</p>
                            <button onclick="window.App.playAudio('${exercise.audioText}')" 
                                    class="w-16 h-16 bg-blue-500 hover:bg-blue-600 text-white rounded-full transition mx-auto shadow-lg flex items-center justify-center">
                                <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M8 5v14l11-7z"/>
                                </svg>
                            </button>
                        </div>
                        
                        <!-- –í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤ (—Ä—É—Å—Å–∫–∏–µ –ø–µ—Ä–µ–≤–æ–¥—ã) -->
                        <div class="grid grid-cols-2 gap-3 mb-4 max-w-lg mx-auto" id="audio-options-${exercise.id}">${exercise.optionsWithTranslations.map((opt, idx) => `
                                <button onclick="window.App.checkAudioAnswer('${exercise.id}', '${opt.russian.replace(/'/g, "\\'")}', this)" 
                                        class="py-4 px-4 bg-gray-100 hover:bg-gray-200 rounded-lg transition text-gray-800 font-medium text-center">
                                    ${opt.russian}
                                </button>
                            `).join('')}
                        </div>
                        
                        <!-- –ü–æ—è—Å–Ω–µ–Ω–∏–µ -->
                        <div id="audio-explanation-${exercise.id}" class="hidden bg-blue-50 border-l-4 border-blue-400 p-4 rounded">
                            <p class="text-sm text-blue-800">üí° ${exercise.explanation}</p>
                        </div>
                    </div>

                    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
                    <div class="flex justify-center space-x-4">
                        ${this.currentAudioExerciseIndex > 0 ? `
                            <button onclick="window.App.prevAudioExercise()" 
                                    class="py-2 px-4 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition">
                                &larr; –ù–∞–∑–∞–¥
                            </button>
                        ` : ''}
                        ${this.currentAudioExerciseIndex < this.audioExercises.length - 1 ? `
                            <button onclick="window.App.nextAudioExercise()" 
                                    class="py-2 px-5 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 transition">
                                –î–∞–ª–µ–µ &rarr;
                            </button>
                        ` : `
                            <button onclick="window.App.finishAudioExercises()" 
                                    class="py-2 px-5 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 transition">
                                –ó–∞–≤–µ—Ä—à–∏—Ç—å ‚úì
                            </button>
                        `}
                        <button onclick="window.App.handleTelegramBackClick()" 
                                class="py-2 px-4 bg-gray-500 text-white font-semibold rounded-lg hover:bg-gray-600 transition">
                            ‚úï –ó–∞–∫—Ä—ã—Ç—å
                        </button>
                    </div>
                `;
            },

            checkAudioAnswer(exerciseId, selectedRussian, button) {
                const exercise = this.audioExercises.find(ex => ex.id === exerciseId);
                if (!exercise || this.audioExerciseResults[exerciseId]) return;
                
                // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∫–ª–∏–∫
                if (button.disabled) return;
                
                const isCorrect = selectedRussian === exercise.correctTranslation;
                this.audioExerciseResults[exerciseId] = isCorrect;
                
                const explanationDiv = document.getElementById(`audio-explanation-${exerciseId}`);
                const optionsDiv = document.getElementById(`audio-options-${exerciseId}`);
                
                // –ë–ª–æ–∫–∏—Ä—É–µ–º –≤—Å–µ –∫–Ω–æ–ø–∫–∏
                const allButtons = optionsDiv.querySelectorAll('button');
                allButtons.forEach(btn => {
                    btn.disabled = true;
                    btn.style.pointerEvents = 'none';
                });
                
                // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫
                if (isCorrect) {
                    this.playCorrectSound();
                } else {
                    this.playIncorrectSound();
                }
                
                // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç
                if (isCorrect) {
                    button.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                    button.classList.add('bg-green-500', 'text-white', 'font-bold');
                } else {
                    button.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                    button.classList.add('bg-red-500', 'text-white', 'font-bold');
                    
                    // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
                    allButtons.forEach(btn => {
                        if (btn.textContent.trim() === exercise.correctTranslation) {
                            btn.classList.remove('bg-gray-100');
                            btn.classList.add('bg-green-500', 'text-white', 'font-bold');
                        }
                    });
                }
                
                explanationDiv.classList.remove('hidden');
            },

            prevAudioExercise() {
                if (this.currentAudioExerciseIndex > 0) {
                    this.currentAudioExerciseIndex--;
                    this.showAudioExerciseCard();
                }
            },

            nextAudioExercise() {
                if (this.currentAudioExerciseIndex < this.audioExercises.length - 1) {
                    this.currentAudioExerciseIndex++;
                    this.showAudioExerciseCard();
                }
            },

            finishAudioExercises() {
                const total = this.audioExercises.length;
                const correct = Object.values(this.audioExerciseResults).filter(r => r).length;
                const percentage = Math.round((correct / total) * 100);
                
                const carouselScreen = document.getElementById('image-carousel-screen');
                carouselScreen.innerHTML = `
                    <div class="max-w-2xl mx-auto px-4 py-20">
                        <div class="bg-white p-8 rounded-2xl shadow-2xl text-center">
                            <svg class="w-20 h-20 mx-auto mb-4 text-green-500" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"></path>
                            </svg>
                            <h2 class="text-3xl font-bold text-gray-800 mb-4">–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ! üéâ</h2>
                            <div class="text-xl text-gray-700 mb-6">
                                <p class="mb-2">–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: <span class="font-bold text-green-600">${correct}</span> –∏–∑ ${total}</p>
                                <p class="text-2xl font-bold ${percentage >= 80 ? 'text-green-600' : percentage >= 60 ? 'text-yellow-600' : 'text-red-600'}">
                                    ${percentage}%
                                </p>
                            </div>
                            <button onclick="window.App.handleTelegramBackClick()" 
                                    class="btn-primary py-3 px-8 inline-flex items-center gap-2">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V20a2 2 0 002 2h12a2 2 0 002-2v-9.586l.707.707a1 1 0 001.414-1.414l-7-7z"></path>
                                </svg>
                                –í –º–µ–Ω—é
                            </button>
                        </div>
                    </div>
                `;
            },

            renderArticleExercises(topicId, weekNum) {
                const topic = this.allTopics.find(t => t.id === topicId);
                const topicName = topic ? topic.name : '–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è';
                
                this.showScreen('loading-screen', false);
                
                // –ü–æ–ª—É—á–∞–µ–º —Å–ª–æ–≤–∞ —Ç–µ–º—ã (—Ç–æ–ª—å–∫–æ —Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ)
                const topicWords = this.allWords.filter(word => 
                    word.topics && word.topics.includes(topicId) && word.partOfSpeech === 'noun' && word.article
                );
                const wordIds = topicWords.map(w => w.id);
                
                // –§–∏–ª—å—Ç—Ä—É–µ–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è —Ç–∏–ø–∞ guess_article –¥–ª—è —Å–ª–æ–≤ —ç—Ç–æ–π —Ç–µ–º—ã
                const exercises = this.allExercises.filter(ex => 
                    ex.type === 'guess_article' && wordIds.includes(ex.wordId)
                );
                
                if (exercises.length === 0) {
                    document.getElementById('loading-screen').innerHTML = '<p class="text-gray-500 text-center py-6">–ù–µ—Ç —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –Ω–∞ –∞—Ä—Ç–∏–∫–ª–∏ –¥–ª—è —ç—Ç–æ–π —Ç–µ–º—ã.</p>';
                    return;
                }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–∞—Ä—É—Å–µ–ª–∏
                this.articleExercises = exercises.map(ex => {
                    const wordObj = this.allWords.find(w => w.id === ex.wordId);
                    return { ...ex, wordObj: wordObj };
                });
                
                this.currentArticleExerciseIndex = 0;
                this.articleExerciseResults = {};
                this.showArticleExerciseCard();
                
                this.showScreen('image-carousel-screen', false, { 
                    renderFunc: 'renderArticleExercises', 
                    param: {topicId, weekNum} 
                });
            },

            showArticleExerciseCard() {
                const exercise = this.articleExercises[this.currentArticleExerciseIndex];
                const carouselScreen = document.getElementById('image-carousel-screen');
                const progress = Math.round(((this.currentArticleExerciseIndex + 1) / this.articleExercises.length) * 100);
                
                carouselScreen.innerHTML = `
                    <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä -->
                    <div class="mb-4">
                        <div class="flex items-center justify-between text-sm text-gray-600 mb-2">
                            <span>${this.currentArticleExerciseIndex + 1} / ${this.articleExercises.length}</span>
                            <span>${progress}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div class="bg-purple-500 h-2.5 rounded-full transition-all duration-300" style="width: ${progress}%"></div>
                        </div>
                    </div>

                    <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è -->
                    <div class="carousel-card bg-white rounded-xl shadow-lg p-6 mb-4">
                        <!-- –í–æ–ø—Ä–æ—Å -->
                        <div class="text-center mb-6">
                            <div class="text-4xl font-bold text-purple-600 mb-4">${exercise.word}</div>
                            ${exercise.wordObj && exercise.wordObj.translation ? `
                                <div class="text-lg text-gray-600 italic">(${exercise.wordObj.translation.join(', ')})</div>
                            ` : ''}
                        </div>
                        
                        <!-- –í–∞—Ä–∏–∞–Ω—Ç—ã –∞—Ä—Ç–∏–∫–ª–µ–π -->
                        <div class="grid grid-cols-3 gap-3 mb-4" id="article-options-${exercise.id}">
                            ${exercise.options.map(article => `
                                <button onclick="window.App.checkArticleAnswer('${exercise.id}', '${article}', this)" 
                                        class="py-6 px-4 bg-gray-100 hover:bg-gray-200 rounded-lg transition text-gray-800 font-bold text-2xl">
                                    ${article}
                                </button>
                            `).join('')}
                        </div>
                        
                        <!-- –ü–æ—è—Å–Ω–µ–Ω–∏–µ -->
                        <div id="article-explanation-${exercise.id}" class="hidden bg-purple-50 border-l-4 border-purple-400 p-4 rounded">
                            <p class="text-sm text-purple-800">üí° ${exercise.explanation}</p>
                        </div>
                    </div>

                    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
                    <div class="flex justify-center space-x-3">
                        ${this.currentArticleExerciseIndex > 0 ? `
                            <button onclick="window.App.prevArticleExercise()" 
                                    class="py-2 px-4 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition">
                                &larr; –ù–∞–∑–∞–¥
                            </button>
                        ` : ''}
                        ${this.currentArticleExerciseIndex < this.articleExercises.length - 1 ? `
                            <button onclick="window.App.nextArticleExercise()" 
                                    class="py-2 px-5 bg-purple-500 text-white font-semibold rounded-lg shadow-md hover:bg-purple-600 transition">
                                –î–∞–ª–µ–µ &rarr;
                            </button>
                        ` : `
                            <button onclick="window.App.finishArticleExercises()" 
                                    class="py-2 px-5 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 transition">
                                –ó–∞–≤–µ—Ä—à–∏—Ç—å ‚úì
                            </button>
                        `}
                        <button onclick="window.App.handleTelegramBackClick()" 
                                class="py-2 px-4 bg-gray-500 text-white font-semibold rounded-lg hover:bg-gray-600 transition">
                            ‚úï –ó–∞–∫—Ä—ã—Ç—å
                        </button>
                    </div>
                `;
            },

            checkArticleAnswer(exerciseId, selectedArticle, button) {
                const exercise = this.articleExercises.find(ex => ex.id === exerciseId);
                if (!exercise || this.articleExerciseResults[exerciseId]) return;
                
                // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∫–ª–∏–∫
                if (button.disabled) return;
                
                const isCorrect = selectedArticle === exercise.answer;
                this.articleExerciseResults[exerciseId] = isCorrect;
                
                const explanationDiv = document.getElementById(`article-explanation-${exerciseId}`);
                const optionsDiv = document.getElementById(`article-options-${exerciseId}`);
                
                // –ë–ª–æ–∫–∏—Ä—É–µ–º –≤—Å–µ –∫–Ω–æ–ø–∫–∏
                const allButtons = optionsDiv.querySelectorAll('button');
                allButtons.forEach(btn => {
                    btn.disabled = true;
                    btn.style.pointerEvents = 'none';
                });
                
                // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫
                if (isCorrect) {
                    this.playCorrectSound();
                } else {
                    this.playIncorrectSound();
                }
                
                // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç
                if (isCorrect) {
                    button.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                    button.classList.add('bg-green-500', 'text-white', 'font-bold');
                } else {
                    button.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                    button.classList.add('bg-red-500', 'text-white', 'font-bold');
                    
                    // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
                    allButtons.forEach(btn => {
                        if (btn.textContent.trim() === exercise.answer) {
                            btn.classList.remove('bg-gray-100');
                            btn.classList.add('bg-green-500', 'text-white', 'font-bold');
                        }
                    });
                }
                
                explanationDiv.classList.remove('hidden');
            },

            prevArticleExercise() {
                if (this.currentArticleExerciseIndex > 0) {
                    this.currentArticleExerciseIndex--;
                    this.showArticleExerciseCard();
                }
            },

            nextArticleExercise() {
                if (this.currentArticleExerciseIndex < this.articleExercises.length - 1) {
                    this.currentArticleExerciseIndex++;
                    this.showArticleExerciseCard();
                }
            },

            finishArticleExercises() {
                const total = this.articleExercises.length;
                const correct = Object.values(this.articleExerciseResults).filter(r => r).length;
                const percentage = Math.round((correct / total) * 100);
                
                const carouselScreen = document.getElementById('image-carousel-screen');
                carouselScreen.innerHTML = `
                    <div class="max-w-2xl mx-auto px-4 py-20">
                        <div class="bg-white p-8 rounded-2xl shadow-2xl text-center">
                            <svg class="w-20 h-20 mx-auto mb-4 text-green-500" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"></path>
                            </svg>
                            <h2 class="text-3xl font-bold text-gray-800 mb-4">–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ! üéâ</h2>
                            <div class="text-xl text-gray-700 mb-6">
                                <p class="mb-2">–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: <span class="font-bold text-green-600">${correct}</span> –∏–∑ ${total}</p>
                                <p class="text-2xl font-bold ${percentage >= 80 ? 'text-green-600' : percentage >= 60 ? 'text-yellow-600' : 'text-red-600'}">
                                    ${percentage}%
                                </p>
                            </div>
                            <button onclick="window.App.handleTelegramBackClick()" 
                                    class="btn-primary py-3 px-8 inline-flex items-center gap-2">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V20a2 2 0 002 2h12a2 2 0 002-2v-9.586l.707.707a1 1 0 001.414-1.414l-7-7z"></path>
                                </svg>
                                –í –º–µ–Ω—é
                            </button>
                        </div>
                    </div>
                `;
            },

            renderWordBuildingExercises(topicId, weekNum) {
            const topic = this.allTopics.find(t => t.id === topicId);
            
            this.showScreen('loading-screen', false);
            
            const filteredExercises = this.allExercises.filter(ex => {
                const word = this.allWords.find(w => w.id === ex.wordId);
                if (!word) return false;
                return ex.type === 'word_building' && 
                       word.topics && word.topics.includes(topicId);
            });

            if (filteredExercises.length === 0) {
                document.getElementById('loading-screen').innerHTML = '<p class="text-gray-500 text-center py-6">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π –¥–ª—è —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Å–ª–æ–≤ –≤ —ç—Ç–æ–π —Ç–µ–º–µ.</p>';
                return;
            }

            // Shuffle letters for each exercise
            this.wordBuildingExercises = filteredExercises.map(ex => {
                const word = this.allWords.find(w => w.id === ex.wordId);
                const shuffledLetters = [...ex.scrambledLetters].sort(() => Math.random() - 0.5);
                return {
                    ...ex,
                    wordObj: word,
                    shuffledLetters: shuffledLetters,
                    userAnswer: []
                };
            });

            this.currentWordBuildingIndex = 0;
            this.wordBuildingResults = [];
            this.showWordBuildingExerciseCard();
        },

        showWordBuildingExerciseCard() {
            const exercise = this.wordBuildingExercises[this.currentWordBuildingIndex];
            
            // Reset user answer for this exercise
            exercise.userAnswer = [];
            
            const progress = this.currentWordBuildingIndex + 1;
            const total = this.wordBuildingExercises.length;

            document.getElementById('loading-screen').innerHTML = `
                <div class="max-w-3xl mx-auto">
                    <!-- Progress bar -->
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-medium text-pink-700">–ü—Ä–æ–≥—Ä–µ—Å—Å</span>
                            <span class="text-sm font-medium text-pink-700">${Math.round((progress / total) * 100)}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3">
                            <div class="bg-pink-500 h-3 rounded-full transition-all duration-300" style="width: ${(progress / total) * 100}%"></div>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow-lg p-8">
                        <p class="text-3xl font-bold mb-6 text-center">${exercise.hint}</p>
                        
                        <!-- User answer area -->
                        <div id="answerArea" class="min-h-20 bg-blue-50 border-2 border-blue-300 rounded-lg p-4 mb-6 flex flex-wrap gap-2 items-center justify-center">
                            <span class="text-gray-400" id="emptyPlaceholder">–í—ã–±–µ—Ä–∏—Ç–µ –±—É–∫–≤—ã –Ω–∏–∂–µ</span>
                        </div>

                        <!-- Available letters -->
                        <div id="lettersArea" class="flex flex-wrap gap-2 justify-center mb-6">
                            ${exercise.shuffledLetters.map((letter, index) => `
                                <button onclick="window.App.addLetterToAnswer(${index})" 
                                        id="letter-${index}"
                                        class="letter-btn w-12 h-12 bg-white border-2 border-gray-300 hover:border-blue-500 rounded-lg font-bold text-xl transition-all hover:shadow-md">
                                    ${letter}
                                </button>
                            `).join('')}
                        </div>

                        <div class="flex gap-4 mb-6">
                            <button onclick="window.App.clearWordBuildingAnswer()" class="flex-1 px-6 py-3 bg-gray-200 hover:bg-gray-300 rounded-lg font-semibold text-2xl">
                                üóëÔ∏è
                            </button>
                            <button onclick="window.App.checkWordBuildingAnswer()" id="checkBtn" class="flex-1 px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-semibold text-2xl">
                                ‚úì
                            </button>
                        </div>

                        <div class="flex justify-between items-center">
                            ${this.currentWordBuildingIndex === 0 ? '' : `
                                <button onclick="window.App.prevWordBuildingExercise()" id="prevBtn" class="px-6 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg">
                                    ‚Üê –ù–∞–∑–∞–¥
                                </button>
                            `}
                            <button onclick="window.App.nextWordBuildingExercise()" id="nextBtn" class="px-6 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg hidden">
                                –î–∞–ª–µ–µ ‚Üí
                            </button>
                            <button onclick="window.App.finishWordBuildingExercises()" id="finishBtn" class="px-6 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg hidden">
                                –ó–∞–≤–µ—Ä—à–∏—Ç—å
                            </button>
                            <button onclick="window.App.handleTelegramBackClick()" 
                                    class="py-2 px-4 bg-gray-500 text-white font-semibold rounded-lg hover:bg-gray-600 transition">
                                ‚úï –ó–∞–∫—Ä—ã—Ç—å
                            </button>
                        </div>
                    </div>
                </div>
            `;
        },

        addLetterToAnswer(letterIndex) {
            const exercise = this.wordBuildingExercises[this.currentWordBuildingIndex];
            const letter = exercise.shuffledLetters[letterIndex];
            
            // Add to user answer
            exercise.userAnswer.push({letter, originalIndex: letterIndex});
            
            // Hide letter button
            document.getElementById(`letter-${letterIndex}`).classList.add('hidden');
            
            // Update answer area
            this.updateAnswerArea();
        },

        removeLetterFromAnswer(answerIndex) {
            const exercise = this.wordBuildingExercises[this.currentWordBuildingIndex];
            const removed = exercise.userAnswer.splice(answerIndex, 1)[0];
            
            // Show letter button again
            document.getElementById(`letter-${removed.originalIndex}`).classList.remove('hidden');
            
            // Update answer area
            this.updateAnswerArea();
        },

        updateAnswerArea() {
            const exercise = this.wordBuildingExercises[this.currentWordBuildingIndex];
            const answerArea = document.getElementById('answerArea');
            
            if (exercise.userAnswer.length === 0) {
                answerArea.innerHTML = '<span class="text-gray-400" id="emptyPlaceholder">–í—ã–±–µ—Ä–∏—Ç–µ –±—É–∫–≤—ã –Ω–∏–∂–µ</span>';
            } else {
                answerArea.innerHTML = exercise.userAnswer.map((item, index) => `
                    <button onclick="window.App.removeLetterFromAnswer(${index})" 
                            class="w-12 h-12 bg-white border-2 border-blue-500 rounded-lg font-bold text-xl hover:bg-red-50 hover:border-red-500 transition-all">
                        ${item.letter}
                    </button>
                `).join('');
            }
        },

        clearWordBuildingAnswer() {
            const exercise = this.wordBuildingExercises[this.currentWordBuildingIndex];
            exercise.userAnswer = [];
            
            // Show all letter buttons and enable them
            exercise.shuffledLetters.forEach((_, index) => {
                const btn = document.getElementById(`letter-${index}`);
                if (btn) {
                    btn.classList.remove('hidden');
                    btn.disabled = false;
                }
            });
            
            // Enable check button
            const checkBtn = document.getElementById('checkBtn');
            if (checkBtn) {
                checkBtn.disabled = false;
                checkBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
            
            // Reset answer area styling
            const answerArea = document.getElementById('answerArea');
            if (answerArea) {
                answerArea.classList.remove('border-green-500', 'bg-green-50', 'border-red-500', 'bg-red-50');
                answerArea.classList.add('border-blue-300', 'bg-blue-50');
            }
            
            this.updateAnswerArea();
        },

        checkWordBuildingAnswer() {
            const exercise = this.wordBuildingExercises[this.currentWordBuildingIndex];
            const checkBtn = document.getElementById('checkBtn');
            
            // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∫–ª–∏–∫
            if (checkBtn.disabled) return;
            
            const userWord = exercise.userAnswer.map(item => item.letter).join('');
            const isCorrect = userWord === exercise.answer;

            // Save result
            this.wordBuildingResults.push({
                exerciseId: exercise.id,
                correct: isCorrect
            });

            const answerArea = document.getElementById('answerArea');
            
            // Disable check button and letter buttons
            checkBtn.disabled = true;
            checkBtn.classList.add('opacity-50', 'cursor-not-allowed');
            document.querySelectorAll('.letter-btn').forEach(btn => {
                btn.disabled = true;
                btn.style.pointerEvents = 'none';
            });
            document.querySelectorAll('#answerArea button').forEach(btn => {
                btn.disabled = true;
                btn.style.pointerEvents = 'none';
            });

            // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫
            if (isCorrect) {
                this.playCorrectSound();
            } else {
                this.playIncorrectSound();
            }

            // –¶–≤–µ—Ç–æ–≤–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è –±–µ–∑ –±–ª–æ–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
            if (isCorrect) {
                answerArea.classList.add('border-green-500', 'bg-green-50');
                answerArea.classList.remove('border-blue-300', 'bg-blue-50');
            } else {
                answerArea.classList.add('border-red-500', 'bg-red-50');
                answerArea.classList.remove('border-blue-300', 'bg-blue-50');
            }

            // Show navigation buttons
            const nextBtn = document.getElementById('nextBtn');
            const finishBtn = document.getElementById('finishBtn');
            
            if (this.currentWordBuildingIndex < this.wordBuildingExercises.length - 1) {
                nextBtn.classList.remove('hidden');
            } else {
                finishBtn.classList.remove('hidden');
            }
        },

        prevWordBuildingExercise() {
            if (this.currentWordBuildingIndex > 0) {
                this.currentWordBuildingIndex--;
                this.showWordBuildingExerciseCard();
            }
        },

        nextWordBuildingExercise() {
            if (this.currentWordBuildingIndex < this.wordBuildingExercises.length - 1) {
                this.currentWordBuildingIndex++;
                this.showWordBuildingExerciseCard();
            }
        },

        finishWordBuildingExercises() {
            const correctCount = this.wordBuildingResults.filter(r => r.correct).length;
            const total = this.wordBuildingResults.length;
            const percentage = Math.round((correctCount / total) * 100);

            const exercise = this.wordBuildingExercises[0];
            const topicId = exercise.wordObj.topics[0].topicId;
            const weekNum = exercise.wordObj.topics[0].weekNum;

            document.getElementById('loading-screen').innerHTML = `
                <div class="max-w-2xl mx-auto">
                    <div class="bg-white rounded-lg shadow-lg p-8 text-center">
                        <h2 class="text-3xl font-bold mb-4">–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ! üéâ</h2>
                        <p class="text-6xl mb-4">${percentage >= 70 ? 'üåü' : 'üí™'}</p>
                        <p class="text-2xl mb-6">–í—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å–æ–±—Ä–∞–ª–∏ ${correctCount} –∏–∑ ${total} —Å–ª–æ–≤</p>
                        <p class="text-4xl font-bold mb-8">${percentage}%</p>
                        <div class="flex gap-4 justify-center">
                            <button onclick="window.App.renderExercisesMenu('${topicId}', ${weekNum})" class="px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-semibold">
                                ‚Üê –ö —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è–º
                            </button>
                            <button onclick="window.App.renderWordBuildingExercises('${topicId}', ${weekNum})" class="px-6 py-3 bg-green-500 hover:bg-green-600 text-white rounded-lg font-semibold">
                                üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å
                            </button>
                        </div>
                    </div>
                </div>
            `;
        },

        renderImageMatchExercises(topicId, weekNum) {
                const topic = this.allTopics.find(t => t.id === topicId);
                const topicName = topic ? topic.name : '–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è';
                
                this.showScreen('loading-screen', false);
                
                // –ü–æ–ª—É—á–∞–µ–º —Å–ª–æ–≤–∞ —Ç–µ–º—ã (—Ç–æ–ª—å–∫–æ —Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ —Å –∫–∞—Ä—Ç–∏–Ω–∫–∞–º–∏)
                const topicWords = this.allWords.filter(word => 
                    word.topics && word.topics.includes(topicId) && 
                    word.partOfSpeech === 'noun' && word.image
                );
                const wordIds = topicWords.map(w => w.id);
                
                // –§–∏–ª—å—Ç—Ä—É–µ–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è —Ç–∏–ø–∞ image_match –¥–ª—è —Å–ª–æ–≤ —ç—Ç–æ–π —Ç–µ–º—ã
                const exercises = this.allExercises.filter(ex => 
                    ex.type === 'image_match' && wordIds.includes(ex.wordId)
                );
                
                if (exercises.length === 0) {
                    document.getElementById('loading-screen').innerHTML = '<p class="text-gray-500 text-center py-6">–ù–µ—Ç —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π —Å –∫–∞—Ä—Ç–∏–Ω–∫–∞–º–∏ –¥–ª—è —ç—Ç–æ–π —Ç–µ–º—ã.</p>';
                    return;
                }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–∞—Ä—É—Å–µ–ª–∏
                this.imageMatchExercises = exercises.map(ex => {
                    const wordObj = this.allWords.find(w => w.id === ex.wordId);
                    return { ...ex, wordObj: wordObj };
                });
                
                this.currentImageMatchExerciseIndex = 0;
                this.imageMatchExerciseResults = {};
                this.showImageMatchExerciseCard();
                
                this.showScreen('image-carousel-screen', false, { 
                    renderFunc: 'renderImageMatchExercises', 
                    param: {topicId, weekNum} 
                });
            },

            showImageMatchExerciseCard() {
                const exercise = this.imageMatchExercises[this.currentImageMatchExerciseIndex];
                const carouselScreen = document.getElementById('image-carousel-screen');
                
                carouselScreen.innerHTML = `
                    <div class="mb-4">
                        <h2 class="text-lg font-semibold text-gray-800 text-center">
                            –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ ${this.currentImageMatchExerciseIndex + 1} –∏–∑ ${this.imageMatchExercises.length}
                        </h2>
                    </div>

                    <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è -->
                    <div class="carousel-card bg-white rounded-xl shadow-lg p-6 mb-6">
                        <!-- –í–æ–ø—Ä–æ—Å -->
                        <div class="text-center mb-4">
                            <p class="text-xl font-bold text-gray-800 mb-4">${exercise.question}</p>
                        </div>
                        
                        <!-- –ö–∞—Ä—Ç–∏–Ω–∫–∞ -->
                        <div class="mb-6" id="image-container-${exercise.id}">
                            <img src="${exercise.wordObj.image}" 
                                 alt="${exercise.wordObj.word}" 
                                 class="w-full h-64 object-cover rounded-lg shadow-md"
                                 onerror="this.onerror=null; this.src='https://placehold.co/400x300/E5E7EB/6B7280?text=–ù–µ—Ç+–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è';">
                        </div>
                        
                        <!-- –í–∞—Ä–∏–∞–Ω—Ç—ã —Å–ª–æ–≤ -->
                        <div class="space-y-3 mb-4" id="image-options-${exercise.id}">
                            ${exercise.options.map(option => `
                                <button onclick="window.App.checkImageMatchAnswer('${exercise.id}', '${option.replace(/'/g, "\\'").replace(/"/g, '&quot;')}', this)" 
                                        class="w-full py-4 px-5 bg-gray-100 hover:bg-gray-200 rounded-lg transition text-gray-800 font-bold text-lg">
                                    ${option}
                                </button>
                            `).join('')}
                        </div>
                        
                        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç -->
                        <div id="image-result-${exercise.id}" class="hidden p-4 rounded-lg mb-4"></div>
                        
                        <!-- –ü–æ—è—Å–Ω–µ–Ω–∏–µ -->
                        <div id="image-explanation-${exercise.id}" class="hidden bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded">
                            <p class="text-sm text-yellow-800">üí° ${exercise.explanation}</p>
                        </div>
                    </div>

                    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
                    <div class="flex justify-center space-x-4">
                        ${this.currentImageMatchExerciseIndex > 0 ? `
                            <button onclick="window.App.prevImageMatchExercise()" 
                                    class="py-3 px-6 bg-gray-200 text-gray-700 font-bold rounded-xl hover:bg-gray-300 transition">
                                &larr; –ù–∞–∑–∞–¥
                            </button>
                        ` : ''}
                        ${this.currentImageMatchExerciseIndex < this.imageMatchExercises.length - 1 ? `
                            <button onclick="window.App.nextImageMatchExercise()" 
                                    class="py-3 px-6 bg-yellow-500 text-white font-bold rounded-xl shadow-md hover:bg-yellow-600 transition">
                                –î–∞–ª–µ–µ &rarr;
                            </button>
                        ` : `
                            <button onclick="window.App.finishImageMatchExercises()" 
                                    class="py-3 px-6 bg-green-500 text-white font-bold rounded-xl shadow-md hover:bg-green-600 transition">
                                –ó–∞–≤–µ—Ä—à–∏—Ç—å ‚úì
                            </button>
                        `}
                    </div>
                `;
            },

            checkImageMatchAnswer(exerciseId, selectedOption, button) {
                const exercise = this.imageMatchExercises.find(ex => ex.id === exerciseId);
                if (!exercise || this.imageMatchExerciseResults[exerciseId]) return;
                
                const isCorrect = selectedOption === exercise.answer;
                this.imageMatchExerciseResults[exerciseId] = isCorrect;
                
                const resultDiv = document.getElementById(`image-result-${exerciseId}`);
                const explanationDiv = document.getElementById(`image-explanation-${exerciseId}`);
                const optionsDiv = document.getElementById(`image-options-${exerciseId}`);
                const imageContainer = document.getElementById(`image-container-${exerciseId}`);
                
                // –ë–ª–æ–∫–∏—Ä—É–µ–º –≤—Å–µ –∫–Ω–æ–ø–∫–∏
                const allButtons = optionsDiv.querySelectorAll('button');
                allButtons.forEach(btn => btn.disabled = true);
                
                // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç
                if (isCorrect) {
                    button.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                    button.classList.add('bg-green-100', 'border-2', 'border-green-500');
                    
                    // –ó–µ–ª–µ–Ω–∞—è —Ä–∞–º–∫–∞ –≤–æ–∫—Ä—É–≥ –∫–∞—Ä—Ç–∏–Ω–∫–∏
                    imageContainer.querySelector('img').classList.add('border-4', 'border-green-500');
                    
                    resultDiv.className = 'p-4 rounded-lg mb-4 bg-green-100 border-2 border-green-500';
                    resultDiv.innerHTML = `
                        <div class="flex items-center gap-2 text-green-800 font-semibold">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"></path>
                            </svg>
                            –ü—Ä–∞–≤–∏–ª—å–Ω–æ! ${exercise.answer}
                        </div>
                    `;
                } else {
                    button.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                    button.classList.add('bg-red-100', 'border-2', 'border-red-500');
                    
                    // –ö—Ä–∞—Å–Ω–∞—è —Ä–∞–º–∫–∞ –≤–æ–∫—Ä—É–≥ –∫–∞—Ä—Ç–∏–Ω–∫–∏
                    imageContainer.querySelector('img').classList.add('border-4', 'border-red-500');
                    
                    // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
                    allButtons.forEach(btn => {
                        if (btn.textContent.trim() === exercise.answer) {
                            btn.classList.remove('bg-gray-100');
                            btn.classList.add('bg-green-100', 'border-2', 'border-green-500');
                        }
                    });
                    
                    resultDiv.className = 'p-4 rounded-lg mb-4 bg-red-100 border-2 border-red-500';
                    resultDiv.innerHTML = `
                        <div class="flex items-center gap-2 text-red-800 font-semibold">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"></path>
                            </svg>
                            –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: ${exercise.answer}
                        </div>
                    `;
                }
                
                resultDiv.classList.remove('hidden');
                explanationDiv.classList.remove('hidden');
            },

            prevImageMatchExercise() {
                if (this.currentImageMatchExerciseIndex > 0) {
                    this.currentImageMatchExerciseIndex--;
                    this.showImageMatchExerciseCard();
                }
            },

            nextImageMatchExercise() {
                if (this.currentImageMatchExerciseIndex < this.imageMatchExercises.length - 1) {
                    this.currentImageMatchExerciseIndex++;
                    this.showImageMatchExerciseCard();
                }
            },

            finishImageMatchExercises() {
                const total = this.imageMatchExercises.length;
                const correct = Object.values(this.imageMatchExerciseResults).filter(r => r).length;
                const percentage = Math.round((correct / total) * 100);
                
                const carouselScreen = document.getElementById('image-carousel-screen');
                carouselScreen.innerHTML = `
                    <div class="max-w-2xl mx-auto px-4 py-20">
                        <div class="bg-white p-8 rounded-2xl shadow-2xl text-center">
                            <svg class="w-20 h-20 mx-auto mb-4 text-green-500" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"></path>
                            </svg>
                            <h2 class="text-3xl font-bold text-gray-800 mb-4">–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ! üéâ</h2>
                            <div class="text-xl text-gray-700 mb-6">
                                <p class="mb-2">–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: <span class="font-bold text-green-600">${correct}</span> –∏–∑ ${total}</p>
                                <p class="text-2xl font-bold ${percentage >= 80 ? 'text-green-600' : percentage >= 60 ? 'text-yellow-600' : 'text-red-600'}">
                                    ${percentage}%
                                </p>
                            </div>
                            <button onclick="window.App.handleTelegramBackClick()" 
                                    class="btn-primary py-3 px-8 inline-flex items-center gap-2">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V20a2 2 0 002 2h12a2 2 0 002-2v-9.586l.707.707a1 1 0 001.414-1.414l-7-7z"></path>
                                </svg>
                                –í –º–µ–Ω—é
                            </button>
                        </div>
                    </div>
                `;
            },

            playAudio(text) {
                if (!text) return;
                if (window.speechSynthesis) {
                    window.speechSynthesis.cancel(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
                    const utter = new SpeechSynthesisUtterance(text);
                    utter.lang = 'de-DE';
                    utter.rate = 0.8; // –ù–µ–º–Ω–æ–≥–æ –º–µ–¥–ª–µ–Ω–Ω–µ–µ –¥–ª—è –ª—É—á—à–µ–≥–æ –ø–æ–Ω–∏–º–∞–Ω–∏—è
                    window.speechSynthesis.speak(utter);
                }
            },

            checkExerciseAnswer(exercise, selectedAnswer, button, resultId, explanationId, optionsId) {
                const resultDiv = document.getElementById(resultId);
                const explanationDiv = document.getElementById(explanationId);
                const optionsDiv = document.getElementById(optionsId);
                
                // –ë–ª–æ–∫–∏—Ä—É–µ–º –≤—Å–µ –∫–Ω–æ–ø–∫–∏
                const allButtons = optionsDiv.querySelectorAll('button');
                allButtons.forEach(btn => {
                    btn.disabled = true;
                    btn.classList.remove('hover:bg-gray-200');
                });
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–≤–µ—Ç
                const isCorrect = selectedAnswer === exercise.answer;
                
                if (isCorrect) {
                    button.classList.remove('bg-gray-100');
                    button.classList.add('bg-green-500', 'text-white');
                    resultDiv.className = 'p-3 rounded-lg mb-3 bg-green-100 border-l-4 border-green-500';
                    resultDiv.innerHTML = '<p class="text-green-800 font-semibold">‚úì –ü—Ä–∞–≤–∏–ª—å–Ω–æ!</p>';
                } else {
                    button.classList.remove('bg-gray-100');
                    button.classList.add('bg-red-500', 'text-white');
                    resultDiv.className = 'p-3 rounded-lg mb-3 bg-red-100 border-l-4 border-red-500';
                    resultDiv.innerHTML = `<p class="text-red-800 font-semibold">‚úó –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ. –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: <span class="font-bold">${exercise.answer}</span></p>`;
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –≤ —Å–ø–∏—Å–æ–∫ –æ—à–∏–±–æ–∫
                    if (!this.wrongExercises.find(ex => ex.id === exercise.id)) {
                        this.wrongExercises.push(exercise);
                    }
                    
                    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É "–ü—Ä–æ–π—Ç–∏ –æ—à–∏–±–∫–∏"
                    const retryBtn = document.getElementById('retry-wrong-btn');
                    if (retryBtn) {
                        retryBtn.disabled = false;
                        retryBtn.innerHTML = `üîÑ –ü—Ä–æ–π—Ç–∏ –æ—à–∏–±–∫–∏ (${this.wrongExercises.length})`;
                    }
                    
                    // –ü–æ–¥—Å–≤–µ—Ç–∏–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
                    allButtons.forEach(btn => {
                        if (btn.textContent === exercise.answer) {
                            btn.classList.remove('bg-gray-100');
                            btn.classList.add('bg-green-500', 'text-white');
                        }
                    });
                }
                
                resultDiv.classList.remove('hidden');
                explanationDiv.style.display = 'block';
            },

            toggleWordForStudy(topicId, wordId, wordData, button) {
                if (!this.selectedWordsForStudy[topicId]) {
                    this.selectedWordsForStudy[topicId] = [];
                }
                
                const index = this.selectedWordsForStudy[topicId].findIndex(w => w.id === wordId);
                
                if (index === -1) {
                    // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª–æ–≤–æ
                    const displayWord = wordData.article ? `${wordData.article} ${wordData.word}` : wordData.word;
                    const translation = Array.isArray(wordData.translation) ? wordData.translation[0] : wordData.translation;
                    this.selectedWordsForStudy[topicId].push({
                        id: wordId,
                        word: displayWord,
                        translation: translation
                    });
                    
                    // –ü–æ–º–µ—á–∞–µ–º —Å–ª–æ–≤–æ –∫–∞–∫ –≥–æ—Ç–æ–≤–æ–µ –∫ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—é
                    if (!this.userProgress[wordId]) {
                        this.userProgress[wordId] = {};
                    }
                    this.userProgress[wordId].isLearning = true;
                    this.userProgress[wordId].box = 0;
                    this.userProgress[wordId].nextReview = this.getTodayDateString();
                    this.saveProgress();
                    
                    button.textContent = '–í —É—á–µ–±–µ';
                    button.className = 'px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white font-semibold rounded-lg transition';
                } else {
                    // –£–±–∏—Ä–∞–µ–º —Å–ª–æ–≤–æ
                    this.selectedWordsForStudy[topicId].splice(index, 1);
                    
                    // –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –¥–ª—è —ç—Ç–æ–≥–æ —Å–ª–æ–≤–∞
                    if (this.userProgress[wordId]) {
                        delete this.userProgress[wordId];
                        this.saveProgress();
                    }
                    
                    button.textContent = '–£—á–∏—Ç—å';
                    button.className = 'px-4 py-2 bg-green-500 hover:bg-green-600 text-white font-semibold rounded-lg transition';
                }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
                this.saveSelectedWords();
            },

            saveSelectedWords() {
                try {
                    localStorage.setItem('selectedWordsForStudy', JSON.stringify(this.selectedWordsForStudy));
                } catch (e) {
                    console.error('Error saving selected words:', e);
                }
            },

            loadSelectedWords() {
                try {
                    const saved = localStorage.getItem('selectedWordsForStudy');
                    if (saved) {
                        this.selectedWordsForStudy = JSON.parse(saved);
                    } else {
                        this.selectedWordsForStudy = {};
                    }
                } catch (e) {
                    console.error('Error loading selected words:', e);
                    this.selectedWordsForStudy = {};
                }
            },

            openWordCard(wordData, topicId, wordId, wordsList = null, currentIndex = null) {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤ –∏ –∏–Ω–¥–µ–∫—Å –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
                if (wordsList !== null) {
                    this.currentWordsList = wordsList;
                    this.currentWordIndex = currentIndex;
                } else {
                    // –ï—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω, –ø–æ–ª—É—á–∞–µ–º –≤—Å–µ —Å–ª–æ–≤–∞ —Ç–µ–º—ã
                    this.currentWordsList = this.allWords.filter(word => word.topics && word.topics.includes(topicId));
                    this.currentWordIndex = this.currentWordsList.findIndex(w => w.id === wordId);
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
                this.updateNavigationButtons();
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–∞–Ω–Ω—ã–º–∏
                document.getElementById('word-card-image').src = wordData.image || 'https://placehold.co/400x200/E5E7EB/6B7280?text=–ù–µ—Ç+–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è';
                
                // –ê—Ä—Ç–∏–∫–ª—å –∏ —Å–ª–æ–≤–æ (–∞—Ä—Ç–∏–∫–ª—å —Ç–æ–ª—å–∫–æ –¥–ª—è —Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö)
                const shouldShowArticle = wordData.article && wordData.article !== '‚Äî' && wordData.partOfSpeech && wordData.partOfSpeech.toLowerCase().includes('noun');
                document.getElementById('word-card-article').textContent = shouldShowArticle ? wordData.article : '';
                document.getElementById('word-card-word').textContent = wordData.word;
                
                // –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –∏ –ø–µ—Ä–µ–≤–æ–¥
                document.getElementById('word-card-transcription-ru').textContent = wordData.transcriptionRu || '';
                const translation = Array.isArray(wordData.translation) ? wordData.translation.join(', ') : wordData.translation;
                document.getElementById('word-card-translation').textContent = translation;
                
                // –ß–∞—Å—Ç—å —Ä–µ—á–∏ –∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ —á–∏—Å–ª–æ
                const partOfSpeech = wordData.partOfSpeech || '';
                document.getElementById('word-card-part-of-speech').textContent = partOfSpeech;
                
                const pluralEl = document.getElementById('word-card-plural');
                if (wordData.plural && wordData.partOfSpeech === 'noun') {
                    pluralEl.textContent = `–º–Ω.—á.: ${wordData.plural}`;
                    pluralEl.style.display = 'block';
                } else {
                    pluralEl.textContent = '';
                    pluralEl.style.display = 'none';
                }
                
                // –¢–µ–≥–∏ —Ç–µ–º
                const topicsEl = document.getElementById('word-card-topics');
                topicsEl.innerHTML = '';
                if (wordData.topics && wordData.topics.length > 0) {
                    wordData.topics.forEach(topicId => {
                        const topic = this.allTopics.find(t => t.id === topicId);
                        if (topic) {
                            const tag = document.createElement('span');
                            tag.className = 'px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-semibold';
                            tag.textContent = topic.name;
                            topicsEl.appendChild(tag);
                        }
                    });
                }
                
                // –ê—Å—Å–æ—Ü–∏–∞—Ü–∏—è –∏ –ø—Ä–∏–º–µ—Ä
                document.getElementById('word-card-association').textContent = wordData.association || '';
                const example = Array.isArray(wordData.examples) && wordData.examples.length > 0 ? wordData.examples[0] : (wordData.example || '');
                document.getElementById('word-card-example').innerHTML = example;
                
                // –û–∑–≤—É—á–∫–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–Ω–æ–ø–∫—É
                const speakBtn = document.getElementById('word-card-speak');
                speakBtn.onclick = () => {
                    const utterance = new SpeechSynthesisUtterance(wordData.word);
                    utterance.lang = 'de-DE';
                    window.speechSynthesis.speak(utterance);
                };
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–£—á–∏—Ç—å"
                this.currentModalWord = {
                    topicId: topicId,
                    wordId: wordId,
                    wordData: wordData
                };
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ "–£—á–∏—Ç—å"
                this.updateStudyButtonState();
                
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                this.openModal('word-card-modal');
            },

            updateStudyButtonState() {
                if (!this.currentModalWord) return;
                
                const { topicId, wordId } = this.currentModalWord;
                const button = document.getElementById('word-card-study-btn');
                
                if (!button) return;
                
                const isInStudy = this.selectedWordsForStudy[topicId] && 
                                  this.selectedWordsForStudy[topicId].some(w => w.id === wordId);
                
                if (isInStudy) {
                    button.textContent = '–í —É—á–µ–±–µ';
                    button.className = 'px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white font-semibold rounded-lg transition';
                } else {
                    button.textContent = '–£—á–∏—Ç—å';
                    button.className = 'px-4 py-2 bg-green-500 hover:bg-green-600 text-white font-semibold rounded-lg transition';
                }
            },

            openWordDetailScreen(wordData, topicId, wordId, wordsList, currentIndex) {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º topicId –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫ —Å–ø–∏—Å–∫—É —Å–ª–æ–≤
                this.currentDetailTopicId = topicId;
                
                // –°–∫—Ä—ã—Ç—å –≤—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ —ç–∫—Ä–∞–Ω—ã
                document.querySelectorAll('.main-content').forEach(el => el.classList.add('hidden'));
                document.getElementById('word-detail-screen').classList.remove('hidden');

                // –ù–µ–º–µ—Ü–∫–æ–µ —Å–ª–æ–≤–æ —Å –∞—Ä—Ç–∏–∫–ª–µ–º (–µ—Å–ª–∏ noun)
                const shouldShowArticle = wordData.article && wordData.article !== '‚Äî' && wordData.partOfSpeech && wordData.partOfSpeech.toLowerCase().includes('noun');
                document.getElementById('word-detail-german').textContent = shouldShowArticle ? `${wordData.article} ${wordData.word}` : wordData.word;

                // –ú–∏–∫—Ä–æ—Ñ–æ–Ω
                document.getElementById('word-detail-speak').onclick = () => {
                    const utterance = new SpeechSynthesisUtterance(wordData.word);
                    utterance.lang = 'de-DE';
                    window.speechSynthesis.speak(utterance);
                };

                // –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è
                document.getElementById('word-detail-transcription').textContent = wordData.transcriptionRu || '';
                // –ü–µ—Ä–µ–≤–æ–¥
                const translation = Array.isArray(wordData.translation) ? wordData.translation.join(', ') : wordData.translation;
                document.getElementById('word-detail-translation').textContent = translation;
                // –ß–∞—Å—Ç—å —Ä–µ—á–∏
                document.getElementById('word-detail-pos').textContent = wordData.partOfSpeech || '';
                // –¢–µ–º—ã
                const topicNames = wordData.topics && this.allTopics ? wordData.topics.map(tid => {
                    const t = this.allTopics.find(tt => tt.id === tid);
                    return t ? t.name : tid;
                }).join(', ') : '';
                document.getElementById('word-detail-topics').textContent = topicNames;
                // –ü—Ä–∏–º–µ—Ä
                const example = Array.isArray(wordData.examples) ? wordData.examples[0] : wordData.examples;
                document.getElementById('word-detail-example').textContent = example || '';

                // –ö–Ω–æ–ø–∫–∞ –ê—Å—Å–æ—Ü–∏–∞—Ü–∏—è - –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä mnemo
                const assocBtn = document.getElementById('word-detail-association');
                const assocText = wordData.association || '';
                const mnemo = wordData.mnemo || 0;
                
                // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                const checkImageExists = (imageUrl) => {
                    return new Promise((resolve) => {
                        if (!imageUrl) {
                            resolve(false);
                            return;
                        }
                        const img = new Image();
                        img.onload = () => resolve(true);
                        img.onerror = () => resolve(false);
                        img.src = imageUrl;
                    });
                };
                
                // –ö–Ω–æ–ø–∫–∞ –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–∏ –≤—Å–µ–≥–¥–∞ –∞–∫—Ç–∏–≤–Ω–∞
                assocBtn.disabled = false;
                assocBtn.className = 'btn-secondary px-4 py-2';
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
                checkImageExists(wordData.image).then(imageExists => {
                    assocBtn.onclick = () => {
                        // –ï—Å–ª–∏ association –ø—É—Å—Ç–æ–µ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ
                        if (!assocText || assocText.trim() === '') {
                            const modalHtml = `
                                <div class="modal fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50" id="association-modal" onclick="this.classList.add('hidden')">
                                    <div class="modal-content bg-white p-6 max-w-lg w-full rounded-2xl" onclick="event.stopPropagation()">
                                        <div class="flex justify-end items-center mb-3">
                                            <button onclick="document.getElementById('association-modal').remove()" class="text-gray-500 text-2xl">&times;</button>
                                        </div>
                                        <div style='text-align:center; padding: 20px;'>
                                            <h3 style='font-size: 1.3em; font-weight: bold; margin-bottom: 15px;'>–ê—Å—Å–æ—Ü–∏–∞—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</h3>
                                            <p style='font-size: 1em; line-height: 1.6;'>–ï—Å–ª–∏ –µ—Å—Ç—å –∏–¥–µ–∏ –ø–æ —Å–ª–æ–≤—É, –ø—Ä–∏—à–ª–∏ –∏—Ö –≤ —á–∞—Ç –∏ –º—ã –æ–ø—É–±–ª–∏–∫—É–µ–º —Ç–≤–æ—é –∞—Å—Å–æ—Ü–∏–∞—Ü–∏—é!!!</p>
                                        </div>
                                    </div>
                                </div>
                            `;
                            document.body.insertAdjacentHTML('beforeend', modalHtml);
                        } else {
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ mnemo = 1
                            let assocImg = (mnemo === 1 && imageExists) ? wordData.image : '';
                            
                            // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–µ–π
                            const modalHtml = `
                                <div class="modal fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50" id="association-modal" onclick="this.classList.add('hidden')">
                                    <div class="modal-content bg-white p-6 max-w-lg w-full rounded-2xl" onclick="event.stopPropagation()">
                                        <div class="flex justify-end items-center mb-3">
                                            <button onclick="document.getElementById('association-modal').remove()" class="text-gray-500 text-2xl">&times;</button>
                                        </div>
                                        <div style='text-align:center;'>
                                            ${assocImg ? `<img src='${assocImg}' alt='–ê—Å—Å–æ—Ü–∏–∞—Ü–∏—è' style='max-width:100%; margin:0 auto 1em; border-radius:8px;'/>` : ''}
                                            <div style='font-size:1.1em;'>${assocText}</div>
                                        </div>
                                    </div>
                                </div>
                            `;
                            document.body.insertAdjacentHTML('beforeend', modalHtml);
                        }
                    };
                });
                
                // –ö–Ω–æ–ø–∫–∞ –£—á–∏—Ç—å
                const studyBtn = document.getElementById('word-detail-study');
                const isInStudy = this.selectedWordsForStudy[topicId] && this.selectedWordsForStudy[topicId].some(w => w.id === wordId);
                studyBtn.textContent = isInStudy ? '–í —É—á–µ–±–µ' : '–£—á–∏—Ç—å';
                studyBtn.className = isInStudy ? 'px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white font-semibold rounded-lg transition' : 'btn-success px-4 py-2';
                studyBtn.onclick = () => {
                    this.toggleWordForStudy(topicId, wordId, wordData, studyBtn);
                };
            },

            closeWordDetailScreen() {
                document.getElementById('word-detail-screen').classList.add('hidden');
                document.getElementById('list-screen').classList.remove('hidden');
                
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ —Å–ø–∏—Å–∫—É —Å–ª–æ–≤ —Ç–µ–º—ã, –µ—Å–ª–∏ –±—ã–ª–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ —Ç–µ–º–∞
                if (this.currentDetailTopicId) {
                    this.renderTopicWords(this.currentDetailTopicId);
                }
            },

            toggleWordForStudyFromModal() {
                if (!this.currentModalWord) return;
                
                const { topicId, wordId, wordData } = this.currentModalWord;
                const button = document.getElementById('word-card-study-btn');
                
                this.toggleWordForStudy(topicId, wordId, wordData, button);
            },

            navigateWordCard(direction) {
                if (!this.currentWordsList || this.currentWordsList.length === 0) return;
                
                // –í—ã—á–∏—Å–ª—è–µ–º –Ω–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å
                const newIndex = this.currentWordIndex + direction;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã
                if (newIndex < 0 || newIndex >= this.currentWordsList.length) return;
                
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–æ–≤–æ–≥–æ —Å–ª–æ–≤–∞
                const newWordData = this.currentWordsList[newIndex];
                const newTopicId = newWordData.topics && newWordData.topics.length > 0 ? newWordData.topics[0] : null;
                const newWordId = newWordData.id;
                
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –Ω–æ–≤–æ–≥–æ —Å–ª–æ–≤–∞
                this.openWordCard(newWordData, newTopicId, newWordId, this.currentWordsList, newIndex);
            },

            updateNavigationButtons() {
                const prevBtn = document.getElementById('word-card-prev');
                const nextBtn = document.getElementById('word-card-next');
                
                if (!prevBtn || !nextBtn) return;
                
                // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥" –µ—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–æ–µ —Å–ª–æ–≤–æ
                if (this.currentWordIndex <= 0) {
                    prevBtn.disabled = true;
                    prevBtn.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    prevBtn.disabled = false;
                    prevBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
                
                // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É "–í–ø–µ—Ä–µ–¥" –µ—Å–ª–∏ —ç—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–ª–æ–≤–æ
                if (!this.currentWordsList || this.currentWordIndex >= this.currentWordsList.length - 1) {
                    nextBtn.disabled = true;
                    nextBtn.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    nextBtn.disabled = false;
                    nextBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            },

            promptForDirection(setId, mode, source = 'allsets') {
                this.tempSetId = setId;
                this.tempMode = mode;
                this.tempSource = source;
                this.openModal('direction-modal');
            },

            closeDirectionModal() {
                this.closeModal('direction-modal');
            },

            startSessionWithDirection(direction) {
                this.currentDirection = direction;
                this.closeDirectionModal();
                // [–ò–ó–ú–ï–ù–ï–ù–û] –ü–µ—Ä–µ–¥–∞–µ–º renderFunc –∏ –∏—Å—Ç–æ—á–Ω–∏–∫ –≤ startSession
                this.startSession(this.tempSetId, this.tempMode, false, this.tempSource);
            },
            
            startSession(setId, mode, isBack = false, source = 'allsets') {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ –Ω–∞–±–æ—Ä–æ–º –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å–ª–æ–≤
                let set;
                if (setId.startsWith('selected_week_') || setId.startsWith('selected_topic_')) {
                    const selectedSets = this.createSelectedWordsSets();
                    set = selectedSets.find(s => s.id === setId);
                    console.log('Selected set found:', set);
                } else {
                    set = WORD_SETS.find(s => s.id === setId);
                }
                
                if (!set) {
                    console.error('Set not found for id:', setId);
                    return;
                }
                
                console.log('Starting session with set:', set);
                console.log('Mode:', mode, 'Source:', source);

                this.isPracticeMode = (mode === 'practice');
                this.isPracticeAllMode = (mode === 'practice-all');

                // –ó–∞–ø–æ–ª–Ω—è–µ–º –º–∞—Å—Å–∏–≤ –∫–∞—Ä—Ç–æ—á–µ–∫ –¥–ª—è —Å–µ—Å—Å–∏–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
                if (this.isPracticeAllMode) {
                    // –ü—Ä–∞–∫—Ç–∏–∫–∞ –≤—Å–µ—Ö —Å–ª–æ–≤: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –í–°–ï –∫–∞—Ä—Ç–æ—á–∫–∏ –Ω–∞–±–æ—Ä–∞ –ë–ï–ó —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
                    this.sessionCards = set.cards.map(card => ({ ...card }));
                } else if (this.isPracticeMode) {
                    // –í —Ä–µ–∂–∏–º–µ –ü—Ä–∞–∫—Ç–∏–∫–∞: –µ—Å–ª–∏ –ø—Ä–∏—à–ª–∏ –∏–∑ –º–µ–Ω—é –ù–µ–¥–µ–ª–∏ –∏–ª–∏ —ç—Ç–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –Ω–∞–±–æ—Ä - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏
                    if (source === 'week' || set.isSelected) {
                        this.sessionCards = set.cards.map(card => ({ ...card }));
                    } else {
                        this.sessionCards = set.cards.filter(card => (this.userProgress[card.id] && this.userProgress[card.id].isLearning === true));
                    }
                } else {
                    // –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ: —Ç–æ–ª—å–∫–æ –∫–∞—Ä—Ç–æ—á–∫–∏, –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∫ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—é —Å–µ–≥–æ–¥–Ω—è
                    const today = this.getTodayDateString();
                    if (set.isSelected) {
                        // –î–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –Ω–∞–±–æ—Ä–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ –∫ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—é
                        this.sessionCards = set.cards.filter(card => {
                            const progress = this.userProgress[card.id];
                            return progress && progress.isLearning && progress.nextReview && progress.nextReview <= today;
                        });
                    } else {
                        this.sessionCards = set.cards.filter(card => {
                            const progress = this.userProgress[card.id];
                            const isVisible = progress && progress.isLearning === true;
                            return isVisible && progress.nextReview && progress.nextReview <= today;
                        });
                    }
                }
                
                console.log('Session cards after filtering:', this.sessionCards.length, this.sessionCards);

                // [–ò–ó–ú–ï–ù–ï–ù–û] –ú–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–æ–∫ –∏ –≤–∏–¥–∏–º–æ—Å—Ç—å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
                const rateNoButton = document.querySelector('#controls-rate button:nth-child(1)');
                const rateYesButton = document.querySelector('#controls-rate button:nth-child(2)');

                if (this.isPracticeAllMode) {
                    // –†–µ–∂–∏–º "–ü—Ä–∞–∫—Ç–∏–∫–∞ –≤—Å–µ—Ö —Å–ª–æ–≤": –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ (–ù–∞–∑–∞–¥, –ü–æ–¥—Å–∫–∞–∑–∫–∞, –í–ø–µ—Ä–µ–¥)
                    document.getElementById('controls-show').classList.add('hidden');
                    document.getElementById('controls-rate').classList.add('hidden');
                    document.getElementById('controls-practice-all').classList.remove('hidden');
                } else if (this.isPracticeMode) {
                    // –†–µ–∂–∏–º "–ü—Ä–∞–∫—Ç–∏–∫–∞": –£—á–∏—Ç—å (false) / –ó–Ω–∞—é (true)
                    rateNoButton.innerHTML = '–£—á–∏—Ç—å üéì';
                    rateYesButton.innerHTML = '–ó–Ω–∞—é üëç';
                    document.getElementById('controls-show').classList.add('hidden');
                    document.getElementById('controls-rate').classList.remove('hidden');
                    document.getElementById('controls-practice-all').classList.add('hidden');
                } else {
                    // –†–µ–∂–∏–º "–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ": –ù–µ –ø–æ–º–Ω—é (false) / –ü–æ–º–Ω—é (true)
                    rateNoButton.innerHTML = '–ù–µ –ø–æ–º–Ω—é ‚ùå';
                    rateYesButton.innerHTML = '–ü–æ–º–Ω—é ‚úÖ';
                    document.getElementById('controls-show').classList.remove('hidden');
                    document.getElementById('controls-rate').classList.add('hidden');
                    document.getElementById('controls-practice-all').classList.add('hidden');
                }

                // [–ò–ó–ú–ï–ù–ï–ù–û] –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ (–≤–∫–ª—é—á–∞–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫)
                const historyState = { renderFunc: 'startSession', param: {setId, mode, source} };

                if (this.sessionCards.length === 0) {
                    // –ï—Å–ª–∏ –ø—Ä–∏—à–ª–∏ –∏–∑ "–í—Å–µ –Ω–∞–±–æ—Ä—ã —Å–ª–æ–≤" - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è —Ç—É–¥–∞
                    if (source === 'allsets') {
                        this.renderAllSetsScreen();
                        return;
                    }
                    
                    // –ò–Ω–∞—á–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω
                    this.showScreen('finish-screen', isBack, historyState);
                    document.getElementById('finish-screen-text').textContent = this.isPracticeMode 
                        ? '–í —ç—Ç–æ–º –Ω–∞–±–æ—Ä–µ –Ω–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫.' 
                        : '–î–ª—è —ç—Ç–æ–≥–æ –Ω–∞–±–æ—Ä–∞ –Ω–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫ –∫ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—é –Ω–∞ —Å–µ–≥–æ–¥–Ω—è!';
                    
                    const returnToSetsBtn = document.getElementById('finish-return-to-sets-btn');
                    returnToSetsBtn.classList.add('hidden');
                    return;
                }

                this.sessionCards.sort(() => Math.random() - 0.5);
                this.currentCardIndex = 0;

                this.showScreen('study-screen', isBack, historyState); // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
                this.showNextCard();
            },

            showAnswer() {
                document.getElementById('card').classList.add('is-flipped');
                // –í —Ä–µ–∂–∏–º–µ Practice –∫–Ω–æ–ø–∫–∏ –≤–∏–¥–Ω—ã —Å—Ä–∞–∑—É –∏ –Ω–µ –º–µ–Ω—è—é—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–≤–æ—Ä–æ—Ç–µ
                // –í —Ä–µ–∂–∏–º–µ PracticeAll –∫–Ω–æ–ø–∫–∏ –≤–∏–¥–Ω—ã –≤—Å–µ–≥–¥–∞ (–Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ)
                if (!this.isPracticeMode && !this.isPracticeAllMode) {
                    document.getElementById('controls-show').classList.add('hidden');
                    document.getElementById('controls-rate').classList.remove('hidden');
                }

                if (this.currentDirection === 'ru-de') {
                     this.speakGerman(this.sessionCards[this.currentCardIndex].back);
                }
            },
            
            showNextCard() {
                if (this.currentCardIndex >= this.sessionCards.length) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ–∫—Ü–∏—é "–ö –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—é —Å–µ–≥–æ–¥–Ω—è" –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏
                    this.renderDueTodaySection();
                    
                    // –ï—Å–ª–∏ –ø—Ä–∏—à–ª–∏ –∏–∑ "–í—Å–µ –Ω–∞–±–æ—Ä—ã —Å–ª–æ–≤" - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è —Ç—É–¥–∞
                    if (this.tempSource === 'allsets') {
                        this.renderAllSetsScreen();
                        return;
                    }
                    
                    // –ò–Ω–∞—á–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω
                    const historyState = this.navigationHistory[this.navigationHistory.length - 1];
                    this.showScreen('finish-screen', false, historyState);
                    document.getElementById('finish-screen-text').textContent = '–í—ã –ø—Ä–æ—à–ª–∏ –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏.';
                    
                    const returnToSetsBtn = document.getElementById('finish-return-to-sets-btn');
                    returnToSetsBtn.classList.add('hidden');
                    return;
                }
                
                const cardEl = document.getElementById('card');
                cardEl.classList.remove('is-flipped', 'slide-in');
                void cardEl.offsetWidth; // –¢—Ä—é–∫ –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –∞–Ω–∏–º–∞—Ü–∏–∏
                cardEl.classList.add('slide-in');

                const totalCards = this.sessionCards.length;
                const percent = ((this.currentCardIndex + 1) / totalCards) * 100;
                document.getElementById('progress-bar').style.width = `${percent}%`;

                // –ü–æ–∫–∞–∑ –∫–Ω–æ–ø–æ–∫ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞: Practice ‚Äî —Å—Ä–∞–∑—É –¥–≤–µ –∫–Ω–æ–ø–∫–∏, PracticeAll ‚Äî –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ, Review ‚Äî –∫–Ω–æ–ø–∫–∞ "–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç"
                if (this.isPracticeAllMode) {
                    document.getElementById('controls-show').classList.add('hidden');
                    document.getElementById('controls-rate').classList.add('hidden');
                    document.getElementById('controls-practice-all').classList.remove('hidden');
                } else if (this.isPracticeMode) {
                    document.getElementById('controls-show').classList.add('hidden');
                    document.getElementById('controls-rate').classList.remove('hidden');
                    document.getElementById('controls-practice-all').classList.add('hidden');
                } else {
                    document.getElementById('controls-show').classList.remove('hidden');
                    document.getElementById('controls-rate').classList.add('hidden');
                    document.getElementById('controls-practice-all').classList.add('hidden');
                }

                const card = this.sessionCards[this.currentCardIndex];
                
                const speakerIconSvg = `
                    <svg class="w-6 h-6 text-blue-500 hover:text-blue-700 inline-block ml-2 cursor-pointer" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707A1 1 0 0112 6v12a1 1 0 01-1.707.707L5.586 15z"></path>
                    </svg>
                `;
                
                const germanHtml = `
                    <div class="flex items-center justify-center gap-2">
                        <span>${card.back}</span>
                        <span onclick="window.App.speakGerman('${card.back}', event)">
                            ${speakerIconSvg}
                        </span>
                    </div>
                `;

                // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
                const frontImage = document.getElementById('card-front-image');
                const backImage = document.getElementById('card-back-image');
                
                if (this.currentDirection === 'ru-de') {
                    // RU ‚Üí DE: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä—É—Å—Å–∫–∏–π —Ç–µ–∫—Å—Ç —Å–ø–µ—Ä–µ–¥–∏, –Ω–µ–º–µ—Ü–∫–∏–π —Å–∑–∞–¥–∏
                    document.getElementById('card-front-text').textContent = card.front;
                    document.getElementById('card-back-text').innerHTML = germanHtml;
                    
                    // –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞ –Ω–µ–º–µ—Ü–∫–æ–π —Å—Ç–æ—Ä–æ–Ω–µ (–∑–∞–¥–Ω—è—è —Å—Ç–æ—Ä–æ–Ω–∞)
                    backImage.style.display = 'none';
                    backImage.classList.add('hidden');
                    frontImage.style.display = 'none';
                    frontImage.classList.add('hidden');
                } else {
                    // DE ‚Üí RU: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–µ–º–µ—Ü–∫–∏–π —Ç–µ–∫—Å—Ç —Å–ø–µ—Ä–µ–¥–∏, —Ä—É—Å—Å–∫–∏–π —Å–∑–∞–¥–∏
                    document.getElementById('card-front-text').innerHTML = germanHtml;
                    document.getElementById('card-back-text').textContent = card.front;
                    
                    // –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞ –Ω–µ–º–µ—Ü–∫–æ–π —Å—Ç–æ—Ä–æ–Ω–µ (–ø–µ—Ä–µ–¥–Ω—è—è —Å—Ç–æ—Ä–æ–Ω–∞)
                    frontImage.style.display = 'none';
                    frontImage.classList.add('hidden');
                    backImage.style.display = 'none';
                    backImage.classList.add('hidden');
                }
                
                document.getElementById('hint-button').classList.toggle('hidden', !card.hintImage);
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–æ–¥—Å–∫–∞–∑–∫–∏ –≤ —Ä–µ–∂–∏–º–µ practice-all
                document.getElementById('hint-button-practice-all').classList.toggle('hidden', !card.hintImage);
            },
            
async handleAnswer(knewIt) {
                if (this.isAdvancing) return; 
                this.isAdvancing = true;

                // [–ò–ó–ú–ï–ù–ï–ù–û] –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è Practice Mode, PracticeAll Mode –∏ Review Mode
                const card = this.sessionCards[this.currentCardIndex];
                let progress = this.userProgress[card.id] || { box: 0 };

                // –í —Ä–µ–∂–∏–º–µ "–ü—Ä–∞–∫—Ç–∏–∫–∞ –≤—Å–µ—Ö —Å–ª–æ–≤" –Ω–µ –º–µ–Ω—è–µ–º userProgress, –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–π –∫–∞—Ä—Ç–æ—á–∫–µ
                if (this.isPracticeAllMode) {
                    // –ü—Ä–∞–∫—Ç–∏–∫–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤
                    document.getElementById('card').classList.add('slide-out');
                    setTimeout(() => {
                        document.getElementById('card').classList.remove('slide-out'); 
                        this.currentCardIndex++; 
                        this.isAdvancing = false; 
                        this.showNextCard(); 
                    }, 400);
                    return;
                }

                if (this.isPracticeMode) {
                    // –í —Ä–µ–∂–∏–º–µ "–ü—Ä–∞–∫—Ç–∏–∫–∞": "–£—á–∏—Ç—å" vs "–ó–Ω–∞—é"
                    if (knewIt) { // "–ó–Ω–∞—é üëç" - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª "–ó–Ω–∞—é" (knewIt = true)
                        // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–Ω–∞–µ—Ç —Å–ª–æ–≤–æ. –°—Ç–∞–≤–∏–º –≤—ã—Å–æ–∫–∏–π –±–æ–∫—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä, 5 = 30 –¥–Ω–µ–π)
                        progress.box = 5;
                        // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–Ω–∞–µ—Ç —Å–ª–æ–≤–æ ‚Äî –ø–æ–º–µ—á–∞–µ–º –µ–≥–æ –∫–∞–∫ –Ω–µ –∏–∑—É—á–∞–µ–º–æ–µ (—Å–∫—Ä—ã–≤–∞—Ç—å –≤ '–í—Å–µ –Ω–∞–±–æ—Ä—ã')
                        progress.isLearning = false;
                    } else { // "–£—á–∏—Ç—å üéì" - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª "–£—á–∏—Ç—å" (knewIt = false)
                        // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç —É—á–∏—Ç—å. –°—Ç–∞–≤–∏–º –±–æ–∫—Å 1 (1 –¥–µ–Ω—å)
                        progress.box = 1;
                        // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–º–µ—Ç–∏–ª —Å–ª–æ–≤–æ –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤ '–í—Å–µ –Ω–∞–±–æ—Ä—ã'
                        progress.isLearning = true;
                    }
                } else {
                    // –í —Ä–µ–∂–∏–º–µ "–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ": "–ù–µ –ø–æ–º–Ω—é" vs "–ü–æ–º–Ω—é"
                    if (knewIt) { // "–ü–æ–º–Ω—é ‚úÖ"
                        // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Å–ø–æ–º–Ω–∏–ª. –ü—Ä–æ–¥–≤–∏–≥–∞–µ–º –±–æ–∫—Å.
                        progress.box = Math.min(6, (progress.box || 0) + 1);
                    } else { // "–ù–µ –ø–æ–º–Ω—é ‚ùå"
                        // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±—ã–ª. –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—é —Å–µ–≥–æ–¥–Ω—è.
                        progress.box = 0;
                    }
                }

                // –û–±—â–∞—è –ª–æ–≥–∏–∫–∞: —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞—Ç—É —Å–ª–µ–¥. –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å
                // –≠—Ç–∞ –ª–æ–≥–∏–∫–∞ —Ç–µ–ø–µ—Ä—å –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–ª—è –û–ë–ï–ò–• —Ä–µ–∂–∏–º–æ–≤ (–ü—Ä–∞–∫—Ç–∏–∫–∞ –∏ –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ)
                progress.nextReview = this.getFutureDateString(REPETITION_INTERVALS[progress.box]);
                console.log('Card rated:', card.id, 'knewIt:', knewIt, 'new box:', progress.box, 'nextReview:', progress.nextReview, 'today:', this.getTodayDateString());
                this.userProgress[card.id] = progress;

                if (this.isAuthReady) { 
                    this.saveProgress(); 
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ–∫—Ü–∏—é "–ö –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—é —Å–µ–≥–æ–¥–Ω—è" –ø–æ—Å–ª–µ –æ—Ü–µ–Ω–∫–∏ –∫–∞—Ä—Ç–æ—á–∫–∏
                this.renderDueTodaySection();
                
                document.getElementById('card').classList.add('slide-out');
                setTimeout(() => {
                    document.getElementById('card').classList.remove('slide-out'); 
                    this.currentCardIndex++; 
                    this.isAdvancing = false; 
                    this.showNextCard(); 
                }, 400); 
            },
            
            speakGerman(textToSpeak, event) {
                if (event) {
                    event.stopPropagation(); 
                }
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                    const utterance = new SpeechSynthesisUtterance(textToSpeak);
                    utterance.lang = 'de-DE'; 
                    const voices = window.speechSynthesis.getVoices().filter(v => v.lang.includes('de-'));
                    if (voices.length > 0) {
                        utterance.voice = voices.find(v => v.name.includes('Anna')) || voices.find(v => v.name.includes('Google')) || voices[0];
                    }
                    window.speechSynthesis.speak(utterance);
                }
            },

            // ==================== –£–¢–ò–õ–ò–¢–´ ====================

            openModal(modalId) {
                // [–ò–ó–ú–ï–ù–ï–ù–û] –õ–æ–≥–∏–∫–∞ –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –ø–ª–µ–µ—Ä–∞
                if (modalId === 'transcript-modal') {
                    const player = document.getElementById('audio-bar');
                    const placeholder = document.getElementById('transcript-audio-player-placeholder');
                    if (player && placeholder) {
                        if (!this.audioPlayerOriginalParent) {
                             this.audioPlayerOriginalParent = player.parentElement; // –ö–µ—à–∏—Ä—É–µ–º —Ä–æ–¥–∏—Ç–µ–ª—è
                        }
                        placeholder.appendChild(player); // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –ø–ª–µ–µ—Ä –≤ –º–æ–¥–∞–ª–∫—É
                        player.classList.remove('fixed-audio-bar'); // –£–±–∏—Ä–∞–µ–º "–ª–∏–ø–∫–æ—Å—Ç—å"
                        
                        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã—Å–æ—Ç—É –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–∞ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                        const mainPlaceholder = document.getElementById('audio-bar-placeholder');
                        if (mainPlaceholder) mainPlaceholder.style.height = '0px';
                    }
                }

                // [–ò–ó–ú–ï–ù–ï–ù–û] –ö–æ–¥ StoryApp.openModal() –£–î–ê–õ–ï–ù, —Ç.–∫. —ç—Ç–æ —Ä–∞–∑–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã
                const modal = document.getElementById(modalId);
                const modalContent = document.getElementById(`${modalId}-content`) || document.getElementById(`${modalId}-modal-content`);
                
                if (modal) {
                    modal.classList.remove('hidden');
                    setTimeout(() => {
                        modal.classList.add('is-open', 'opacity-100');
                        if (modalContent) modalContent.classList.add('is-open');
                    }, 10);
                }
            },
            
            closeModal(modalId) {
                // [–ò–ó–ú–ï–ù–ï–ù–û] –õ–æ–≥–∏–∫–∞ –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –ø–ª–µ–µ—Ä–∞
                if (modalId === 'transcript-modal') {
                    const player = document.getElementById('audio-bar');
                    // –ü–æ–ª—É—á–∞–µ–º —Ä–æ–¥–∏—Ç–µ–ª—è –∏–∑ –∫–µ—à–∞ (–∏–ª–∏ –ø–æ ID, –µ—Å–ª–∏ –∫–µ—à –ø—É—Å—Ç)
                    const originalParent = this.audioPlayerOriginalParent || document.getElementById('audio-bar-wrapper'); 
                    if (player && originalParent) {
                        originalParent.prepend(player); // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–ª–µ–µ—Ä –≤ –Ω–∞—á–∞–ª–æ –µ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
                    }
                }

                // [–ù–û–í–û–ï] –û—á–∏—Å—Ç–∫–∞ –º–∞–Ω—Ç—Ä–∞-—Å–µ—Å—Å–∏–∏ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª–∞
                if (modalId === 'mantra-modal') {
                    this.mantraCards = [];
                    this.currentMantraIndex = 0;
                    this.mantraKnownCount = 0;
                    this.mantraUnknownCount = 0;
                    this.mantraSeen = [];
                }

                // [–ù–û–í–û–ï] –û—á–∏—Å—Ç–∫–∞ –∫–∞—Ä—É—Å–µ–ª–∏ –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–π –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª–∞
                if (modalId === 'associations-modal') {
                    this.associationCards = [];
                    this.currentAssociationIndex = 0;
                }

                // [–ò–ó–ú–ï–ù–ï–ù–û] –ö–æ–¥ StoryApp.closeModal() –£–î–ê–õ–ï–ù
                const modal = document.getElementById(modalId);
                const modalContent = document.getElementById(`${modalId}-content`) || document.getElementById(`${modalId}-modal-content`);
                
                if (modal) {
                    modal.classList.remove('is-open', 'opacity-100');
                    if (modalContent) modalContent.classList.remove('is-open');
                    setTimeout(() => modal.classList.add('hidden'), 300);
                }
            },

            // [–ò–ó–ú–ï–ù–ï–ù–û] closeDirectionModal —Ç–µ–ø–µ—Ä—å —Ç–æ–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç App.closeModal
            closeDirectionModal() {
                this.closeModal('direction-modal');
            },
            
            showHint() {
                const card = this.sessionCards[this.currentCardIndex];
                if (!card || !card.hintImage) return;
                document.getElementById('hint-image').src = card.hintImage; 
                this.openModal('hint-modal');
            },

            // ========== –ú–µ—Ç–æ–¥—ã –¥–ª—è —ç–∫—Ä–∞–Ω–∞ "–í—Å–µ –Ω–∞–±–æ—Ä—ã" (–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è isLearning) ==========
            allSetsRemember(cardId) {
                const entry = this.findCardById(cardId);
                if (!entry) return;
                let progress = this.userProgress[cardId] || { box: 0 };
                progress.box = Math.min(6, (progress.box || 0) + 1);
                progress.nextReview = this.getFutureDateString(REPETITION_INTERVALS[progress.box]);
                // –ù–µ –º–µ–Ω—è–µ–º isLearning
                this.userProgress[cardId] = progress;
                if (this.isAuthReady) this.saveProgress();
                this.renderAllSetsScreen(true);
            },

            allSetsForgot(cardId) {
                const entry = this.findCardById(cardId);
                if (!entry) return;
                let progress = this.userProgress[cardId] || { box: 0 };
                progress.box = 1;
                progress.nextReview = this.getFutureDateString(REPETITION_INTERVALS[progress.box]);
                // –ù–µ –º–µ–Ω—è–µ–º isLearning
                this.userProgress[cardId] = progress;
                if (this.isAuthReady) this.saveProgress();
                this.renderAllSetsScreen(true);
            },

            showHintForAllSet(cardId) {
                const entry = this.findCardById(cardId);
                if (!entry) return;
                const card = entry.card;
                if (card && card.hintImage) {
                    document.getElementById('hint-image').src = card.hintImage;
                } else {
                    document.getElementById('hint-image').src = 'https://placehold.co/400x150/FCA5A5/FFFFFF?text=–ù–µ—Ç+–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è';
                }
                this.openModal('hint-modal');
            },

            // –ù–∞–≤–∏–≥–∞—Ü–∏—è –¥–ª—è —Ä–µ–∂–∏–º–∞ "–ü—Ä–∞–∫—Ç–∏–∫–∞ –≤—Å–µ—Ö —Å–ª–æ–≤"
            prevCard() {
                if (this.currentCardIndex > 0) {
                    document.getElementById('card').classList.add('slide-out');
                    setTimeout(() => {
                        document.getElementById('card').classList.remove('slide-out');
                        this.currentCardIndex--;
                        this.isAdvancing = false;
                        this.showNextCard();
                    }, 400);
                }
            },

            nextCard() {
                if (this.currentCardIndex < this.sessionCards.length - 1) {
                    document.getElementById('card').classList.add('slide-out');
                    setTimeout(() => {
                        document.getElementById('card').classList.remove('slide-out');
                        this.currentCardIndex++;
                        this.isAdvancing = false;
                        this.showNextCard();
                    }, 400);
                } else {
                    // –ï—Å–ª–∏ —ç—Ç–æ –ø–æ—Å–ª–µ–¥–Ω—è—è –∫–∞—Ä—Ç–æ—á–∫–∞
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ–∫—Ü–∏—é "–ö –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—é —Å–µ–≥–æ–¥–Ω—è"
                    this.renderDueTodaySection();
                    
                    // –ï—Å–ª–∏ –ø—Ä–∏—à–ª–∏ –∏–∑ "–í—Å–µ –Ω–∞–±–æ—Ä—ã —Å–ª–æ–≤" - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è —Ç—É–¥–∞
                    if (this.tempSource === 'allsets') {
                        this.renderAllSetsScreen();
                        return;
                    }
                    
                    // –ò–Ω–∞—á–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω
                    const historyState = this.navigationHistory[this.navigationHistory.length - 1];
                    this.showScreen('finish-screen', false, historyState);
                    document.getElementById('finish-screen-text').textContent = '–í—ã –ø—Ä–æ—à–ª–∏ –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏.';
                    
                    const returnToSetsBtn = document.getElementById('finish-return-to-sets-btn');
                    returnToSetsBtn.classList.add('hidden');
                }
            },

            // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è: –Ω–∞–π—Ç–∏ –∫–∞—Ä—Ç–æ—á–∫—É –ø–æ id –∏ –≤–µ—Ä–Ω—É—Ç—å {set, card}
            findCardById(cardId) {
                for (let s of WORD_SETS) {
                    for (let c of s.cards) {
                        if (c.id === cardId) return { set: s, card: c };
                    }
                }
                return null;
            },

            /**
             * [–ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø]
             * @param {string} screenId - ID —ç–∫—Ä–∞–Ω–∞ –¥–ª—è –ø–æ–∫–∞–∑–∞
             * @param {boolean} isBackNavigation - true, –µ—Å–ª–∏ —ç—Ç–æ –≤–æ–∑–≤—Ä–∞—Ç (–Ω–µ –ø–∏—à–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é)
             * @param {object} historyState - { renderFunc, param } –¥–ª—è –∑–∞–ø–∏—Å–∏ –≤ –∏—Å—Ç–æ—Ä–∏—é
             * @param {boolean} clearStack - true, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é (–Ω–∞–ø—Ä. "–î–æ–º–æ–π")
             */
            showScreen(screenId, isBackNavigation = false, historyState = null, clearStack = false) {
                
                // [–ù–û–í–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï ‚Ññ2]
                // –ï—Å–ª–∏ –º—ã —É—Ö–æ–¥–∏–º —Å —ç–∫—Ä–∞–Ω–∞ –∏—Å—Ç–æ—Ä–∏–∏, —Å—Ç–∞–≤–∏–º –∞—É–¥–∏–æ –Ω–∞ –ø–∞—É–∑—É.
                if (this.currentScreenId === 'content-viewer-screen' && screenId !== 'content-viewer-screen') {
                    const audio = document.getElementById('story-audio-player');
                    if (audio && !audio.paused) {
                        audio.pause();
                        // –û–±–Ω–æ–≤–ª—è–µ–º UI –∫–Ω–æ–ø–∫–∏ (Play/Pause), —á—Ç–æ–±—ã –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ
                        // –æ–Ω–∞ –±—ã–ª–∞ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏
                        window.StoryApp.updateAudioUi(false);
                    }
                }
                
                // 1. –õ–æ–≥–∏–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
                if (clearStack) {
                    this.navigationHistory = [];
                }
                if (!isBackNavigation && historyState) {
                    this.navigationHistory.push(historyState);
                }
                // –ù–∞ home-screen –≤—Å–µ–≥–¥–∞ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–æ –æ–¥–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
                if (screenId === 'home-screen' && historyState) {
                     this.navigationHistory = [historyState];
                }

                // 2. –õ–æ–≥–∏–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≠–∫—Ä–∞–Ω–∞
                this.currentScreenId = screenId;
                ['loading-screen', 'home-screen', 'list-screen', 'study-screen', 'finish-screen', 'video-content-screen', 'external-link-screen', 'content-viewer-screen', 'carousel-list-screen', 'image-carousel-screen'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.classList.add('hidden');
                });
                const screen = document.getElementById(screenId);
                if (screen) {
                    screen.classList.remove('hidden');
                }

                // 3. –õ–æ–≥–∏–∫–∞ –∫–Ω–æ–ø–æ–∫ Telegram
                if (!this.tg) return; // –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å, –µ—Å–ª–∏ tg –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤
                
                if (screenId === 'home-screen') {
                    // –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º "Schlie√üen", –ø—Ä—è—á–µ–º "Zur√ºck"
                    this.tg.BackButton.hide();
                    this.tg.MainButton.setText('Schlie√üen'); // "–ó–∞–∫—Ä—ã—Ç—å"
                    this.tg.MainButton.onClick(() => this.tg.close());
                    this.tg.MainButton.show();
                } else {
                    // –õ—é–±–æ–π –¥—Ä—É–≥–æ–π —ç–∫—Ä–∞–Ω: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º "Zur√ºck", –ø—Ä—è—á–µ–º "Schlie√üen"
                    this.tg.BackButton.show();
                    this.tg.MainButton.hide();
                }
            },
            
            showError(message) {
                this.showScreen('loading-screen'); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞ —ç–∫—Ä–∞–Ω–µ –∑–∞–≥—Ä—É–∑–∫–∏
                document.getElementById('loading-screen').innerHTML = `<p class="text-red-500 font-semibold">${message}</p>`;
            },
            
            getTodayDateString() {
                return new Date().toISOString().split('T')[0];
            },

            getFutureDateString(daysToAdd) {
                const date = new Date();
                date.setDate(date.getDate() + daysToAdd);
                return date.toISOString().split('T')[0];
            }
        };
        
        // ==========================================================
        // 3. –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø (Conceptual Bootstrap)
        // ==========================================================

        window.addEventListener('load', () => {
            // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –≥–æ–ª–æ—Å–æ–≤ –¥–ª—è —Å–∏–Ω—Ç–µ–∑–∞ —Ä–µ—á–∏
            if ('speechSynthesis' in window) {
                window.speechSynthesis.getVoices(); 
                if (window.speechSynthesis.onvoiceschanged !== undefined) {
                    window.speechSynthesis.onvoiceschanged = () => window.speechSynthesis.getVoices();
                }
            }
            // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
            window.App.init();
        });

    </script>
    
</body>
</html>
