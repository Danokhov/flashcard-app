<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–ò–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω–æ–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º API Telegram -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–µ—Ä–µ–≤–æ—Ä–æ—Ç–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ */
        .card { perspective: 1000px; }
        .card-inner {
            position: relative;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .card.is-flipped .card-inner {
            transform: rotateY(180deg);
        }
        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            top: 0; left: 0;
        }
        .card-back {
            transform: rotateY(180deg);
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ "—É—Ö–æ–¥–∞" –∏ "–ø–æ—è–≤–ª–µ–Ω–∏—è" –∫–∞—Ä—Ç–æ—á–∫–∏ */
        @keyframes slide-left {
            0% { transform: translateX(0); opacity: 1; }
            100% { transform: translateX(-100%); opacity: 0; }
        }
        @keyframes slide-in-right {
            0% { transform: translateX(100%); opacity: 0; }
            100% { transform: translateX(0); opacity: 1; }
        }

        .card.slide-out {
            animation: slide-left 0.4s ease forwards;
        }
        .card.slide-in {
            animation: slide-in-right 0.4s ease;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω */
        .modal {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
            transform: scale(0.95);
        }
        .modal.is-open {
            opacity: 1;
        }
        .modal.is-open .modal-content {
            transform: scale(1);
        }

        /* –°—Ç–∏–ª—å –¥–ª—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∫–Ω–æ–ø–∫–∏ */
        .button-locked {
            background-color: #e5e7eb; /* gray-200 */
            color: #6b7280; /* gray-500 */
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        /* –ù–æ–≤—ã–π —Å—Ç–∏–ª—å –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ü—Ä–æ–±–Ω–æ–≥–æ —É—Ä–æ–∫–∞ */
        .promo-button {
            background: linear-gradient(to right, #F97316, #FBBF24); /* Orange/Amber */
            color: white;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .promo-button:hover {
            box-shadow: 0 10px 15px -3px rgba(249, 115, 22, 0.5), 0 4px 6px -2px rgba(249, 115, 22, 0.2);
            transform: translateY(-2px);
        }
        
        /* –°—Ç–∏–ª—å –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ê–∫—Ç–∏–≤–Ω–æ–π –Ω–µ–¥–µ–ª–∏ */
        .active-week-button {
            background: linear-gradient(to right, #3B82F6, #2563EB); /* Blue */
            color: white;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .active-week-button:hover {
            box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.5), 0 4px 6px -2px rgba(59, 130, 246, 0.2);
            transform: translateY(-2px);
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä 16:9 –¥–ª—è –≤–∏–¥–µ–æ */
        .video-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
            height: 0;
            overflow: hidden;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Ä—É—Å–µ–ª–∏ */
        .carousel-card {
            min-height: 250px;
        }
    </style>
</head>

<body class="min-h-screen bg-gray-100 font-sans p-4 pb-28">

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
    <div id="app" class="max-w-xl mx-auto">
        
        <!-- 1. –≠–∫—Ä–∞–Ω –ó–∞–≥—Ä—É–∑–∫–∏ (–≤–∏–¥–µ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
        <div id="loading-screen" class="text-center py-20">
            <p class="text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
        </div>

        <!-- 2. –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ (Home Screen) -->
        <div id="home-screen" class="hidden">
            <h1 class="text-2xl font-bold text-center mb-8 text-gray-800">–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</h1>
            <div class="space-y-4">

                <!-- –î–ò–ù–ê–ú–ò–ß–ï–°–ö–ò–ô –ë–õ–û–ö: –ü—Ä–æ–±–Ω—ã–π —É—Ä–æ–∫ –ò–õ–ò –ê–∫—Ç–∏–≤–Ω–∞—è –Ω–µ–¥–µ–ª—è/–£—Ä–æ–∫–∏ –ø–æ –Ω–µ–¥–µ–ª—è–º -->
                <div id="main-content-block">
                    <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JS (–≤–∫–ª—é—á–∞–µ—Ç –ü—Ä–æ–±–Ω—ã–π, –ü–æ–¥–±–æ—Ä–∫–∏ –∑–∞ –Ω–µ–¥–µ–ª—é –∏ –í—Å–µ –Ω–∞–±–æ—Ä—ã —Å–ª–æ–≤) -->
                </div>
                
                <!-- 3. –†–∞–∑–¥–µ–ª: –í—Å–µ –Ω–∞–±–æ—Ä—ã —Å–ª–æ–≤ (–£–î–ê–õ–ï–ù –∏–∑ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ HTML, —á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å) -->
                
                <!-- –ù–û–í–ê–Ø –°–ï–ö–¶–ò–Ø: –ì–æ—Ä—è—â–∏–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è -->
                <div id="due-today-section" class="hidden pt-6 mt-4 border-t border-gray-200">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <span>üî• –ö –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—é —Å–µ–≥–æ–¥–Ω—è</span>
                    </h2>
                    <div id="due-today-list" class="space-y-3">
                        <!-- –°—é–¥–∞ JS –¥–æ–±–∞–≤–∏—Ç –≥–æ—Ä—è—â–∏–µ —Å–µ—Ç—ã -->
                    </div>
                </div>

            </div>
        </div>
        
        <!-- 3. –≠–ö–†–ê–ù –°–ü–ò–°–ö–ê (–¥–ª—è –Ω–µ–¥–µ–ª—å, —Å–µ—Ç–æ–≤) -->
        <div id="list-screen" class="hidden">
            <h1 id="list-title" class="text-2xl font-bold text-center mb-6 text-gray-800"></h1>
            
            
            
            <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã/–ø–æ–∏—Å–∫ -->
            <div id="filter-controls" class="mb-4 space-y-3">
                <!-- –§–∏–ª—å—Ç—Ä—ã –∏–ª–∏ –ø–æ–∏—Å–∫ –±—É–¥—É—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω—ã –∑–¥–µ—Å—å -->
            </div>
            
            <!-- –°–ø–∏—Å–æ–∫ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ -->
            <div id="content-list" class="space-y-4">
                <!-- –°—é–¥–∞ –±—É–¥—É—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω—ã –Ω–∞–±–æ—Ä—ã, –Ω–µ–¥–µ–ª–∏ -->
            </div>
        </div>
        
        <!-- 4. –≠–ö–†–ê–ù –í–ò–î–ï–û –ö–û–ù–¢–ï–ù–¢–ê (–¥–ª—è –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–π –Ω–µ–¥–µ–ª–∏) -->
        <div id="video-content-screen" class="hidden">
             

            <h1 id="video-title" class="text-xl font-bold text-gray-800 mb-4 text-center"></h1>
            
            <!-- –í–∏–¥–µ–æ 16:9 -->
            <div class="video-container mb-6">
                <iframe id="video-embed" src="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            </div>

            <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç (–¥–ª—è –∑–∞–¥–∞–Ω–∏–π –Ω–µ–¥–µ–ª–∏) -->
            <div id="video-extra-text" class="p-4 bg-white rounded-xl shadow-lg text-gray-700">
                <!-- –°—é–¥–∞ –±—É–¥–µ—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω —Ç–µ–∫—Å—Ç –∑–∞–¥–∞–Ω–∏—è -->
            </div>
        </div>

        <!-- 5. –≠–ö–†–ê–ù –í–ù–ï–®–ù–ï–ô –°–°–´–õ–ö–ò -->
        <div id="external-link-screen" class="hidden text-center py-10">
           

            <h2 id="external-link-title" class="text-xl font-bold text-gray-800 mb-4"></h2>
            <p id="external-link-text" class="text-gray-600 mb-6 px-4">–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É (–∏–ª–∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É).</p>
            
            <a id="external-link-button" href="#" target="_blank" 
               class="py-3 px-6 bg-blue-500 text-white font-bold rounded-xl shadow-md hover:bg-blue-600 inline-block transition duration-150">
                –û—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É
            </a>
            
            <p id="external-link-url-display" class="mt-4 text-sm text-gray-500 break-all px-4"></p>
        </div>

        <!-- 6. –≠–ö–†–ê–ù –ü–†–û–°–ú–û–¢–†–ê –°–¢–†–ê–ù–ò–¶–´ (–¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ HTML-–∫–æ–Ω—Ç–µ–Ω—Ç–∞, –∫–∞–∫ text1.html) -->
        <div id="content-viewer-screen" class="hidden">
                     
            <h2 id="content-viewer-title" class="text-xl font-bold text-gray-800 mb-4 text-center"></h2>
            <!-- –¢—É—Ç –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –∫–æ–Ω—Ç–µ–Ω—Ç text1.html -->
            <div id="content-viewer-body" class="p-4 bg-gray-100 rounded-xl">
                <p class="text-center text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞...</p>
            </div>
        </div>
        
        <!-- 7. –≠–ö–†–ê–ù –°–ü–ò–°–ö–ê –ö–ê–†–£–°–ï–õ–ï–ô (–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –µ—Å–ª–∏ –Ω–µ—Ç —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –Ω–∞–±–æ—Ä–∞) -->
        <div id="carousel-list-screen" class="hidden">
            <h1 id="carousel-list-title" class="text-2xl font-bold text-center mb-6 text-gray-800">–ö–∞—Ä—É—Å–µ–ª—å –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–π</h1>
            <div id="carousel-sets-list" class="space-y-4">
                <!-- –°—é–¥–∞ JS –≤—Å—Ç–∞–≤–∏—Ç –∫–Ω–æ–ø–∫–∏ –Ω–∞–±–æ—Ä–æ–≤ -->
            </div>
        </div>

        <!-- 8. –≠–ö–†–ê–ù –ö–ê–†–£–°–ï–õ–ò (–ü—Ä–æ—Å–º–æ—Ç—Ä —Å–ª–æ–≤ —Å –∫–∞—Ä—Ç–∏–Ω–∫–∞–º–∏) -->
        <div id="image-carousel-screen" class="hidden">
                 <h2 id="carousel-word-count" class="text-lg font-semibold text-gray-800 mb-4 text-center"></h2>

            <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –∫–∞—Ä—É—Å–µ–ª–∏ -->
            <div class="carousel-card bg-white rounded-xl shadow-lg p-4 mb-6 relative">
                <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ -->
                <img id="carousel-image" src="" alt="–ò–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—è" class="w-full h-auto object-contain rounded-lg max-h-48 mb-4" 
                     onerror="this.onerror=null; this.src='https://placehold.co/400x200/FCA5A5/FFFFFF?text=–ù–µ—Ç+–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è';">
                
                <!-- –ù–µ–º–µ—Ü–∫–æ–µ —Å–ª–æ–≤–æ -->
                <div class="text-center mb-4">
                    <span id="carousel-word" class="text-2xl font-bold text-gray-800"></span>
                    <button onclick="window.App.speakGerman(window.App.carouselCards[window.App.currentCarouselIndex].word, event)" 
                            class="ml-2 text-blue-500 hover:text-blue-700">
                        <svg class="w-6 h-6 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707A1 1 0 0112 6v12a1 1 0 01-1.707.707L5.586 15z"></path>
                        </svg>
                    </button>
                </div>
                
                <!-- –ü–µ—Ä–µ–≤–æ–¥ (—Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
                <div id="carousel-translation" class="text-center text-xl text-gray-600 font-semibold mb-4 hidden"></div>

                <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
                <div class="flex justify-center space-x-4">
                    <button onclick="window.App.showPrevWord()" class="py-2 px-4 bg-gray-200 text-gray-700 font-bold rounded-xl hover:bg-gray-300 transition duration-150">
                        &larr; –ù–∞–∑–∞–¥
                    </button>
                    <button id="toggle-translation-button" onclick="window.App.toggleTranslation()" 
                            class="py-2 px-4 bg-yellow-400 text-yellow-900 font-bold rounded-xl shadow-md hover:bg-yellow-500 transition duration-150">
                        –ü–æ–∫–∞–∑–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥
                    </button>
                    <button onclick="window.App.showNextWord()" class="py-2 px-4 bg-blue-500 text-white font-bold rounded-xl shadow-md hover:bg-blue-600 transition duration-150">
                        –î–∞–ª–µ–µ &rarr;
                    </button>
                </div>
            </div>
            <div class="text-center mt-4">
                <button onclick="window.App.returnToCarouselList()" class="text-gray-500 hover:text-gray-700">
                    &larr; –ù–∞–∑–∞–¥ –∫ –°–ø–∏—Å–∫—É –ö–∞—Ä—É—Å–µ–ª–µ–π
                </button>
            </div>
        </div>

        <!-- 9. –≠–∫—Ä–∞–Ω –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è (Study Screen) -->
        <div id="study-screen" class="hidden">
            <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä -->
            <div class="bg-gray-200 rounded-full h-2.5 mb-4">
                <div id="progress-bar" class="bg-blue-500 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
            
            <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ -->
            <div id="card" class="card h-64 w-full mb-4">
                <div id="card-inner" class="card-inner h-full w-full" onclick="window.App.showAnswer()">
                    <!-- –ü–µ—Ä–µ–¥–Ω—è—è —Å—Ç–æ—Ä–æ–Ω–∞ -->
                    <div id="card-front" class="card-front flex items-center justify-center p-6 bg-white rounded-xl shadow-lg text-center">
                        <div id="card-front-text" class="text-2xl font-semibold"></div>
                    </div>
                    <!-- –ó–∞–¥–Ω—è—è —Å—Ç–æ—Ä–æ–Ω–∞ -->
                    <div id="card-back" class="card-back flex items-center justify-center p-6 bg-blue-100 rounded-xl shadow-lg text-center">
                        <div id="card-back-text" class="text-2xl font-semibold"></div>
                    </div>
                </div>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
            <div id="controls-show" class="text-center space-y-3">
                <button onclick="window.App.showAnswer()" class="w-full py-3 px-4 bg-blue-500 text-white font-bold rounded-xl shadow-md hover:bg-blue-600 transition duration-150">
                    –ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç
                </button>
                <button id="hint-button" onclick="window.App.showHint()" class="w-full py-2 px-4 bg-yellow-400 text-yellow-900 font-semibold rounded-xl shadow-md hover:bg-yellow-500 transition duration-150 hidden">
                    üí° –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É
                </button>
            </div>
            
            <div id="controls-rate" class="hidden grid grid-cols-2 gap-4">
                <button onclick="window.App.handleAnswer(false)" class="py-3 px-4 bg-red-500 text-white font-bold rounded-xl shadow-md hover:bg-red-600 transition duration-150">
                    –ù–µ –ø–æ–º–Ω—é ‚ùå
                </button>
                <button onclick="window.App.handleAnswer(true)" class="py-3 px-4 bg-green-500 text-white font-bold rounded-xl shadow-md hover:bg-green-600 transition duration-150">
                    –ü–æ–º–Ω—é ‚úÖ
                </button>
            </div>
             <!-- –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é" –≤–æ –≤—Ä–µ–º—è —Å–µ—Å—Å–∏–∏ -->
            <div class="text-center mt-4">
                <button onclick="window.App.renderHomeScreen()" class="text-gray-500 hover:text-gray-700">
                    &larr; –ù–∞–∑–∞–¥ –≤ –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
                </button>
            </div>
        </div>
        
        <!-- 10. –≠–∫—Ä–∞–Ω –ó–∞–≤–µ—Ä—à–µ–Ω–∏—è (Finish Screen) -->
         <div id="finish-screen" class="hidden text-center py-20">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</h2>
            <p id="finish-screen-text" class="text-gray-600 mb-6">–í—ã –ø—Ä–æ—à–ª–∏ –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏.</p>
            <button onclick="window.App.renderHomeScreen()" class="py-3 px-6 bg-blue-500 text-white font-bold rounded-xl shadow-md hover:bg-blue-600">
                –í –º–µ–Ω—é
            </button>
        </div>

    </div>

    <div id="navigation-footer" class="hidden fixed bottom-0 left-0 right-0 bg-white p-3 border-t border-gray-200 shadow-lg z-40 max-w-xl mx-auto rounded-t-xl">
        <div id="nav-content-container">
            </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ü–æ–¥—Å–∫–∞–∑–∫–∏ -->
    <div id="hint-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 opacity-0" onclick="window.App.closeModal('hint-modal')">
        <div id="hint-modal-content" class="modal-content bg-white p-4 rounded-xl shadow-xl max-w-sm w-full" onclick="event.stopPropagation()">
            <h3 class="text-lg font-semibold mb-3">–ü–æ–¥—Å–∫–∞–∑–∫–∞:</h3>
            <img id="hint-image" src="" alt="–ü–æ–¥—Å–∫–∞–∑–∫–∞" class="w-full h-auto rounded-md object-contain max-h-64" onerror="this.onerror=null; this.src='https://placehold.co/400x150/FCA5A5/FFFFFF?text=–ù–µ—Ç+–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è';">
            <button onclick="window.App.closeModal('hint-modal')" class="w-full mt-4 py-2 px-4 bg-gray-200 text-gray-700 font-semibold rounded-xl hover:bg-gray-300">
                –ó–∞–∫—Ä—ã—Ç—å
            </button>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –í—ã–±–æ—Ä–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
    <div id="direction-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 opacity-0" onclick="window.App.closeDirectionModal()">
        <div id="direction-modal-content" class="modal-content bg-white p-6 rounded-xl shadow-xl max-w-sm w-full" onclick="event.stopPropagation()">
            <h3 class="text-lg font-semibold mb-4 text-center">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h3>
            <div class="space-y-3">
                <button onclick="window.App.startSessionWithDirection('ru-de')" class="w-full py-3 px-4 bg-blue-500 text-white font-bold rounded-xl shadow-md hover:bg-blue-600">
                    –†—É—Å—Å–∫–∏–π ‚Üí –ù–µ–º–µ—Ü–∫–∏–π
                </button>
                <button onclick="window.App.startSessionWithDirection('de-ru')" class="w-full py-3 px-4 bg-purple-500 text-white font-bold rounded-xl shadow-md hover:bg-purple-600">
                    –ù–µ–º–µ—Ü–∫–∏–π ‚Üí –†—É—Å—Å–∫–∏–π
                </button>
                <button onclick="window.App.closeDirectionModal()" class="w-full mt-2 py-2 px-4 text-gray-600 font-semibold rounded-xl hover:bg-gray-100">
                    –û—Ç–º–µ–Ω–∞
                </button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π –Ω–µ–¥–µ–ª–∏ -->
    <div id="week-details-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 opacity-0" onclick="window.App.closeModal('week-details-modal')">
        <div id="week-details-modal-content" class="modal-content bg-white p-6 rounded-xl shadow-xl max-w-sm w-full" onclick="event.stopPropagation()">
            <h3 id="week-details-title" class="text-xl font-bold mb-3 text-center text-gray-800"></h3>
            <p id="week-details-body" class="text-gray-700 mb-5"></p>
            <button onclick="window.App.closeModal('week-details-modal')" class="w-full py-3 px-4 bg-blue-500 text-white font-bold rounded-xl shadow-md hover:bg-blue-600">
                –ü–æ–Ω—è—Ç–Ω–æ
            </button>
        </div>
    </div>


    <!-- "–ú–ê–ì–ò–Ø" (JavaScript) -->
<script type="module">
        // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –º–æ–¥—É–ª–∏ Firebase (v9+)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        
        // ==========================================================
        // !!! –í–ê–®–ò –ù–ê–°–¢–†–û–ô–ö–ò FIREBASE !!!
        // –ó–ê–ú–ï–ù–ò–¢–ï –≠–¢–ò –ó–ê–ì–õ–£–®–ö–ò –ù–ê –í–ê–®–ò –†–ï–ê–õ–¨–ù–´–ï –î–ê–ù–ù–´–ï
        // ==========================================================
        
        // 1. –í–ê–® –û–ë–™–ï–ö–¢ –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò
        // –ï—Å–ª–∏ —É –≤–∞—Å –Ω–µ—Ç –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö Canvas, –≤—ã –¥–æ–ª–∂–Ω—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–≤–æ—é:
        const MY_FIREBASE_CONFIG = {
apiKey: "AIzaSyAyKS1QWLlIaq_WtpNO0J5RbWAguDd5y-0",
  authDomain: "flash-app-19ddb.firebaseapp.com",
  projectId: "flash-app-19ddb",
  storageBucket: "flash-app-19ddb.firebasestorage.app",
  messagingSenderId: "779096518661",
  appId: "1:779096518661:web:397ba47299418261d56c6c"
        };
        
        // 2. –í–ê–® ID –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø—É—Ç–∏ –∫ –¥–æ–∫—É–º–µ–Ω—Ç—É, –µ—Å–ª–∏ —É –≤–∞—Å —Å–≤–æ—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
        const MY_APP_ID = "flash-app-19ddb"; // <-- –ó–ê–ú–ï–ù–ò–¢–¨ (–ú–æ–∂–µ—Ç –±—ã—Ç—å –ª—é–±—ã–º ID, –µ—Å–ª–∏ –≤—ã –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É Canvas)

        // 3. –ò–º—è –≤–∞—à–µ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏/–ø—É—Ç—å: –ï—Å–ª–∏ –≤—ã –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –ø—É—Ç—å Canvas (artifacts/{appId}/users/{userId}/progress/data),
        //    –£–∫–∞–∂–∏—Ç–µ –∑–¥–µ—Å—å –∏–º—è –≤–∞—à–µ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä: 'user_progress'
        const MY_COLLECTION_NAME = "userProgress"; // <-- –ó–ê–ú–ï–ù–ò–¢–¨ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 'user_progress')

        // –ò—Å–ø–æ–ª—å–∑—É–µ–º Telegram ID –∫–∞–∫ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Ç.–∫. –º—ã –æ—Ç–∫–∞–∑—ã–≤–∞–µ–º—Å—è –æ—Ç Auth Canvas
        const MY_USER_ID_SOURCE = (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe?.user?.id?.toString()) 
                                ? window.Telegram.WebApp.initDataUnsafe.user.id.toString()
                                : "fallback_web_user_" + Math.random().toString(36).substring(7);

        // ==========================================================
        // –ö–û–ù–ï–¶ –í–ê–®–ò–• –ù–ê–°–¢–†–û–ï–ö
        // ==========================================================

        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É—é—Ç –≤–∞—à–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        const firebaseConfig = MY_FIREBASE_CONFIG;
        const appId = MY_APP_ID; 
        const initialAuthToken = null; // –û—Ç–∫–ª—é—á–∞–µ–º Auth Canvas
        
        // ==========================================================
        // 1. –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ò –î–ê–ù–ù–´–ï (Conceptual Data Module)
        // ==========================================================
        
        // –ò–Ω—Ç–µ—Ä–≤–∞–ª—ã –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è –≤ –¥–Ω—è—Ö (–æ—Ç 1 –¥–æ 6 –±–æ–∫—Å–æ–≤)
        const REPETITION_INTERVALS = {
            1: 1,  // 1 –¥–µ–Ω—å
            2: 3,  // 3 –¥–Ω—è
            3: 7,  // 7 –¥–Ω–µ–π
            4: 14, // 2 –Ω–µ–¥–µ–ª–∏
            5: 30, // 1 –º–µ—Å—è—Ü
            6: 90  // 3 –º–µ—Å—è—Ü–∞
        };
        
        /**
         * –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –±–∞–∑–æ–≤–æ–≥–æ URL (–∫–æ—Ä–Ω–µ–≤–æ–π –ø–∞–ø–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)
         */
        function getBaseUrl() {
            const path = window.location.pathname.split('/');
            // –£–¥–∞–ª—è–µ–º –∏–º—è —Ñ–∞–π–ª–∞ (index.html)
            path.pop(); 
            // –ü–æ–ª—É—á–∞–µ–º –ø—É—Ç—å –∫ –ø–∞–ø–∫–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, '/subfolder/')
            const folderPath = path.join('/') + (path.length > 1 ? '/' : ''); 
            
            // –°–æ–±–∏—Ä–∞–µ–º –ø–æ–ª–Ω—ã–π –±–∞–∑–æ–≤—ã–π URL: 'https://[your-site-name].netlify.app/subfolder/'
            const base = window.location.origin + folderPath;
            
            // –£–±–∏—Ä–∞–µ–º –∫–æ–Ω–µ—á–Ω—ã–π —Å–ª—ç—à, –µ—Å–ª–∏ —ç—Ç–æ –∫–æ—Ä–µ–Ω—å, –∏–ª–∏ –æ—Å—Ç–∞–≤–ª—è–µ–º, –µ—Å–ª–∏ –µ—Å—Ç—å –ø—É—Ç—å
            return base.endsWith('/') ? base : base + '/';
        }

        /**
         * –î–∞–Ω–Ω—ã–µ –Ω–∞–±–æ—Ä–æ–≤ —Å–ª–æ–≤
         */
        const WORD_SETS = [
            // –ù–µ–¥–µ–ª—è 1
            { id: "a1_nouns_1", week: 1, name: "–°—É—â. A1 (–ß–∞—Å—Ç—å 1)", cards: [
                { id: "der_Tisch", front: "—Å—Ç–æ–ª", back: "der Tisch", hintImage: "https://placehold.co/150x100/505050/ffffff?text=–°—Ç–æ–ª" },
                { id: "die_Frau", front: "–∂–µ–Ω—â–∏–Ω–∞", back: "die Frau" }
            ]},
            // –ù–µ–¥–µ–ª—è 2
            { id: "a1_nouns_2", week: 2, name: "–°—É—â. A1 (–ß–∞—Å—Ç—å 2)", cards: [
                { id: "das_Auto", front: "–º–∞—à–∏–Ω–∞", back: "das Auto" },
                { id: "das_Haus", front: "–¥–æ–º", back: "das Haus" }
            ]},
            // –ù–µ–¥–µ–ª—è 3 (–ü–æ–∫–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
            { id: "a1_nouns_3", week: 3, name: "–°—É—â. A1 (–ß–∞—Å—Ç—å 3)", cards: [
                { id: "der_Mann", front: "–º—É–∂—á–∏–Ω–∞", back: "der Mann" },
                { id: "die_Stadt", front: "–≥–æ—Ä–æ–¥", back: "die Stadt" }
            ]},
            // –ù–µ–¥–µ–ª—è 4 (–ù–æ–≤—ã–π –Ω–∞–±–æ—Ä)
            { id: "a1_verbs_1", week: 4, name: "–ì–ª–∞–≥–æ–ª—ã A1 (–ß–∞—Å—Ç—å 1)", cards: [
                { id: "machen", front: "–¥–µ–ª–∞—Ç—å", back: "machen" },
                { id: "gehen", front: "–∏–¥—Ç–∏", back: "gehen" }
            ]},
        ];

        /**
         * –ö–∞—Ä—Ç–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–ª—è –∫–∞–∂–¥–æ–π –Ω–µ–¥–µ–ª–∏. 
         * –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ 'description' –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ "–ü–æ–¥—Ä–æ–±–Ω–µ–µ".
         */
        const WEEKLY_CONTENT_MAP = {
            1: {
                associationVideo: "https://www.youtube.com/embed/jNQXAC9IVRw?autoplay=0&controls=1&showinfo=0&rel=0",
                associationTitle: "–ê—Å—Å–æ—Ü–∏–∞—Ü–∏–∏ –¥–ª—è –∑–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è —Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö A1",
                storyLink: "text1.html", // –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤–Ω—É—Ç—Ä–∏ SPA
                wordSetId: "a1_nouns_1",
                dialoguesLink: "https://your-domain.com/dialogs/week1",
                carouselId: "week1", 
                description: "–í —ç—Ç–æ–π –ø–æ–¥–±–æ—Ä–∫–µ –≤—ã –Ω–∞—á–Ω–µ—Ç–µ –∏–∑—É—á–µ–Ω–∏–µ –±–∞–∑–æ–≤—ã—Ö —Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö —É—Ä–æ–≤–Ω—è –ê1, –æ—Å–≤–æ–∏—Ç–µ –∞—Ä—Ç–∏–∫–ª–∏ –∏ –ø–æ–ª—É—á–∏—Ç–µ –≤–∏–¥–µ–æ-–∞—Å—Å–æ—Ü–∏–∞—Ü–∏–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –∑–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è."
            },
            2: {
                associationVideo: "https://www.youtube.com/embed/2-nFz1WJ3vM?autoplay=0&controls=1&showinfo=0&rel=0",
                associationTitle: "–ê—Å—Å–æ—Ü–∏–∞—Ü–∏–∏ –¥–ª—è –∞—Ä—Ç–∏–∫–ª—è 'Das' (—Å—Ä–µ–¥–Ω–∏–π —Ä–æ–¥)",
                storyLink: "https://your-domain.com/story/week2",
                wordSetId: "a1_nouns_2",
                dialoguesLink: "https://your-domain.com/dialogs/week2",
                carouselId: "week1", 
                description: "–§–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è –Ω–∞ —Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö —Å—Ä–µ–¥–Ω–µ–≥–æ —Ä–æ–¥–∞ (Das) –∏ —Ä–∞–∑–±–∏—Ä–∞–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –æ–ø–∏—Å–∞–Ω–∏—è –¥–æ–º–∞ –∏ –≥–æ—Ä–æ–¥–∞."
            },
            3: {
                associationVideo: "https://www.youtube.com/embed/M0TfQvX5X1o?autoplay=0&controls=1&showinfo=0&rel=0",
                associationTitle: "–ê—Å—Å–æ—Ü–∏–∞—Ü–∏–∏ –¥–ª—è —Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –ê1 (–ß–∞—Å—Ç—å 3)",
                storyLink: "https://your-domain.com/story/week3",
                wordSetId: "a1_nouns_3",
                dialoguesLink: "https://your-domain.com/dialogs/week3",
                carouselId: "week1", 
                description: "–ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–∞—Å—à–∏—Ä—è—Ç—å —Å–ª–æ–≤–∞—Ä–Ω—ã–π –∑–∞–ø–∞—Å –ê1, –∏–∑—É—á–∞—è —Å–ª–æ–≤–∞, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –ª—é–¥—å–º–∏ –∏ –º–µ—Å—Ç–∞–º–∏. –î–æ—Å—Ç—É–ø–Ω–æ –ø–æ—Å–ª–µ 2-–π –Ω–µ–¥–µ–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∏."
            },
            4: {
                associationVideo: "https://www.youtube.com/embed/example4?autoplay=0&controls=1&showinfo=0&rel=0",
                associationTitle: "–ê—Å—Å–æ—Ü–∏–∞—Ü–∏–∏ –¥–ª—è –≥–ª–∞–≥–æ–ª–æ–≤ A1",
                storyLink: "https://your-domain.com/story/week4",
                wordSetId: "a1_verbs_1", 
                dialoguesLink: "https://your-domain.com/dialogs/week4",
                carouselId: "week1",
                description: "–ò–∑—É—á–µ–Ω–∏–µ –ø–µ—Ä–≤—ã—Ö 10 –≤–∞–∂–Ω—ã—Ö –≥–ª–∞–≥–æ–ª–æ–≤ —É—Ä–æ–≤–Ω—è A1, –∏—Ö —Å–ø—Ä—è–∂–µ–Ω–∏—è –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –ø—Ä–æ—Å—Ç—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è—Ö."
            },
        };

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–∞—Å—Å–∏–≤—ã –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
        const ALL_WEEKS = Object.keys(WEEKLY_CONTENT_MAP).map(Number).sort((a, b) => a - b);


        // ==========================================================
        // 2. –õ–û–ì–ò–ö–ê –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø (Conceptual App Module)
        // ==========================================================

        window.App = {
            db: null,
            auth: null, // –î–æ–±–∞–≤–ª—è–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä Auth
            userId: null,
            isAuthReady: false, // –§–ª–∞–≥ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
            userProgress: {}, 
            
            // –ü–û–õ–Ø –î–õ–Ø –ü–û–î–ü–ò–°–ö–ò –ò –ê–ö–¢–ò–í–ê–¶–ò–ò
            isSubscriber: false, 
            activationDate: null, 
            selectedWeek: 0, 
            
            unlockedWeek: 1, 
            sessionCards: [], 
            currentCardIndex: 0,
            isPracticeMode: false,
            isAdvancing: false,
            currentDirection: 'ru-de', 
            tempSetId: null, 
            tempMode: null,
            currentScreenId: 'loading-screen', 
            
            // –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ (—Ç–æ–ª—å–∫–æ –¥–ª—è "–í—Å–µ –Ω–∞–±–æ—Ä—ã —Å–ª–æ–≤")
            currentWeekFilter: 'All', 
            currentThemeFilter: 'All', 
            
            // –¢–µ–∫—É—â–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥"
            returnContext: { screen: 'home-screen', param: null },

            // –î–∞–Ω–Ω—ã–µ –∫–∞—Ä—É—Å–µ–ª–∏
            carouselSetsMetadata: [],
            carouselCards: [],
            currentCarouselIndex: 0,
            carouselReturnContext: { screen: 'home-screen', param: null },

            /**
             * –í–ê–ñ–ù–û: –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø—É—Ç—å –∫ –¥–æ–∫—É–º–µ–Ω—Ç—É –≤ Firestore, –∏—Å–ø–æ–ª—å–∑—É—è –í–ê–®–£ –ö–û–õ–õ–ï–ö–¶–ò–Æ –ò ID
             */
            getUserDocRef() {
                 if (!this.db || !this.userId) return null;
                 // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –í–ê–®–ï–ô –ö–û–õ–õ–ï–ö–¶–ò–ò (MY_COLLECTION_NAME) –∏ Telegram ID (this.userId)
                 return doc(this.db, MY_COLLECTION_NAME, this.userId);
                 
                 // –ï—Å–ª–∏ –±—ã –≤—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É Canvas, —ç—Ç–æ –≤—ã–≥–ª—è–¥–µ–ª–æ –±—ã —Ç–∞–∫:
                 // return doc(this.db, 'artifacts', appId, 'users', this.userId, 'progress', 'data');
            },


            async init() {
                try {
                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase —Å –í–ê–®–ï–ô –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
                    if (Object.keys(firebaseConfig).length > 0 && firebaseConfig.apiKey !== "YOUR_FIREBASE_CONFIG_HERE") {
                        const app = initializeApp(firebaseConfig);
                        this.db = getFirestore(app);
                        
                        // –ü–æ–ª—É—á–∞–µ–º Telegram ID –∏–ª–∏ Fallback ID
                        this.userId = MY_USER_ID_SOURCE;
                        this.isAuthReady = true;
                        
                        // –í —ç—Ç–æ–º —Ä–µ–∂–∏–º–µ –º—ã –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ–º Firebase Auth, –ø–æ—ç—Ç–æ–º—É –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.
                        // –ù–∞–º –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã –ø—Ä–∞–≤–∏–ª–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ Firebase —Ä–∞–∑—Ä–µ—à–∞–ª–∏ –∑–∞–ø–∏—Å—å –Ω–∞ –æ—Å–Ω–æ–≤–µ Document ID.
                        // (–ü—Ä–∞–≤–∏–ª–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –Ω–∞ –≤–∞—à–µ–π —Å—Ç–æ—Ä–æ–Ω–µ)

                    } else {
                         console.error("Firebase configuration not found or not set. Progress will not be saved.");
                         this.isAuthReady = false;
                         this.userId = MY_USER_ID_SOURCE; // –í—Å–µ —Ä–∞–≤–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º Telegram ID –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Å–∏–º—É–ª—è—Ü–∏–∏
                    }

                    // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞—â–∏—Ç—É –æ—Ç –∑—É–º–∏—Ä–æ–≤–∞–Ω–∏—è
                    this.disableZoom();
                    
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—É—Å–µ–ª–∏ –∑–∞—Ä–∞–Ω–µ–µ, —á—Ç–æ–±—ã –æ–Ω–∏ –±—ã–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –º–µ–Ω—é
                    await this.loadCarouselMetadata(); 

                    if (this.isAuthReady) {
                        await this.loadProgress();
                    } else {
                        // –í –ª–æ–∫–∞–ª—å–Ω–æ–º —Ä–µ–∂–∏–º–µ
                        this.isSubscriber = false; 
                        this.selectedWeek = 0; 
                        this.unlockedWeek = this.getMaxAvailableWeek(); 
                        this.renderHomeScreen();
                    }


                } catch (error) {
                    this.showError(`–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏/–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏: ${error.message}`);
                    console.error(error);
                }
            },
            
            /**
             * –û—Ç–∫–ª—é—á–∞–µ—Ç –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ (pinch-to-zoom) –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö.
             */
            disableZoom() {
                document.addEventListener('touchstart', (event) => {
                    // –ï—Å–ª–∏ –¥–≤–∞ –ø–∞–ª—å—Ü–∞ –∏ –±–æ–ª—å—à–µ, –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ (–∑—É–º)
                    if (event.touches.length > 1) {
                        event.preventDefault();
                    }
                }, { passive: false });

                // –¢–∞–∫–∂–µ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –¥–≤–æ–π–Ω–æ–π —Ç–∞–ø
                let lastTouchEnd = 0;
                document.addEventListener('touchend', function (event) {
                    const now = (new Date()).getTime();
                    if (now - lastTouchEnd <= 300) {
                        event.preventDefault();
                    }
                    lastTouchEnd = now;
                }, false);
            },


            async loadProgress() {
                this.showScreen('loading-screen');
                if (!this.isAuthReady) return; 

                try {
                    const docRef = this.getUserDocRef();
                    if (!docRef) {
                        console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç Firestore.");
                        return;
                    }

                    const docSnap = await getDoc(docRef);

                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        this.userProgress = data.cards || {};
                        
                        // –ù–û–í–´–ï –ü–û–õ–Ø
                        this.isSubscriber = data.isSubscriber || false;
                        this.activationDate = data.activationDate; 
                        this.selectedWeek = data.selectedWeek || 0; 
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–æ—Å—Ç—É–ø–Ω—É—é –Ω–µ–¥–µ–ª—é, –æ—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
                        this.unlockedWeek = this.getMaxAvailableWeek(); 

                    } else {
                        // –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
                        this.userProgress = {};
                        this.isSubscriber = false;
                        this.selectedWeek = 0; 
                        this.unlockedWeek = 1; 
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç
                        await this.saveProgress(); 
                    }
                } catch (error) {
                    console.error("Error loading progress:", error);
                } finally {
                    this.renderHomeScreen();
                }
            },
            
            async saveProgress() {
                if (!this.isAuthReady) return; 

                try {
                    const docRef = this.getUserDocRef();
                    if (!docRef) {
                        console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç Firestore.");
                        return;
                    }
                    
                    await setDoc(docRef, { 
                        cards: this.userProgress,
                        isSubscriber: this.isSubscriber,
                        activationDate: this.activationDate,
                        selectedWeek: this.selectedWeek
                    }, { merge: true });
                    console.log('–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ Firebase');
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:', error);
                }
            },

            /**
             * [–ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø] –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–æ—Å—Ç—É–ø–Ω—É—é –Ω–µ–¥–µ–ª—é.
             * –ü—Ä–∞–≤–∏–ª–æ: 1 –Ω–µ–¥–µ–ª—è = 7 –¥–Ω–µ–π —Å –¥–∞—Ç—ã –∞–∫—Ç–∏–≤–∞—Ü–∏–∏.
             */
            getMaxAvailableWeek() {
                if (!this.isSubscriber || !this.activationDate) {
                    // –ï—Å–ª–∏ –Ω–µ –ø–æ–¥–ø–∏—Å—á–∏–∫, –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –ù–µ–¥–µ–ª—è 1 (–∫–∞–∫ –ø—Ä–æ–±–Ω—ã–π —É—Ä–æ–∫)
                    return 1; 
                }
                
                // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º activationDate –≤ –æ–±—ä–µ–∫—Ç Date
                const activationTime = new Date(this.activationDate).getTime();
                const currentTime = new Date().getTime();
                
                // –†–∞–∑–Ω–∏—Ü–∞ –≤ –¥–Ω—è—Ö
                const daysDiff = Math.floor((currentTime - activationTime) / (1000 * 60 * 60 * 24));
                
                // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–æ—Å—Ç—É–ø–Ω–∞—è –Ω–µ–¥–µ–ª—è: 
                // –ù–µ–¥–µ–ª—è 1: –¥–Ω–∏ 0-6; –ù–µ–¥–µ–ª—è 2: –¥–Ω–∏ 7-13 –∏ —Ç.–¥.
                let maxWeek = Math.floor(daysDiff / 7) + 1;
                
                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –ø–æ –æ–±—â–µ–º—É –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –Ω–µ–¥–µ–ª—å –≤ –∫—É—Ä—Å–µ
                return Math.min(ALL_WEEKS.length, Math.max(1, maxWeek));
            },
            
            /**
             * [–ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø] –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è Telegram-–±–æ—Ç–æ–º)
             */
            async activateSubscription() {
                if (this.isSubscriber) return; // –£–∂–µ –∞–∫—Ç–∏–≤–µ–Ω

                this.isSubscriber = true;
                this.activationDate = this.getTodayDateString();
                this.selectedWeek = 1; // –í—ã–±–∏—Ä–∞–µ–º –ù–µ–¥–µ–ª—é 1 –∫–∞–∫ –∞–∫—Ç–∏–≤–Ω—É—é
                this.unlockedWeek = this.getMaxAvailableWeek(); 
                
                await this.saveProgress();
                this.renderHomeScreen();
            },

            // ==================== –†–ï–ù–î–ï–†–ò–ù–ì –≠–ö–†–ê–ù–û–í ====================

renderHomeScreen() {
            this.showScreen('home-screen');
            this.returnContext = { screen: 'home-screen', param: null };

            // ‚ñº‚ñº‚ñº –î–û–ë–ê–í–õ–ï–ù–ê –≠–¢–ê –°–¢–†–û–ö–ê ‚ñº‚ñº‚ñº
            this.renderBackButton('home-screen'); // –°–∫—Ä—ã–≤–∞–µ–º —Ñ—É—Ç–µ—Ä –Ω–∞ –≥–ª–∞–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ

            const mainBlock = document.getElementById('main-content-block');
                mainBlock.innerHTML = '';
                
                // 1. –î–ò–ù–ê–ú–ò–ß–ï–°–ö–ò–ô –ë–õ–û–ö: –ü—Ä–æ–±–Ω—ã–π —É—Ä–æ–∫ –ò–õ–ò –ê–∫—Ç–∏–≤–Ω–∞—è –Ω–µ–¥–µ–ª—è
                // selectedWeek = 0, –µ—Å–ª–∏ –Ω–µ –ø–æ–¥–ø–∏—Å—á–∏–∫ –∏ –Ω–µ –≤—ã–±—Ä–∞–ª –Ω–µ–¥–µ–ª—é
                if (!this.isSubscriber && this.selectedWeek === 0) { 
                    // 1.1. –ü—Ä–æ–±–Ω—ã–π —É—Ä–æ–∫
                    // –ò–°–ü–†–ê–í–õ–ï–ù–û: –í–µ–¥–µ–º —Å—Ä–∞–∑—É –Ω–∞ –ö–æ–Ω—Ç–µ–Ω—Ç –ù–µ–¥–µ–ª–∏ 1
                    mainBlock.innerHTML += `
                        <button onclick="window.App.renderWeekContent(1)" class="promo-button w-full py-4 px-5 rounded-xl shadow-lg text-left text-lg font-bold flex justify-between items-center transition duration-150">
                            <span>üöÄ –ü—Ä–æ–±–Ω—ã–π —É—Ä–æ–∫</span>
                            <span>–ù–∞—á–∞—Ç—å &rarr;</span>
                        </button>
                    `;
                    
                } else {
                    // 1.2. –ê–∫—Ç–∏–≤–Ω–∞—è –Ω–µ–¥–µ–ª—è (–∏–ª–∏ –ø–æ—Å–ª–µ–¥–Ω—è—è –≤—ã–±—Ä–∞–Ω–Ω–∞—è, –¥–∞–∂–µ –µ—Å–ª–∏ –ü—Ä–æ–±–Ω—ã–π)
                    const activeWeek = this.selectedWeek;
                    const weekTitle = activeWeek === 1 && !this.isSubscriber 
                                    ? '–ü—Ä–æ–±–Ω—ã–π —É—Ä–æ–∫ (–ù–µ–¥–µ–ª—è 1)' 
                                    : `–ù–µ–¥–µ–ª—è ${activeWeek}`;
                    
                    if (activeWeek >= 1 && activeWeek <= ALL_WEEKS.length) {
                        // –ê–∫—Ç–∏–≤–Ω–∞—è –Ω–µ–¥–µ–ª—è –Ω–∞ –ì–ª–∞–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ
                        mainBlock.innerHTML += `
                            <button onclick="window.App.renderWeekContent(${activeWeek})" class="active-week-button w-full py-4 px-5 rounded-xl shadow-lg text-left text-lg font-bold flex justify-between items-center transition duration-150">
                                <span>üìÖ –ê–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–±–æ—Ä–∫–∞: ${weekTitle}</span>
                                <span>–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å &rarr;</span>
                            </button>
                        `;
                    }
                }
                
                // 2. –ö–Ω–æ–ø–∫–∞ "–ü–æ–¥–±–æ—Ä–∫–∏ –ø–æ –Ω–µ–¥–µ–ª—è–º"
                mainBlock.innerHTML += `
                    <button onclick="window.App.renderWeeklySelections()" class="w-full py-4 px-5 bg-white rounded-xl shadow-lg text-left text-lg font-semibold text-gray-800 hover:bg-gray-50 flex justify-between items-center transition duration-150 mt-4 border border-gray-200">
                        <span>üìö –ü–æ–¥–±–æ—Ä–∫–∏ –∑–∞ –Ω–µ–¥–µ–ª—é</span>
                        <span>&rarr;</span>
                    </button>
                `;

                // 3. –†–∞–∑–¥–µ–ª: –í—Å–µ –Ω–∞–±–æ—Ä—ã —Å–ª–æ–≤ (–ü–µ—Ä–µ–º–µ—â–µ–Ω –∏–∑ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ HTML –≤ JS, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è)
                mainBlock.innerHTML += `
                    <button onclick="window.App.renderAllSetsScreen()" class="w-full py-4 px-5 bg-white rounded-xl shadow-lg text-left text-lg font-semibold text-gray-800 hover:bg-gray-50 flex justify-between items-center transition duration-150 mt-4">
                        <span>üìö –í—Å–µ –Ω–∞–±–æ—Ä—ã —Å–ª–æ–≤</span>
                        <span>&rarr;</span>
                    </button>
                `;
                
                // --- –õ–ò–®–ù–Ø–Ø –ö–ù–û–ü–ö–ê –£–î–ê–õ–ï–ù–ê –ò–ó –ì–õ–ê–í–ù–û–ì–û HTML ---
                
                
                this.renderDueTodaySection();
            },
            /**
             * [–ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø] –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å–µ–∫—Ü–∏—é —Å –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ–º –Ω–∞ –≥–ª–∞–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ.
             */
            renderDueTodaySection() {
                // (–õ–æ–≥–∏–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–µ–∫—Ü–∏–∏ "–ö –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—é —Å–µ–≥–æ–¥–Ω—è" - –Ω–µ –∏–∑–º–µ–Ω–µ–Ω–∞)
                const section = document.getElementById('due-today-section');
                const list = document.getElementById('due-today-list');
                if (!section || !list) return;

                const today = this.getTodayDateString();
                let dueSetsCount = 0;

                list.innerHTML = '';

                WORD_SETS.forEach(set => {
                    // –ü—Ä–æ–±–Ω—ã–π —É—Ä–æ–∫ –¥–æ—Å—Ç—É–ø–µ–Ω –≤—Å–µ–≥–¥–∞, –æ—Å—Ç–∞–ª—å–Ω–æ–µ —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ –¥–æ unlockedWeek
                    if (this.isSubscriber && set.week > this.unlockedWeek) return;
                    if (!this.isSubscriber && set.week > 1) return;

                    let dueCount = 0;
                    set.cards.forEach(card => {
                        const progress = this.userProgress[card.id];
                        if (!progress || (progress.nextReview && progress.nextReview <= today)) {
                            dueCount++;
                        }
                    });

                    if (dueCount > 0) {
                        dueSetsCount++;
                        const setEl = document.createElement('div');
                        setEl.className = "bg-white p-4 rounded-xl shadow-md border-l-4 border-orange-500 flex justify-between items-center transform transition hover:-translate-y-1";
                        setEl.innerHTML = `
                            <div>
                                <span class="font-bold text-gray-800">${set.name}</span>
                                <span class="text-sm text-orange-600 font-medium block">–î–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è: ${dueCount}</span>
                            </div>
                            <button onclick="window.App.promptForDirection('${set.id}', 'review')"
                                    class="py-2 px-4 bg-orange-100 text-orange-700 font-bold rounded-xl hover:bg-orange-200 transition duration-150 flex items-center">
                                –ù–∞—á–∞—Ç—å
                                <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            </button>
                        `;
                        list.appendChild(setEl);
                    }
                });

                if (dueSetsCount > 0) {
                    section.classList.remove('hidden');
                } else {
                    section.classList.add('hidden');
                }
            },

            // –£–î–ê–õ–ï–ù–ê —Ñ—É–Ω–∫—Ü–∏—è renderTrialLesson, —Ç–µ–ø–µ—Ä—å –ª–æ–≥–∏–∫–∞ –≤ renderHomeScreen


            renderWeeklySelections() {
                this.returnContext = { screen: 'home-screen', param: null };
                document.getElementById('list-title').innerText = 'üìö –ü–æ–¥–±–æ—Ä–∫–∏ –∑–∞ –Ω–µ–¥–µ–ª—é';
                this.renderBackButton('home-screen');
                document.getElementById('filter-controls').innerHTML = '';

                const contentListDiv = document.getElementById('content-list');
                contentListDiv.innerHTML = '';
                
                // [–ò–ó–ú–ï–ù–ï–ù–ò–ï] –û–±–Ω–æ–≤–ª—è–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–æ—Å—Ç—É–ø–Ω—É—é –Ω–µ–¥–µ–ª—é –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ —Å–ø–∏—Å–æ–∫
                this.unlockedWeek = this.getMaxAvailableWeek(); 

                ALL_WEEKS.forEach(i => {
                    const isSubscriber = this.isSubscriber;
                    const maxAvailableWeek = this.unlockedWeek;
                    const isCurrentSelected = i === this.selectedWeek; // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –Ω–µ–¥–µ–ª—é
                    const isAvailable = isSubscriber ? (i <= maxAvailableWeek) : (i === 1); // –ù–µ–ø–æ–¥–ø–∏—Å—á–∏–∫—É –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –ù–µ–¥–µ–ª—è 1
                    const weekData = WEEKLY_CONTENT_MAP[i];
                    
                    let statusText = '–î–æ—Å—Ç—É–ø–Ω–æ';
                    let buttonClass = 'bg-white hover:bg-gray-50';

                    if (!isAvailable) {
                        buttonClass = 'button-locked';
                        if (!isSubscriber) {
                            statusText = 'üîí –û—Ñ–æ—Ä–º–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É';
                        } else {
                            // –ü–æ–¥–ø–∏—Å—á–∏–∫, –Ω–æ –∂–¥–µ—Ç –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏
                            const activationTime = new Date(this.activationDate).getTime();
                            const currentTime = new Date().getTime();
                            const daysDiff = Math.floor((currentTime - activationTime) / (1000 * 60 * 60 * 24));
                            const daysNeeded = (i - 1) * 7;
                            const daysLeft = daysNeeded - daysDiff;
                            
                            statusText = `üîí –î–æ—Å—Ç—É–ø–Ω–æ —á–µ—Ä–µ–∑ ${daysLeft} –¥–Ω.`;
                        }
                    } else if (i === 1 && !isSubscriber) {
                        buttonClass = 'bg-green-100 border-2 border-green-500';
                        statusText = '–ü—Ä–æ–±–Ω—ã–π —É—Ä–æ–∫';
                    } else if (isCurrentSelected) {
                        buttonClass = 'bg-yellow-100 border-2 border-yellow-500';
                        statusText = '–ê–∫—Ç–∏–≤–Ω–æ';
                    }

                    const weekContainer = document.createElement('div');
                    weekContainer.className = `w-full p-4 rounded-xl shadow-md ${buttonClass}`;
                    weekContainer.innerHTML = `
                        <div class="flex justify-between items-center mb-3">
                            <div>
                                <span class="font-bold text-lg ${!isAvailable ? 'text-gray-500' : 'text-gray-800'}">–ù–µ–¥–µ–ª—è ${i}</span>
                                <span class="block text-sm ${!isAvailable ? 'text-orange-600' : 'text-gray-500'}">${statusText}</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="window.App.showWeekDetails(${i}, '${weekData.description.replace(/'/g, "\\'")}')" 
                                    class="w-full py-2 px-3 bg-gray-200 text-gray-700 font-semibold rounded-xl text-sm hover:bg-gray-300 transition duration-150">
                                –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                            </button>
                            <button id="week-learn-${i}" 
                                    class="w-full py-2 px-3 text-white font-semibold rounded-xl text-sm transition duration-150 ${isAvailable ? 'bg-blue-500 hover:bg-blue-600' : 'button-locked'}"
                                    onclick="${isAvailable ? `window.App.selectAndRenderWeek(${i})` : 'void(0)'}">
                                –£—á–∏—Ç—å
                            </button>
                        </div>
                    `;
                    contentListDiv.appendChild(weekContainer);
                });
                
                this.showScreen('list-screen');
            },
            
            /**
             * [–ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø] –û—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –Ω–µ–¥–µ–ª–∏.
             */
            showWeekDetails(weekNum, description) {
                document.getElementById('week-details-title').textContent = `–ù–µ–¥–µ–ª—è ${weekNum}`;
                document.getElementById('week-details-body').textContent = description;
                this.openModal('week-details-modal');
            },

            /**
             * [–ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø] –í—ã–±–∏—Ä–∞–µ—Ç –Ω–µ–¥–µ–ª—é –∫–∞–∫ –∞–∫—Ç–∏–≤–Ω—É—é, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ –µ–µ –∫–æ–Ω—Ç–µ–Ω—Ç—É.
             */
            async selectAndRenderWeek(weekNum) {
                this.selectedWeek = weekNum;
                await this.saveProgress();
                this.renderWeekContent(weekNum);
            },
            
            /**
             * –†–µ–Ω–¥–µ—Ä–∏—Ç –∫–∞—Ä—Ç–æ—á–∫—É –º–µ–Ω—é –¥–ª—è –Ω–µ–¥–µ–ª–∏
             */
            renderMenuCard(container, title, subtitle, onClickAction, style = 'bg-white hover:bg-gray-50') {
                const button = document.createElement('button');
                button.className = `w-full text-left p-4 ${style} rounded-xl shadow-md flex justify-between items-center transition duration-150`;
                button.setAttribute('onclick', onClickAction);
                
                button.innerHTML = `
                    <div>
                        <span class="font-semibold text-lg text-gray-800">${title}</span>
                        <span class="block text-sm text-gray-500">${subtitle}</span>
                    </div>
                    <span>&rarr;</span>
                `;
                container.appendChild(button);
            },
            
            renderWeekContent(weekNum) {
                const weekData = WEEKLY_CONTENT_MAP[weekNum];
                if (!weekData) return;
                
                // >>> –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø–æ–¥–ø–∏—Å—á–∏–∫ –∏ —Ç–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è - –ù–µ–¥–µ–ª—è 1, 
                // –∏ –æ–Ω–∞ –µ—â–µ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞ (selectedWeek === 0), —Å–æ—Ö—Ä–∞–Ω—è–µ–º –µ–µ –∫–∞–∫ –≤—ã–±—Ä–∞–Ω–Ω—É—é.
               // const isTrialLessonClicked = !this.isSubscriber && weekNum === 1 && this.selectedWeek === 0;
                // if (isTrialLessonClicked) {
                   // this.selectedWeek = 1;
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å, —á—Ç–æ–±—ã –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –≤—Ö–æ–¥–µ –æ—Ç–æ–±—Ä–∞–∂–∞–ª–∞—Å—å –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–±–æ—Ä–∫–∞, –∞ –Ω–µ –∫–Ω–æ–ø–∫–∞ –ü—Ä–æ–±–Ω–æ–≥–æ —É—Ä–æ–∫–∞.
                   // this.saveProgress(); 
                //}
                
                // 1. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞
                // –ï—Å–ª–∏ –ù–µ–ø–æ–¥–ø–∏—Å—á–∏–∫ –ò –∞–∫—Ç–∏–≤–Ω–∞ –ù–µ–¥–µ–ª—è 1 (–ü—Ä–æ–±–Ω—ã–π —É—Ä–æ–∫), —Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –Ω–∞ –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω.
                // –ò–Ω–∞—á–µ (–ü–æ–¥–ø–∏—Å—á–∏–∫ –∏–ª–∏ –ù–µ–¥–µ–ª—è 1 –æ—Ç–∫—Ä—ã—Ç–∞ —á–µ—Ä–µ–∑ —Å–ø–∏—Å–æ–∫), –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –Ω–∞ –°–ø–∏—Å–æ–∫ –ù–µ–¥–µ–ª—å.
                const isTrialLesson = !this.isSubscriber && weekNum === 1;
                
                if (isTrialLesson) {
                    this.returnContext = { screen: 'home-screen', param: null };
                } else {
                    this.returnContext = { screen: 'weekly-selections', param: null };
                }
                
                // 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞
                if (isTrialLesson) {
                    document.getElementById('list-title').innerText = `üöÄ –ö–æ–Ω—Ç–µ–Ω—Ç –ü—Ä–æ–±–Ω–æ–≥–æ —É—Ä–æ–∫–∞`;
                } else {
                    document.getElementById('list-title').innerText = `üìö –ö–æ–Ω—Ç–µ–Ω—Ç –ù–µ–¥–µ–ª–∏ ${weekNum}`;
                }

                // 3. –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥"
                this.renderBackButton(this.returnContext.screen, this.returnContext.param); 
                document.getElementById('filter-controls').innerHTML = '';

                const contentListDiv = document.getElementById('content-list');
                contentListDiv.innerHTML = '';
                
                // 1. –ê—Å—Å–æ—Ü–∏–∞—Ü–∏–∏ –Ω–∞ –Ω–µ–¥–µ–ª—é (–í–∏–¥–µ–æ)
                this.renderMenuCard(contentListDiv, 
                    `üß† –í–∏–¥–µ–æ –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–∏`, 
                    weekData.associationTitle,
                    `window.App.renderVideoContentScreen('${weekData.associationTitle.replace(/'/g, "\\'")}', '${weekData.associationVideo}', null, 'week-content', ${weekNum})`
                );
                
                // 2. –ö–∞—Ä—É—Å–µ–ª—å –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–π (–ü–†–Ø–ú–û–ô –ü–ï–†–ï–•–û–î –ö –û–î–ù–û–ô –ö–ê–†–£–°–ï–õ–ò)
                const carouselSet = this.carouselSetsMetadata.find(set => set.id === weekData.carouselId);
                if (carouselSet) {
                    this.renderMenuCard(contentListDiv, 
                        `üñºÔ∏è –ö–∞—Ä—É—Å–µ–ª—å –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–π: ${carouselSet.title}`, 
                        `–í–∏–∑—É–∞–ª—å–Ω–æ–µ –∏–∑—É—á–µ–Ω–∏–µ ${carouselSet.wordCount} —Å–ª–æ–≤`,
                        `window.App.startCarouselSession('${carouselSet.id}', '${carouselSet.title}', '${carouselSet.filepath}', 'week-content', ${weekNum})`,
                        'bg-purple-100 hover:bg-purple-200'
                    );
                } else {
                     this.renderMenuCard(contentListDiv, 
                        `üñºÔ∏è –ö–∞—Ä—É—Å–µ–ª—å –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–π (–û—à–∏–±–∫–∞)`, 
                        `–ù–∞–±–æ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω.`,
                        `void(0)`,
                        'button-locked'
                    );
                }

                // 3. –ò—Å—Ç–æ—Ä–∏—è –Ω–µ–¥–µ–ª–∏ (–í–ù–£–¢–†–ï–ù–ù–Ø–Ø –ó–ê–ì–†–£–ó–ö–ê text1.html –¢–û–õ–¨–ö–û –î–õ–Ø –ù–ï–î–ï–õ–ò 1)
                let storyAction;
                if (weekNum === 1 && weekData.storyLink === 'text1.html') {
                    // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Å–ª—É—á–∞–π –¥–ª—è –ù–µ–¥–µ–ª–∏ 1: –∑–∞–≥—Ä—É–∂–∞–µ–º text1.html –≤–Ω—É—Ç—Ä–∏ SPA
                    // –ö–æ–Ω—Ç–µ–∫—Å—Ç –≤–æ–∑–≤—Ä–∞—Ç–∞: 'week-content' (–ö–æ–Ω—Ç–µ–Ω—Ç –ù–µ–¥–µ–ª–∏)
                    storyAction = `window.App.renderStoryScreen('üìñ –ò—Å—Ç–æ—Ä–∏—è –Ω–µ–¥–µ–ª–∏ ${weekNum}', '${getBaseUrl() + 'text1.html'}', 'week-content', ${weekNum})`; 
                } else {
                    // –û—Å—Ç–∞–ª—å–Ω—ã–µ –Ω–µ–¥–µ–ª–∏ - –≤–Ω–µ—à–Ω—è—è —Å—Å—ã–ª–∫–∞ –∏–ª–∏ –æ–±—ã—á–Ω—ã–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç
                    storyAction = `window.App.renderExternalLinkScreen('üìñ –ò—Å—Ç–æ—Ä–∏—è –Ω–µ–¥–µ–ª–∏ ${weekNum}', '${weekData.storyLink}', 'week-content', ${weekNum})`; 
                }
                
                this.renderMenuCard(contentListDiv, 
                    `üìñ –ò—Å—Ç–æ—Ä–∏—è –Ω–µ–¥–µ–ª–∏`, 
                    `–í–∏–¥–µ–æ + –∫–≤–∏–∑`,
                    storyAction 
                );

                // 4. –°–ª–æ–≤–∞ –Ω–∞ –Ω–µ–¥–µ–ª—é (–°—Ä–∞–∑—É –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è)
                this.renderMenuCard(contentListDiv, 
                    `üìö –°–ª–æ–≤–∞ –Ω–∞ –Ω–µ–¥–µ–ª—é`, 
                    `–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ ${WORD_SETS.find(s => s.id === weekData.wordSetId)?.cards.length || 0} —Å–ª–æ–≤`,
                    `window.App.promptForDirection('${weekData.wordSetId}', 'practice')`,
                    'bg-green-100 hover:bg-green-200'
                );
                
                // 5. –ü–æ–ª–µ–∑–Ω—ã–µ —Ñ—Ä–∞–∑—ã / –î–∏–∞–ª–æ–≥–∏ –Ω–∞ —Ç–µ–º—É (–í–ù–ï–®–ù–Ø–Ø –°–°–´–õ–ö–ê)
                this.renderMenuCard(contentListDiv, 
                    `üó£Ô∏è –ü–æ–ª–µ–∑–Ω—ã–µ —Ñ—Ä–∞–∑—ã / –î–∏–∞–ª–æ–≥–∏ –Ω–∞ —Ç–µ–º—É`, 
                    `–í–Ω–µ—à–Ω—è—è —Å—Å—ã–ª–∫–∞`,
                    `window.App.renderExternalLinkScreen('üó£Ô∏è –î–∏–∞–ª–æ–≥–∏ –ù–µ–¥–µ–ª–∏ ${weekNum}', '${weekData.dialoguesLink}', 'week-content', ${weekNum})` 
                );

                this.showScreen('list-screen');
                
                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –≤—ã–∑–æ–≤ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö, –µ—Å–ª–∏ –æ–Ω–∏ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
                if (this.carouselSetsMetadata.length === 0) {
                     this.loadCarouselMetadata().then(() => {
                         // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω, —á—Ç–æ–±—ã –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É –∫–∞—Ä—É—Å–µ–ª–∏
                         this.renderWeekContent(weekNum); 
                     });
                }
            },
            
            /**
             * –†–µ–Ω–¥–µ—Ä–∏—Ç —ç–∫—Ä–∞–Ω —Å –≤–∏–¥–µ–æ –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç–æ–º (–¥–ª—è –∑–∞–¥–∞–Ω–∏–π/–∞—Å—Å–æ—Ü–∏–∞—Ü–∏–π –Ω–µ–¥–µ–ª–∏)
             */
            renderVideoContentScreen(title, videoUrl, textContent, fromScreen, fromParam) {
                this.returnContext = { screen: fromScreen, param: fromParam };
                
                document.getElementById('video-title').textContent = title;
                const videoIframe = document.getElementById('video-embed');
                const extraTextDiv = document.getElementById('video-extra-text');

                if (videoUrl) {
                    videoIframe.src = videoUrl;
                    videoIframe.style.display = 'block';
                } else {
                    videoIframe.src = '';
                    videoIframe.style.display = 'none';
                }
                
                if (textContent) {
                    extraTextDiv.innerHTML = `<p>${textContent}</p>`;
                    extraTextDiv.style.display = 'block';
                } else {
                    extraTextDiv.innerHTML = '';
                    extraTextDiv.style.display = 'none';
                }
                
                // –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥ –≤–µ–¥–µ—Ç –Ω–∞ –ö–æ–Ω—Ç–µ–Ω—Ç –ù–µ–¥–µ–ª–∏
                this.renderBackButton('week-content', fromParam, 'video-content-screen');
                this.showScreen('video-content-screen');
            },
            
            /**
             * –†–µ–Ω–¥–µ—Ä–∏—Ç —ç–∫—Ä–∞–Ω –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –ø–æ –≤–Ω–µ—à–Ω–µ–π —Å—Å—ã–ª–∫–µ
             */
            renderExternalLinkScreen(title, url, fromScreen, fromParam) {
                this.returnContext = { screen: fromScreen, param: fromParam };

                document.getElementById('external-link-title').textContent = title;
                const button = document.getElementById('external-link-button');
                const urlDisplay = document.getElementById('external-link-url-display');
                
                button.href = url;
                urlDisplay.textContent = url;
                
                // –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥ –≤–µ–¥–µ—Ç –Ω–∞ –ö–æ–Ω—Ç–µ–Ω—Ç –ù–µ–¥–µ–ª–∏
                this.renderBackButton('week-content', fromParam, 'external-link-screen');
                this.showScreen('external-link-screen');

                // –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É —Å—Ä–∞–∑—É, –µ—Å–ª–∏ —ç—Ç–æ Telegram Web App
                if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.openLink) {
                    window.Telegram.WebApp.openLink(url);
                }
            },

            /**
             * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç HTML-–∫–æ–Ω—Ç–µ–Ω—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, text1.html) –≤–Ω—É—Ç—Ä–∏ SPA.
             */
/**
             * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç HTML-–∫–æ–Ω—Ç–µ–Ω—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, text1.html) –≤–Ω—É—Ç—Ä–∏ SPA.
             * [–ò–°–ü–†–ê–í–õ–ï–ù–û] –¢–µ–ø–µ—Ä—å —Ç–∞–∫–∂–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç <style> —Ç–µ–≥–∏ –∏–∑ <head>.
             */
            async renderStoryScreen(title, url, fromScreen, fromParam) {
                this.returnContext = { screen: fromScreen, param: fromParam };
                
                document.getElementById('content-viewer-title').textContent = title;
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º fromScreen –∏ fromParam –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –≤–æ–∑–≤—Ä–∞—Ç–∞
                this.renderBackButton(fromScreen, fromParam, 'content-viewer-screen');
                
                const contentBody = document.getElementById('content-viewer-body');
                contentBody.innerHTML = '<p class="text-center text-gray-500 py-10">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞...</p>';

                this.showScreen('content-viewer-screen');

                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('Network response was not ok');
                    let htmlContent = await response.text();
                    
                    // 1. –ò–∑–æ–ª–∏—Ä—É–µ–º HTML
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(htmlContent, 'text/html');
                    
                    // 2. [–ù–û–í–û–ï] –ò–∑–≤–ª–µ–∫–∞–µ–º —Å—Ç–∏–ª–∏ –∏–∑ <head>
                    const styles = doc.head.querySelectorAll('style');
                    let styleHtml = '';
                    styles.forEach(style => {
                        styleHtml += style.outerHTML;
                    });

                    // 3. –ò–∑–≤–ª–µ–∫–∞–µ–º —á–∏—Å—Ç—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –∏–∑ <body>
                    const innerContent = doc.body ? doc.body.innerHTML : htmlContent;
                    
                    // 4. [–ò–ó–ú–ï–ù–ï–ù–û] –í—Å—Ç–∞–≤–ª—è–µ–º –°–¢–ò–õ–ò + HTML
                    // –°–Ω–∞—á–∞–ª–∞ –≤—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏, –ø–æ—Ç–æ–º –∫–æ–Ω—Ç–µ–Ω—Ç
                    contentBody.innerHTML = styleHtml + innerContent;
                    
                    // 5. –í—ã–ø–æ–ª–Ω—è–µ–º —Å–∫—Ä–∏–ø—Ç—ã
                    // (–≠—Ç–∞ —á–∞—Å—Ç—å –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å, –æ–Ω–∞ –∏ —Ç–∞–∫ —Ä–∞–±–æ—Ç–∞–ª–∞)
                    const scripts = doc.querySelectorAll('script');
                    scripts.forEach(script => {
                        const newScript = document.createElement('script');
                        script.getAttributeNames().forEach(attr => {
                            newScript.setAttribute(attr, script.getAttribute(attr));
                        });
                        if (script.src) {
                            newScript.src = script.src;
                        } else {
                            newScript.textContent = script.textContent;
                        }
                        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –≤ –∫–æ–Ω–µ—Ü body, —á—Ç–æ–±—ã –æ–Ω –≤—ã–ø–æ–ª–Ω–∏–ª—Å—è
                        contentBody.appendChild(newScript);
                    });
                    
                    // 6. –ó–∞–ø—É—Å–∫–∞–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π init, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
                    // (–≠—Ç–∞ —á–∞—Å—Ç—å –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å)
                    const storyApp = window.StoryApp; 
                    if (storyApp && typeof storyApp.init === 'function') {
                         storyApp.init();
                    }

                } catch (error) {
                    contentBody.innerHTML = `<p class="text-red-500 text-center py-10">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞: ${error.message}</p>`;
                    console.error('Error loading story content:', error);
                }
            },

            renderAllSetsScreen() {
                // (–õ–æ–≥–∏–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è "–í—Å–µ –Ω–∞–±–æ—Ä—ã —Å–ª–æ–≤" - –Ω–µ –∏–∑–º–µ–Ω–µ–Ω–∞)
                document.getElementById('list-title').innerText = 'üìö –í—Å–µ –Ω–∞–±–æ—Ä—ã —Å–ª–æ–≤';
                this.renderBackButton('home-screen');
                
                this.renderSetFilterControls();
                
                const filteredSets = WORD_SETS.filter(set => {
                    const weekMatch = this.currentWeekFilter === 'All' || set.week.toString() === this.currentWeekFilter;
                    const unlockedMatch = set.week <= this.unlockedWeek; 
                    return weekMatch && unlockedMatch;
                });
                
                this.renderSetCards(filteredSets);
                this.showScreen('list-screen');
            },

            // ==================== –§–ò–õ–¨–¢–†–´ –ò –ö–ê–†–¢–û–ß–ö–ò ====================

            /**
             * –†–µ–Ω–¥–µ—Ä–∏—Ç –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥" —Å —É—á–µ—Ç–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
/**
             * [–ù–û–í–ê–Ø –í–ï–†–°–ò–Ø] –†–µ–Ω–¥–µ—Ä–∏—Ç –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥" –≤ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–º —Ñ—É—Ç–µ—Ä–µ.
             */
            renderBackButton(target, param = null, screenOverride = null) {
                const footer = document.getElementById('navigation-footer');
                const container = document.getElementById('nav-content-container');
                
                if (!footer || !container) return;

                // 1. –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –Ω—É–∂–Ω–∞ –ª–∏ –∫–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥".
                // –ï—Å–ª–∏ 'target' - —ç—Ç–æ 'home-screen', –º—ã –Ω–∞ –≥–ª–∞–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ, –∫–Ω–æ–ø–∫–∞ –Ω–µ –Ω—É–∂–Ω–∞.
                if (target === 'home-screen') {
                    footer.classList.add('hidden'); // –°–∫—Ä—ã–≤–∞–µ–º –≤–µ—Å—å —Ñ—É—Ç–µ—Ä
                    container.innerHTML = '';
                    return;
                }

                // 2. –í–∞—à–∞ –ª–æ–≥–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –∏ —Ñ—É–Ω–∫—Ü–∏–∏ (–æ–Ω–∞ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å, –æ–Ω–∞ –±—ã–ª–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π)
                let targetFunction;
                let buttonText; 

                switch (target) {
                    case 'home-screen':
                        targetFunction = 'window.App.renderHomeScreen()';
                        buttonText = '–í –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é';
                        break;
                    case 'weekly-selections':
                        targetFunction = 'window.App.renderWeeklySelections()';
                        buttonText = '–ö –ü–æ–¥–±–æ—Ä–∫–∞–º –ù–µ–¥–µ–ª–∏';
                        break;
                    case 'week-content':
                        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫—É–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å—Å—è –∏–∑ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–∞ (–≤–∏–¥–µ–æ/–∏—Å—Ç–æ—Ä–∏—è)
                        const isTrialLesson = !this.isSubscriber && this.selectedWeek === 1;
                        if (isTrialLesson) {
                             targetFunction = 'window.App.renderHomeScreen()';
                             buttonText = '–í –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é';
                        } else {
                            targetFunction = `window.App.renderWeekContent(${param})`; 
                            buttonText = '–ö –ö–æ–Ω—Ç–µ–Ω—Ç—É –ù–µ–¥–µ–ª–∏';
                        }
                        break;
                    case 'carousel-list':
                        targetFunction = `window.App.renderCarouselListScreen('week-content', ${this.selectedWeek})`; 
                        buttonText = '–ö –°–ø–∏—Å–∫—É –ö–∞—Ä—É—Å–µ–ª–µ–π';
                        break;
                    default:
                        targetFunction = 'window.App.renderHomeScreen()';
                        buttonText = '–í –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é';
                }

                // 3. –†–µ–Ω–¥–µ—Ä–∏–º –∫—Ä–∞—Å–∏–≤—É—é –∫–Ω–æ–ø–∫—É –≤ —Ñ—É—Ç–µ—Ä–µ
                container.innerHTML = `
                    <button onclick="${targetFunction}" class="w-full py-3 px-4 bg-blue-500 text-white font-bold rounded-xl shadow-md hover:bg-blue-600 transition duration-150 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                        <span>${buttonText}</span>
                    </button>
                `;
                
                // 4. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ—É—Ç–µ—Ä
                footer.classList.remove('hidden');
            },
            
            renderSetFilterControls() {
                // (–õ–æ–≥–∏–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –¥–ª—è "–í—Å–µ –Ω–∞–±–æ—Ä—ã —Å–ª–æ–≤" - –Ω–µ –∏–∑–º–µ–Ω–µ–Ω–∞)
                const filterControls = document.getElementById('filter-controls');
                filterControls.innerHTML = `
                    <div class="grid grid-cols-2 gap-3">
                        <select id="week-filter" onchange="window.App.updateSetFilter('week', this.value)" 
                                class="p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="All">–í—Å–µ –ù–µ–¥–µ–ª–∏</option>
                            ${ALL_WEEKS.map(w => `<option value="${w}" ${this.currentWeekFilter === w.toString() ? 'selected' : ''}>–ù–µ–¥–µ–ª—è ${w}</option>`).join('')}
                        </select>
                    </div>
                `;
            },
            
            updateSetFilter(filterType, value) {
                if (filterType === 'week') {
                    this.currentWeekFilter = value;
                }
                this.renderAllSetsScreen();
            },

            renderSetCards(setsToRender) {
                // (–õ–æ–≥–∏–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–µ–∫ –Ω–∞–±–æ—Ä–æ–≤ —Å–ª–æ–≤ - –Ω–µ –∏–∑–º–µ–Ω–µ–Ω–∞)
                const contentListDiv = document.getElementById('content-list');
                contentListDiv.innerHTML = '';
                const today = this.getTodayDateString();

                if (setsToRender.length === 0) {
                    contentListDiv.innerHTML = '<p class="text-gray-500 text-center py-6">–ù–µ—Ç –Ω–∞–±–æ—Ä–æ–≤, —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—è—é—â–∏—Ö —É—Å–ª–æ–≤–∏—è–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏.</p>';
                    return;
                }

                setsToRender.forEach(set => {
                    let dueCount = 0;
                    set.cards.forEach(card => {
                        const progress = this.userProgress[card.id];
                        if (!progress || (progress.nextReview && progress.nextReview <= today)) {
                            dueCount++;
                        }
                    });

                    const setContainer = document.createElement('div');
                    setContainer.className = "w-full p-4 bg-white rounded-xl shadow-md";
                    
                    setContainer.innerHTML = `
                        <div class="flex justify-between items-center mb-3">
                            <div>
                                <span class="font-semibold text-gray-800 text-lg">${set.name}</span>
                                <span class="block text-sm text-gray-500">–ù–µ–¥–µ–ª—è ${set.week} | ${set.cards.length} —Å–ª–æ–≤</span>
                            </div>
                            ${dueCount > 0 ? 
                                `<span class="bg-blue-500 text-white text-xs font-bold px-3 py-1 rounded-full shadow-md">${dueCount} –∫ –ø–æ–≤—Ç–æ—Ä—É</span>` :
                                `<span class="text-green-500 font-semibold">‚úì</span>`
                            }
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <button class="w-full py-2 px-3 bg-blue-500 text-white font-semibold rounded-xl text-sm hover:bg-blue-600 transition duration-150" 
                                    onclick="window.App.promptForDirection('${set.id}', 'review')">
                                –ü–æ–≤—Ç–æ—Ä–∏—Ç—å (${dueCount})
                            </button>
                            <button class="w-full py-2 px-3 bg-gray-200 text-gray-700 font-semibold rounded-xl text-sm hover:bg-gray-300 transition duration-150" 
                                    onclick="window.App.promptForDirection('${set.id}', 'practice')">
                                –ü—Ä–∞–∫—Ç–∏–∫–∞ (–í—Å–µ)
                            </button>
                        </div>
                    `;
                    contentListDiv.appendChild(setContainer);
                });
            },
            
            // ==================== –õ–û–ì–ò–ö–ê –ö–ê–†–£–°–ï–õ–ò ====================
            
            /**
             * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤—Å–µ—Ö –∫–∞—Ä—É—Å–µ–ª–µ–π (carousel_sets.json).
             */
            async loadCarouselMetadata() {
                try {
                    // –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ carousel_sets.json –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –∫–æ—Ä–Ω–µ–≤–æ–π –ø–∞–ø–∫–µ
                    const response = await fetch(getBaseUrl() + 'carousel_sets.json');
                    if (!response.ok) {
                        throw new Error(`–û—à–∏–±–∫–∞ HTTP: ${response.status} ${response.statusText}`);
                    }
                    let rawResponseText = await response.text(); 
                    this.carouselSetsMetadata = JSON.parse(rawResponseText);
                    return true;
                } catch (error) {
                    console.error('Carousel Metadata Load Error:', error);
                    return false;
                }
            },


            /**
             * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤—Å–µ—Ö –∫–∞—Ä—É—Å–µ–ª–µ–π –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å–ø–∏—Å–æ–∫ (–ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø –¢–û–õ–¨–ö–û –î–õ–Ø –≠–ö–†–ê–ù–ê –°–ü–ò–°–ö–ê)
             */
            async renderCarouselListScreen(fromScreen, fromParam) {
                this.carouselReturnContext = { screen: fromScreen, param: fromParam };
                
                document.getElementById('carousel-list-title').innerText = '–ö–∞—Ä—É—Å–µ–ª—å –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–π';
                this.renderBackButton(fromScreen, fromParam, 'carousel-list-screen');
                
                const listDiv = document.getElementById('carousel-sets-list');
                listDiv.innerHTML = '<p class="text-center text-gray-500 py-6">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –Ω–∞–±–æ—Ä–æ–≤...</p>';
                this.showScreen('carousel-list-screen');
                
                if (this.carouselSetsMetadata.length === 0) {
                   await this.loadCarouselMetadata();
                }

                if (this.carouselSetsMetadata.length === 0) {
                     listDiv.innerHTML = '<p class="text-red-500 text-center py-6">–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –Ω–∞–±–æ—Ä–æ–≤ –∫–∞—Ä—É—Å–µ–ª–µ–π.</p>';
                     return;
                }
                
                listDiv.innerHTML = '';

                this.carouselSetsMetadata.forEach(set => {
                    const button = document.createElement('button');
                    button.className = 'w-full py-4 px-5 bg-white rounded-xl shadow-md text-left text-lg font-semibold text-gray-800 hover:bg-gray-50 flex justify-between items-center transition duration-150';
                    button.textContent = set.title;
                    button.innerHTML = `
                        <span>${set.title}</span>
                        <span class="text-sm text-gray-500">${set.wordCount} —Å–ª–æ–≤ &rarr;</span>
                    `;
                    button.onclick = () => this.startCarouselSession(set.id, set.title, set.filepath, 'carousel-list', null);
                    listDiv.appendChild(button);
                });
            },
            
            async startCarouselSession(setId, setTitle, filepath, fromScreen, fromParam) {
                // –ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥" –≤ —Å–∞–º–æ–π –∫–∞—Ä—É—Å–µ–ª–∏
                if (fromScreen && fromParam !== undefined) {
                    // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ï—Å–ª–∏ –ø—Ä–∏—à–ª–∏ —Å –ö–æ–Ω—Ç–µ–Ω—Ç–∞ –ù–µ–¥–µ–ª–∏, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è —Ç—É–¥–∞
                    this.carouselReturnContext = { screen: fromScreen, param: fromParam };
                } else {
                    // –ï—Å–ª–∏ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å–ø–∏—Å–∫–∞, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ —Å–ø–∏—Å–∫—É
                    this.carouselReturnContext = { screen: 'carousel-list', param: null };
                }
                
                const currentScreen = document.getElementById(this.currentScreenId);
                const loadingIndicator = document.createElement('p');
                loadingIndicator.className = "text-center text-gray-500 py-6";
                loadingIndicator.textContent = `–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞–±–æ—Ä–∞ "${setTitle}"...`;
                
                // –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                if (currentScreen) {
                    currentScreen.appendChild(loadingIndicator);
                }
                
                this.showScreen('loading-screen'); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—â–∏–π —ç–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –≤—Ä–µ–º—è fetch
                
                try {
                    // –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ —Ñ–∞–π–ª—ã —Å –¥–∞–Ω–Ω—ã–º–∏ –∫–∞—Ä—É—Å–µ–ª–µ–π –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –∫–æ—Ä–Ω–µ–≤–æ–π –ø–∞–ø–∫–µ
                    const response = await fetch(getBaseUrl() + filepath);
                    if (!response.ok) throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –Ω–∞–±–æ—Ä–∞: ${filepath}`);
                    
                    let rawResponseText = await response.text(); 
                    this.carouselCards = JSON.parse(rawResponseText);

                    if (this.carouselCards.length === 0) {
                        throw new Error('–ù–∞–±–æ—Ä –ø—É—Å—Ç.');
                    }

                    this.currentCarouselIndex = 0;
                    this.showCarouselCard();
                    this.showScreen('image-carousel-screen');
                    
                } catch (error) {
                    this.showScreen('loading-screen');
                    document.getElementById('loading-screen').innerHTML = `<p class="text-red-500 text-center py-6">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—É—Å–µ–ª–∏: ${error.message}</p>`;
                    console.error('Carousel Data Load Error:', error);
                }
            },

            showCarouselCard() {
                const card = this.carouselCards[this.currentCarouselIndex];
                
                document.getElementById('carousel-word-count').textContent = `–°–ª–æ–≤–æ ${this.currentCarouselIndex + 1} –∏–∑ ${this.carouselCards.length}`;
                document.getElementById('carousel-image').src = card.image;
                document.getElementById('carousel-word').textContent = card.word;
                document.getElementById('carousel-translation').textContent = card.translation;
                
                // –°–∫—Ä—ã–≤–∞–µ–º –ø–µ—Ä–µ–≤–æ–¥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                document.getElementById('carousel-translation').classList.add('hidden');
                document.getElementById('toggle-translation-button').textContent = '–ü–æ–∫–∞–∑–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥';

                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞–∑–∞–¥
                this.renderBackButton(this.carouselReturnContext.screen, this.carouselReturnContext.param, 'image-carousel-screen');
            },

            showNextWord() {
                this.currentCarouselIndex = (this.currentCarouselIndex + 1) % this.carouselCards.length;
                this.showCarouselCard();
            },

            showPrevWord() {
                this.currentCarouselIndex = (this.currentCarouselIndex - 1 + this.carouselCards.length) % this.carouselCards.length;
                this.showCarouselCard();
            },
            
            toggleTranslation() {
                const translationEl = document.getElementById('carousel-translation');
                const button = document.getElementById('toggle-translation-button');
                
                const isHidden = translationEl.classList.contains('hidden');
                
                if (isHidden) {
                    translationEl.classList.remove('hidden');
                    button.textContent = '–°–∫—Ä—ã—Ç—å –ø–µ—Ä–µ–≤–æ–¥';
                    // –ü—ã—Ç–∞–µ–º—Å—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ —Å–ª–æ–≤–æ –ø—Ä–∏ –ø–æ–∫–∞–∑–µ –ø–µ—Ä–µ–≤–æ–¥–∞
                    this.speakGerman(this.carouselCards[this.currentCarouselIndex].word); 
                } else {
                    translationEl.classList.add('hidden');
                    button.textContent = '–ü–æ–∫–∞–∑–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥';
                }
            },

            returnToCarouselList() {
                 // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç, –æ—Ç–∫—É–¥–∞ –ø—Ä–∏—à–ª–∏ (–ª–∏–±–æ —Å–ø–∏—Å–æ–∫ –Ω–µ–¥–µ–ª—å, –ª–∏–±–æ —Å–ø–∏—Å–æ–∫ –∫–∞—Ä—É—Å–µ–ª–µ–π)
                 const { screen, param } = this.carouselReturnContext;
                 if (screen === 'week-content' && param !== null) {
                    this.renderWeekContent(param);
                 } else {
                    this.renderCarouselListScreen(this.carouselReturnContext.screen, this.carouselReturnContext.param);
                 }
            },


            // ==================== –õ–û–ì–ò–ö–ê –ü–û–í–¢–û–†–ï–ù–ò–Ø ====================

            promptForDirection(setId, mode) {
                this.tempSetId = setId;
                this.tempMode = mode;
                this.openModal('direction-modal');
            },

            closeDirectionModal() {
                this.closeModal('direction-modal');
            },

            startSessionWithDirection(direction) {
                this.currentDirection = direction;
                this.closeDirectionModal();
                this.startSession(this.tempSetId, this.tempMode);
            },
            
            startSession(setId, mode) {
                const set = WORD_SETS.find(s => s.id === setId);
                if (!set) return;

                this.isPracticeMode = (mode === 'practice');
                
                if (this.isPracticeMode) {
                    this.sessionCards = set.cards.map(card => ({...card})); 
                } else {
                    const today = this.getTodayDateString();
                    this.sessionCards = set.cards.filter(card => {
                        const progress = this.userProgress[card.id];
                        return !progress || (progress.nextReview && progress.nextReview <= today);
                    });
                }
                
                if (this.sessionCards.length === 0) {
                    this.showScreen('finish-screen');
                    document.getElementById('finish-screen-text').textContent = this.isPracticeMode 
                        ? '–í —ç—Ç–æ–º –Ω–∞–±–æ—Ä–µ –Ω–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫.' 
                        : '–î–ª—è —ç—Ç–æ–≥–æ –Ω–∞–±–æ—Ä–∞ –Ω–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫ –∫ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—é –Ω–∞ —Å–µ–≥–æ–¥–Ω—è!';
                    return;
                }
                
                this.sessionCards.sort(() => Math.random() - 0.5);
                this.currentCardIndex = 0;
                
                this.showScreen('study-screen');
                this.showNextCard();
            },

            showAnswer() {
                document.getElementById('card').classList.add('is-flipped');
                document.getElementById('controls-show').classList.add('hidden');
                document.getElementById('controls-rate').classList.remove('hidden');
                
                // –ü—Ä–æ–∏–∑–Ω–æ—Å–∏–º —Å–ª–æ–≤–æ, –µ—Å–ª–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ RU->DE
                if (this.currentDirection === 'ru-de') {
                     this.speakGerman(this.sessionCards[this.currentCardIndex].back);
                }
            },
            
            showNextCard() {
                if (this.currentCardIndex >= this.sessionCards.length) {
                    this.showScreen('finish-screen');
                    document.getElementById('finish-screen-text').textContent = '–í—ã –ø—Ä–æ—à–ª–∏ –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏.';
                    return;
                }
                
                const cardEl = document.getElementById('card');
                
                cardEl.classList.remove('is-flipped');
                cardEl.classList.add('slide-in');
                setTimeout(() => cardEl.classList.remove('slide-in'), 400);

                const totalCards = this.sessionCards.length;
                const currentCount = this.currentCardIndex + 1;
                const percent = (currentCount / totalCards) * 100;
                document.getElementById('progress-bar').style.width = `${percent}%`;

                document.getElementById('controls-show').classList.remove('hidden');
                document.getElementById('controls-rate').classList.add('hidden');

                const card = this.sessionCards[this.currentCardIndex];
                
                const speakerIconSvg = `
                    <svg class="w-6 h-6 text-blue-500 hover:text-blue-700 inline-block ml-2 cursor-pointer" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707A1 1 0 0112 6v12a1 1 0 01-1.707.707L5.586 15z"></path>
                    </svg>
                `;
                
                const germanHtml = `
                    <div class="flex items-center justify-center gap-2">
                        <span>${card.back}</span>
                        <span onclick="window.App.speakGerman('${card.back}', event)">
                            ${speakerIconSvg}
                        </span>
                    </div>
                `;

                if (this.currentDirection === 'ru-de') {
                    document.getElementById('card-front-text').textContent = card.front;
                    document.getElementById('card-back-text').innerHTML = germanHtml;
                } else {
                    document.getElementById('card-front-text').innerHTML = germanHtml;
                    document.getElementById('card-back-text').textContent = card.front;
                    // –ü—Ä–æ–∏–∑–Ω–æ—Å–∏–º —Å–ª–æ–≤–æ, –µ—Å–ª–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ DE->RU
                    this.speakGerman(card.back);
                }
                
                const hintButton = document.getElementById('hint-button');
                if (card.hintImage) {
                    hintButton.classList.remove('hidden');
                } else {
                    hintButton.classList.add('hidden');
                }
            },
            
            async handleAnswer(knewIt) {
                if (this.isAdvancing) return; 
                this.isAdvancing = true;

                if (!this.isPracticeMode) {
                    const card = this.sessionCards[this.currentCardIndex];
                    let progress = this.userProgress[card.id] || { box: 0 };

                    if (knewIt) {
                        progress.box = Math.min(6, (progress.box || 0) + 1);
                    } else {
                        progress.box = 1;
                    }
                    
                    const interval = REPETITION_INTERVALS[progress.box];
                    progress.nextReview = this.getFutureDateString(interval);
                    
                    this.userProgress[card.id] = progress;
                    if (this.isAuthReady) { // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
                        this.saveProgress(); 
                    } else {
                         console.warn("–ü—Ä–æ–≥—Ä–µ—Å—Å –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω: Firebase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.");
                    }
                }
                
                document.getElementById('card').classList.add('slide-out');
                setTimeout(() => {
                    document.getElementById('card').classList.remove('slide-out'); 
                    this.currentCardIndex++; 
                    this.isAdvancing = false; 
                    this.showNextCard(); 
                }, 400); 
            },
            
            speakGerman(textToSpeak, event) {
                if (event) {
                    event.stopPropagation(); 
                }
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                    const utterance = new SpeechSynthesisUtterance(textToSpeak);
                    utterance.lang = 'de-DE'; 
                    // –ü—ã—Ç–∞–µ–º—Å—è –≤—ã–±—Ä–∞—Ç—å –Ω–µ–º–µ—Ü–∫–∏–π –≥–æ–ª–æ—Å –¥–ª—è –ª—É—á—à–µ–≥–æ –ø—Ä–æ–∏–∑–Ω–æ—à–µ–Ω–∏—è
                    const voices = window.speechSynthesis.getVoices().filter(v => v.lang.includes('de-'));
                    if (voices.length > 0) {
                        // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –≥–æ–ª–æ—Å —Å –∏–º–µ–Ω–µ–º "Anna" (—á–∞—Å—Ç–æ –Ω–µ–º–µ—Ü–∫–∏–π) –∏–ª–∏ –ø–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π
                        utterance.voice = voices.find(v => v.name.includes('Anna')) || voices.find(v => v.name.includes('Google')) || voices[0];
                    }
                    window.speechSynthesis.speak(utterance);
                } else {
                    console.log('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–∏–Ω—Ç–µ–∑ —Ä–µ—á–∏.');
                }
            },

            // ==================== –£–¢–ò–õ–ò–¢–´ ====================

            openModal(modalId) {
                const modal = document.getElementById(modalId);
                const modalContent = document.getElementById(`${modalId}-content`) || document.getElementById(`${modalId}-modal-content`);
                
                if (modal) {
                    modal.classList.remove('hidden');
                    setTimeout(() => {
                        modal.classList.add('is-open', 'opacity-100');
                        if (modalContent) {
                            modalContent.classList.add('is-open');
                        }
                    }, 10);
                }
            },
            
            closeModal(modalId) {
                const modal = document.getElementById(modalId);
                const modalContent = document.getElementById(`${modalId}-content`) || document.getElementById(`${modalId}-modal-content`);
                
                if (modal) {
                    modal.classList.remove('is-open', 'opacity-100');
                    if (modalContent) {
                        modalContent.classList.remove('is-open');
                    }
                    setTimeout(() => {
                        modal.classList.add('hidden');
                    }, 300);
                }
            },
            
            showHint() {
                const card = this.sessionCards[this.currentCardIndex];
                if (!card || !card.hintImage) return;
                const img = document.getElementById('hint-image');
                img.src = card.hintImage; 
                this.openModal('hint-modal');
            },

            closeHintModal() {
                this.closeModal('hint-modal');
            },
            
            showScreen(screenId) {
                this.currentScreenId = screenId;
                ['loading-screen', 'home-screen', 'list-screen', 'study-screen', 'finish-screen', 'video-content-screen', 'external-link-screen', 'content-viewer-screen', 'carousel-list-screen', 'image-carousel-screen'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.classList.add('hidden');
                });
                const screen = document.getElementById(screenId);
                if (screen) {
                    screen.classList.remove('hidden');
                }
            },
            
            showError(message) {
                this.showScreen('loading-screen');
                const loadingScreen = document.getElementById('loading-screen');
                if (loadingScreen) {
                    loadingScreen.innerHTML = `<p class="text-red-500 font-semibold">${message}</p>`;
                }
            },
            
            getTodayDateString() {
                return new Date().toISOString().split('T')[0];
            },

            getFutureDateString(daysToAdd) {
                const date = new Date();
                date.setDate(date.getDate() + daysToAdd);
                return date.toISOString().split('T')[0];
            }
        };
        
        // ==========================================================
        // 3. –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø (Conceptual Bootstrap)
        // ==========================================================

        window.addEventListener('load', () => {
            // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –≥–æ–ª–æ—Å–æ–≤ –¥–ª—è —Å–∏–Ω—Ç–µ–∑–∞ —Ä–µ—á–∏
            if ('speechSynthesis' in window) {
                window.speechSynthesis.getVoices(); 
                if (window.speechSynthesis.onvoiceschanged !== undefined) {
                    window.speechSynthesis.onvoiceschanged = () => window.speechSynthesis.getVoices();
                }
            }
            window.App.init();
        });

    </script>
</body>
</html>