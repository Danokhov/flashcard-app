<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–ò–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω–æ–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Tailwind –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —à—Ä–∏—Ñ—Ç–∞ Inter
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        };
    </script>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Firebase (–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö) -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, query, where, limit, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.firebaseImports = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, 
            getFirestore, collection, onSnapshot, doc, query, where, limit, getDocs
        };
    </script>
    
    <style>
        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –∏ —à—Ä–∏—Ñ—Ç */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–µ—Ä–µ–≤–æ—Ä–æ—Ç–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ */
        .card { perspective: 1000px; }
        .card-inner {
            position: relative;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .card.is-flipped .card-inner {
            transform: rotateY(180deg);
        }
        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            top: 0; left: 0;
            padding: 1.5rem; /* p-6 */
            border-radius: 0.75rem; /* rounded-xl */
        }
        .card-back {
            transform: rotateY(180deg);
            background-color: #DBEAFE; /* blue-100 */
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω */
        .modal { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; transform: scale(0.95); }
        .modal.is-open { opacity: 1; }
        .modal.is-open .modal-content { transform: scale(1); }

        /* –ù–æ–≤—ã–π —Å—Ç–∏–ª—å –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ë–∞–∑—ã –ê—Å—Å–æ—Ü–∏–∞—Ü–∏–π */
        .association-button {
            background-image: linear-gradient(to right, #6D28D9 0%, #8B5CF6 100%);
            transition: all 0.3s ease;
        }
        .association-button:hover {
            box-shadow: 0 10px 15px -3px rgba(109, 40, 217, 0.5), 0 4px 6px -2px rgba(109, 40, 217, 0.2);
            transform: translateY(-2px);
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∏—Å—á–µ–∑–∞–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏ (–¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞) */
        @keyframes slide-out-left {
            0% { transform: translateX(0); opacity: 1; }
            100% { transform: translateX(-100%); opacity: 0; }
        }
        .card.slide-out { animation: slide-out-left 0.4s ease forwards; }

    </style>
</head>

<body class="min-h-screen bg-gray-100 font-sans p-4">

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
    <div id="app" class="max-w-md mx-auto">
        
        <!-- 1. –≠–∫—Ä–∞–Ω –ó–∞–≥—Ä—É–∑–∫–∏ -->
        <div id="loading-screen" class="text-center py-20">
            <p class="text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
        </div>

        <!-- 2. –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ (Home Screen) -->
        <div id="home-screen" class="hidden">
            <h1 class="text-2xl font-bold text-center mb-8 text-gray-800">–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</h1>
            <div class="space-y-4">
                <!-- –û—Å–Ω–æ–≤–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã -->
                <button onclick="App.renderAllSetsScreen()" class="w-full py-4 px-5 bg-white rounded-xl shadow-lg text-left text-lg font-semibold text-gray-800 hover:bg-gray-50 flex justify-between items-center transition duration-150">
                    <span>üìö –í—Å–µ –Ω–∞–±–æ—Ä—ã —Å–ª–æ–≤</span>
                    <span>&rarr;</span>
                </button>
                <button onclick="App.renderAllStoriesScreen()" class="w-full py-4 px-5 bg-white rounded-xl shadow-lg text-left text-lg font-semibold text-gray-800 hover:bg-gray-50 flex justify-between items-center transition duration-150">
                    <span>üìñ –í—Å–µ –∏—Å—Ç–æ—Ä–∏–∏</span>
                    <span>&rarr;</span>
                </button>
                <button onclick="App.renderWeeklySelections()" class="w-full py-4 px-5 bg-white rounded-xl shadow-lg text-left text-lg font-semibold text-gray-800 hover:bg-gray-50 flex justify-between items-center transition duration-150">
                    <span>üìÖ –ü–æ–¥–±–æ—Ä–∫–∏ –ø–æ –Ω–µ–¥–µ–ª—è–º</span>
                    <span>&rarr;</span>
                </button>
                
                <!-- –†–ê–ó–î–ï–õ: –ë–∞–∑–∞ –ê—Å—Å–æ—Ü–∏–∞—Ü–∏–π -->
                <div class="pt-4 border-t border-gray-200">
                    <button onclick="App.renderAssociationBaseScreen()" class="association-button w-full py-4 px-5 text-white rounded-xl shadow-lg text-left text-lg font-bold flex justify-between items-center">
                        <span>üß† –ë–∞–∑–∞ –ê—Å—Å–æ—Ü–∏–∞—Ü–∏–π</span>
                        <span>&rarr;</span>
                    </button>
                </div>
            </div>
            
            <!-- –ù–û–í–´–ô –†–ê–ó–î–ï–õ: –ö–∞—Ä—Ç–æ—á–∫–∏ –∫ –ø–æ–≤—Ç–æ—Ä—É -->
            <div class="pt-6 mt-6 border-t-4 border-dashed border-red-300">
                <h2 class="text-xl font-bold mb-3 text-red-600">üî• –ö–∞—Ä—Ç–æ—á–∫–∏ –∫ –ø–æ–≤—Ç–æ—Ä—É</h2>
                <div id="due-review-section" class="space-y-3">
                    <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ JS -->
                </div>
            </div>

        </div>
        
        <!-- 3. –≠–ö–†–ê–ù –°–ü–ò–°–ö–ê (–¥–ª—è –Ω–µ–¥–µ–ª—å, —Å–µ—Ç–æ–≤, –∏—Å—Ç–æ—Ä–∏–π –∏–ª–∏ –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–π) -->
        <div id="list-screen" class="hidden">
            <h1 id="list-title" class="text-2xl font-bold text-center mb-6 text-gray-800"></h1>
            
            <!-- –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" -->
            <div id="back-button-container" class="mb-4"></div>
            
            <!-- –°–ø–∏—Å–æ–∫ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ -->
            <div id="content-list" class="space-y-4">
                <!-- –°—é–¥–∞ –±—É–¥—É—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω—ã –Ω–∞–±–æ—Ä—ã, –Ω–µ–¥–µ–ª–∏, –∏—Å—Ç–æ—Ä–∏–∏ –∏–ª–∏ –∫–∞—Ä—Ç–æ—á–∫–∏ –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–π -->
            </div>
        </div>

        <!-- 4. –≠–∫—Ä–∞–Ω –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è (Study Screen) -->
        <div id="study-screen" class="hidden">
            <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä -->
            <div class="bg-gray-200 rounded-full h-2.5 mb-4">
                <div id="progress-bar" class="bg-blue-500 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
            
            <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ -->
            <div id="card" class="card h-64 w-full mb-4">
                <div id="card-inner" class="card-inner h-full w-full" onclick="App.showAnswer()">
                    <!-- –ü–µ—Ä–µ–¥–Ω—è—è —Å—Ç–æ—Ä–æ–Ω–∞ -->
                    <div id="card-front" class="card-front flex items-center justify-center p-6 bg-white rounded-xl shadow-lg text-center">
                        <div id="card-front-text" class="text-2xl font-semibold"></div>
                    </div>
                    <!-- –ó–∞–¥–Ω—è—è —Å—Ç–æ—Ä–æ–Ω–∞ -->
                    <div id="card-back" class="card-back flex items-center justify-center p-6 bg-blue-100 rounded-xl shadow-lg text-center">
                        <div id="card-back-text" class="text-2xl font-semibold"></div>
                    </div>
                </div>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
            <div id="controls-show" class="text-center space-y-3">
                <button onclick="App.showAnswer()" class="w-full py-3 px-4 bg-blue-500 text-white font-bold rounded-xl shadow-md hover:bg-blue-600 transition duration-150">
                    –ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç
                </button>
            </div>
            
            <div id="controls-rate" class="hidden grid grid-cols-2 gap-4">
                <button onclick="App.handleAnswer(false)" class="py-3 px-4 bg-red-500 text-white font-bold rounded-xl shadow-md hover:bg-red-600 transition duration-150">
                    –ù–µ –ø–æ–º–Ω—é ‚ùå
                </button>
                <button onclick="App.handleAnswer(true)" class="py-3 px-4 bg-green-500 text-white font-bold rounded-xl shadow-md hover:bg-green-600 transition duration-150">
                    –ü–æ–º–Ω—é ‚úÖ
                </button>
            </div>
             <!-- –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é" –≤–æ –≤—Ä–µ–º—è —Å–µ—Å—Å–∏–∏ -->
            <div class="text-center mt-4">
                <button onclick="App.renderHomeScreen()" class="text-gray-500 hover:text-gray-700">
                    &larr; –ù–∞–∑–∞–¥ –≤ –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
                </button>
            </div>
        </div>
        
        <!-- 5. –≠–∫—Ä–∞–Ω –ó–∞–≤–µ—Ä—à–µ–Ω–∏—è (Finish Screen) -->
         <div id="finish-screen" class="hidden text-center py-20">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</h2>
            <p id="finish-screen-text" class="text-gray-600 mb-6">–í—ã –ø—Ä–æ—à–ª–∏ –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏.</p>
            <button onclick="App.renderHomeScreen()" class="py-3 px-6 bg-blue-500 text-white font-bold rounded-xl shadow-md hover:bg-blue-600">
                –í –º–µ–Ω—é
            </button>
        </div>

    </div>

    <!-- –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê -->
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –í—ã–±–æ—Ä–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
    <div id="direction-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 opacity-0" onclick="App.closeDirectionModal()">
        <div id="direction-modal-content" class="modal-content bg-white p-6 rounded-xl shadow-xl max-w-sm w-full" onclick="event.stopPropagation()">
            <h3 class="text-lg font-semibold mb-4 text-center">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h3>
            <div class="space-y-3">
                <button onclick="App.startSessionWithDirection('ru-de')" class="w-full py-3 px-4 bg-blue-500 text-white font-bold rounded-xl shadow-md hover:bg-blue-600">
                    –†—É—Å—Å–∫–∏–π ‚Üí –ù–µ–º–µ—Ü–∫–∏–π
                </button>
                <button onclick="App.startSessionWithDirection('de-ru')" class="w-full py-3 px-4 bg-purple-500 text-white font-bold rounded-xl shadow-md hover:bg-purple-600">
                    –ù–µ–º–µ—Ü–∫–∏–π ‚Üí –†—É—Å—Å–∫–∏–π
                </button>
                <button onclick="App.closeDirectionModal()" class="w-full mt-2 py-2 px-4 text-gray-600 font-semibold rounded-xl hover:bg-gray-100">
                    –û—Ç–º–µ–Ω–∞
                </button>
            </div>
        </div>
    </div>


    <!-- "–ú–ê–ì–ò–Ø" (JavaScript) -->
    <script>
        
        // ==========================================================
        // –®–ê–ì 1: –ù–ê–°–¢–†–û–ô–ö–ê –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø –ò –î–ê–ù–ù–´–•
        // ==========================================================
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ Firebase
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { projectId: 'mock-project' };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        // –ò–Ω—Ç–µ—Ä–≤–∞–ª—ã –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è –≤ –¥–Ω—è—Ö
        const repetitionIntervals = {
            1: 1,  // –ü–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è - –ø–æ–≤—Ç–æ—Ä–∏—Ç—å —á–µ—Ä–µ–∑ 1 –¥–µ–Ω—å
            2: 3,
            3: 7,
            4: 14,
            5: 30,
            6: 90
        };
        
        // --- –ú–û–ö-–î–ê–ù–ù–´–ï ---
        // –ò–º–∏—Ç–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ Firestore. –î–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è
        // nextReview: –î–∞—Ç–∞ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö, –∫–æ–≥–¥–∞ –∫–∞—Ä—Ç–æ—á–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–≤—Ç–æ—Ä–µ–Ω–∞
        const wordSets = [
            { 
                id: "a1_nouns_1", 
                title: "–ù–µ–º–µ—Ü–∫–∏–µ —Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ (A1)", 
                cards: [
                    { de: "Haus", ru: "–î–æ–º", hint_img: "https://placehold.co/150x100/FCA5A5/FFFFFF?text=–î–æ–º", level: 0, nextReview: Date.now() - (1000 * 60 * 60 * 24 * 3) }, // –ü–†–û–°–†–û–ß–ï–ù–û (3 –¥–Ω—è –Ω–∞–∑–∞–¥)
                    { de: "Auto", ru: "–ú–∞—à–∏–Ω–∞", hint_img: "https://placehold.co/150x100/A7F3D0/FFFFFF?text=–ú–∞—à–∏–Ω–∞", level: 1, nextReview: Date.now() + (1000 * 60 * 60 * 24 * 2) }, // –í –ü–õ–ê–ù–ï (—á–µ—Ä–µ–∑ 2 –¥–Ω—è)
                    { de: "Tisch", ru: "–°—Ç–æ–ª", hint_img: "https://placehold.co/150x100/BFDBFE/FFFFFF?text=–°—Ç–æ–ª", level: 2, nextReview: Date.now() - (1000 * 60 * 60 * 24 * 1) }, // –ü–†–û–°–†–û–ß–ï–ù–û (1 –¥–µ–Ω—å –Ω–∞–∑–∞–¥)
                    { de: "Stuhl", ru: "–°—Ç—É–ª", hint_img: "https://placehold.co/150x100/FEF9C3/FFFFFF?text=–°—Ç—É–ª", level: 0, nextReview: Date.now() - (1000 * 60 * 60 * 24 * 5) }, // –ü–†–û–°–†–û–ß–ï–ù–û (5 –¥–Ω–µ–π –Ω–∞–∑–∞–¥)
                ]
            },
            { 
                id: "verbs_b2", 
                title: "–°–ª–æ–∂–Ω—ã–µ –≥–ª–∞–≥–æ–ª—ã (B2)", 
                cards: [
                    { de: "verstehen", ru: "–ø–æ–Ω–∏–º–∞—Ç—å", level: 3, nextReview: Date.now() + (1000 * 60 * 60 * 24 * 5) }, // –í –ü–õ–ê–ù–ï (—á–µ—Ä–µ–∑ 5 –¥–Ω–µ–π)
                    { de: "entwickeln", ru: "—Ä–∞–∑–≤–∏–≤–∞—Ç—å", level: 1, nextReview: Date.now() + (1000 * 60 * 60 * 24 * 1) }, // –í –ü–õ–ê–ù–ï (—á–µ—Ä–µ–∑ 1 –¥–µ–Ω—å)
                ]
            },
            { 
                id: "phrases_travel", 
                title: "–§—Ä–∞–∑—ã –¥–ª—è –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–π", 
                cards: [
                    { de: "Wo ist...", ru: "–ì–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è...", level: 0, nextReview: Date.now() + (1000 * 60 * 60 * 24 * 10) }, // –í –ü–õ–ê–ù–ï (—á–µ—Ä–µ–∑ 10 –¥–Ω–µ–π)
                ]
            },
        ];
        
        const allStories = [
            { id: "story_1", title: "–ò—Å—Ç–æ—Ä–∏—è –æ –∫–æ—Ç–µ", content: "...", week: 1 },
            { id: "story_2", title: "–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ –≤ –ê–ª—å–ø—ã", content: "...", week: 1 },
        ];

        const associationBase = [
            { id: "ass_1", de: "Gl√ºck", ru: "–°—á–∞—Å—Ç—å–µ", transcription: "[…°l èk]", association_img: "https://placehold.co/150x100/FBBF24/FFFFFF?text=–£–¥–∞—á–∞" },
            { id: "ass_2", de: "Apfel", ru: "–Ø–±–ª–æ–∫–æ", transcription: "[ÀàapflÃ©]", association_img: "https://placehold.co/150x100/EF4444/FFFFFF?text=–§—Ä—É–∫—Ç" },
        ];


        // ==========================================================
        // –®–ê–ì 2: –ö–õ–ê–°–° –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
        // ==========================================================

        const App = {
            currentSetId: null,
            currentDirection: null, // 'ru-de' –∏–ª–∏ 'de-ru'
            sessionCards: [], // –ö–∞—Ä—Ç–æ—á–∫–∏ –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏
            originalSessionCards: [], // –ö–æ–ø–∏—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
            currentCardIndex: 0,
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
            async initFirebase() {
                try {
                    const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore } = window.firebaseImports;
                    
                    const app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);

                    console.log("Firebase initialized.");

                    return new Promise((resolve) => {
                        // –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
                        if (initialAuthToken) {
                            signInWithCustomToken(auth, initialAuthToken).catch(e => console.error("Custom token sign in failed:", e));
                        } else {
                            signInAnonymously(auth).catch(e => console.error("Anonymous sign in failed:", e));
                        }
                        
                        // –ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å –∑–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
                        const unsubscribe = onAuthStateChanged(auth, (user) => {
                            if (user) {
                                userId = user.uid;
                                console.log("User ID set:", userId);
                            } else {
                                userId = null;
                            }
                            isAuthReady = true;
                            unsubscribe(); // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–ª—É—à–∞—Ç–µ–ª—è –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è
                            resolve();
                        });
                    });
                } catch (e) {
                    console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase:", e);
                    // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –±–µ–∑ Firebase, –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å
                    isAuthReady = true;
                    return Promise.resolve();
                }
            },

            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–æ–≤
            showScreen(screenId) {
                const screens = ['loading-screen', 'home-screen', 'list-screen', 'study-screen', 'finish-screen'];
                screens.forEach(id => {
                    document.getElementById(id).classList.add('hidden');
                });
                document.getElementById(screenId).classList.remove('hidden');
            },

            // ==========================================================
            // –ì–õ–ê–í–ù–´–ô –≠–ö–†–ê–ù –ò –ü–û–í–¢–û–†–ï–ù–ò–ï
            // ==========================================================

            /**
             * –§–∏–ª—å—Ç—Ä—É–µ—Ç –Ω–∞–±–æ—Ä—ã, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ —Ç–µ, –≤ –∫–æ—Ç–æ—Ä—ã—Ö –µ—Å—Ç—å –∫–∞—Ä—Ç–æ—á–∫–∏, 
             * —Ç—Ä–µ–±—É—é—â–∏–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è (nextReview <= —Å–µ–π—á–∞—Å).
             * @returns {Array} –°–ø–∏—Å–æ–∫ –Ω–∞–±–æ—Ä–æ–≤, —Ç—Ä–µ–±—É—é—â–∏—Ö –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è.
             */
            getDueReviewSets() {
                const now = Date.now();
                
                return wordSets.filter(set => {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤ —ç—Ç–æ–º –Ω–∞–±–æ—Ä–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞
                    return set.cards.some(card => card.nextReview <= now);
                }).map(set => {
                    // –í—ã—á–∏—Å–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ –≤ –Ω–∞–±–æ—Ä–µ
                    const dueCount = set.cards.filter(card => card.nextReview <= now).length;
                    return {
                        id: set.id,
                        title: set.title,
                        dueCount: dueCount,
                        totalCount: set.cards.length
                    };
                });
            },

            /**
             * –†–µ–Ω–¥–µ—Ä–∏—Ç —Å–µ–∫—Ü–∏—é "–ö–∞—Ä—Ç–æ—á–∫–∏ –∫ –ø–æ–≤—Ç–æ—Ä—É" –Ω–∞ –≥–ª–∞–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ.
             */
            renderDueReviewSection() {
                const container = document.getElementById('due-review-section');
                const dueSets = this.getDueReviewSets();

                if (dueSets.length === 0) {
                    container.innerHTML = `
                        <div class="bg-green-100 text-green-700 p-4 rounded-xl border border-green-200 text-center font-medium">
                            üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –ù–µ—Ç –Ω–∞–±–æ—Ä–æ–≤, —Ç—Ä–µ–±—É—é—â–∏—Ö –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è.
                        </div>
                    `;
                } else {
                    container.innerHTML = dueSets.map(set => `
                        <div onclick="App.renderDirectionModal('${set.id}')" 
                             class="flex justify-between items-center p-4 bg-white rounded-xl shadow-md border-l-4 border-red-500 cursor-pointer hover:bg-red-50 transition duration-150">
                            <div>
                                <p class="font-semibold text-gray-800">${set.title}</p>
                                <p class="text-sm text-red-600 font-bold">
                                    –ö –ø–æ–≤—Ç–æ—Ä—É: ${set.dueCount} / ${set.totalCount} –∫–∞—Ä—Ç–æ—á–µ–∫
                                </p>
                            </div>
                            <span>&rarr;</span>
                        </div>
                    `).join('');
                }
            },

            // –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω
            renderHomeScreen() {
                this.showScreen('home-screen');
                this.renderDueReviewSection(); // –†–µ–Ω–¥–µ—Ä–∏–º –Ω–æ–≤—ã–π —Ä–∞–∑–¥–µ–ª!
            },

            // –†–µ–Ω–¥–µ—Ä–∏—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–µ—Ä–µ–¥ —Å—Ç–∞—Ä—Ç–æ–º —Å–µ—Å—Å–∏–∏
            renderDirectionModal(setId) {
                this.currentSetId = setId;
                const modal = document.getElementById('direction-modal');
                modal.classList.remove('hidden', 'opacity-0');
                modal.classList.add('is-open', 'opacity-100');
            },

            closeDirectionModal() {
                const modal = document.getElementById('direction-modal');
                modal.classList.remove('is-open', 'opacity-100');
                modal.classList.add('opacity-0');
                setTimeout(() => modal.classList.add('hidden'), 300);
            },

            // ==========================================================
            // –≠–ö–†–ê–ù –°–ü–ò–°–ö–ê (–°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –Ω–∞–±–æ—Ä–æ–≤)
            // ==========================================================
            renderAllSetsScreen() {
                this.showScreen('list-screen');
                document.getElementById('list-title').textContent = '–í—Å–µ –Ω–∞–±–æ—Ä—ã —Å–ª–æ–≤';
                document.getElementById('back-button-container').innerHTML = `<button onclick="App.renderHomeScreen()" class="text-blue-500 hover:text-blue-700">&larr; –ù–∞–∑–∞–¥</button>`;

                const listContainer = document.getElementById('content-list');
                listContainer.innerHTML = wordSets.map(set => `
                    <div onclick="App.renderDirectionModal('${set.id}')" 
                         class="flex justify-between items-center p-4 bg-white rounded-xl shadow-sm cursor-pointer hover:bg-gray-50 transition duration-150">
                        <p class="font-semibold text-gray-800">${set.title} (${set.cards.length} —Å–ª–æ–≤)</p>
                        <span>&rarr;</span>
                    </div>
                `).join('');
            },

            // ... (–°—Ç–∞—Ä—ã–µ –∑–∞–≥–ª—É—à–∫–∏ –¥–ª—è –¥—Ä—É–≥–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤) ...
            renderAllStoriesScreen() {
                this.showScreen('list-screen');
                document.getElementById('list-title').textContent = '–í—Å–µ –∏—Å—Ç–æ—Ä–∏–∏';
                document.getElementById('back-button-container').innerHTML = `<button onclick="App.renderHomeScreen()" class="text-blue-500 hover:text-blue-700">&larr; –ù–∞–∑–∞–¥</button>`;
                document.getElementById('content-list').innerHTML = `
                    <div class="bg-yellow-100 p-4 rounded-xl text-yellow-800">–ó–∞–≥–ª—É—à–∫–∞: –°–ø–∏—Å–æ–∫ –∏—Å—Ç–æ—Ä–∏–π</div>
                `;
            },
            renderWeeklySelections() {
                this.showScreen('list-screen');
                document.getElementById('list-title').textContent = '–ü–æ–¥–±–æ—Ä–∫–∏ –ø–æ –Ω–µ–¥–µ–ª—è–º';
                document.getElementById('back-button-container').innerHTML = `<button onclick="App.renderHomeScreen()" class="text-blue-500 hover:text-blue-700">&larr; –ù–∞–∑–∞–¥</button>`;
                document.getElementById('content-list').innerHTML = `
                    <div class="bg-yellow-100 p-4 rounded-xl text-yellow-800">–ó–∞–≥–ª—É—à–∫–∞: –°–ø–∏—Å–æ–∫ –Ω–µ–¥–µ–ª—å</div>
                `;
            },
            renderAssociationBaseScreen() {
                this.showScreen('list-screen');
                document.getElementById('list-title').textContent = '–ë–∞–∑–∞ –ê—Å—Å–æ—Ü–∏–∞—Ü–∏–π';
                document.getElementById('back-button-container').innerHTML = `<button onclick="App.renderHomeScreen()" class="text-blue-500 hover:text-blue-700">&larr; –ù–∞–∑–∞–¥</button>`;
                document.getElementById('content-list').innerHTML = associationBase.map(item => `
                    <div onclick="App.openAssociationDetailModal('${item.id}')" 
                         class="flex justify-between items-center p-4 bg-purple-50 rounded-xl shadow-sm cursor-pointer hover:bg-purple-100 transition duration-150">
                        <div>
                            <p class="font-semibold text-purple-800">${item.de}</p>
                            <p class="text-sm text-purple-600">${item.ru}</p>
                        </div>
                        <span>üëÅÔ∏è</span>
                    </div>
                `).join('');
            },


            // ==========================================================
            // –≠–ö–†–ê–ù –ü–û–í–¢–û–†–ï–ù–ò–Ø (STUDY SESSION)
            // ==========================================================

            startSessionWithDirection(direction) {
                this.closeDirectionModal();
                this.currentDirection = direction;
                this.showScreen('study-screen');
                
                const set = wordSets.find(s => s.id === this.currentSetId);
                if (!set) {
                    console.error("–ù–∞–±–æ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω.");
                    this.renderHomeScreen();
                    return;
                }
                
                // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ –∫–∞—Ä—Ç–æ—á–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ —Ç—Ä–µ–±—É—é—Ç –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å
                const now = Date.now();
                const cardsToReview = set.cards.filter(card => card.nextReview <= now);

                this.sessionCards = cardsToReview.length > 0 ? cardsToReview : set.cards; 
                this.originalSessionCards = [...this.sessionCards];
                this.currentCardIndex = 0;
                
                // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏
                this.sessionCards.sort(() => Math.random() - 0.5);

                this.renderCurrentCard();
            },

            renderCurrentCard() {
                const card = document.getElementById('card');
                const controlsRate = document.getElementById('controls-rate');
                const controlsShow = document.getElementById('controls-show');
                const progressBar = document.getElementById('progress-bar');
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏
                if (this.currentCardIndex >= this.sessionCards.length) {
                    this.showScreen('finish-screen');
                    document.getElementById('finish-screen-text').textContent = 
                        `–í—ã –ø—Ä–æ—à–ª–∏ ${this.originalSessionCards.length} –∫–∞—Ä—Ç–æ—á–µ–∫ –≤ —ç—Ç–æ–º –Ω–∞–±–æ—Ä–µ. –û—Ç–ª–∏—á–Ω–æ!`;
                    return;
                }

                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                const total = this.originalSessionCards.length;
                const done = total - this.sessionCards.length + this.currentCardIndex;
                const progress = (done / total) * 100;
                progressBar.style.width = `${progress}%`;
                
                const currentCardData = this.sessionCards[this.currentCardIndex];
                
                const frontText = this.currentDirection === 'ru-de' ? currentCardData.ru : currentCardData.de;
                const backText = this.currentDirection === 'ru-de' ? currentCardData.de : currentCardData.ru;
                
                // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏
                card.classList.remove('is-flipped');
                controlsRate.classList.add('hidden');
                controlsShow.classList.remove('hidden');

                // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞
                document.getElementById('card-front-text').textContent = frontText;
                document.getElementById('card-back-text').textContent = backText;
            },
            
            showAnswer() {
                document.getElementById('card').classList.add('is-flipped');
                document.getElementById('controls-show').classList.add('hidden');
                document.getElementById('controls-rate').classList.remove('hidden');
            },

            handleAnswer(isCorrect) {
                const currentCardData = this.sessionCards[this.currentCardIndex];
                const cardElement = document.getElementById('card');

                // 1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è –∏ —Å–ª–µ–¥—É—é—â–µ–π –¥–∞—Ç—ã –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è
                if (isCorrect) {
                    currentCardData.level = Math.min(6, currentCardData.level + 1);
                    const days = repetitionIntervals[currentCardData.level] || 1;
                    currentCardData.nextReview = Date.now() + (days * 1000 * 60 * 60 * 24);
                    
                    // –£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç -> —É–¥–∞–ª—è–µ–º –∏–∑ —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏
                    this.sessionCards.splice(this.currentCardIndex, 1);
                    // –ù–µ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä—É–µ–º –∏–Ω–¥–µ–∫—Å, —Ç–∞–∫ –∫–∞–∫ —Å–ª–µ–¥—É—é—â–∏–π —ç–ª–µ–º–µ–Ω—Ç —Å–º–µ—Å—Ç–∏–ª—Å—è –Ω–∞ –µ–≥–æ –º–µ—Å—Ç–æ
                } else {
                    // –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç -> —Å–±—Ä–æ—Å —É—Ä–æ–≤–Ω—è –∏ –ø–µ—Ä–µ–Ω–æ—Å –≤ –∫–æ–Ω–µ—Ü —Å–µ—Å—Å–∏–∏
                    currentCardData.level = 0;
                    currentCardData.nextReview = Date.now() + (1000 * 60 * 5); // –ü–æ–≤—Ç–æ—Ä–∏—Ç—å —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç
                    
                    const failedCard = this.sessionCards.splice(this.currentCardIndex, 1)[0];
                    this.sessionCards.push(failedCard);
                    
                    // –ù–µ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä—É–µ–º –∏–Ω–¥–µ–∫—Å
                }

                // 2. –ê–Ω–∏–º–∞—Ü–∏—è —É—Ö–æ–¥–∞
                cardElement.classList.add('slide-out');

                // 3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ (–∑–∞–≥–ª—É—à–∫–∞)
                // –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ª–æ–≥–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ Firestore

                // 4. –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–π –∫–∞—Ä—Ç–æ—á–∫–µ
                setTimeout(() => {
                    // –£–±—Ä–∞—Ç—å –∞–Ω–∏–º–∞—Ü–∏—é —É—Ö–æ–¥–∞
                    cardElement.classList.remove('slide-out');
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É (–≤—ã–∑–æ–≤ renderCurrentCard —Å–∞–º –ø—Ä–æ–≤–µ—Ä–∏—Ç, –Ω–µ –∑–∞–∫–æ–Ω—á–∏–ª–∞—Å—å –ª–∏ —Å–µ—Å—Å–∏—è)
                    this.renderCurrentCard(); 

                }, 400); // –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∞–Ω–∏–º–∞—Ü–∏–∏
            },

            // ==========================================================
            // –ó–ê–ü–£–°–ö
            // ==========================================================

            async start() {
                this.showScreen('loading-screen');
                await this.initFirebase(); 
                this.renderHomeScreen();
            }
        };

        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.onload = () => {
            App.start();
        };

    </script>
</body>
</html>