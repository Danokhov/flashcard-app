<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–ò–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω–æ–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º API Telegram -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Firebase (–ë–∞–∑—É –¥–∞–Ω–Ω—ã—Ö) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <style>
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–µ—Ä–µ–≤–æ—Ä–æ—Ç–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ */
        .card { perspective: 1000px; }
        .card-inner {
            position: relative;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .card.is-flipped .card-inner {
            transform: rotateY(180deg);
        }
        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            top: 0; left: 0;
        }
        .card-back {
            transform: rotateY(180deg);
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ "—É—Ö–æ–¥–∞" –∏ "–ø–æ—è–≤–ª–µ–Ω–∏—è" –∫–∞—Ä—Ç–æ—á–∫–∏ */
        @keyframes slide-left {
            0% { transform: translateX(0); opacity: 1; }
            100% { transform: translateX(-100%); opacity: 0; }
        }
        @keyframes slide-in-right {
            0% { transform: translateX(100%); opacity: 0; }
            100% { transform: translateX(0); opacity: 1; }
        }

        .card.slide-out {
            animation: slide-left 0.4s ease forwards;
        }
        .card.slide-in {
            animation: slide-in-right 0.4s ease;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω */
        .modal {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
            transform: scale(0.95);
        }
        .modal.is-open {
            opacity: 1;
        }
        .modal.is-open .modal-content {
            transform: scale(1);
        }

        /* === –ù–û–í–´–ô –°–¢–ò–õ–¨ –î–õ–Ø –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù–ù–û–ô –ö–ù–û–ü–ö–ò === */
        .button-locked {
            background-color: #e5e7eb; /* gray-200 */
            color: #6b7280; /* gray-500 */
            cursor: not-allowed;
            opacity: 0.7;
        }
    </style>
</head>

<body class="min-h-screen bg-gray-100 font-sans p-4">

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
    <div id="app" class="max-w-md mx-auto">
        
        <!-- 1. –≠–∫—Ä–∞–Ω –ó–∞–≥—Ä—É–∑–∫–∏ (–≤–∏–¥–µ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
        <div id="loading-screen" class="text-center py-20">
            <p class="text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
        </div>

        <!-- 2. –≠–∫—Ä–∞–Ω –ì–ª–∞–≤–Ω–æ–≥–æ –ú–µ–Ω—é (—Å–∫—Ä—ã—Ç) -->
        <div id="main-menu-screen" class="hidden">
            <h1 class="text-2xl font-bold text-center mb-6">–í–∞—à–∏ –Ω–∞–±–æ—Ä—ã —Å–ª–æ–≤</h1>
            <div id="set-list" class="space-y-4">
                <!-- –°—é–¥–∞ –±—É–¥—É—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω—ã –Ω–∞–±–æ—Ä—ã —Å–ª–æ–≤ -->
            </div>
        </div>

        <!-- 3. –≠–∫—Ä–∞–Ω –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è (—Å–∫—Ä—ã—Ç) -->
        <div id="study-screen" class="hidden">
            <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä -->
            <div class="bg-gray-200 rounded-full h-2.5 mb-4">
                <div id="progress-bar" class="bg-blue-500 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
            
            <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ -->
            <div id="card" class="card h-64 w-full mb-4">
                <div id="card-inner" class="card-inner h-full w-full">
                    <!-- –ü–µ—Ä–µ–¥–Ω—è—è —Å—Ç–æ—Ä–æ–Ω–∞ -->
                    <div id="card-front" class="card-front flex items-center justify-center p-6 bg-white rounded-lg shadow-lg text-center">
                        <p id="card-front-text" class="text-2xl font-semibold"></p>
                    </div>
                    <!-- –ó–∞–¥–Ω—è—è —Å—Ç–æ—Ä–æ–Ω–∞ -->
                    <div id="card-back" class="card-back flex items-center justify-center p-6 bg-blue-100 rounded-lg shadow-lg text-center">
                        <p id="card-back-text" class="text-2xl font-semibold"></p>
                    </div>
                </div>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
            <div id="controls-show" class="text-center space-y-3">
                <button onclick="App.showAnswer()" class="w-full py-3 px-4 bg-blue-500 text-white font-bold rounded-lg shadow-md hover:bg-blue-600">
                    –ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç
                </button>
                <button id="hint-button" onclick="App.showHint()" class="w-full py-2 px-4 bg-yellow-400 text-yellow-900 font-semibold rounded-lg shadow-md hover:bg-yellow-500 hidden">
                    üí° –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É
                </button>
            </div>
            
            <div id="controls-rate" class="hidden grid grid-cols-2 gap-4">
                <button onclick="App.handleAnswer(false)" class="py-3 px-4 bg-red-500 text-white font-bold rounded-lg shadow-md hover:bg-red-600">
                    –ù–µ –ø–æ–º–Ω—é ‚ùå
                </button>
                <button onclick="App.handleAnswer(true)" class="py-3 px-4 bg-green-500 text-white font-bold rounded-lg shadow-md hover:bg-green-600">
                    –ü–æ–º–Ω—é ‚úÖ
                </button>
            </div>
             <!-- –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é" –≤–æ –≤—Ä–µ–º—è —Å–µ—Å—Å–∏–∏ -->
            <div class="text-center mt-4">
                <button onclick="App.showScreen('main-menu-screen')" class="text-gray-500 hover:text-gray-700">
                    –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é
                </button>
            </div>
        </div>
        
        <!-- 4. –≠–∫—Ä–∞–Ω –ó–∞–≤–µ—Ä—à–µ–Ω–∏—è (—Å–∫—Ä—ã—Ç) -->
         <div id="finish-screen" class="hidden text-center py-20">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</h2>
            <p id="finish-screen-text" class="text-gray-600 mb-6">–í—ã –ø—Ä–æ—à–ª–∏ –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏.</p>
            <button onclick="App.showScreen('main-menu-screen')" class="py-3 px-6 bg-blue-500 text-white font-bold rounded-lg shadow-md hover:bg-blue-600">
                –í –º–µ–Ω—é
            </button>
        </div>

    </div>

    <!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –î–õ–Ø –ü–û–î–°–ö–ê–ó–ö–ò (–∏–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç–æ) -->
    <div id="hint-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 opacity-0" onclick="App.closeHintModal()">
        <div id="hint-modal-content" class="modal-content bg-white p-4 rounded-lg shadow-xl max-w-sm w-full" onclick="event.stopPropagation()">
            <h3 class="text-lg font-semibold mb-3">–ü–æ–¥—Å–∫–∞–∑–∫–∞:</h3>
            <img id="hint-image" src="" alt="–ü–æ–¥—Å–∫–∞–∑–∫–∞" class="w-full h-auto rounded-md object-contain max-h-64">
            <button onclick="App.closeHintModal()" class="w-full mt-4 py-2 px-4 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300">
                –ó–∞–∫—Ä—ã—Ç—å
            </button>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –î–õ–Ø –í–´–ë–û–†–ê –ù–ê–ü–†–ê–í–õ–ï–ù–ò–Ø -->
    <div id="direction-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 opacity-0" onclick="App.closeDirectionModal()">
        <div id="direction-modal-content" class="modal-content bg-white p-6 rounded-lg shadow-xl max-w-sm w-full" onclick="event.stopPropagation()">
            <h3 class="text-lg font-semibold mb-4 text-center">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h3>
            <div class="space-y-3">
                <button onclick="App.startSessionWithDirection('ru-de')" class="w-full py-3 px-4 bg-blue-500 text-white font-bold rounded-lg shadow-md hover:bg-blue-600">
                    –†—É—Å—Å–∫–∏–π ‚Üí –ù–µ–º–µ—Ü–∫–∏–π
                </button>
                <button onclick="App.startSessionWithDirection('de-ru')" class="w-full py-3 px-4 bg-purple-500 text-white font-bold rounded-lg shadow-md hover:bg-purple-600">
                    –ù–µ–º–µ—Ü–∫–∏–π ‚Üí –†—É—Å—Å–∫–∏–π
                </button>
                <button onclick="App.closeDirectionModal()" class="w-full mt-2 py-2 px-4 text-gray-600 font-semibold rounded-lg hover:bg-gray-100">
                    –û—Ç–º–µ–Ω–∞
                </button>
            </div>
        </div>
    </div>


    <!-- "–ú–ê–ì–ò–Ø" (JavaScript) -->
    <script>
        
        // ==========================================================
        // –®–ê–ì 1: –ù–ê–°–¢–†–û–ô–ö–ê –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
        // ==========================================================

        const firebaseConfig = {
            apiKey: "AIzaSyAyKS1QWLlIaq_WtpNO0J5RbWAguDd5y-0",
            authDomain: "flash-app-19ddb.firebaseapp.com",
            projectId: "flash-app-19ddb",
            storageBucket: "flash-app-19ddb.appspot.com",
            messagingSenderId: "779096518661",
            appId: "1:779096518661:web:397ba47299418261d56c6c",
            measurementId: "G-EP0YBD164K"
        };

        const wordSets = [
            {
                id: "a1_nouns_1",
                name: "–°—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ A1 (–ß–∞—Å—Ç—å 1)", // <- –£—Ä–æ–≤–µ–Ω—å 1 (–±–µ—Å–ø–ª–∞—Ç–Ω—ã–π)
                cards: [
                    { id: "graben", front: "–∫–æ–ø–∞—Ç—å", back: "graben - grub - gegraben", hintImage: "images/graben.jpg" },
                    { id: "die_Frau", front: "–∂–µ–Ω—â–∏–Ω–∞", back: "die Frau" },
                    { id: "das_Buch", front: "–∫–Ω–∏–≥–∞", back: "das Buch", hintImage: "images/buch.png" },
                    { id: "der_Mann", front: "–º—É–∂—á–∏–Ω–∞", back: "der Mann" },
                    { id: "die_Stadt", front: "–≥–æ—Ä–æ–¥", back: "die Stadt" }
                ]
            },
            {
                id: "a1_verbs_1",
                name: "–ì–ª–∞–≥–æ–ª—ã A1 (–ß–∞—Å—Ç—å 1)", // <- –£—Ä–æ–≤–µ–Ω—å 2 (–ø–ª–∞—Ç–Ω—ã–π)
                cards: [
                    { id: "gehen", front: "–∏–¥—Ç–∏", back: "gehen" },
                    { id: "sehen", front: "–≤–∏–¥–µ—Ç—å", back: "sehen" },
                    { id: "sprechen", front: "–≥–æ–≤–æ—Ä–∏—Ç—å", back: "sprechen" },
                    { id: "kommen", front: "–ø—Ä–∏—Ö–æ–¥–∏—Ç—å", back: "kommen" }
                ]
            },
            {
                id: "a1_nouns_2",
                name: "–°—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ A1 (–ß–∞—Å—Ç—å 2)", // <- –£—Ä–æ–≤–µ–Ω—å 3 (–ø–ª–∞—Ç–Ω—ã–π)
                cards: [
                    { id: "das_Auto", front: "–º–∞—à–∏–Ω–∞", back: "das Auto" },
                    { id: "das_Haus", front: "–¥–æ–º", back: "das Haus" }
                ]
            }
        ];

        const repetitionIntervals = {
            1: 1,  // 1 –¥–µ–Ω—å
            2: 3,  // 3 –¥–Ω—è
            3: 7,  // 7 –¥–Ω–µ–π
            4: 14, // 2 –Ω–µ–¥–µ–ª–∏
            5: 30, // 1 –º–µ—Å—è—Ü
            6: 90  // 3 –º–µ—Å—è—Ü–∞
        };

        // ==========================================================
        // –ö–û–ù–ï–¶ –ù–ê–°–¢–†–û–ô–ö–ò
        // ==========================================================

        const App = {
            db: null,
            userId: null,
            userProgress: {}, 
            unlockedLevel: 1, // --- –ù–û–í–û–ï: –£—Ä–æ–≤–µ–Ω—å –¥–æ—Å—Ç—É–ø–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ---
            sessionCards: [], 
            currentCardIndex: 0,
            isPracticeMode: false,
            isAdvancing: false,
            currentDirection: 'ru-de', 
            tempSetId: null, 
            tempMode: null,  

            async init() {
                try {
                    firebase.initializeApp(firebaseConfig);
                    this.db = firebase.firestore();
                    Telegram.WebApp.ready();
                    
                    if (!Telegram.WebApp.initDataUnsafe || !Telegram.WebApp.initDataUnsafe.user) {
                        console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ Telegram. –ó–∞–ø—É—Å–∫ –≤ —Ä–µ–∂–∏–º–µ –æ—Ç–ª–∞–¥–∫–∏.");
                        this.userId = "test_user_123"; 
                    } else {
                        this.userId = Telegram.WebApp.initDataUnsafe.user.id.toString();
                    }
                    
                    await this.loadProgress();
                    this.renderMainMenu();
                    this.showScreen('main-menu-screen');

                } catch (error) {
                    this.showError(`–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ${error.message}`);
                    console.error(error);
                }
            },

            async loadProgress() {
                this.showScreen('loading-screen');
                const progressRef = this.db.collection('userProgress').doc(this.userId);
                const doc = await progressRef.get();
                
                if (doc.exists) {
                    this.userProgress = doc.data().cards || {};
                    // --- –ò–ó–ú–ï–ù–ï–ù–ò–ï –ó–î–ï–°–¨: –ó–∞–≥—Ä—É–∂–∞–µ–º —É—Ä–æ–≤–µ–Ω—å –¥–æ—Å—Ç—É–ø–∞ ---
                    this.unlockedLevel = doc.data().unlockedLevel || 1; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 1
                } else {
                    // --- –ò–ó–ú–ï–ù–ï–ù–ò–ï –ó–î–ï–°–¨: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —É—Ä–æ–≤–µ–Ω—å 1 –¥–ª—è –Ω–æ–≤–∏—á–∫–æ–≤ ---
                    this.userProgress = {};
                    this.unlockedLevel = 1;
                    await this.saveProgress(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                }
            },

            renderMainMenu() {
                const setListDiv = document.getElementById('set-list');
                setListDiv.innerHTML = '';
                const today = this.getTodayDateString();

                // --- –ò–ó–ú–ï–ù–ï–ù–ò–ï –ó–î–ï–°–¨: –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø ---
                wordSets.forEach((set, index) => {
                    const setLevel = index + 1; // –£—Ä–æ–≤–µ–Ω—å —Å–µ—Ç–∞ = –µ–≥–æ –ø–æ—Ä—è–¥–∫–æ–≤—ã–π –Ω–æ–º–µ—Ä
                    const isUnlocked = setLevel <= this.unlockedLevel;

                    let dueCount = 0;
                    if (isUnlocked) { // –°—á–∏—Ç–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–ª—å–∫–æ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç—ã—Ö —Å–µ—Ç–æ–≤
                        set.cards.forEach(card => {
                            const progress = this.userProgress[card.id];
                            if (!progress) {
                                dueCount++; 
                            } else if (progress.nextReview && progress.nextReview <= today) {
                                dueCount++; 
                            }
                        });
                    }

                    const setContainer = document.createElement('div');
                    setContainer.className = "w-full p-4 bg-white rounded-lg shadow-md";
                    
                    let buttonsHtml = '';
                    if (isUnlocked) {
                        // –ï—Å–ª–∏ —Å–µ—Ç –æ—Ç–∫—Ä—ã—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—ã—á–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
                        buttonsHtml = `
                            <div class="grid grid-cols-2 gap-3">
                                <button class="w-full py-2 px-3 bg-blue-500 text-white font-semibold rounded-lg text-sm hover:bg-blue-600" 
                                        onclick="App.promptForDirection('${set.id}', 'review')">
                                    –ü–æ–≤—Ç–æ—Ä–∏—Ç—å (${dueCount})
                                </button>
                                <button class="w-full py-2 px-3 bg-gray-200 text-gray-700 font-semibold rounded-lg text-sm hover:bg-gray-300" 
                                        onclick="App.promptForDirection('${set.id}', 'practice')">
                                    –ü—Ä–∞–∫—Ç–∏–∫–∞ (–í—Å–µ)
                                </button>
                            </div>
                        `;
                    } else {
                        // –ï—Å–ª–∏ —Å–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–û—Ç–∫—Ä—ã—Ç—å"
                        buttonsHtml = `
                            <button class="w-full py-2 px-3 button-locked" 
                                    onclick="App.showPaymentInfo(${setLevel})">
                                üîí –û—Ç–∫—Ä—ã—Ç—å –¥–æ—Å—Ç—É–ø
                            </button>
                        `;
                    }

                    setContainer.innerHTML = `
                        <div class="flex justify-between items-center mb-3">
                            <div>
                                <span class="font-semibold text-gray-800 text-lg">${set.name}</span>
                                <span class="block text-sm text-gray-500">${set.cards.length} —Å–ª–æ–≤</span>
                            </div>
                            ${isUnlocked ? 
                                (dueCount > 0 ? 
                                    `<span class="bg-blue-500 text-white text-xs font-bold px-3 py-1 rounded-full">${dueCount} –∫ –ø–æ–≤—Ç–æ—Ä—É</span>` :
                                    `<span class="text-green-500 font-semibold">‚úì</span>`) :
                                '' // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –¥–ª—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö
                            }
                        </div>
                        ${buttonsHtml}
                    `;
                    setListDiv.appendChild(setContainer);
                });
            },
            
            // --- –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ–ø–ª–∞—Ç–µ ---
            showPaymentInfo(setLevel) {
                alert(`–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ C–µ—Ç—É ${setLevel}, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏ –≤ —á–∞—Ç–µ –¥–ª—è –æ–ø–ª–∞—Ç—ã.`);
                // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–¥ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è Mini App
                // Telegram.WebApp.close();
            },

            promptForDirection(setId, mode) {
                this.tempSetId = setId;
                this.tempMode = mode;
                this.openModal('direction-modal');
            },

            closeDirectionModal() {
                this.closeModal('direction-modal');
            },

            startSessionWithDirection(direction) {
                this.currentDirection = direction;
                this.closeDirectionModal();
                this.startSession(this.tempSetId, this.tempMode);
            },
            
            startSession(setId, mode) {
                const set = wordSets.find(s => s.id === setId);
                if (!set) return;

                this.isPracticeMode = (mode === 'practice');
                
                if (this.isPracticeMode) {
                    this.sessionCards = set.cards.map(card => ({...card})); 
                } else {
                    const today = this.getTodayDateString();
                    this.sessionCards = set.cards.filter(card => {
                        const progress = this.userProgress[card.id];
                        return !progress || (progress.nextReview && progress.nextReview <= today);
                    });
                }
                
                if (this.sessionCards.length === 0) {
                    alert(this.isPracticeMode ? '–í —ç—Ç–æ–º –Ω–∞–±–æ—Ä–µ –Ω–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫.' : '–î–ª—è —ç—Ç–æ–≥–æ –Ω–∞–±–æ—Ä–∞ –Ω–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫ –∫ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—é –Ω–∞ —Å–µ–≥–æ–¥–Ω—è!');
                    return;
                }
                
                this.sessionCards.sort(() => Math.random() - 0.5);
                this.currentCardIndex = 0;
                
                this.showScreen('study-screen');
                this.showNextCard();
            },

            showNextCard() {
                if (this.currentCardIndex >= this.sessionCards.length) {
                    this.showScreen('finish-screen');
                    return;
                }
                
                const cardEl = document.getElementById('card');
                
                cardEl.classList.remove('is-flipped');
                cardEl.classList.add('slide-in');
                setTimeout(() => cardEl.classList.remove('slide-in'), 400);

                const percent = ((this.currentCardIndex + 1) / this.sessionCards.length) * 100;
                document.getElementById('progress-bar').style.width = `${percent}%`;

                document.getElementById('controls-show').classList.remove('hidden');
                document.getElementById('controls-rate').classList.add('hidden');

                const card = this.sessionCards[this.currentCardIndex];
                
                if (this.currentDirection === 'ru-de') {
                    document.getElementById('card-front-text').textContent = card.front;
                    document.getElementById('card-back-text').textContent = card.back;
                } else {
                    document.getElementById('card-front-text').textContent = card.back;
                    document.getElementById('card-back-text').textContent = card.front;
                }
                
                const hintButton = document.getElementById('hint-button');
                if (card.hintImage) {
                    hintButton.classList.remove('hidden');
                } else {
                    hintButton.classList.add('hidden');
                }
            },
            
            showAnswer() {
                document.getElementById('card').classList.add('is-flipped');
                document.getElementById('controls-show').classList.add('hidden');
                document.getElementById('controls-rate').classList.remove('hidden');
            },

            async handleAnswer(knewIt) {
                if (this.isAdvancing) return; 
                this.isAdvancing = true;

                if (!this.isPracticeMode) {
                    const card = this.sessionCards[this.currentCardIndex];
                    let progress = this.userProgress[card.id] || { box: 0 };

                    if (knewIt) {
                        progress.box = (progress.box || 0) + 1;
                    } else {
                        progress.box = 1;
                    }
                    
                    const interval = repetitionIntervals[progress.box];
                    if (interval) {
                        progress.nextReview = this.getFutureDateString(interval);
                    } else {
                        const maxBox = Math.max(...Object.keys(repetitionIntervals));
                        const finalInterval = repetitionIntervals[maxBox] || 90;
                        progress.nextReview = this.getFutureDateString(finalInterval);
                    }
                    
                    this.userProgress[card.id] = progress;
                    this.saveProgress(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –∫–∞—Ä—Ç–æ—á–∫–∏
                }
                
                document.getElementById('card').classList.add('slide-out');
                setTimeout(() => {
                    document.getElementById('card').classList.remove('slide-out'); 
                    this.currentCardIndex++; 
                    this.isAdvancing = false; 
                    this.showNextCard(); 
                }, 400); 
            },
            
            async saveProgress() {
                try {
                    const progressRef = this.db.collection('userProgress').doc(this.userId);
                    // --- –ò–ó–ú–ï–ù–ï–ù–ò–ï –ó–î–ï–°–¨: –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏ –∫–∞—Ä—Ç–æ—á–∫–∏, –∏ —É—Ä–æ–≤–µ–Ω—å –¥–æ—Å—Ç—É–ø–∞ ---
                    await progressRef.set({ 
                        cards: this.userProgress,
                        unlockedLevel: this.unlockedLevel 
                    }, { merge: true }); // merge: true –≤–∞–∂–Ω–æ, —á—Ç–æ–±—ã –Ω–µ –∑–∞—Ç–µ—Ä–µ—Ç—å –æ–¥–Ω–æ –¥—Ä—É–≥–∏–º
                    console.log('–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ Firebase');
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:', error);
                }
            },

            openModal(modalId) {
                const modal = document.getElementById(modalId);
                const modalContent = document.getElementById(`${modalId}-content`);
                
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modal.classList.add('is-open', 'opacity-100');
                    modalContent.classList.add('is-open');
                }, 10);
            },
            
            closeModal(modalId) {
                const modal = document.getElementById(modalId);
                const modalContent = document.getElementById(`${modalId}-content`);
                
                modal.classList.remove('is-open', 'opacity-100');
                modalContent.classList.remove('is-open');
                
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
            },
            
            showHint() {
                const card = this.sessionCards[this.currentCardIndex];
                if (!card || !card.hintImage) return;
                const img = document.getElementById('hint-image');
                img.src = card.hintImage; 
                this.openModal('hint-modal');
            },

            closeHintModal() {
                this.closeModal('hint-modal');
            },
            
            showScreen(screenId) {
                ['loading-screen', 'main-menu-screen', 'study-screen', 'finish-screen'].forEach(id => {
                    document.getElementById(id).classList.add('hidden');
                });
                document.getElementById(screenId).classList.remove('hidden');
                
                if (screenId === 'main-menu-screen') {
                    this.renderMainMenu();
                }
            },
            
            showError(message) {
                this.showScreen('loading-screen');
                document.getElementById('loading-screen').innerHTML = `<p class="text-red-500 font-semibold">${message}</p>`;
            },
            
            getTodayDateString() {
                return new Date().toISOString().split('T')[0];
            },

            getFutureDateString(daysToAdd) {
                const date = new Date();
                date.setDate(date.getDate() + daysToAdd);
                return date.toISOString().split('T')[0];
            }
        };

        window.addEventListener('load', () => {
            App.init();
        });

    </script>
</body>
</html>












