<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Интервальное повторение</title>
    <!-- Подключаем Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Подключаем API Telegram -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        /* ===== ГЛОБАЛЬНЫЕ СТИЛИ ===== */
        * {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            user-select: none;
            -webkit-user-select: none;
        }

        /* Стили для анимации переворота карточки */
        .card { perspective: 1000px; }
        .card-inner {
            position: relative;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .card.is-flipped .card-inner {
            transform: rotateY(180deg);
        }
        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            top: 0; left: 0;
        }
        .card-front {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .card-back {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            transform: rotateY(180deg);
        }
        
        /* Стили для анимации "ухода" и "появления" карточки */
        @keyframes slide-left {
            0% { transform: translateX(0); opacity: 1; }
            100% { transform: translateX(-100%); opacity: 0; }
        }
        @keyframes slide-in-right {
            0% { transform: translateX(100%); opacity: 0; }
            100% { transform: translateX(0); opacity: 1; }
        }

        .card.slide-out {
            animation: slide-left 0.4s ease forwards;
        }
        .card.slide-in {
            animation: slide-in-right 0.4s ease;
        }

        /* Стили для модальных окон */
        .modal {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
            transform: scale(0.95);
            background: linear-gradient(135deg, #ffffff 0%, #f8f9ff 100%);
            border-radius: 20px;
        }
        .modal.is-open {
            opacity: 1;
        }
        .modal.is-open .modal-content {
            transform: scale(1);
        }

        /* Современные кнопки */
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            border-radius: 12px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
        }
        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            font-weight: 600;
            border-radius: 12px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(17, 153, 142, 0.4);
        }
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(17, 153, 142, 0.6);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%);
            color: white;
            font-weight: 600;
            border-radius: 12px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(245, 87, 108, 0.4);
        }
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(245, 87, 108, 0.6);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #333;
            font-weight: 600;
            border-radius: 12px;
            transition: all 0.3s ease;
        }
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        /* Карточки контента */
        .card-content {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        .card-content:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }

        /* Главное содержимое */
        .main-content {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding-bottom: 80px;
        }

        /* Стиль для заблокированной кнопки */
        .button-locked {
            background-color: #e5e7eb;
            color: #6b7280;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        /* Контейнер 16:9 для видео */
        .video-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
            height: 0;
            overflow: hidden;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        /* Стили для карусели */
        .carousel-card {
            min-height: 250px;
        }

        /* --- Стили, интегрированные из text1.html --- */
        .quiz-option { transition: all 0.15s ease; outline: none; }
        .quiz-option:hover { transform: translateY(-2px); box-shadow: 0 6px 10px -2px rgba(0,0,0,0.1); }
        .quiz-selected {
          background-color:#A5B4FC!important;
          color:#1E3A8A!important;
          border-color:#6366F1!important;
          box-shadow:0 4px 6px -1px rgba(99,102,241,0.3)!important;
        }
        .next-button-disabled {
          background-color:#D1D5DB!important;
          color:#6B7280!important;
          cursor:not-allowed;
          box-shadow:none!important;
        }
        .next-button-active {
          background:linear-gradient(to right,#4F46E5,#6366F1)!important;
          color:#fff!important;
          box-shadow:0 4px 10px -2px rgba(79,70,229,0.5);
          transition:all 0.2s ease;
        }
        .next-button-active:hover { opacity:.9; transform:translateY(-1px); }
        #question-box { border-left:5px solid #6366F1; }

        .story-visual-container img {
          width:100%;
          height:auto;
          display:block;
        }

        /* ФИКСИРОВАННАЯ ПАНЕЛЬ ПРОИГРЫВАТЕЛЯ */
        #audio-bar.fixed-audio-bar {
            position: fixed;
            top: env(safe-area-inset-top, 0px); /* Автоматически подстраивается под шапку TG */
            left: 0;
            right: 0;
            z-index: 999;
            background: rgba(243, 244, 246, 0.97);
            backdrop-filter: blur(6px);
            padding-top: 0.5rem;
            padding-bottom: 0.75rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        #audio-bar.fixed-audio-bar {
            width: 100% !important;
            left: 0 !important;
            right: 0 !important;
            padding: 0.5rem 1rem !important;
            box-sizing: border-box;
        }

        #audio-bar.fixed-audio-bar > div {
            max-width: none !important;
            width: 100% !important;
            margin: 0 auto;
        }
        /* Чтобы контент не прыгал — отступ под панель */
        #audio-bar-placeholder.fixed-visible {
            height: 120px; /* подбери под реальную высоту твоего бара (примерно 100-130px) */
        }

        .audio-main-button {
          transition: transform 0.15s ease, box-shadow 0.15s ease, opacity 0.15s ease;
        }
        .audio-main-button:hover {
          transform: translateY(-1px);
          box-shadow: 0 8px 18px rgba(37,99,235,0.55);
          opacity:.95;
        }

        input[type="range"] { width:100%; cursor:pointer; }

        .accordion-content {
          max-height:0;
          overflow:hidden;
          transition:max-height 0.4s ease-in-out,opacity 0.4s ease-in-out;
          opacity:0;
          visibility:hidden;
        }
        .accordion-content.is-open {
          max-height:90vh;
          opacity:1;
          visibility:visible;
          overflow-y:auto;
        }
        /* --- Конец интегрированных стилей --- */
        /* --- Стили для Транскрипции --- */
        #transcript-scroll-area {
            /* Вот ваш шрифт. 
              1rem = 16px (по умолчанию)
              1.125rem = 18px (как text-lg в Tailwind)
              1.25rem = 20px (как text-xl в Tailwind)
            */
            font-size: 1.125rem; 
        }
        
        #transcript-scroll-area p {
            /* Вот ваши отступы. 
              По умолчанию у вас 'mb-3', что равно 0.75rem (12px).
              mb-2 = 0.5rem (8px)
              mb-1 = 0.25rem (4px)
            */
            margin-bottom: 0.5rem; 

            /* Если вы хотите уменьшить не отступ МЕЖДУ абзацами, 
              а интервал МЕЖДУ строками ВНУТРИ абзаца (межстрочный интервал), 
              используйте 'line-height':
            */
            /* line-height: 1.4; */ /* (по умолчанию примерно 1.5 или 1.6) */
        }
        /* --- Конец стилей для Транскрипции --- */
    </style>
</head>

<body class="min-h-screen bg-gray-100 font-sans p-4 pb-28">

    <!-- Основной контейнер приложения -->
    <div id="app" class="max-w-xl mx-auto">
        
        <!-- 1. Экран Загрузки (виден по умолчанию) -->
        <div id="loading-screen" class="text-center py-20">
            <p class="text-gray-500">Загрузка данных...</p>
        </div>

        <!-- МОДАЛЬНОЕ ОКНО: МАНТРЫ ПОЛЕЗНЫХ ФРАЗ -->
        <div id="mantra-modal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
            <div class="modal-content bg-white p-4 max-w-lg w-full rounded-2xl">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-lg font-semibold">Мантры полезных фраз</h3>
                    <button onclick="window.App.closeModal('mantra-modal')" class="text-gray-500">✕</button>
                </div>
                <div id="mantra-modal-body">
                    <div id="mantra-card-area">
                        <div id="mantra-progress" class="text-sm text-gray-500 mb-4 text-center">0 / 0</div>
                        
                        <!-- Верхний блок: Русский (всегда видим) -->
                        <div class="bg-blue-50 p-6 rounded-xl shadow-md mb-3">
                            <p class="text-sm text-gray-500 mb-2">Русский:</p>
                            <div id="mantra-russian" class="text-xl font-semibold text-gray-900">...</div>
                        </div>

                        <!-- Нижний блок: Немецкий (закрыт/открыт) -->
                        <div class="bg-green-50 p-6 rounded-xl shadow-md">
                            <div id="mantra-german-hidden">
                                <button onclick="window.App.showMantraAnswer()" class="btn-secondary w-full">Показать ответ</button>
                            </div>
                            <div id="mantra-german-shown" class="hidden">
                                <p class="text-sm text-gray-500 mb-2">Немецкий:</p>
                                <div id="mantra-german" class="text-xl font-semibold text-gray-900 mb-3">...</div>
                                <button onclick="window.App.speakMantra(document.getElementById('mantra-german').textContent)" class="btn-primary w-full mb-3">🔊 Озвучить</button>
                            </div>
                        </div>

                        <!-- Оценка -->
                        <div class="mt-4 text-center text-sm text-gray-600 mb-3">Оцени свой ответ:</div>
                        <div class="mt-4 flex gap-2" id="mantra-controls">
                            <button onclick="window.App.handleMantraAnswer(false)" class="btn-danger flex-1">Не верно</button>
                            <button onclick="window.App.handleMantraAnswer(true)" class="btn-success flex-1">Верно</button>
                        </div>
                    </div>

                    <div id="mantra-summary" class="hidden text-center p-4">
                        <!-- Сюда будет вставлен итог -->
                    </div>

                    <div id="mantra-summary-actions" class="mt-2"></div>
                </div>
            </div>
        </div>

        <!-- 2. ГЛАВНОЕ МЕНЮ (Home Screen) -->
        <div id="home-screen" class="hidden main-content">
            <div class="px-4 pt-2 pb-4 max-w-2xl mx-auto">
                <div class="text-center mb-5">
                    <div class="text-5xl mb-1">🇩🇪</div>
                    <h1 class="text-3xl font-bold bg-gradient-to-r from-orange-500 via-yellow-500 to-red-500 bg-clip-text text-transparent mb-0.5">Мнемо Deutsch</h1>
                    <p class="text-gray-600 text-sm font-semibold">Клуб изучения немецкого языка</p>
                </div>

                <div class="space-y-2">
                    <!-- ДИНАМИЧЕСКИЙ БЛОК: Пробный урок ИЛИ Активная неделя/Уроки по неделям -->
                    <div id="main-content-block">
                        <!-- Заполняется JS (включает Пробный, Подборки за неделю и Все наборы слов) -->
                    </div>
                    
                    <!-- НОВАЯ СЕКЦИЯ: Горящие повторения -->
                    <div id="due-today-section" class="hidden pt-6 mt-6 border-t-2 border-purple-200">
                        <h2 class="text-xl font-bold bg-gradient-to-r from-orange-500 to-red-500 bg-clip-text text-transparent mb-4 flex items-center">
                            <span class="mr-2">🔥</span>
                            <span>К повторению сегодня</span>
                        </h2>
                        <div id="due-today-list" class="space-y-3">
                            <!-- Сюда JS добавит горящие сеты -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 3. ЭКРАН СПИСКА (для недель, сетов) -->
        <div id="list-screen" class="hidden main-content">
            <div class="max-w-2xl mx-auto px-4 pt-6">
                <h1 id="list-title" class="text-3xl font-bold text-center mb-2 bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent"></h1>
                <p class="text-center text-gray-600 mb-6">Выберите набор для начала</p>
                
                <!-- Кнопка "Назад" УДАЛЕНА. Будет использоваться Telegram.WebApp.BackButton -->
                <div id="back-button-container" class="mb-4"></div>
                
                <!-- Динамические фильтры/поиск -->
                <div id="filter-controls" class="mb-4 space-y-3">
                    <!-- Фильтры или поиск будут вставлены здесь -->
                </div>
                
                <!-- Список содержимого -->
                <div id="content-list" class="space-y-4 pb-20">
                    <!-- Сюда будут вставлены наборы, недели -->
                </div>
            </div>
        </div>
        
        <!-- 4. ЭКРАН ВИДЕО КОНТЕНТА (для ассоциаций недели) -->
        <div id="video-content-screen" class="hidden main-content">
            <!-- Кнопка "Назад" УДАЛЕНА. -->
            <div id="video-back-button-container" class="mb-2"></div> 
            
            <div class="max-w-2xl mx-auto px-4 pt-2 pb-20">
                <h1 id="video-title" class="text-2xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent mb-3 text-center"></h1>
                
                <!-- Видео 16:9 -->
                <div class="video-container mb-3 rounded-2xl overflow-hidden shadow-2xl">
                    <iframe id="video-embed" src="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                </div>

                <!-- Дополнительный текст (для заданий недели) -->
                <div id="video-extra-text" class="card-content p-4 text-gray-700 mb-4 text-sm max-h-32 overflow-y-auto">
                    <!-- Сюда будет вставлен текст задания -->
                </div>

                <!-- Кнопка Карусель ассоциаций -->
                <div id="video-carousel-button-container" class="mt-4">
                    <!-- Кнопка будет добавлена динамически -->
                </div>
            </div>
        </div>

        <!-- 5. ЭКРАН ВНЕШНЕЙ ССЫЛКИ -->
        <div id="external-link-screen" class="hidden text-center py-10">
           <!-- Кнопка "Назад" УДАЛЕНА. -->
           <div id="external-link-back-button-container" class="mb-4 text-left"></div>

            <h2 id="external-link-title" class="text-xl font-bold text-gray-800 mb-4"></h2>
            <p id="external-link-text" class="text-gray-600 mb-6 px-4">Нажмите кнопку ниже, чтобы перейти на отдельную страницу (или скопируйте ссылку).</p>
            
            <a id="external-link-button" href="#" target="_blank" 
               class="py-3 px-6 bg-blue-500 text-white font-bold rounded-xl shadow-md hover:bg-blue-600 inline-block transition duration-150">
                Открыть ссылку
            </a>
            
            <p id="external-link-url-display" class="mt-4 text-sm text-gray-500 break-all px-4"></p>
        </div>

        <!-- 6. ЭКРАН ПРОСМОТРА СТРАНИЦЫ (для загрузки внутреннего HTML-контента, как text1.html) -->
        <div id="content-viewer-screen" class="hidden">
             <!-- Кнопка "Назад" УДАЛЕНА. -->
             <div id="content-viewer-back-button-container" class="mb-4"></div>        
            <h2 id="content-viewer-title" class="text-xl font-bold text-gray-800 mb-4 text-center"></h2>
            
            <!-- 
              --- НАЧАЛО ИНТЕГРАЦИИ text1.html ---
              HTML-контент из text1.html теперь находится здесь
            -->
            <div id="content-viewer-body" class="p-4 bg-gray-100 rounded-xl">
                
                <!-- картинка + аудио -->
                <div class="story-visual-container rounded-xl shadow-xl overflow-hidden">
                  <img src="Woche1_text.png"
                       alt="Иллюстрация к истории"
                       onclick="event.preventDefault();event.stopPropagation();">
                  <audio id="story-audio-player" src="Woche1_text.mp3"></audio>
                </div>

                <!-- заголовок -->
                <h1 class="text-2xl font-bold text-center text-gray-900">
                  Der Termin beim Arzt
                </h1>

                <!-- ОБЁРТКА ПАНЕЛИ: сначала обычная, потом становится fixed -->
                <div id="audio-bar-wrapper">
                  <div id="audio-bar">
                    <div class="max-w-md mx-auto">
                      <div class="bg-white rounded-2xl px-4 py-3 shadow-lg border border-gray-200 flex flex-col gap-2">
                        <div class="flex items-center justify-center">
                          <button id="audio-main-button"
                                  class="audio-main-button rounded-full btn-primary px-6 py-3 flex items-center justify-center shadow-lg transition duration-150 hover:scale-110 active:scale-95">
                            <svg id="play-icon" class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                              <path d="M8 5v14l11-7z"></path>
                            </svg>
                            <svg id="pause-icon" class="w-8 h-8 hidden" fill="currentColor" viewBox="0 0 24 24">
                              <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"></path>
                            </svg>
                          </button>
                        </div>

                        <div class="flex flex-col gap-1">
                          <input id="audio-progress" type="range" min="0" max="100" value="0">
                          <div class="flex justify-between text-xs text-gray-500">
                            <span id="audio-current-time">0:00</span>
                            <span id="audio-duration">0:00</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- плейсхолдер, чтобы страница не “прыгала”, когда бар становится fixed -->
                <div id="audio-bar-placeholder" style="height: 0;"></div>

                <!-- АККОРДЕОНЫ -->
                <div class="space-y-4">

                  <!-- транскрипция (теперь кнопка модального окна) -->
                  <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
                    <button id="transcript-button"
                            onclick="window.App.openModal('transcript-modal')"
                            class="w-full py-4 px-5 text-left text-lg font-semibold text-gray-700 hover:bg-gray-50 flex justify-between items-center transition">
                      <span><span class="mr-3 text-green-500">📖</span>Транскрипция</span>
                      <span>&rarr;</span>
                    </button>
                    <!-- Содержимое аккордеона <div id="transcript-content">...</div> было удалено и перемещено в модальное окно -->
                  </div>

                  <!-- [ИЗМЕНЕНО] кнопка квиза (ПЕРЕМЕЩЕНА СЮДА) -->
                  <button onclick="window.StoryApp.startStoryQuiz()"
                          class="w-full py-4 px-5 bg-indigo-500 text-white rounded-xl shadow-xl text-left text-lg font-bold 
                                 hover:bg-indigo-600 transition flex justify-between items-center 
                                 bg-gradient-to-r from-indigo-600 to-indigo-500 transform hover:scale-[1.01] hover:shadow-2xl">
                    <span><span class="mr-3 text-yellow-300">🧠</span>Квиз на помннимание текста</span>
                    <span>&rarr;</span>
                  </button>
                  
                  <!-- [ИЗМЕНЕНО] разбор текста -->
                  <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
                    <button id="analysis-button"
                            onclick="window.StoryApp.toggleAccordion('analysis-content')"
                            class="w-full py-4 px-5 text-left text-lg font-semibold text-gray-700 hover:bg-gray-50 flex justify-between items-center transition">
                      <span><span class="mr-3 text-blue-500">📝</span>Разбор текста</span>
                      <span id="analysis-arrow">&darr;</span>
                    </button>
                    <div id="analysis-content"
                         class="accordion-content bg-gray-50 border-t border-gray-200 hidden p-4">
                      <div id="analysis-carousel" class="space-y-4">
                        <div id="analysis-slide" class="space-y-3"></div>

                        <div class="flex items-center justify-between mt-4">
                          <button onclick="window.StoryApp.prevAnalysisSlide()"
                                  class="py-2 px-4 bg-gray-200 text-gray-700 rounded-lg text-sm font-semibold hover:bg-gray-300 transition">
                            ← Назад
                          </button>

                          <span id="analysis-progress"
                                class="text-xs text-gray-500 mx-2 flex-1 text-center">
                            1 / 1
                          </span>

                          <button onclick="window.StoryApp.nextAnalysisSlide()"
                                  class="py-2 px-4 bg-indigo-500 text-white rounded-lg text-sm font-semibold hover:bg-indigo-600 transition">
                            Вперёд →
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- [ИЗМЕНЕНО] кнопка квиза УДАЛЕНА ОТСЮДА -->
                
            </div>
            <!-- --- КОНЕЦ ИНТЕГРАЦИИ text1.html --- -->
        </div>
        
        <!-- 7. ЭКРАН СПИСКА КАРУСЕЛЕЙ (Используется, если нет фиксированного набора) -->
        <div id="carousel-list-screen" class="hidden">
         
            <h1 id="carousel-list-title" class="text-2xl font-bold text-center mb-6 text-gray-800">Карусель ассоциаций</h1>
            <!-- Кнопка "Назад" УДАЛЕНА. -->
            <div id="carousel-list-back-button-container" class="mb-4"></div>
            <div id="carousel-sets-list" class="space-y-4">
                <!-- Сюда JS вставит кнопки наборов -->
            </div>
        </div>

        <!-- 8. ЭКРАН КАРУСЕЛИ (Просмотр слов с картинками) -->
        <div id="image-carousel-screen" class="hidden">
            <!-- Кнопка "Назад" УДАЛЕНА. -->
            <div id="carousel-back-button-container" class="mb-4"></div>
                 <h2 id="carousel-word-count" class="text-lg font-semibold text-gray-800 mb-4 text-center"></h2>

            <!-- Карточка карусели -->
            <div class="carousel-card bg-white rounded-xl shadow-lg p-4 mb-6 relative">
                <!-- Изображение -->
                <img id="carousel-image" src="" alt="Иллюстрация" class="w-full h-auto object-contain rounded-lg max-h-48 mb-4" 
                     onerror="this.onerror=null; this.src='https://placehold.co/400x200/FCA5A5/FFFFFF?text=Нет+Изображения';">
                
                <!-- Немецкое слово -->
                <div class="text-center mb-4">
                    <span id="carousel-word" class="text-2xl font-bold text-gray-800"></span>
                    <button onclick="window.App.speakGerman(window.App.carouselCards[window.App.currentCarouselIndex].word, event)" 
                            class="ml-2 text-blue-500 hover:text-blue-700">
                        <svg class="w-6 h-6 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707A1 1 0 0112 6v12a1 1 0 01-1.707.707L5.586 15z"></path>
                        </svg>
                    </button>
                </div>
                
                <!-- Перевод (скрыт по умолчанию) -->
                <div id="carousel-translation" class="text-center text-xl text-gray-600 font-semibold mb-4 hidden"></div>

                <!-- Кнопки управления -->
                <div class="flex justify-center space-x-4">
                    <button onclick="window.App.showPrevWord()" class="py-2 px-4 bg-gray-200 text-gray-700 font-bold rounded-xl hover:bg-gray-300 transition duration-150">
                        &larr; Назад
                    </button>
                    <button id="toggle-translation-button" onclick="window.App.toggleTranslation()" 
                            class="py-2 px-4 bg-yellow-400 text-yellow-900 font-bold rounded-xl shadow-md hover:bg-yellow-500 transition duration-150">
                        Показать перевод
                    </button>
                    <button onclick="window.App.showNextWord()" class="py-2 px-4 bg-blue-500 text-white font-bold rounded-xl shadow-md hover:bg-blue-600 transition duration-150">
                        Далее &rarr;
                    </button>
                </div>
            </div>
             <!-- Кнопка "Назад к Списку Каруселей" УДАЛЕНА. -->
        </div>

        <!-- 9. Экран Повторения (Study Screen) -->
        <div id="study-screen" class="hidden main-content">
            <!-- Кнопка "Назад" УДАЛЕНА. -->
            <div id="study-back-button-container" class="mt-4"></div>
            
            <div class="max-w-2xl mx-auto px-4 pt-6">
                <!-- Прогресс-бар -->
                <div class="bg-gray-300 rounded-full h-2.5 mb-6 shadow-lg">
                    <div id="progress-bar" class="bg-gradient-to-r from-purple-500 to-pink-500 h-2.5 rounded-full transition-all duration-500 shadow-lg" style="width: 0%"></div>
                </div>
                
                <!-- Карточка -->
                <div id="card" class="card h-80 w-full mb-6">
                    <div id="card-inner" class="card-inner h-full w-full" onclick="window.App.showAnswer()">
                        <!-- Передняя сторона -->
                        <div id="card-front" class="card-front flex items-center justify-center p-6 rounded-2xl shadow-2xl text-center cursor-pointer hover:shadow-xl transition-shadow">
                            <div id="card-front-text" class="text-3xl font-bold"></div>
                        </div>
                        <!-- Задняя сторона -->
                        <div id="card-back" class="card-back flex items-center justify-center p-6 rounded-2xl shadow-2xl text-center cursor-pointer hover:shadow-xl transition-shadow">
                            <div id="card-back-text" class="text-3xl font-bold"></div>
                        </div>
                    </div>
                </div>

                <!-- Кнопки управления -->
            <div id="controls-show" class="text-center space-y-3">
                <button onclick="window.App.showAnswer()" class="btn-primary w-full py-3 px-4 flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                    Показать ответ
                </button>
                <button id="hint-button" onclick="window.App.showHint()" class="btn-secondary w-full py-2 px-4 flex items-center justify-center gap-2 hidden">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"></path></svg>
                    💡 Подсказка
                </button>
            </div>
            
            <div id="controls-rate" class="hidden grid grid-cols-2 gap-4">
                <button onclick="window.App.handleAnswer(false)" class="btn-danger py-3 px-4 flex items-center justify-center gap-2 font-bold">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"></path></svg>
                    Учить
                </button>
                <button onclick="window.App.handleAnswer(true)" class="btn-success py-3 px-4 flex items-center justify-center gap-2 font-bold">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"></path></svg>
                    Знаю
                </button>
            </div>
            
            <div id="controls-practice-all" class="hidden grid grid-cols-3 gap-3">
                <button onclick="window.App.prevCard()" class="btn-secondary py-3 px-4 flex items-center justify-center gap-2 font-bold">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12l4.58-4.59z"></path></svg>
                    Назад
                </button>
                <button id="hint-button-practice-all" onclick="window.App.showHint()" class="btn-secondary py-2 px-4 flex items-center justify-center gap-2 font-bold">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"></path></svg>
                    Подсказка
                </button>
                <button onclick="window.App.nextCard()" class="btn-primary py-3 px-4 flex items-center justify-center gap-2 font-bold">
                    Вперед
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6-6-6z"></path></svg>
                </button>
            </div>
             <!-- Кнопка "Назад в меню" во время сессии УДАЛЕНА. -->
        </div>
        
        <!-- 10. Экран Завершения (Finish Screen) -->
         <div id="finish-screen" class="hidden main-content">
            <div class="max-w-2xl mx-auto px-4 py-20">
                <div class="card-content p-8 text-center">
                    <svg class="w-20 h-20 mx-auto mb-4 text-green-500" fill="currentColor" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"></path></svg>
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Отлично! 🎉</h2>
                    <p id="finish-screen-text" class="text-gray-600 mb-6 text-lg">Вы прошли все карточки в этой сессии.</p>
                    <button onclick="window.App.renderHomeScreen(false, true)" class="btn-primary py-3 px-8 inline-flex items-center gap-2">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V20a2 2 0 002 2h12a2 2 0 002-2v-9.586l.707.707a1 1 0 001.414-1.414l-7-7z"></path></svg>
                        В меню
                    </button>
                </div>
            </div>
        </div>

    </div>

<div id="navigation-footer" class="fixed bottom-0 left-0 right-0 bg-gradient-to-r from-blue-500 to-blue-600 border-t border-blue-700 shadow-2xl z-40 max-w-xl mx-auto">
    <div id="nav-content-container" class="flex justify-around items-center h-16">

        <!-- ИЗМЕНЕНО: onclick вызывает renderHomeScreen с clearStack=true, чтобы сбросить историю навигации -->
        <button onclick="window.App.renderHomeScreen(false, true)" class="flex flex-col items-center justify-center text-white hover:text-blue-100 transition-colors w-1/3 py-2 group">
            <svg class="w-7 h-7 group-hover:scale-110 transition-transform" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V20a2 2 0 002 2h12a2 2 0 002-2v-9.586l.707.707a1 1 0 001.414-1.414l-7-7z"></path></svg>
            <span class="text-xs mt-1 font-semibold">Главная</span>
        </button>

        <button onclick="window.App.renderAllSetsScreen()" class="flex flex-col items-center justify-center text-white hover:text-blue-100 transition-colors w-1/3 py-2 group">
            <svg class="w-7 h-7 group-hover:scale-110 transition-transform" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"></path></svg>
            <span class="text-xs mt-1 font-semibold">Все слова</span>
        </button>

        <button onclick="window.App.renderTopicSelection()" class="flex flex-col items-center justify-center text-white hover:text-blue-100 transition-colors w-1/3 py-2 group">
            <svg class="w-7 h-7 group-hover:scale-110 transition-transform" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11z"></path></svg>
            <span class="text-xs mt-1 font-semibold">Все Темы</span>
        </button>

    </div>
</div>

    <!-- Модальное окно для Подсказки -->
    <div id="hint-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 opacity-0" onclick="window.App.closeModal('hint-modal')">
        <div id="hint-modal-content" class="modal-content bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full" onclick="event.stopPropagation()">
            <h3 class="text-2xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent mb-4">💡 Подсказка</h3>
            <img id="hint-image" src="" alt="Подсказка" class="w-full h-auto rounded-lg object-contain max-h-64 mb-4" onerror="this.onerror=null; this.src='https://placehold.co/400x150/FCA5A5/FFFFFF?text=Нет+Изображения';">
            <button onclick="window.App.closeModal('hint-modal')" class="btn-primary w-full py-2 px-4">
                Закрыть
            </button>
        </div>
    </div>
    
    <!-- Модальное окно для Выбора направления -->
    <div id="direction-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 opacity-0" onclick="window.App.closeDirectionModal()">
        <div id="direction-modal-content" class="modal-content bg-white p-6 rounded-2xl shadow-2xl max-w-sm w-full" onclick="event.stopPropagation()">
            <h3 class="text-2xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent mb-6 text-center">🌍 Направление обучения</h3>
            <div class="space-y-3">
                <button onclick="window.App.startSessionWithDirection('ru-de')" class="btn-primary w-full py-3 px-4 flex items-center justify-center gap-2">
                    <span>🇷🇺</span>
                    Русский → Немецкий
                </button>
                <button onclick="window.App.startSessionWithDirection('de-ru')" class="btn-success w-full py-3 px-4 flex items-center justify-center gap-2">
                    <span>🇩🇪</span>
                    Немецкий → Русский
                </button>
                <button onclick="window.App.closeDirectionModal()" class="btn-secondary w-full mt-4 py-2 px-4">
                    ✕ Отмена
                </button>
            </div>
        </div>
    </div>

    <!-- Модальное окно для деталей недели -->
    <div id="week-details-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 opacity-0" onclick="window.App.closeModal('week-details-modal')">
        <div id="week-details-modal-content" class="modal-content bg-white p-6 rounded-xl shadow-xl max-w-sm w-full" onclick="event.stopPropagation()">
            <h3 id="week-details-title" class="text-xl font-bold mb-3 text-center text-gray-800"></h3>
            <p id="week-details-body" class="text-gray-700 mb-5"></p>
            <button onclick="window.App.closeModal('week-details-modal')" class="w-full py-3 px-4 bg-blue-500 text-white font-bold rounded-xl shadow-md hover:bg-blue-600">
                Понятно
            </button>
        </div>
    </div>

    <!-- ===== ИНТЕГРАЦИЯ: Модальное окно квиза ===== -->
    <div id="quiz-modal"
         class="modal hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 opacity-0"
         onclick="window.StoryApp.closeModal('quiz-modal')" role="dialog" aria-modal="true">
      <div id="quiz-modal-content"
           class="modal-content bg-white p-6 rounded-xl shadow-xl max-w-sm w-full"
           onclick="event.stopPropagation()">
        <h3 id="quiz-modal-title"
            class="text-xl font-bold mb-4 text-gray-800 text-center border-b pb-2">Квиз по истории</h3>

        <div class="text-sm text-gray-500 mb-4 text-center">
          <span id="quiz-progress">Вопрос 1 из 3</span>
        </div>

        <div id="quiz-scroll-area" class="max-h-[65vh] overflow-y-auto pr-2">
          <div id="question-box" class="bg-indigo-50 p-4 rounded-lg mb-4 shadow-inner">
            <p id="quiz-question" class="text-xl font-bold text-gray-800"></p>
          </div>
          <div id="quiz-options" class="space-y-3"></div>
          <p id="quiz-feedback" class="mt-4 text-center text-xl font-extrabold hidden"></p>
        </div>

        <button id="quiz-next-button"
                onclick="window.StoryApp.nextQuizQuestion()"
                class="w-full mt-6 py-3 px-4 font-bold rounded-xl shadow-md transition next-button-disabled"
                disabled>
          Следующий вопрос
        </button>

        <div id="quiz-end-controls" class="space-y-3 mt-6 hidden">
          <button onclick="window.StoryApp.startStoryQuiz()"
                  class="w-full py-3 px-4 bg-blue-500 text-white font-bold rounded-xl shadow-md hover:bg-blue-600 transition">
            Пройти ещё раз
          </button>
          <button onclick="window.StoryApp.showCorrectAnswers()"
                  class="w-full py-3 px-4 bg-yellow-500 text-yellow-900 font-bold rounded-xl shadow-md hover:bg-yellow-600 transition">
            Показать правильные ответы
          </button>
          <button onclick="window.App.closeModal('quiz-modal')"
                  class="w-full py-3 px-4 bg-gray-500 text-white font-bold rounded-xl shadow-md hover:bg-gray-600 transition">
            Завершить
          </button>
        </div>
      </div>
    </div>
    <!-- ===== КОНЕЦ ИНТЕГРАЦИИ: Модальное окно квиза ===== -->

    <!-- ===== НОВОЕ: Модальное окно для Транскрипции ===== -->
    <div id="transcript-modal"
         class="modal hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 opacity-0"
         onclick="window.App.closeModal('transcript-modal')" role="dialog" aria-modal="true">
      <div id="transcript-modal-content"
           class="modal-content bg-white p-6 rounded-xl shadow-xl max-w-sm w-full"
           onclick="event.stopPropagation()">
        
        <!-- [ИЗМЕНЕНО] Заголовок "Транскрипция" удален -->
        <!-- <h3 id="transcript-modal-title" ...></h3> -->

        <!-- [НОВОЕ] Место для плеера -->
        <div id="transcript-audio-player-placeholder" class="mb-4">
            <!-- Аудио-плеер будет перемещен сюда с помощью JS -->
        </div>

        <!-- Скроллируемый контейнер -->
        <div id="transcript-scroll-area" class="max-h-[60vh] overflow-y-auto pr-2 text-gray-700">
            <!-- [ИЗМЕНЕНО] Заголовок "Der Termin beim Arzt" удален -->
            <!-- <p class="mb-4 font-bold text-gray-800">Der Termin beim Arzt</p> -->
            <p class="mb-3">Als Thomas an einem Montagmorgen aufwacht, merkt er sofort, dass etwas не stimmt.</p>
            <p class="mb-3">Er ist völlig verschwitzt, sein Kopf tut weh, der Rücken ist steif, und er hat Schmerzen im Magen.</p>
            <p class="mb-3">Außerdem fühlt er sich müde und schwach.</p>
            <p class="mb-3">Seine Frau schaut ihn besorgt an:</p>
            <p class="mb-3">„Thomas, du siehst gar nicht gut aus. Ich mache mir Sorgen. Du solltest lieber zum Arzt gehen.“</p>
            <p class="mb-3">Thomas nickt, aber er hat Angst, dass es etwas Schlimmes sein könnte.</p>
            <p class="mb-3">„Vielleicht ist es nur Stress“, murmelt er.</p>
            <p class="mb-3">„Vielleicht“, antwortet sie ruhig, „aber deine Gesundheit ist wichtiger.“</p>
            <p class="mb-3">Er ruft an der Rezeption der Praxis an.</p>
            <p class="mb-3">Die Mitarbeiterin hört ihm aufmerksam zu, als er seine Beschwerden beschreibt.</p>
            <p class="mb-3">„Kommen Sie heute Nachmittag vorbei“, sagt sie. „Wenn Sie Schmerzen haben, bekommen Sie natürlich schnell einen Termin.“</p>
            <p class="mb-3">Am Nachmittag sitzt Thomas im Wartezimmer.</p>
            <p class="mb-3">Es ist stickig, und er beginnt wieder zu schwitzen.</p>
            <p class="mb-3">Viele Menschen warten. Eine ältere Frau hustet, ein Kind hält sich das Auge, und jemand stöhnt leлеise vor Schmerzen.</p>
            <p class="mb-3">Thomas versucht ruhig zu atmen, doch der Magen brennt stärker, und ihm wird schwindlig.</p>
            <p class="mb-3">Endlich ruft die Arzthelferin: „Herr Berger, bitte!“</p>
            <p class="mb-3">Dr. Keller, ein freundlicher Hausarzt, begrüßt ihn:</p>
            <p class="mb-3">„Was fehlt Ihnen?“</p>
            <p class="mb-3">Thomas erzählt, dass er seit zwei Tagen kaum essen kann, sich schwach fühlt und nachts leidet.</p>
            <p class="mb-3">Der Arzt misst den Blutdruck, hört den Körper ab und erklärt:</p>
            <p class="mb-3">„Sie haben wahrscheinlich eine Magenentzündung. Ich verschreibe Ihnen starke Antibiotika. Sie müssen sie regelmäßig einnehmen – drei Mal am Tag nach dem Essen. Hier ist außerdem ein Rezept, damit Sie die Medikamente in der Apotheke bekommen.“</p>
            <p class="mb-3">Dann fügt er hinzu:</p>
            <p class="mb-3">„Sie sollen die Antibiotika immer nach dem Essen einnehmen, damit der Magen sie besser verträgt. Und Sie sollen mindestens drei Tage zu Hause bleiben und sich ausruhen.“</p>
            <p class="mb-3">Thomas fragt:</p>
            <p class="mb-3">„Wie lange soll ich die Tabletten nehmen?“</p>
            <p class="mb-3">Dr. Keller antwortet:</p>
            <p class="mb-3">„Fünf Tage, dann sollte es Ihnen deutlich besser gehen.“</p>
            <p class="mb-3">„Die Antibiotika wirken schnell, aber Sie brauchen Ruhe. Vermeiden Sie Kaffee und Alkohol.“</p>
            <p class="mb-3">Dann fragt er:</p>
            <p class="mb-3">„Brauchen Sie auch ein Attest für die Arbeit?“</p>
            <p class="mb-3">Thomas antwortet:</p>
            <p class="mb-3">„Ja, bitte – für drei Tage.“</p>
            <p class="mb-3">Dr. Keller notiert es und lächelt:</p>
            <p class="mb-3">„In Ordnung. Dann ruhen Sie sich gut aus.“</p>
            <p class="mb-3">Zu Hause hilft ihm seine Frau, das Fenster zu öffnen, bringt Tee und Suppe ans Bett:</p>
            <p class="mb-3">„Ich werde dich gut pflegen, bis es dir besser geht.“</p>
            <p class="mb-3">Nach zwei Tagen geht es ihm schon besser.</p>
            <p class="mb-3">Die Schmerzen sind fast weg, das Brennen im Magen ist vorbei, und er kann wieder schlafen.</p>
            <p class="mb-3">Am dritten Tag fühlt sich Thomas stark und изgeruht.</p>
            <p class="mb-3">Er beschließt, am nächsten Morgen wieder zur Arbeit zu gehen – froh, dass alles harmlos war und die Medikamente gut wirken.</p>
        </div>

        <button onclick="window.App.closeModal('transcript-modal')"
                class="w-full mt-6 py-3 px-4 bg-gray-500 text-white font-bold rounded-xl shadow-md hover:bg-gray-600 transition">
          Закрыть
        </button>
      </div>
    </div>
    <!-- ===== КОНЕЦ: Модальное окно для Транскрипции ===== -->


    <!-- "МАГИЯ" (JavaScript) -->
<<script type="module">
        // Импортируем необходимые модули Firebase (v9+)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        
        // ==========================================================
        // !!! ВАШИ НАСТРОЙКИ FIREBASE !!!
        // ЗАМЕНИТЕ ЭТИ ЗАГЛУШКИ НА ВАШИ РЕАЛЬНЫЕ ДАННЫЕ
        // ==========================================================
        
        // 1. ВАШ ОБЪЕКТ КОНФИГУРАЦИИ
        // Если у вас нет глобальных переменных Canvas, вы должны использовать свою:
        const MY_FIREBASE_CONFIG = {
apiKey: "AIzaSyAyKS1QWLlIaq_WtpNO0J5RbWAguDd5y-0",
  authDomain: "flash-app-19ddb.firebaseapp.com",
  projectId: "flash-app-19ddb",
  storageBucket: "flash-app-19ddb.firebasestorage.app",
  messagingSenderId: "779096518661",
  appId: "1:779096518661:web:397ba47299418261d56c6c"
        };
        
        // 2. ВАШ ID ПРИЛОЖЕНИЯ (используется для пути к документу, если у вас своя структура)
        const MY_APP_ID = "flash-app-19ddb"; // <-- ЗАМЕНИТЬ (Может быть любым ID, если вы не используете структуру Canvas)

        // 3. Имя вашей коллекции/путь: Если вы не используете путь Canvas (artifacts/{appId}/users/{userId}/progress/data),
        //    Укажите здесь имя вашей коллекции, например: 'user_progress'
        const MY_COLLECTION_NAME = "userProgress"; // <-- ЗАМЕНИТЬ (например: 'user_progress')

        // Используем Telegram ID как ID пользователя, т.к. мы отказываемся от Auth Canvas
        const MY_USER_ID_SOURCE = (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe?.user?.id?.toString()) 
                                ? window.Telegram.WebApp.initDataUnsafe.user.id.toString()
                                : "fallback_web_user_" + Math.random().toString(36).substring(7);

        // ==========================================================
        // КОНЕЦ ВАШИХ НАСТРОЕК
        // ==========================================================

        // Переменные для инициализации теперь используют ваши настройки
        const firebaseConfig = MY_FIREBASE_CONFIG;
        const appId = MY_APP_ID; 
        const initialAuthToken = null; // Отключаем Auth Canvas
        
        // ==========================================================
        // 1. КОНФИГУРАЦИЯ И ДАННЫЕ (Conceptual Data Module)
        // ==========================================================
        
        // Интервалы повторения в днях (от 1 до 6 боксов)
        const REPETITION_INTERVALS = {
            1: 0,  // Первое повторение — в тот же день
            2: 1,  // 1 день
            3: 3,  // 3 дня
            4: 7,  // 7 дней
            5: 14, // 2 недели
            6: 30  // 1 месяц
        };
        
        /**
         * Утилита для получения базового URL (корневой папки приложения)
         */
        function getBaseUrl() {
            // Memoized — compute once per page load to avoid repeated work
            if (getBaseUrl._cached) return getBaseUrl._cached;
            const path = window.location.pathname.split('/');
            // Удаляем имя файла (index.html)
            path.pop(); 
            // Получаем путь к папке (например, '/subfolder/')
            const folderPath = path.join('/') + (path.length > 1 ? '/' : ''); 
            // Собираем полный базовый URL
            const base = window.location.origin + folderPath;
            getBaseUrl._cached = base.endsWith('/') ? base : base + '/';
            return getBaseUrl._cached;
        }

        /**
         * Данные наборов слов
         */
        const WORD_SETS = [
            // Неделя 1
            { id: "a1_nouns_1", week: 1, name: "Сущ. A1 (Часть 1)", cards: [
                { id: "die_Beschwerde", front: "жалоба, недомогание", back: "die Beschwerde", hintImage: "images/beschwerden.png" },
                { id: "brennen", front: "гореть, жечь", back: "brennen", hintImage: null },
                { id: "das_Geschaeft", front: "магазин", back: "das Geschäft", hintImage: "https://placehold.co/300x200/22C55E/FFFFFF?text=Geschaeft" },
                { id: "der_Park", front: "парк", back: "der Park", hintImage: "https://placehold.co/300x200/059669/FFFFFF?text=Park" },
                { id: "die_Bruecke", front: "мост", back: "die Brücke", hintImage: "https://placehold.co/300x200/4F46E5/FFFFFF?text=Bruecke" },
                { id: "das_Rathaus", front: "мэрия, ратуша", back: "das Rathaus", hintImage: "https://placehold.co/300x200/3B82F6/FFFFFF?text=Rathaus" },
                { id: "die_Kirche", front: "церковь", back: "die Kirche", hintImage: "https://placehold.co/300x200/A855F7/FFFFFF?text=Kirche" },
                { id: "der_Supermarkt", front: "супермаркет", back: "der Supermarkt", hintImage: "https://placehold.co/300x200/EC4899/FFFFFF?text=Supermarkt" },
                { id: "das_Krankenhaus", front: "больница", back: "das Krankenhaus", hintImage: "https://placehold.co/300x200/F97316/FFFFFF?text=Krankenhaus" },
                { id: "die_Apotheke", front: "аптека", back: "die Apotheke", hintImage: "https://placehold.co/300x200/10B981/FFFFFF?text=Apotheke" },
                { id: "das_Museum", front: "музей", back: "das Museum", hintImage: "https://placehold.co/300x200/6B7280/FFFFFF?text=Museum" },
                { id: "der_Platz", front: "площадь", back: "der Platz", hintImage: "https://placehold.co/300x200/EF4444/FFFFFF?text=Platz" },
                { id: "die_Haltestelle", front: "остановка", back: "die Haltestelle", hintImage: "https://placehold.co/300x200/374151/FFFFFF?text=Haltestelle" },
                { id: "das_Cafe", front: "кафе", back: "das Café", hintImage: "https://placehold.co/300x200/FBBF24/FFFFFF?text=Cafe" },
                { id: "der_Flughafen", front: "аэропорт", back: "der Flughafen", hintImage: "https://placehold.co/300x200/6366F1/FFFFFF?text=Flughafen" }
            ]},
            // Неделя 2
            { id: "a1_nouns_2", week: 2, name: "Сущ. A1 (Часть 2)", cards: [
                { id: "das_Auto", front: "машина", back: "das Auto" },
                { id: "das_Haus", front: "дом", back: "das Haus" }
            ]},
            // Неделя 3 (Пока заблокирована для новых пользователей)
            { id: "a1_nouns_3", week: 3, name: "Сущ. A1 (Часть 3)", cards: [
                { id: "der_Mann", front: "мужчина", back: "der Mann" },
                { id: "die_Stadt", front: "город", back: "die Stadt" }
            ]},
            // Неделя 4 (Новый набор)
            { id: "a1_verbs_1", week: 4, name: "Глаголы A1 (Часть 1)", cards: [
                { id: "machen", front: "делать", back: "machen" },
                { id: "gehen", front: "идти", back: "gehen" }
            ]},
        ];

        /**
         * Карта контента для каждой недели. 
         * Добавлено поле 'description' для модального окна "Подробнее".
         */
        const WEEKLY_CONTENT_MAP = {
            1: {
                associationVideo: "https://www.youtube.com/embed/jNQXAC9IVRw?autoplay=0&controls=1&showinfo=0&rel=0",
                associationTitle: "Ассоциации для запоминания существительных A1",
                storyLink: "text1.html", // Относительный путь для загрузки внутри SPA
                wordSetId: "a1_nouns_1",
                carouselId: "week1", 
                description: "В этой подборке вы начнете изучение базовых существительных уровня А1, освоите артикли и получите видео-ассоциации для быстрого запоминания.",
                // [ИЗМЕНЕНО]
                dialoguesTitle: "Диалоги (Неделя 1): Знакомство",
                dialoguesVideo: "https://www.youtube.com/embed/R-p9lq-E_OQ?autoplay=0&controls=1&showinfo=0&rel=0", // Placeholder
                dialoguesText: "<b>Диалог 1:</b><br>- Hallo! Wie heißt du?<br>- Ich heiße Anna. Und du?<br><br><b>Полезные фразы:</b><br>Guten Tag.<br>Wie geht's?"
            },
            2: {
                associationVideo: "https://www.youtube.com/embed/2-nFz1WJ3vM?autoplay=0&controls=1&showinfo=0&rel=0",
                associationTitle: "Ассоциации для артикля 'Das' (средний род)",
                storyLink: "https://your-domain.com/story/week2",
                wordSetId: "a1_nouns_2",
                carouselId: "week1", 
                description: "Фокусируемся на существительных среднего рода (Das) и разбираем основные конструкции для описания дома и города.",
                // [ИЗМЕНЕНО]
                dialoguesTitle: "Диалоги (Неделя 2): В ресторане",
                dialoguesVideo: "https://www.youtube.com/embed/example2?autoplay=0&controls=1&showinfo=0&rel=0", // Placeholder
                dialoguesText: "<b>Диалог 2:</b><br>- Ich hätte gern einen Kaffee, bitte.<br>- Sonst noch etwas?<br><br><b>Полезные фразы:</b><br>Die Speisekarte, bitte.<br>Zahlen, bitte."
            },
            3: {
                associationVideo: "https://www.youtube.com/embed/M0TfQvX5X1o?autoplay=0&controls=1&showinfo=0&rel=0",
                associationTitle: "Ассоциации для существительных А1 (Часть 3)",
                storyLink: "https://your-domain.com/story/week3",
                wordSetId: "a1_nouns_3",
                carouselId: "week1", 
                description: "Продолжаем расширять словарный запас А1, изучая слова, связанные с людьми и местами. Доступно после 2-й недели подписки.",
                // [ИЗМЕНЕНО]
                dialoguesTitle: "Диалоги (Неделя 3): Покупки",
                dialoguesVideo: "https://www.youtube.com/embed/example3?autoplay=0&controls=1&showinfo=0&rel=0", // Placeholder
                dialoguesText: "<b>Диалог 3:</b><br>- Was kostet das?<br>- Das kostet 10 Euro.<br><br><b>Полезные фразы:</b><br>Das ist zu teuer.<br>Ich nehme das."
            },
            4: {
                associationVideo: "https://www.youtube.com/embed/example4?autoplay=0&controls=1&showinfo=0&rel=0",
                associationTitle: "Ассоциации для глаголов A1",
                storyLink: "https://your-domain.com/story/week4",
                wordSetId: "a1_verbs_1", 
                carouselId: "week1",
                description: "Изучение первых 10 важных глаголов уровня A1, их спряжения и использования в простых предложениях.",
                // [ИЗМЕНЕНО]
                dialoguesTitle: "Диалоги (Неделя 4): Планы",
                dialoguesVideo: "https://www.youtube.com/embed/example4_dialog?autoplay=0&controls=1&showinfo=0&rel=0", // Placeholder
                dialoguesText: "<b>Диалог 4:</b><br>- Was machst du heute?<br>- Ich gehe ins Kino.<br><br><b>Полезные фразы:</b><br>Hast du Zeit?<br>Kommst du mit?"
            },
        };

        // Вспомогательные массивы для фильтров
        const ALL_WEEKS = Object.keys(WEEKLY_CONTENT_MAP).map(Number).sort((a, b) => a - b);


        // ===== НАЧАЛО ИНТЕГРАЦИИ text1.html (JavaScript) =====
        
        // [ИЗМЕНЕНО] 
        // Раньше здесь были жестко заданы QUIZ_DATA и ANALYSIS_SLIDES.
        // Теперь они инициализируются как пустые и будут заполняться из JSON.
        window.StoryApp = {
          quizData: [], // [ИЗМЕНЕНО] Инициализируем как пустой массив
          currentIndex: 0,
          userAnswers: [],
          analysisSlides: [], // [ИЗМЕНЕНО] Инициализируем как пустой массив
          currentAnalysisIndex: 0,
          
          // [НОВОЕ] Хранилища для обработчиков, чтобы избежать дублирования
          audioPlayHandler: null,
          audioProgressHandler: null,

          init() {
            this.initAudioPlayback();
            this.initAnalysisCarousel(); // Эта функция теперь будет использовать данные из quizData
            this.initStickyAudioBar();
            // ← Добавьте эту строку:
            if (window.Telegram?.WebApp?.BackButton) {
                window.Telegram.WebApp.BackButton.show();
             }   
          },

          /* ====== АУДИО ====== */
          initAudioPlayback() {
            const audio = document.getElementById('story-audio-player');
            const playBtn = document.getElementById('audio-main-button');
            const progress = document.getElementById('audio-progress');
            const curTimeEl = document.getElementById('audio-current-time');
            const durEl = document.getElementById('audio-duration');

            if (!audio) return;

            // [ИЗМЕНЕНО] Удаляем старый обработчик, прежде чем добавить новый
            if (playBtn) {
              // 1. Удаляем *старый* обработчик, если он существует
              if (this.audioPlayHandler) {
                playBtn.removeEventListener('click', this.audioPlayHandler);
              }
              // 2. Создаем и сохраняем *новый* обработчик
              this.audioPlayHandler = (e) => {
                e.stopPropagation();
                this.toggleAudioPlay();
              };
              // 3. Добавляем новый обработчик
              playBtn.addEventListener('click', this.audioPlayHandler);
            }

            audio.addEventListener('loadedmetadata', () => {
              if (durEl && isFinite(audio.duration)) {
                durEl.textContent = this.formatTime(audio.duration);
              }
            });

            audio.addEventListener('timeupdate', () => {
              if (progress && isFinite(audio.duration) && audio.duration > 0) {
                progress.value = (audio.currentTime / audio.duration) * 100;
              }
              if (curTimeEl) {
                curTimeEl.textContent = this.formatTime(audio.currentTime);
              }
            });

            // [ИЗМЕНЕНО] Та же логика для ползунка
            if (progress) {
              // 1. Удаляем *старый* обработчик
              if (this.audioProgressHandler) {
                progress.removeEventListener('input', this.audioProgressHandler);
              }
              // 2. Создаем и сохраняем *новый*
              this.audioProgressHandler = (e) => {
                if (!isFinite(audio.duration) || audio.duration <= 0) return;
                const val = Number(e.target.value) || 0;
                audio.currentTime = (val / 100) * audio.duration;
              };
              // 3. Добавляем новый
              progress.addEventListener('input', this.audioProgressHandler);
            }

            audio.onplay = () => this.updateAudioUi(true);
            audio.onpause = () => this.updateAudioUi(false);
            audio.onended = () => this.updateAudioUi(false);
          },

          formatTime(sec) {
            const s = Math.floor(sec % 60);
            const m = Math.floor(sec / 60);
            return `${m}:${s.toString().padStart(2, '0')}`;
          },

          toggleAudioPlay() {
            const audio = document.getElementById('story-audio-player');
            if (!audio) return;
            if (audio.paused) audio.play(); else audio.pause();
          },

          updateAudioUi(isPlaying) {
            const playIcon = document.getElementById('play-icon');
            const pauseIcon = document.getElementById('pause-icon');
            if (!playIcon || !pauseIcon) return;

            if (isPlaying) {
              playIcon.classList.add('hidden');
              pauseIcon.classList.remove('hidden');
            } else {
              playIcon.classList.remove('hidden');
              pauseIcon.classList.add('hidden');
            }
          },

          /* ====== FIXED AUDIO BAR ====== */
        initStickyAudioBar() {
            const wrapper     = document.getElementById('audio-bar-wrapper');
            const bar         = document.getElementById('audio-bar');
            const placeholder = document.getElementById('audio-bar-placeholder');
            if (!wrapper || !bar || !placeholder) return;

            // Вычисляем высоту шапки Telegram
            const getTelegramHeaderHeight = () => {
                if (window.Telegram?.WebApp?.viewportStableHeight) {
                    return window.innerHeight - window.Telegram.WebApp.viewportStableHeight;
                }
                return 56; // запасной вариант
            };

            let barHeight = 0;
            const headerHeight = getTelegramHeaderHeight();

            const checkPosition = () => {
                if (!wrapper || !bar || !placeholder) return; // Проверка на null
                
                const wrapperRect = wrapper.getBoundingClientRect();
                
                // Проверяем, что плеер не в модальном окне
                const isInModal = bar.closest('#transcript-modal');
                if (isInModal) {
                    if (bar.classList.contains('fixed-audio-bar')) {
                        bar.classList.remove('fixed-audio-bar');
                        placeholder.style.height = '0px';
                        bar.style.top = '';
                    }
                    return; // Не делаем "липким" в модальном окне
                }


                // Когда верхняя граница обёртки дошла до нижней границы шапки TG
                if (wrapperRect.top <= headerHeight) {
                    if (!bar.classList.contains('fixed-audio-bar')) {
                        barHeight = bar.offsetHeight;
                        bar.classList.add('fixed-audio-bar');
                        placeholder.style.height = barHeight + 'px';
                        bar.style.top = headerHeight + 'px';
                    }
                } else {
                    if (bar.classList.contains('fixed-audio-bar')) {
                        bar.classList.remove('fixed-audio-bar');
                        placeholder.style.height = '0px';
                        bar.style.top = '';
                    }
                }
            };

            // Throttle scroll/resize using requestAnimationFrame to reduce work
            let ticking = false;
            const requestCheck = () => {
                if (!ticking) {
                    ticking = true;
                    requestAnimationFrame(() => {
                        checkPosition();
                        ticking = false;
                    });
                }
            };
            window.addEventListener('scroll', requestCheck, { passive: true });
            window.addEventListener('resize', requestCheck);
            // Проверяем сразу при загрузке (на случай, если уже проскроллено)
            setTimeout(checkPosition, 100);
        },

          /* ====== АККОРДЕОНЫ ====== */
          toggleAccordion(contentId) {
            const content = document.getElementById(contentId);
            const arrow = document.getElementById(contentId.replace('-content', '-arrow'));
            if (!content || !arrow) return;

            const isOpen = content.classList.contains('is-open');
            if (isOpen) {
              content.classList.remove('is-open');
              arrow.innerHTML = '&darr;';
              setTimeout(() => content.classList.add('hidden'), 400);
            } else {
              content.classList.remove('hidden');
              setTimeout(() => content.classList.add('is-open'), 10);
              arrow.innerHTML = '&uarr;';
            }
          },

          /* ====== КАРУСЕЛЬ РАЗБОРА ====== */
          initAnalysisCarousel() {
            // [ИЗМЕНЕНО] Проверяем, есть ли данные в this.analysisSlides
            if (!this.analysisSlides || !this.analysisSlides.length) {
                const slideContainer = document.getElementById('analysis-slide');
                if (slideContainer) slideContainer.innerHTML = '<p class="text-gray-500 text-center">Нет данных для разбора.</p>';
                return;
            }
            this.currentAnalysisIndex = 0;
            this.renderAnalysisSlide();
          },

          renderAnalysisSlide() {
            const slideContainer = document.getElementById('analysis-slide');
            const progressEl = document.getElementById('analysis-progress');
            if (!slideContainer) return;

            const slide = this.analysisSlides[this.currentAnalysisIndex];
            if (!slide) return;

            slideContainer.innerHTML = `
              <p class="mb-1 text-xs font-semibold uppercase tracking-wide text-indigo-600">
                ${slide.title || 'Разбор'}
              </p>
              <p class="mb-2 font-semibold text-gray-800">${slide.original}</p>
              <p class="mb-3 text-gray-700">${slide.translation}</p>
              ${
                slide.notes && slide.notes.length
                  ? `<ul class="list-disc list-inside text-sm text-gray-600 space-y-1">
                       ${slide.notes.map(n => `<li>${n}</li>`).join('')}
                     </ul>`
                  : ''
              }
            `;

            if (progressEl) {
              const total = this.analysisSlides.length;
              const current = this.currentAnalysisIndex + 1;
              progressEl.textContent = `${current} / ${total}`;
            }
          },

          nextAnalysisSlide() {
            if (!this.analysisSlides || !this.analysisSlides.length) return;
            this.currentAnalysisIndex =
              (this.currentAnalysisIndex + 1) % this.analysisSlides.length;
            this.renderAnalysisSlide();
          },

          prevAnalysisSlide() {
            if (!this.analysisSlides || !this.analysisSlides.length) return;
            this.currentAnalysisIndex =
              (this.currentAnalysisIndex - 1 + this.analysisSlides.length) % this.analysisSlides.length;
            this.renderAnalysisSlide();
          },

          /* ====== КВИЗ ====== */
          startStoryQuiz() {
            // [ИЗМЕНЕНО] Проверяем, есть ли данные в this.quizData
            if (!this.quizData || !this.quizData.length) {
                console.error("Нет данных для квиза!");
                // Можно показать alert или просто не открывать модалку
                return;
            }
            this.currentIndex = 0;
            this.userAnswers = [];
            this.renderCurrentQuestion();
            this.updateProgress();
            this.resetControls();
            window.App.openModal('quiz-modal'); // [ИЗМЕНЕНО] Используем App.openModal
          },

          renderCurrentQuestion() {
            const q = this.quizData[this.currentIndex];
            if (!q) return;

            const questionEl = document.getElementById('quiz-question');
            const optionsContainer = document.getElementById('quiz-options');
            const feedbackEl = document.getElementById('quiz-feedback');
            const questionBox = document.getElementById('question-box'); 

            if (!questionEl || !optionsContainer || !feedbackEl || !questionBox) return; 

            // --- ИЗМЕНЕНО: Показываем элементы при рендере вопроса ---
            questionBox.classList.remove('hidden');
            optionsContainer.classList.remove('hidden');
            // --- КОНЕЦ ИЗМЕНЕНИЯ ---

            questionEl.textContent = q.question;
            optionsContainer.innerHTML = '';

            q.options.forEach((opt, idx) => {
              const btn = document.createElement('button');
              btn.className =
                'quiz-option w-full py-2 px-3 border border-gray-300 rounded-lg text-sm text-left bg-white text-gray-800 font-medium hover:bg-indigo-100';
              btn.textContent = opt;
              btn.onclick = () => this.selectOption(idx);
              optionsContainer.appendChild(btn);
            });

            feedbackEl.classList.add('hidden');
            feedbackEl.textContent = '';

            const endControls = document.getElementById('quiz-end-controls');
            if (endControls) endControls.classList.add('hidden');

            const nextBtn = document.getElementById('quiz-next-button');
            if (nextBtn) {
              nextBtn.disabled = true;
              nextBtn.classList.add('next-button-disabled');
              nextBtn.classList.remove('next-button-active', 'hidden');
            }
          },

          selectOption(idx) {
            const q = this.quizData[this.currentIndex];
            if (!q) return;

            const chosen = q.options[idx];
            this.userAnswers[this.currentIndex] = chosen;

            document.querySelectorAll('#quiz-options .quiz-option').forEach(btn => {
              btn.classList.remove('quiz-selected');
              if (btn.textContent.trim() === chosen.trim()) {
                btn.classList.add('quiz-selected');
              }
            });

            const nextBtn = document.getElementById('quiz-next-button');
            if (nextBtn) {
              nextBtn.disabled = false;
              nextBtn.classList.remove('next-button-disabled');
              nextBtn.classList.add('next-button-active');
            }
          },

          nextQuizQuestion() {
            if (this.currentIndex < this.quizData.length - 1) {
              this.currentIndex++;
              this.renderCurrentQuestion();
              this.updateProgress();
            } else {
              this.finishQuiz();
            }
          },

          updateProgress() {
            const progressEl = document.getElementById('quiz-progress');
            if (!progressEl) return;

            // --- ИЗМЕНЕНО: Показываем прогресс ---
            progressEl.classList.remove('hidden');
            // --- КОНЕЦ ИЗМЕНЕНИЯ ---

            const total = this.quizData.length;
            const current = this.currentIndex + 1;
            progressEl.textContent = `Вопрос ${current} из ${total}`;
          },

          resetControls() {
            const endControls = document.getElementById('quiz-end-controls');
            if (endControls) endControls.classList.add('hidden');

            const nextBtn = document.getElementById('quiz-next-button');
            if (nextBtn) {
              nextBtn.disabled = true;
              nextBtn.classList.add('next-button-disabled');
              nextBtn.classList.remove('next-button-active', 'hidden');
            }

            const feedbackEl = document.getElementById('quiz-feedback');
            if (feedbackEl) {
              feedbackEl.classList.add('hidden');
              feedbackEl.textContent = '';
            }
          },

          finishQuiz() {
            const total = this.quizData.length;
            let correct = 0;

            this.quizData.forEach((q, i) => {
              if (this.userAnswers[i] === q.answer) correct++;
            });

            const feedbackEl = document.getElementById('quiz-feedback');
            if (feedbackEl) {
              feedbackEl.textContent = `Вы ответили правильно на ${correct} из ${total} вопросов.`;
              feedbackEl.classList.remove('hidden');
            }

            const nextBtn = document.getElementById('quiz-next-button');
            if (nextBtn) nextBtn.classList.add('hidden');

            const endControls = document.getElementById('quiz-end-controls');
            if (endControls) endControls.classList.remove('hidden');

            // --- ИЗМЕНЕНО: Скрываем вопрос, опции и прогресс при завершении ---
            const questionBox = document.getElementById('question-box');
            if (questionBox) questionBox.classList.add('hidden');
            
            const optionsContainer = document.getElementById('quiz-options');
            if (optionsContainer) optionsContainer.classList.add('hidden');
            
            const progressEl = document.getElementById('quiz-progress');
            if (progressEl) progressEl.classList.add('hidden');
            // --- КОНЕЦ ИЗМЕНЕНИЯ ---
          },

          showCorrectAnswers() {
            const optionsContainer = document.getElementById('quiz-options');
            const feedbackEl = document.getElementById('quiz-feedback');
            if (!optionsContainer) return;

            // --- ИСПРАВЛЕНИЕ: Показываем контейнер перед заполнением ---
            optionsContainer.classList.remove('hidden');
            // --- КОНЕЦ ИСПРАВЛЕНИЯ ---

            optionsContainer.innerHTML = '';

            this.quizData.forEach((q, i) => {
              const block = document.createElement('div');
              block.className = 'mb-3 p-3 bg-indigo-50 rounded-lg';
              block.innerHTML = `
                <p class="font-semibold mb-1">${i + 1}. ${q.question}</p>
                <p class="text-green-700 font-bold">Правильный ответ: ${q.answer}</p>
              `;
              optionsContainer.appendChild(block);
            });

            if (feedbackEl) feedbackEl.classList.add('hidden');
          },

          /* ====== МОДАЛКИ (ВНУТРИ StoryApp) ====== */
          // [ИЗМЕНЕНО] Эти функции теперь вызываются из App.openModal / App.closeModal
          // поэтому мы можем их УДАЛИТЬ или оставить (пока оставим, но они не используются)
          openModal(id) {
            // ... (Этот код больше не используется, используется App.openModal)
          },

          closeModal(id) {
            // ... (Этот код больше не используется, используется App.closeModal)
          }
        };
        // ===== КОНЕЦ ИНТЕГРАЦИИ text1.html =====


        // ==========================================================
        // 2. ЛОГИКА ПРИЛОЖЕНИЯ (Conceptual App Module)
        // ==========================================================

        window.App = {
            db: null,
            auth: null, 
            userId: null,
            isAuthReady: false, 
            userProgress: {}, 
            audioPlayerOriginalParent: null, // [НОВОЕ] Для хранения родителя плеера
            allStoryContent: {}, // [НОВОЕ] Для хранения загруженного JSON
            
            // ПОЛЯ ДЛЯ ПОДПИСКИ И АКТИВАЦИИ
            isSubscriber: false, 
            activationDate: null, 
            selectedWeek: 0, 
            
            unlockedWeek: 1, 
            sessionCards: [], 
            currentCardIndex: 0,
            isPracticeMode: false,
            isAdvancing: false,
            currentDirection: 'ru-de', 
            tempSetId: null, 
            tempMode: null,
            tempSource: null,
            currentScreenId: 'loading-screen', 
            
            // Состояние фильтров
            currentWeekFilter: 'All', 
            currentThemeFilter: 'All', 
            
            // --- НОВАЯ ЛОГИКА НАВИГАЦИИ ---
            tg: null, // Объект Telegram Web App
            navigationHistory: [], // Стек для хранения истории
            // { renderFunc: 'renderHomeScreen', param: null }
            // { renderFunc: 'renderWeekContent', param: 1 }
            // { renderFunc: 'renderVideoContentScreen', param: { title: '...', videoUrl: '...' } }
            // -------------------------------

            // Данные карусели
            carouselSetsMetadata: [],
            carouselCards: [],
            currentCarouselIndex: 0,
            
            /**
             * ВАЖНО: Определяет путь к документу в Firestore, используя ВАШУ КОЛЛЕКЦИЮ И ID
             */
            getUserDocRef() {
                 if (!this.db || !this.userId) return null;
                 // Использование ВАШЕЙ КОЛЛЕКЦИИ (MY_COLLECTION_NAME) и Telegram ID (this.userId)
                 return doc(this.db, MY_COLLECTION_NAME, this.userId);
            },


            // [НОВАЯ ФУНКЦИЯ] для (пере)установки обработчиков Telegram
            setupTelegramHandlers() {
                if (!this.tg) {
                    this.tg = window.Telegram.WebApp;
                    this.tg.ready(); 
                }
                // (Пере)назначаем наш главный обработчик "Назад"
                this.tg.BackButton.onClick(() => this.handleTelegramBackClick());
            },

            async init() {
                try {
                    // --- ИНИЦИАЛИЗАЦИЯ TELEGRAM API ---
                    // Делаем это *первым*, чтобы API было доступно
                    // [ИЗМЕНЕНО] Вызываем новую функцию
                    this.setupTelegramHandlers();
                    // ------------------------------------

                    // Инициализация Firebase
                    if (Object.keys(firebaseConfig).length > 0 && firebaseConfig.apiKey !== "YOUR_FIREBASE_CONFIG_HERE") {
                        const app = initializeApp(firebaseConfig);
                        this.db = getFirestore(app);
                        this.userId = MY_USER_ID_SOURCE;
                        this.isAuthReady = true;
                    } else {
                         console.error("Firebase configuration not found or not set. Progress will not be saved.");
                         this.isAuthReady = false;
                         this.userId = MY_USER_ID_SOURCE; 
                    }

                    this.disableZoom();
                    await this.loadCarouselMetadata(); 
                    await this.loadStoryContent(); // [НОВОЕ] Загружаем контент историй

                    if (this.isAuthReady) {
                        await this.loadProgress();
                    } else {
                        // В локальном режиме
                        this.isSubscriber = false; 
                        this.selectedWeek = 0; 
                        this.unlockedWeek = this.getMaxAvailableWeek(); 
                        this.renderHomeScreen(); // <-- Первый вызов, который запустит showScreen
                    }

                } catch (error) {
                    this.showError(`Ошибка инициализации/аутентификации: ${error.message}`);
                    console.error(error);
                }
            },
            
            disableZoom() {
                document.addEventListener('touchstart', (event) => {
                    if (event.touches.length > 1) {
                        event.preventDefault();
                    }
                }, { passive: false });

                let lastTouchEnd = 0;
                document.addEventListener('touchend', function (event) {
                    const now = (new Date()).getTime();
                    if (now - lastTouchEnd <= 300) {
                        event.preventDefault();
                    }
                    lastTouchEnd = now;
                }, false);
            },


            // [НОВОЕ] Загружает контент для историй (транскрипты, квизы и т.д.)
            async loadStoryContent() {
                try {
                    const response = await fetch(getBaseUrl() + 'story_content.json');
                    if (!response.ok) throw new Error('Не удалось загрузить story_content.json');
                    this.allStoryContent = await response.json();
                    console.log('Контент историй загружен:', this.allStoryContent);
                } catch (error) {
                    console.error("Ошибка загрузки контента историй:", error);
                    this.showError('Не удалось загрузить контент историй.');
                }
            },

            async loadProgress() {
                this.showScreen('loading-screen'); // Показываем загрузку
                if (!this.isAuthReady) {
                    // Попытка загрузить прогресс из localStorage когда Firebase недоступен
                    try {
                        this.loadLocalProgress();
                    } catch (err) {
                        console.warn('Local progress load failed:', err);
                    }
                    return;
                }

                try {
                    const docRef = this.getUserDocRef();
                    if (!docRef) {
                        console.error("Не удалось получить ссылку на документ Firestore.");
                        return;
                    }
                    const docSnap = await getDoc(docRef);

                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        this.userProgress = data.cards || {};
                        this.isSubscriber = data.isSubscriber || false;
                        this.activationDate = data.activationDate; 
                        this.selectedWeek = data.selectedWeek || 0; 
                        this.unlockedWeek = this.getMaxAvailableWeek(); 
                    } else {
                        // Новый пользователь
                        this.userProgress = {};
                        this.isSubscriber = false;
                        this.selectedWeek = 0; 
                        this.unlockedWeek = 1; 
                        await this.saveProgress(); 
                    }
                } catch (error) {
                    console.error("Error loading progress:", error);
                } finally {
                    this.renderHomeScreen(); // <-- Первый рендер после загрузки
                }
            },
            
            async saveProgress() {
                // Если Firebase доступен — сохраняем в Firestore, иначе — в localStorage
                if (this.isAuthReady) {
                    try {
                        const docRef = this.getUserDocRef();
                        if (!docRef) {
                            console.error("Не удалось получить ссылку на документ Firestore.");
                            return;
                        }
                        await setDoc(docRef, { 
                            cards: this.userProgress,
                            isSubscriber: this.isSubscriber,
                            activationDate: this.activationDate,
                            selectedWeek: this.selectedWeek
                        }, { merge: true });
                        console.log('Прогресс сохранен в Firebase');
                    } catch (error) {
                        console.error('Ошибка сохранения прогресса:', error);
                    }
                } else {
                    try {
                        this.saveLocalProgress();
                        console.log('Прогресс сохранен в localStorage');
                    } catch (err) {
                        console.error('Ошибка сохранения локального прогресса:', err);
                    }
                }
            },

            // Local storage helpers for offline / no-Firebase mode
            loadLocalProgress() {
                try {
                    const raw = localStorage.getItem('flash_app_progress_v1');
                    if (!raw) return;
                    const data = JSON.parse(raw);
                    this.userProgress = data.cards || {};
                    this.isSubscriber = data.isSubscriber || false;
                    this.activationDate = data.activationDate || null;
                    this.selectedWeek = data.selectedWeek || 0;
                    this.unlockedWeek = this.getMaxAvailableWeek();
                    this.renderHomeScreen();
                } catch (err) {
                    console.error('Failed to parse local progress:', err);
                }
            },

            saveLocalProgress() {
                try {
                    const payload = {
                        cards: this.userProgress || {},
                        isSubscriber: this.isSubscriber || false,
                        activationDate: this.activationDate || null,
                        selectedWeek: this.selectedWeek || 0
                    };
                    localStorage.setItem('flash_app_progress_v1', JSON.stringify(payload));
                } catch (err) {
                    console.error('Failed to save local progress:', err);
                }
            },

            getMaxAvailableWeek() {
                if (!this.isSubscriber || !this.activationDate) {
                    return 1; 
                }
                const activationTime = new Date(this.activationDate).getTime();
                const currentTime = new Date().getTime();
                const daysDiff = Math.floor((currentTime - activationTime) / (1000 * 60 * 60 * 24));
                let maxWeek = Math.floor(daysDiff / 7) + 1;
                return Math.min(ALL_WEEKS.length, Math.max(1, maxWeek));
            },
            
            async activateSubscription() {
                if (this.isSubscriber) return; 
                this.isSubscriber = true;
                this.activationDate = this.getTodayDateString();
                this.selectedWeek = 1; 
                this.unlockedWeek = this.getMaxAvailableWeek(); 
                await this.saveProgress();
                this.renderHomeScreen(false, true); // Рендерим с очисткой стека
            },

            // ==================== НОВАЯ ЛОГИКА НАВИГАЦИИ ====================

            /**
             * [НОВЫЙ] Обработчик нажатия кнопки "Zurück" в хедере Telegram.
             */
            handleTelegramBackClick() {
                // В стеке не может быть меньше 2 экранов (home + текущий)
                if (this.navigationHistory.length < 2) {
                    // Этого не должно случиться, так как кнопка "Назад" должна быть скрыта на home-screen
                    return; 
                }
                
                // 1. Удаляем *текущий* экран из истории
                this.navigationHistory.pop();
                
                // 2. Получаем *предыдущее* состояние
                const prevState = this.navigationHistory[this.navigationHistory.length - 1];
                
                // 3. Перерисовываем предыдущее состояние
                // true = "это навигация назад", не нужно снова пушить в историю
                this.reRenderState(prevState, true);
            },

            /**
             * [НОВЫЙ] "Роутер", который перерисовывает экран из состояния в истории.
             */
            reRenderState(state, isBackNavigation = false) {
                if (!state) {
                    this.renderHomeScreen(isBackNavigation); // Безопасный возврат
                    return;
                }

                const { renderFunc, param } = state;
                
                // Вызываем соответствующую функцию рендеринга
                switch (renderFunc) {
                    case 'renderHomeScreen':
                        this.renderHomeScreen(isBackNavigation);
                        break;
                    case 'renderWeeklySelections':
                        this.renderWeeklySelections(isBackNavigation);
                        break;
                    case 'renderWeekContent':
                        this.renderWeekContent(param, isBackNavigation);
                        break;
                    case 'renderAllSetsScreen':
                        this.renderAllSetsScreen(isBackNavigation);
                        break;
                    case 'renderVideoContentScreen':
                        this.renderVideoContentScreen(param.title, param.videoUrl, param.textContent, isBackNavigation);
                        break;
                    case 'renderExternalLinkScreen':
                        this.renderExternalLinkScreen(param.title, param.url, isBackNavigation);
                        break;
                    case 'renderStoryScreen':
                        // [ИЗМЕНЕНО] param.url -> param.weekId
                        this.renderStoryScreen(param.title, param.weekId, isBackNavigation);
                        break;
                    case 'renderCarouselListScreen':
                        this.renderCarouselListScreen(isBackNavigation);
                        break;
                    case 'startCarouselSession':
                        this.startCarouselSession(param.setId, param.setTitle, param.filepath, isBackNavigation);
                        break;
                    case 'startSession':
                        this.startSession(param.setId, param.mode, isBackNavigation, param.source);
                        break;
                    default:
                        this.renderHomeScreen(isBackNavigation); // По умолчанию
                }
            },


            // ==================== РЕНДЕРИНГ ЭКРАНОВ (ИЗМЕНЕНО) ====================

            // isBack - флаг, что мы пришли сюда по кнопке "Назад"
            // clearStack - флаг, что нужно очистить всю историю (напр. при клике "Домой" в футере)
            renderHomeScreen(isBack = false, clearStack = false) {
                this.renderDueTodaySection();
                
                const mainBlock = document.getElementById('main-content-block');
                mainBlock.innerHTML = '';
                
                if (!this.isSubscriber && this.selectedWeek === 0) { 
                    mainBlock.innerHTML += `
                        <button onclick="window.App.renderWeekContent(1)" class="w-full py-4 px-5 rounded-xl shadow-xl bg-gradient-to-r from-green-400 to-green-600 text-white text-left text-lg font-bold flex justify-between items-center transition duration-150 hover:shadow-2xl transform hover:-translate-y-1">
                            <span>🚀 Тема 1</span>
                            <span>Начать &rarr;</span>
                        </button>
                    `;
                } else {
                    const activeWeek = this.selectedWeek;
                    const weekTitle = activeWeek === 1 && !this.isSubscriber 
                                    ? 'Тема 1' 
                                    : `Тема ${activeWeek}`;
                    
                    if (activeWeek >= 1 && activeWeek <= ALL_WEEKS.length) {
                        mainBlock.innerHTML += `
                            <button onclick="window.App.renderWeekContent(${activeWeek})" class="w-full py-4 px-5 rounded-xl shadow-xl bg-gradient-to-r from-yellow-400 to-orange-500 text-white text-left text-lg font-bold flex justify-between items-center transition duration-150 hover:shadow-2xl transform hover:-translate-y-1">
                                <span>📅 Активная подборка: ${weekTitle}</span>
                                <span>Продолжить &rarr;</span>
                            </button>
                        `;
                    }
                }
                
                mainBlock.innerHTML += `
                    <button onclick="window.App.renderTopicSelection()" class="w-full py-4 px-5 bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl shadow-md text-left text-lg font-semibold text-indigo-900 hover:from-blue-100 hover:to-indigo-100 flex justify-between items-center transition duration-150 mt-3 border-2 border-indigo-200">
                        <span>🗂️ Все Темы</span>
                        <span>&rarr;</span>
                    </button>
                `;

                mainBlock.innerHTML += `
                    <button onclick="window.App.renderAllSetsScreen()" class="w-full py-4 px-5 bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl shadow-md text-left text-lg font-semibold text-purple-900 hover:from-purple-100 hover:to-pink-100 flex justify-between items-center transition duration-150 mt-3 border-2 border-purple-200">
                        <span>📚 Все наборы слов</span>
                        <span>&rarr;</span>
                    </button>
                `;
                
                this.renderDueTodaySection();
                
                // [ИЗМЕНЕНО] Вызываем showScreen с состоянием для истории
                this.showScreen('home-screen', isBack, { renderFunc: 'renderHomeScreen', param: null }, clearStack);
            },
            
            renderDueTodaySection() {
                const section = document.getElementById('due-today-section');
                const list = document.getElementById('due-today-list');
                if (!section || !list) return;

                const today = this.getTodayDateString();
                let dueSetsCount = 0;
                list.innerHTML = '';

                WORD_SETS.forEach(set => {
                    if (this.isSubscriber && set.week > this.unlockedWeek) return;
                    if (!this.isSubscriber && set.week > 1) return;

                    let dueCount = 0;
                    set.cards.forEach(card => {
                        const progress = this.userProgress[card.id];
                        if (!progress || (progress.nextReview && progress.nextReview <= today)) {
                            dueCount++;
                        }
                    });

                    if (dueCount > 0) {
                        dueSetsCount++;
                        const setEl = document.createElement('div');
                        setEl.className = "bg-white p-4 rounded-xl shadow-md border-l-4 border-orange-500 flex justify-between items-center transform transition hover:-translate-y-1";

                        const left = document.createElement('div');
                        const title = document.createElement('span');
                        title.className = 'font-bold text-gray-800';
                        title.textContent = set.name;
                        const info = document.createElement('span');
                        info.className = 'text-sm text-orange-600 font-medium block';
                        info.textContent = `Доступно для повторения: ${dueCount}`;
                        left.appendChild(title);
                        left.appendChild(info);

                        const btn = document.createElement('button');
                        btn.className = 'py-2 px-4 bg-orange-100 text-orange-700 font-bold rounded-xl hover:bg-orange-200 transition duration-150 flex items-center';
                        btn.type = 'button';
                        btn.textContent = 'Начать';
                        btn.addEventListener('click', () => this.promptForDirection(set.id, 'review', 'allsets'));

                        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                        svg.setAttribute('class', 'w-4 h-4 ml-1');
                        svg.setAttribute('fill', 'none');
                        svg.setAttribute('stroke', 'currentColor');
                        svg.setAttribute('viewBox', '0 0 24 24');
                        const p1 = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                        p1.setAttribute('stroke-linecap', 'round');
                        p1.setAttribute('stroke-linejoin', 'round');
                        p1.setAttribute('stroke-width', '2');
                        p1.setAttribute('d', 'M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z');
                        const p2 = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                        p2.setAttribute('stroke-linecap', 'round');
                        p2.setAttribute('stroke-linejoin', 'round');
                        p2.setAttribute('stroke-width', '2');
                        p2.setAttribute('d', 'M21 12a9 9 0 11-18 0 9 9 0 0118 0z');
                        svg.appendChild(p1);
                        svg.appendChild(p2);
                        btn.appendChild(svg);

                        setEl.appendChild(left);
                        setEl.appendChild(btn);
                        list.appendChild(setEl);
                    }
                });

                if (dueSetsCount > 0) {
                    section.classList.remove('hidden');
                } else {
                    section.classList.add('hidden');
                }
            },

            renderWeeklySelections(isBack = false) {
                // [ИЗМЕНЕНО] Убраны this.returnContext и this.renderBackButton
                document.getElementById('list-title').innerText = '🗂️ Все Темы';
                document.getElementById('filter-controls').innerHTML = '';

                const contentListDiv = document.getElementById('content-list');
                contentListDiv.innerHTML = '';
                this.unlockedWeek = this.getMaxAvailableWeek(); 

                ALL_WEEKS.forEach(i => {
                    const isSubscriber = this.isSubscriber;
                    const maxAvailableWeek = this.unlockedWeek;
                    const isCurrentSelected = i === this.selectedWeek; 
                    const isAvailable = isSubscriber ? (i <= maxAvailableWeek) : (i === 1); 
                    const weekData = WEEKLY_CONTENT_MAP[i];
                    
                    let statusText = 'Доступно';
                    let buttonClass = 'bg-white hover:bg-gray-50';

                    if (!isAvailable) {
                        buttonClass = 'button-locked';
                        if (!isSubscriber) {
                            statusText = '🔒 Оформите подписку';
                        } else {
                            const activationTime = new Date(this.activationDate).getTime();
                            const currentTime = new Date().getTime();
                            const daysDiff = Math.floor((currentTime - activationTime) / (1000 * 60 * 60 * 24));
                            const daysNeeded = (i - 1) * 7;
                            const daysLeft = daysNeeded - daysDiff;
                            statusText = `🔒 Доступно через ${daysLeft} дн.`;
                        }
                    } else if (i === 1 && !isSubscriber) {
                        buttonClass = 'bg-green-100 border-2 border-green-500';
                        statusText = 'Тема 1';
                    } else if (isCurrentSelected) {
                        buttonClass = 'bg-yellow-100 border-2 border-yellow-500';
                        statusText = 'Активно';
                    }

                    const weekContainer = document.createElement('div');
                    weekContainer.className = `w-full p-4 rounded-xl shadow-md ${buttonClass}`;

                    const topRow = document.createElement('div');
                    topRow.className = 'flex justify-between items-center mb-3';
                    const leftCol = document.createElement('div');
                    const titleSpan = document.createElement('span');
                    titleSpan.className = `font-bold text-lg ${!isAvailable ? 'text-gray-500' : 'text-gray-800'}`;
                    titleSpan.textContent = `Тема ${i}`;
                    const statusSpan = document.createElement('span');
                    statusSpan.className = `block text-sm ${!isAvailable ? 'text-orange-600' : 'text-gray-500'}`;
                    statusSpan.textContent = statusText;
                    leftCol.appendChild(titleSpan);
                    leftCol.appendChild(statusSpan);
                    topRow.appendChild(leftCol);

                    const bottomRow = document.createElement('div');
                    bottomRow.className = 'grid grid-cols-2 gap-3';

                    const detailsBtn = document.createElement('button');
                    detailsBtn.className = 'w-full py-2 px-3 bg-gray-200 text-gray-700 font-semibold rounded-xl text-sm hover:bg-gray-300 transition duration-150';
                    detailsBtn.type = 'button';
                    detailsBtn.textContent = 'Подробнее';
                    detailsBtn.addEventListener('click', () => this.showWeekDetails(i, weekData.description));

                    const learnBtn = document.createElement('button');
                    learnBtn.id = `week-learn-${i}`;
                    learnBtn.className = `w-full py-2 px-3 text-white font-semibold rounded-xl text-sm transition duration-150 ${isAvailable ? 'bg-blue-500 hover:bg-blue-600' : 'button-locked'}`;
                    learnBtn.type = 'button';
                    learnBtn.textContent = 'Учить';
                    if (isAvailable) {
                        learnBtn.addEventListener('click', () => this.selectAndRenderWeek(i));
                    } else {
                        learnBtn.disabled = true;
                    }

                    bottomRow.appendChild(detailsBtn);
                    bottomRow.appendChild(learnBtn);

                    weekContainer.appendChild(topRow);
                    weekContainer.appendChild(bottomRow);
                    contentListDiv.appendChild(weekContainer);
                });
                
                // [ИЗМЕНЕНО] Вызываем showScreen с состоянием для истории
                this.showScreen('list-screen', isBack, { renderFunc: 'renderWeeklySelections', param: null });
            },
            
            showWeekDetails(weekNum, description) {
                document.getElementById('week-details-title').textContent = `Тема ${weekNum}`;
                document.getElementById('week-details-body').textContent = description;
                this.openModal('week-details-modal');
            },

            async selectAndRenderWeek(weekNum) {
                this.selectedWeek = weekNum;
                await this.saveProgress();
                this.renderWeekContent(weekNum); // Это уже не 'isBack'
            },
            
            renderMenuCard(container, title, subtitle, onClickAction, style = 'bg-white hover:bg-gray-50') {
                const button = document.createElement('button');
                button.className = `w-full text-left p-4 ${style} rounded-xl shadow-md flex justify-between items-center transition duration-150`;
                button.setAttribute('onclick', onClickAction);
                button.innerHTML = `
                    <div>
                        <span class="font-semibold text-lg text-gray-800">${title}</span>
                        <span class="block text-sm text-gray-500">${subtitle}</span>
                    </div>
                    <span>&rarr;</span>
                `;
                container.appendChild(button);
            },

            renderWordListScreen(setId, title, isBack = false) {
                document.getElementById('list-title').innerText = title;
                document.getElementById('filter-controls').innerHTML = '';
                const contentListDiv = document.getElementById('content-list');
                contentListDiv.innerHTML = '';

                const wordSet = WORD_SETS.find(s => s.id === setId);
                if (!wordSet) {
                    contentListDiv.innerHTML = '<p class="text-gray-500 text-center py-6">Набор слов не найден.</p>';
                    this.showScreen('list-screen', isBack, { renderFunc: 'renderWordListScreen', param: {setId, title} });
                    return;
                }

                const wordsContainer = document.createElement('div');
                wordsContainer.className = 'space-y-2';

                wordSet.cards.forEach(card => {
                    const wordButton = document.createElement('button');
                    wordButton.className = 'w-full text-left p-4 bg-white hover:bg-blue-50 rounded-xl shadow-md transition duration-150 flex justify-between items-center';
                    wordButton.innerHTML = `
                        <div>
                            <span class="font-semibold text-gray-800">${card.front}</span>
                            <span class="block text-sm text-gray-500">${card.back || ''}</span>
                        </div>
                        <span class="text-blue-500">&rarr;</span>
                    `;
                    wordButton.addEventListener('click', () => {
                        const cardIndex = wordSet.cards.findIndex(c => c.id === card.id);
                        if (cardIndex !== -1) {
                            this.sessionCards = wordSet.cards.map(c => ({...c}));
                            this.currentCardIndex = cardIndex;
                            this.isPracticeMode = false;
                            this.isPracticeAllMode = true;
                            this.currentSetId = setId;
                            
                            // Настраиваем UI для режима просмотра всех слов
                            document.getElementById('controls-rate').classList.add('hidden');
                            document.getElementById('controls-practice').classList.add('hidden');
                            document.getElementById('controls-practice-all').classList.remove('hidden');
                            
                            // Показываем экран и карточку
                            this.showScreen('study-screen', false, { 
                                renderFunc: 'renderWordListScreen', 
                                param: {setId, title} 
                            });
                            this.showNextCard();
                        }
                    });
                    wordsContainer.appendChild(wordButton);
                });

                contentListDiv.appendChild(wordsContainer);
                this.showScreen('list-screen', isBack, { renderFunc: 'renderWordListScreen', param: {setId, title} });
            },
            
            renderWeekContent(weekNum, isBack = false) {
                const weekData = WEEKLY_CONTENT_MAP[weekNum];
                if (!weekData) return;
                
                const isTrialLesson = !this.isSubscriber && weekNum === 1;
                
                if (isTrialLesson) {
                    document.getElementById('list-title').innerText = `Тема ${weekNum}`;
                } else {
                    document.getElementById('list-title').innerText = `Тема ${weekNum}`;
                }

                // [ИЗМЕНЕНО] Убраны this.returnContext и this.renderBackButton
                document.getElementById('filter-controls').innerHTML = '';
                const contentListDiv = document.getElementById('content-list');
                contentListDiv.innerHTML = '';
                
                // 1. Видео ассоциации
                if (weekData.associationVideo) {
                    const videoWrapper = document.createElement('div');
                    videoWrapper.className = 'mb-4';

                    const poster = document.createElement('div');
                    poster.className = 'relative rounded-lg overflow-hidden bg-black';
                    poster.style.paddingTop = '56.25%';

                    const playBtn = document.createElement('button');
                    playBtn.type = 'button';
                    playBtn.className = 'absolute inset-0 w-full h-full flex items-center justify-center text-white';
                    playBtn.setAttribute('aria-label', 'Play association video');
                    playBtn.innerHTML = `<svg class="w-16 h-16 opacity-90" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5 3v18l15-9L5 3z"/></svg>`;

                    playBtn.addEventListener('click', () => {
                        const iframe = document.createElement('iframe');
                        iframe.style.position = 'absolute';
                        iframe.style.top = '0';
                        iframe.style.left = '0';
                        iframe.style.width = '100%';
                        iframe.style.height = '100%';
                        iframe.src = weekData.associationVideo;
                        iframe.setAttribute('frameborder', '0');
                        iframe.setAttribute('allow', 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share');
                        iframe.setAttribute('allowfullscreen', '');
                        poster.replaceWith(iframe);
                    });

                    poster.appendChild(playBtn);
                    videoWrapper.appendChild(poster);
                    contentListDiv.appendChild(videoWrapper);
                }

                // 2. Список слов по теме (как подраздел)
                const wordSet = WORD_SETS.find(s => s.id === weekData.wordSetId);
                if (wordSet) {
                    this.renderMenuCard(contentListDiv, 
                        `📝 Список слов`, 
                        `${wordSet.cards.length} слов для изучения`,
                        `window.App.renderWordListScreen('${weekData.wordSetId}', 'Список слов — Тема ${weekNum}')`,
                        'bg-white hover:bg-gray-50'
                    );
                }

                // 3. Упражнения
                this.renderMenuCard(contentListDiv, 
                    `✏️ Упражнения`, 
                    `Практические задания`,
                    `window.App.promptForDirection('${weekData.wordSetId}', 'practice', 'week')`,
                    'bg-green-100 hover:bg-green-200'
                );

                // 4. Мантры полезных фраз
                this.renderMenuCard(contentListDiv,
                    `🕯️ Мантры полезных фраз`,
                    'Короткие полезные фразы для ежедневной практики',
                    `window.App.currentWeekMantraData = { setId: 'mantra_week1', setTitle: 'Мантры полезных фраз', filepath: 'mantra_week1.json' }; window.App.startMantraSession('mantra_week1','Мантры полезных фраз','mantra_week1.json')`
                );
                
                // 5. Полезные фразы
                // [ИЗМЕНЕНО]
                const dialoguesTextEscaped = (weekData.dialoguesText || '').replace(/'/g, "\\'").replace(/"/g, '&quot;').replace(/\r\n|\r|\n/g, '<br>');
                const dialoguesTitleEscaped = (weekData.dialoguesTitle || `Диалоги Недели ${weekNum}`).replace(/'/g, "\\'");

                this.renderMenuCard(contentListDiv, 
                    `🗣️ Полезные фразы / Диалоги на тему`, 
                    `Видео и текст`, // [ИЗМЕНЕНО]
                    `window.App.renderVideoContentScreen('${dialoguesTitleEscaped}', '${weekData.dialoguesVideo || ''}', '${dialoguesTextEscaped}')` // [ИЗМЕНЕНО]
                );

                // [ИЗМЕНЕНО] Вызываем showScreen с состоянием для истории
                this.showScreen('list-screen', isBack, { renderFunc: 'renderWeekContent', param: weekNum });
                
                if (this.carouselSetsMetadata.length === 0) {
                     this.loadCarouselMetadata().then(() => {
                         this.renderWeekContent(weekNum, true); // Перерисовываем, но отмечаем как isBack, чтобы не дублировать историю
                     });
                }
            },
            
            renderVideoContentScreen(title, videoUrl, textContent, isBack = false, carouselData = null) {
                // [ИЗМЕНЕНО] Убраны this.returnContext и this.renderBackButton
                document.getElementById('video-title').textContent = title;
                const videoIframe = document.getElementById('video-embed');
                const extraTextDiv = document.getElementById('video-extra-text');
                const carouselButtonContainer = document.getElementById('video-carousel-button-container');

                videoIframe.src = videoUrl ? videoUrl : '';
                
                // [ИСПРАВЛЕНИЕ] Показываем/скрываем контейнер видео
                const videoContainer = videoIframe.closest('.video-container');
                if(videoContainer) {
                    videoContainer.style.display = videoUrl ? 'block' : 'none';
                }

                extraTextDiv.innerHTML = textContent ? textContent : ''; // Используем innerHTML для поддержки <b>
                extraTextDiv.style.display = textContent ? 'block' : 'none';
                
                // [НОВОЕ] Добавляем кнопку карусели если доступны данные
                carouselButtonContainer.innerHTML = '';
                const carouselDataToUse = carouselData || this.currentWeekCarouselData;
                if (carouselDataToUse && carouselDataToUse.setId && carouselDataToUse.setTitle && carouselDataToUse.filepath) {
                    const btn = document.createElement('button');
                    btn.className = 'btn-success w-full py-4 px-6 text-lg font-semibold flex items-center justify-center gap-3 rounded-2xl shadow-lg hover:shadow-xl transition duration-150 hover:scale-105';
                    btn.innerHTML = '🖼️ Карусель ассоциаций';
                    btn.onclick = () => this.startCarouselSession(carouselDataToUse.setId, carouselDataToUse.setTitle, carouselDataToUse.filepath);
                    carouselButtonContainer.appendChild(btn);
                }
                
                // [ИЗМЕНЕНО] Вызываем showScreen с состоянием для истории
                this.showScreen('video-content-screen', isBack, { 
                    renderFunc: 'renderVideoContentScreen', 
                    param: {title, videoUrl, textContent, carouselData} 
                });
            },
            
            renderExternalLinkScreen(title, url, isBack = false) {
                // [ИЗМЕНЕНО] Убраны this.returnContext и this.renderBackButton
                document.getElementById('external-link-title').textContent = title;
                document.getElementById('external-link-button').href = url;
                document.getElementById('external-link-url-display').textContent = url;
                
                // [ИЗМЕНЕНО] Вызываем showScreen с состоянием для истории
                this.showScreen('external-link-screen', isBack, { 
                    renderFunc: 'renderExternalLinkScreen', 
                    param: {title, url} 
                });

                if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.openLink) {
                    window.Telegram.WebApp.openLink(url);
                }
            },

            // [СИЛЬНО ИЗМЕНЕНО] 
            // Эта функция больше не загружает HTML. Она читает данные из
            // 'this.allStoryContent' и динамически заполняет страницу.
            async renderStoryScreen(title, weekId, isBack = false) { // weekId = 'week_1'
                
                // 1. Получаем контент из загруженных данных
                const content = this.allStoryContent[weekId];
                if (!content) {
                    this.showError(`Контент для '${weekId}' не найден.`);
                    console.error(`Контент для '${weekId}' не найден в this.allStoryContent`);
                    return; // Не показываем экран, если нет данных
                }

                // 2. Устанавливаем заголовок экрана
                document.getElementById('content-viewer-title').textContent = title;
                
                // 3. Заполняем элементы истории (заголовок, аудио, картинка)
                const storyBody = document.getElementById('content-viewer-body');
                storyBody.querySelector('h1').textContent = content.title;
                // (Если пути к аудио/картинкам тоже в JSON, их можно установить здесь)
                // [ИЗМЕНЕНО] Устанавливаем пути к медиа из JSON
                const imgEl = storyBody.querySelector('.story-visual-container img');
                const audioEl = storyBody.querySelector('#story-audio-player');
                
                if (imgEl && content.imageSrc) imgEl.src = content.imageSrc;
                if (audioEl && content.audioSrc) audioEl.src = content.audioSrc;


                // 4. [НОВОЕ] Заполняем модальное окно транскрипции
                const transcriptContainer = document.getElementById('transcript-scroll-area');
                transcriptContainer.innerHTML = ''; // Очищаем старые данные
                
                if (content.transcript && Array.isArray(content.transcript)) {
                    content.transcript.forEach(paragraph => {
                        const p = document.createElement('p');
                        p.className = 'mb-3';
                        p.innerHTML = paragraph;
                        transcriptContainer.appendChild(p);
                    });
                }

                // 5. [НОВОЕ] Передаем данные о квизе и разборе в 'StoryApp'
                window.StoryApp.quizData = content.quiz || [];
                window.StoryApp.analysisSlides = content.analysis || [];
                
                // 6. Показываем экран и записываем в историю
                this.showScreen('content-viewer-screen', isBack, { 
                    renderFunc: 'renderStoryScreen', 
                    param: {title, weekId} 
                });

                try {
                    // 7. Инициализируем StoryApp (он подхватит новые данные)
                    if (window.StoryApp && typeof window.StoryApp.init === 'function') {
                         await window.StoryApp.init();
                    } else {
                        console.error("StoryApp не найден или не имеет .init()");
                    }
                    
                    // 8. Восстанавливаем обработчик кнопки "Назад"
                    this.setupTelegramHandlers();

                } catch (error) {
                    console.error('Error initializing story content:', error);
                }
            },

            renderAllSetsScreen(isBack = false) {
                // [ИЗМЕНЕНО] Убраны this.returnContext и this.renderBackButton
                document.getElementById('list-title').innerText = '📚 Все наборы слов';
                this.renderSetFilterControls();
                
                const filteredSets = WORD_SETS.filter(set => {
                    const weekMatch = this.currentWeekFilter === 'All' || set.week.toString() === this.currentWeekFilter;
                    // [ИСПРАВЛЕНИЕ] Проверяем подписку
                    const unlockedMatch = (this.isSubscriber && set.week <= this.unlockedWeek) || (!this.isSubscriber && set.week === 1);
                    return weekMatch && unlockedMatch;
                });
                
                this.renderSetCards(filteredSets);
                
                // [ИЗМЕНЕНО] Вызываем showScreen с состоянием для истории
                this.showScreen('list-screen', isBack, { renderFunc: 'renderAllSetsScreen', param: null });
            },

            // ==================== ФИЛЬТРЫ И КАРТОЧКИ (Без изменений) ====================

            renderSetFilterControls() {
                const filterControls = document.getElementById('filter-controls');
                filterControls.innerHTML = `
                    <div class="grid grid-cols-2 gap-3">
                        <select id="week-filter" onchange="window.App.updateSetFilter('week', this.value)" 
                                class="p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="All">Все Недели</option>
                            ${ALL_WEEKS.map(w => `<option value="${w}" ${this.currentWeekFilter === w.toString() ? 'selected' : ''}>Тема ${w}</option>`).join('')}
                        </select>
                    </div>
                `;
            },
            
            updateSetFilter(filterType, value) {
                if (filterType === 'week') {
                    this.currentWeekFilter = value;
                }
                this.renderAllSetsScreen(true); // true = isBack, не дублируем историю
            },

            renderSetCards(setsToRender) {
                const contentListDiv = document.getElementById('content-list');
                contentListDiv.innerHTML = '';
                const today = this.getTodayDateString();

                if (setsToRender.length === 0) {
                    contentListDiv.innerHTML = '<p class="text-gray-500 text-center py-6">Нет наборов, удовлетворяющих условиям фильтрации.</p>';
                    return;
                }

                setsToRender.forEach(set => {
                    // Для экрана "Все наборы" показываем наборы с двумя кнопками: "К повтору (N)" и "Практика (Все)"
                    let dueCount = 0;
                    set.cards.forEach(card => {
                        const progress = this.userProgress[card.id];
                        if (!progress || (progress.nextReview && progress.nextReview <= today)) {
                            dueCount++;
                        }
                    });

                    const setContainer = document.createElement('div');
                    setContainer.className = "w-full p-4 bg-white rounded-xl shadow-md";
                    setContainer.innerHTML = `
                        <div class="flex justify-between items-center mb-3">
                            <div>
                                <span class="font-semibold text-gray-800 text-lg">${set.name}</span>
                                <span class="block text-sm text-gray-500">Тема ${set.week} | ${set.cards.length} слов</span>
                            </div>
                            ${dueCount > 0 ? 
                                `<span class="bg-blue-500 text-white text-xs font-bold px-3 py-1 rounded-full shadow-md">${dueCount} к повтору</span>` :
                                `<span class="text-green-500 font-semibold">✓</span>`
                            }
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            ${dueCount > 0 ? 
                                `<button class="w-full py-2 px-3 bg-blue-500 text-white font-semibold rounded-xl text-sm hover:bg-blue-600 transition duration-150" 
                                        onclick="window.App.promptForDirection('${set.id}', 'review', 'allsets')">
                                    К повтору (${dueCount})
                                </button>` :
                                `<button class="w-full py-2 px-3 bg-gray-300 text-gray-500 font-semibold rounded-xl text-sm cursor-not-allowed" disabled>
                                    К повтору (0)
                                </button>`
                            }
                            <button class="w-full py-2 px-3 bg-gray-200 text-gray-700 font-semibold rounded-xl text-sm hover:bg-gray-300 transition duration-150" 
                                    onclick="window.App.promptForDirection('${set.id}', 'practice-all', 'allsets')">
                                Практика всех слов
                            </button>
                        </div>
                    `;
                    contentListDiv.appendChild(setContainer);
                });
            },
            
            // ==================== ЛОГИКА КАРУСЕЛИ (ИЗМЕНЕНО) ====================
            
            async loadCarouselMetadata() {
                try {
                    const response = await fetch(getBaseUrl() + 'carousel_sets.json');
                    if (!response.ok) {
                        throw new Error(`Ошибка HTTP: ${response.status} ${response.statusText}`);
                    }
                    let rawResponseText = await response.text(); 
                    this.carouselSetsMetadata = JSON.parse(rawResponseText);
                    return true;
                } catch (error) {
                    console.error('Carousel Metadata Load Error:', error);
                    return false;
                }
            },

            async renderCarouselListScreen(isBack = false) {
                // [ИЗМЕНЕНО] Убраны this.carouselReturnContext и this.renderBackButton
                document.getElementById('carousel-list-title').innerText = 'Карусель ассоциаций';
                const listDiv = document.getElementById('carousel-sets-list');
                listDiv.innerHTML = '<p class="text-center text-gray-500 py-6">Загрузка списка наборов...</p>';
                
                // [ИЗМЕНЕНО] Вызываем showScreen с состоянием для истории
                this.showScreen('carousel-list-screen', isBack, { renderFunc: 'renderCarouselListScreen', param: null });
                
                if (this.carouselSetsMetadata.length === 0) {
                   await this.loadCarouselMetadata();
                }

                if (this.carouselSetsMetadata.length === 0) {
                     listDiv.innerHTML = '<p class="text-red-500 text-center py-6">Ошибка: Не удалось загрузить список наборов каруселей.</p>';
                     return;
                }
                
                listDiv.innerHTML = '';
                this.carouselSetsMetadata.forEach(set => {
                    const button = document.createElement('button');
                    button.className = 'w-full py-4 px-5 bg-white rounded-xl shadow-md text-left text-lg font-semibold text-gray-800 hover:bg-gray-50 flex justify-between items-center transition duration-150';
                    button.innerHTML = `
                        <span>${set.title}</span>
                        <span class="text-sm text-gray-500">${set.wordCount} слов &rarr;</span>
                    `;
                    button.onclick = () => this.startCarouselSession(set.id, set.title, set.filepath);
                    listDiv.appendChild(button);
                });
            },
            
            async startCarouselSession(setId, setTitle, filepath, isBack = false) {
                // [ИЗМЕНЕНО] Убраны this.carouselReturnContext
                this.showScreen('loading-screen', isBack); // Показываем загрузку (isBack, чтобы не записать 'loading' в историю)
                
                try {
                    const response = await fetch(getBaseUrl() + filepath);
                    if (!response.ok) throw new Error(`Не удалось загрузить данные набора: ${filepath}`);
                    
                    let rawResponseText = await response.text(); 
                    this.carouselCards = JSON.parse(rawResponseText);

                    if (this.carouselCards.length === 0) {
                        throw new Error('Набор пуст.');
                    }

                    this.currentCarouselIndex = 0;
                    this.showCarouselCard();
                    
                    // [ИЗМЕНЕНО] Вызываем showScreen с состоянием для истории
                    this.showScreen('image-carousel-screen', isBack, { 
                        renderFunc: 'startCarouselSession', 
                        param: {setId, setTitle, filepath} 
                    });
                    
                } catch (error) {
                    this.showScreen('loading-screen', true); // true = не пишем в историю
                    document.getElementById('loading-screen').innerHTML = `<p class="text-red-500 text-center py-6">Ошибка загрузки карусели: ${error.message}</p>`;
                    console.error('Carousel Data Load Error:', error);
                    // Автоматически вернем пользователя назад через 2 сек
                    setTimeout(() => this.handleTelegramBackClick(), 2000);
                }
            },

            showCarouselCard() {
                const card = this.carouselCards[this.currentCarouselIndex];
                document.getElementById('carousel-word-count').textContent = `Слово ${this.currentCarouselIndex + 1} из ${this.carouselCards.length}`;
                document.getElementById('carousel-image').src = card.image;
                document.getElementById('carousel-word').textContent = card.word;
                document.getElementById('carousel-translation').textContent = card.translation;
                
                document.getElementById('carousel-translation').classList.add('hidden');
                document.getElementById('toggle-translation-button').textContent = 'Показать перевод';
                // [ИЗМЕНЕНО] Убран вызов renderBackButton
            },

            showNextWord() {
                this.currentCarouselIndex = (this.currentCarouselIndex + 1) % this.carouselCards.length;
                this.showCarouselCard();
            },

            showPrevWord() {
                this.currentCarouselIndex = (this.currentCarouselIndex - 1 + this.carouselCards.length) % this.carouselCards.length;
                this.showCarouselCard();
            },
            
            toggleTranslation() {
                const translationEl = document.getElementById('carousel-translation');
                const button = document.getElementById('toggle-translation-button');
                const isHidden = translationEl.classList.contains('hidden');
                
                if (isHidden) {
                    translationEl.classList.remove('hidden');
                    button.textContent = 'Скрыть перевод';
                    this.speakGerman(this.carouselCards[this.currentCarouselIndex].word); 
                } else {
                    translationEl.classList.add('hidden');
                    button.textContent = 'Показать перевод';
                }
            },

            // ==================== ЛОГИКА МАНТР (НОВЫЙ БЛОК) ====================
            async startMantraSession(setId, setTitle, filepath, isBack = false) {
                this.openModal('mantra-modal');
                try {
                    const response = await fetch(getBaseUrl() + filepath);
                    if (!response.ok) throw new Error('Не удалось загрузить мантры.');
                    const raw = await response.text();
                    this.mantraCards = JSON.parse(raw);
                    if (!Array.isArray(this.mantraCards) || this.mantraCards.length === 0) {
                        document.getElementById('mantra-modal-body').innerHTML = '<p class="text-center text-gray-500 py-6">Набор мантр пуст.</p>';
                        return;
                    }
                    this.currentMantraIndex = 0;
                    this.mantraKnownCount = 0;
                    this.mantraUnknownCount = 0;
                    this.mantraSeen = [];
                    // Reset UI: show card area, hide summary, clear actions
                    document.getElementById('mantra-card-area').classList.remove('hidden');
                    document.getElementById('mantra-summary').classList.add('hidden');
                    document.getElementById('mantra-summary-actions').innerHTML = '';
                    this.showMantraCard();
                } catch (err) {
                    console.error('Mantra load error', err);
                    document.getElementById('mantra-modal-body').innerHTML = `<p class="text-red-500 text-center py-6">Ошибка загрузки мантр: ${err.message}</p>`;
                }
            },

            showMantraCard() {
                const card = this.mantraCards[this.currentMantraIndex];
                if (!card) return;
                // Russian always visible
                document.getElementById('mantra-russian').textContent = card.ru || '';
                // German hidden by default
                document.getElementById('mantra-german').textContent = card.de || '';
                document.getElementById('mantra-german-hidden').classList.remove('hidden');
                document.getElementById('mantra-german-shown').classList.add('hidden');
                document.getElementById('mantra-progress').textContent = `${this.currentMantraIndex + 1} / ${this.mantraCards.length}`;
            },

            showMantraAnswer() {
                document.getElementById('mantra-german-hidden').classList.add('hidden');
                document.getElementById('mantra-german-shown').classList.remove('hidden');
            },

            flipMantraCard() {
                // Deprecated - no longer used in new design
            },

            speakMantra(text) {
                if (!text) return;
                if (window.speechSynthesis) {
                    const utter = new SpeechSynthesisUtterance(text);
                    utter.lang = 'de-DE';
                    window.speechSynthesis.cancel();
                    window.speechSynthesis.speak(utter);
                }
            },

            handleMantraAnswer(known) {
                // record answer
                if (known) this.mantraKnownCount++;
                else this.mantraUnknownCount++;
                this.mantraSeen.push({ index: this.currentMantraIndex, known });

                // advance to next card or show summary
                this.currentMantraIndex++;
                if (this.currentMantraIndex >= this.mantraCards.length) {
                    // finished session
                    this.showMantraSummary();
                } else {
                    // reset UI for next card
                    this.showMantraCard();
                }
            },

            showMantraSummary() {
                // hide card area, show summary
                document.getElementById('mantra-card-area').classList.add('hidden');
                const summaryEl = document.getElementById('mantra-summary');
                summaryEl.classList.remove('hidden');
                summaryEl.innerHTML = `
                    <p class="text-lg font-semibold">Результат</p>
                    <p class="mt-2">Пройдено: <b>${this.mantraKnownCount}</b></p>
                    <p>Не пройдено: <b>${this.mantraUnknownCount}</b></p>
                `;
                // options: repeat not-known, retry all, close
                document.getElementById('mantra-summary-actions').innerHTML = `
                    <div class="flex gap-2 mt-4">
                        <button class="btn-success flex-1" onclick="window.App.restartMantraWithFilter(false)">Повторить непроходные</button>
                        <button class="btn-primary flex-1" onclick="window.App.restartMantraWithFilter(true)">Пройти заново все</button>
                    </div>
                    <div class="mt-3 text-center">
                        <button class="py-2 px-4 text-sm text-gray-600" onclick="window.App.closeModal('mantra-modal')">Закрыть</button>
                    </div>
                `;
            },

            restartMantraWithFilter(restartAll) {
                // rebuild mantraCards view
                if (restartAll) {
                    this.currentMantraIndex = 0;
                    this.mantraKnownCount = 0;
                    this.mantraUnknownCount = 0;
                    document.getElementById('mantra-summary').classList.add('hidden');
                    document.getElementById('mantra-summary-actions').innerHTML = '';
                    document.getElementById('mantra-card-area').classList.remove('hidden');
                    this.showMantraCard();
                } else {
                    // filter to unknowns
                    const unknownIndexes = this.mantraSeen.filter(s => !s.known).map(s => s.index);
                    if (unknownIndexes.length === 0) {
                        // nothing to repeat
                        alert('Нет непроходных карточек для повторения.');
                        return;
                    }
                    this.mantraCards = unknownIndexes.map(i => this.mantraCards[i]);
                    this.currentMantraIndex = 0;
                    this.mantraKnownCount = 0;
                    this.mantraUnknownCount = 0;
                    this.mantraSeen = [];
                    document.getElementById('mantra-summary').classList.add('hidden');
                    document.getElementById('mantra-summary-actions').innerHTML = '';
                    document.getElementById('mantra-card-area').classList.remove('hidden');
                    this.showMantraCard();
                }
            },

            // [ИЗМЕНЕНО] Функция УДАЛЕНА, так как HTML кнопка удалена
            // returnToCarouselList() { ... }


            // ==================== ЛОГИКА ПОВТОРЕНИЯ (ИЗМЕНЕНО) ====================

            promptForDirection(setId, mode, source = 'allsets') {
                this.tempSetId = setId;
                this.tempMode = mode;
                this.tempSource = source;
                this.openModal('direction-modal');
            },

            closeDirectionModal() {
                this.closeModal('direction-modal');
            },

            startSessionWithDirection(direction) {
                this.currentDirection = direction;
                this.closeDirectionModal();
                // [ИЗМЕНЕНО] Передаем renderFunc и источник в startSession
                this.startSession(this.tempSetId, this.tempMode, false, this.tempSource);
            },
            
            startSession(setId, mode, isBack = false, source = 'allsets') {
                const set = WORD_SETS.find(s => s.id === setId);
                if (!set) return;

                this.isPracticeMode = (mode === 'practice');
                this.isPracticeAllMode = (mode === 'practice-all');

                // Заполняем массив карточек для сессии в зависимости от режима
                if (this.isPracticeAllMode) {
                    // Практика всех слов: показываем ВСЕ карточки набора БЕЗ фильтрации
                    this.sessionCards = set.cards.map(card => ({ ...card }));
                } else if (this.isPracticeMode) {
                    // В режиме Практика: если пришли из меню Недели - показываем все карточки недели,
                    // если из раздела "Все наборы слов" - показываем только те карточки, которые пользователь пометил как "Учить"
                    if (source === 'week') {
                        this.sessionCards = set.cards.map(card => ({ ...card }));
                    } else {
                        this.sessionCards = set.cards.filter(card => (this.userProgress[card.id] && this.userProgress[card.id].isLearning === true));
                    }
                } else {
                    // Повторение: только карточки, доступные к повторению сегодня (и помеченные как учатся)
                    const today = this.getTodayDateString();
                    this.sessionCards = set.cards.filter(card => {
                        const progress = this.userProgress[card.id];
                        const isVisible = progress && progress.isLearning === true;
                        return isVisible && (!progress || (progress.nextReview && progress.nextReview <= today));
                    });
                }

                // [ИЗМЕНЕНО] Меняем текст кнопок и видимость в зависимости от режима
                const rateNoButton = document.querySelector('#controls-rate button:nth-child(1)');
                const rateYesButton = document.querySelector('#controls-rate button:nth-child(2)');

                if (this.isPracticeAllMode) {
                    // Режим "Практика всех слов": показываем только навигационные кнопки (Назад, Подсказка, Вперед)
                    document.getElementById('controls-show').classList.add('hidden');
                    document.getElementById('controls-rate').classList.add('hidden');
                    document.getElementById('controls-practice-all').classList.remove('hidden');
                } else if (this.isPracticeMode) {
                    // Режим "Практика": Учить (false) / Знаю (true)
                    rateNoButton.innerHTML = 'Учить 🎓';
                    rateYesButton.innerHTML = 'Знаю 👍';
                    document.getElementById('controls-show').classList.add('hidden');
                    document.getElementById('controls-rate').classList.remove('hidden');
                    document.getElementById('controls-practice-all').classList.add('hidden');
                } else {
                    // Режим "Повторение": Не помню (false) / Помню (true)
                    rateNoButton.innerHTML = 'Не помню ❌';
                    rateYesButton.innerHTML = 'Помню ✅';
                    document.getElementById('controls-show').classList.remove('hidden');
                    document.getElementById('controls-rate').classList.add('hidden');
                    document.getElementById('controls-practice-all').classList.add('hidden');
                }

                // [ИЗМЕНЕНО] Состояние для истории (включаем источник)
                const historyState = { renderFunc: 'startSession', param: {setId, mode, source} };

                if (this.sessionCards.length === 0) {
                    this.showScreen('finish-screen', isBack, historyState); // Записываем в историю
                    document.getElementById('finish-screen-text').textContent = this.isPracticeMode 
                        ? 'В этом наборе нет карточек.' 
                        : 'Для этого набора нет карточек к повторению на сегодня!';
                    return;
                }

                this.sessionCards.sort(() => Math.random() - 0.5);
                this.currentCardIndex = 0;

                this.showScreen('study-screen', isBack, historyState); // Записываем в историю
                this.showNextCard();
            },

            showAnswer() {
                document.getElementById('card').classList.add('is-flipped');
                // В режиме Practice кнопки видны сразу и не меняются при перевороте
                // В режиме PracticeAll кнопки видны всегда (навигационные)
                if (!this.isPracticeMode && !this.isPracticeAllMode) {
                    document.getElementById('controls-show').classList.add('hidden');
                    document.getElementById('controls-rate').classList.remove('hidden');
                }

                if (this.currentDirection === 'ru-de') {
                     this.speakGerman(this.sessionCards[this.currentCardIndex].back);
                }
            },
            
            showNextCard() {
                if (this.currentCardIndex >= this.sessionCards.length) {
                    // [ИЗМЕНЕНО] Состояние для истории
                    const historyState = this.navigationHistory[this.navigationHistory.length - 1];
                    this.showScreen('finish-screen', false, historyState); // Переиспользуем состояние, но не пишем в историю
                    document.getElementById('finish-screen-text').textContent = 'Вы прошли все карточки в этой сессии.';
                    return;
                }
                
                const cardEl = document.getElementById('card');
                cardEl.classList.remove('is-flipped', 'slide-in');
                void cardEl.offsetWidth; // Трюк для перезапуска анимации
                cardEl.classList.add('slide-in');

                const totalCards = this.sessionCards.length;
                const percent = ((this.currentCardIndex + 1) / totalCards) * 100;
                document.getElementById('progress-bar').style.width = `${percent}%`;

                // Показ кнопок в зависимости от режима: Practice — сразу две кнопки, PracticeAll — навигационные, Review — кнопка "Показать ответ"
                if (this.isPracticeAllMode) {
                    document.getElementById('controls-show').classList.add('hidden');
                    document.getElementById('controls-rate').classList.add('hidden');
                    document.getElementById('controls-practice-all').classList.remove('hidden');
                } else if (this.isPracticeMode) {
                    document.getElementById('controls-show').classList.add('hidden');
                    document.getElementById('controls-rate').classList.remove('hidden');
                    document.getElementById('controls-practice-all').classList.add('hidden');
                } else {
                    document.getElementById('controls-show').classList.remove('hidden');
                    document.getElementById('controls-rate').classList.add('hidden');
                    document.getElementById('controls-practice-all').classList.add('hidden');
                }

                const card = this.sessionCards[this.currentCardIndex];
                
                const speakerIconSvg = `
                    <svg class="w-6 h-6 text-blue-500 hover:text-blue-700 inline-block ml-2 cursor-pointer" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707A1 1 0 0112 6v12a1 1 0 01-1.707.707L5.586 15z"></path>
                    </svg>
                `;
                
                const germanHtml = `
                    <div class="flex items-center justify-center gap-2">
                        <span>${card.back}</span>
                        <span onclick="window.App.speakGerman('${card.back}', event)">
                            ${speakerIconSvg}
                        </span>
                    </div>
                `;

                if (this.currentDirection === 'ru-de') {
                    document.getElementById('card-front-text').textContent = card.front;
                    document.getElementById('card-back-text').innerHTML = germanHtml;
                } else {
                    document.getElementById('card-front-text').innerHTML = germanHtml;
                    document.getElementById('card-back-text').textContent = card.front;
                    this.speakGerman(card.back);
                }
                
                document.getElementById('hint-button').classList.toggle('hidden', !card.hintImage);
                // Показываем/скрываем кнопку подсказки в режиме practice-all
                document.getElementById('hint-button-practice-all').classList.toggle('hidden', !card.hintImage);
            },
            
async handleAnswer(knewIt) {
                if (this.isAdvancing) return; 
                this.isAdvancing = true;

                // [ИЗМЕНЕНО] Новая логика для Practice Mode, PracticeAll Mode и Review Mode
                const card = this.sessionCards[this.currentCardIndex];
                let progress = this.userProgress[card.id] || { box: 0 };

                // В режиме "Практика всех слов" не меняем userProgress, просто переходим к следующей карточке
                if (this.isPracticeAllMode) {
                    // Практика без изменения статусов
                    document.getElementById('card').classList.add('slide-out');
                    setTimeout(() => {
                        document.getElementById('card').classList.remove('slide-out'); 
                        this.currentCardIndex++; 
                        this.isAdvancing = false; 
                        this.showNextCard(); 
                    }, 400);
                    return;
                }

                if (this.isPracticeMode) {
                    // В режиме "Практика": "Учить" vs "Знаю"
                    if (knewIt) { // "Знаю 👍" - пользователь нажал "Знаю" (knewIt = true)
                        // Пользователь знает слово. Ставим высокий бокс (например, 5 = 30 дней)
                        progress.box = 5;
                        // Если пользователь знает слово — помечаем его как не изучаемое (скрывать в 'Все наборы')
                        progress.isLearning = false;
                    } else { // "Учить 🎓" - пользователь нажал "Учить" (knewIt = false)
                        // Пользователь хочет учить. Ставим бокс 1 (1 день)
                        progress.box = 1;
                        // Пользователь пометил слово для изучения — показываем в 'Все наборы'
                        progress.isLearning = true;
                    }
                } else {
                    // В режиме "Повторение": "Не помню" vs "Помню"
                    if (knewIt) { // "Помню ✅"
                        // Пользователь вспомнил. Продвигаем бокс.
                        progress.box = Math.min(6, (progress.box || 0) + 1);
                    } else { // "Не помню ❌"
                        // Пользователь забыл. Сбрасываем на бокс 1.
                        progress.box = 1;
                    }
                }

                // Общая логика: установить дату след. повторения и сохранить
                // Эта логика теперь выполняется для ОБЕИХ режимов (Практика и Повторение)
                progress.nextReview = this.getFutureDateString(REPETITION_INTERVALS[progress.box]);
                this.userProgress[card.id] = progress;

                if (this.isAuthReady) { 
                    this.saveProgress(); 
                }
                
                document.getElementById('card').classList.add('slide-out');
                setTimeout(() => {
                    document.getElementById('card').classList.remove('slide-out'); 
                    this.currentCardIndex++; 
                    this.isAdvancing = false; 
                    this.showNextCard(); 
                }, 400); 
            },
            
            speakGerman(textToSpeak, event) {
                if (event) {
                    event.stopPropagation(); 
                }
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                    const utterance = new SpeechSynthesisUtterance(textToSpeak);
                    utterance.lang = 'de-DE'; 
                    const voices = window.speechSynthesis.getVoices().filter(v => v.lang.includes('de-'));
                    if (voices.length > 0) {
                        utterance.voice = voices.find(v => v.name.includes('Anna')) || voices.find(v => v.name.includes('Google')) || voices[0];
                    }
                    window.speechSynthesis.speak(utterance);
                }
            },

            // ==================== УТИЛИТЫ ====================

            openModal(modalId) {
                // [ИЗМЕНЕНО] Логика для перемещения плеера
                if (modalId === 'transcript-modal') {
                    const player = document.getElementById('audio-bar');
                    const placeholder = document.getElementById('transcript-audio-player-placeholder');
                    if (player && placeholder) {
                        if (!this.audioPlayerOriginalParent) {
                             this.audioPlayerOriginalParent = player.parentElement; // Кешируем родителя
                        }
                        placeholder.appendChild(player); // Перемещаем плеер в модалку
                        player.classList.remove('fixed-audio-bar'); // Убираем "липкость"
                        
                        // Сбрасываем высоту плейсхолдера на главной странице
                        const mainPlaceholder = document.getElementById('audio-bar-placeholder');
                        if (mainPlaceholder) mainPlaceholder.style.height = '0px';
                    }
                }

                // [ИЗМЕНЕНО] Код StoryApp.openModal() УДАЛЕН, т.к. это разные системы
                const modal = document.getElementById(modalId);
                const modalContent = document.getElementById(`${modalId}-content`) || document.getElementById(`${modalId}-modal-content`);
                
                if (modal) {
                    modal.classList.remove('hidden');
                    setTimeout(() => {
                        modal.classList.add('is-open', 'opacity-100');
                        if (modalContent) modalContent.classList.add('is-open');
                    }, 10);
                }
            },
            
            closeModal(modalId) {
                // [ИЗМЕНЕНО] Логика для возврата плеера
                if (modalId === 'transcript-modal') {
                    const player = document.getElementById('audio-bar');
                    // Получаем родителя из кеша (или по ID, если кеш пуст)
                    const originalParent = this.audioPlayerOriginalParent || document.getElementById('audio-bar-wrapper'); 
                    if (player && originalParent) {
                        originalParent.prepend(player); // Возвращаем плеер в начало его контейнера
                    }
                }

                // [НОВОЕ] Очистка мантра-сессии при закрытии модала
                if (modalId === 'mantra-modal') {
                    this.mantraCards = [];
                    this.currentMantraIndex = 0;
                    this.mantraKnownCount = 0;
                    this.mantraUnknownCount = 0;
                    this.mantraSeen = [];
                }

                // [ИЗМЕНЕНО] Код StoryApp.closeModal() УДАЛЕН
                const modal = document.getElementById(modalId);
                const modalContent = document.getElementById(`${modalId}-content`) || document.getElementById(`${modalId}-modal-content`);
                
                if (modal) {
                    modal.classList.remove('is-open', 'opacity-100');
                    if (modalContent) modalContent.classList.remove('is-open');
                    setTimeout(() => modal.classList.add('hidden'), 300);
                }
            },

            // [ИЗМЕНЕНО] closeDirectionModal теперь тоже использует App.closeModal
            closeDirectionModal() {
                this.closeModal('direction-modal');
            },
            
            showHint() {
                const card = this.sessionCards[this.currentCardIndex];
                if (!card || !card.hintImage) return;
                document.getElementById('hint-image').src = card.hintImage; 
                this.openModal('hint-modal');
            },

            // ========== Методы для экрана "Все наборы" (переключения без изменения isLearning) ==========
            allSetsRemember(cardId) {
                const entry = this.findCardById(cardId);
                if (!entry) return;
                let progress = this.userProgress[cardId] || { box: 0 };
                progress.box = Math.min(6, (progress.box || 0) + 1);
                progress.nextReview = this.getFutureDateString(REPETITION_INTERVALS[progress.box]);
                // Не меняем isLearning
                this.userProgress[cardId] = progress;
                if (this.isAuthReady) this.saveProgress();
                this.renderAllSetsScreen(true);
            },

            allSetsForgot(cardId) {
                const entry = this.findCardById(cardId);
                if (!entry) return;
                let progress = this.userProgress[cardId] || { box: 0 };
                progress.box = 1;
                progress.nextReview = this.getFutureDateString(REPETITION_INTERVALS[progress.box]);
                // Не меняем isLearning
                this.userProgress[cardId] = progress;
                if (this.isAuthReady) this.saveProgress();
                this.renderAllSetsScreen(true);
            },

            showHintForAllSet(cardId) {
                const entry = this.findCardById(cardId);
                if (!entry) return;
                const card = entry.card;
                if (card && card.hintImage) {
                    document.getElementById('hint-image').src = card.hintImage;
                } else {
                    document.getElementById('hint-image').src = 'https://placehold.co/400x150/FCA5A5/FFFFFF?text=Нет+Изображения';
                }
                this.openModal('hint-modal');
            },

            // Навигация для режима "Практика всех слов"
            prevCard() {
                if (this.currentCardIndex > 0) {
                    document.getElementById('card').classList.add('slide-out');
                    setTimeout(() => {
                        document.getElementById('card').classList.remove('slide-out');
                        this.currentCardIndex--;
                        this.isAdvancing = false;
                        this.showNextCard();
                    }, 400);
                }
            },

            nextCard() {
                if (this.currentCardIndex < this.sessionCards.length - 1) {
                    document.getElementById('card').classList.add('slide-out');
                    setTimeout(() => {
                        document.getElementById('card').classList.remove('slide-out');
                        this.currentCardIndex++;
                        this.isAdvancing = false;
                        this.showNextCard();
                    }, 400);
                } else {
                    // Если это последняя карточка, переходим на экран завершения
                    const historyState = this.navigationHistory[this.navigationHistory.length - 1];
                    this.showScreen('finish-screen', false, historyState);
                    document.getElementById('finish-screen-text').textContent = 'Вы прошли все карточки в этой сессии.';
                }
            },

            // Вспомогательная функция: найти карточку по id и вернуть {set, card}
            findCardById(cardId) {
                for (let s of WORD_SETS) {
                    for (let c of s.cards) {
                        if (c.id === cardId) return { set: s, card: c };
                    }
                }
                return null;
            },

            /**
             * [ГЛАВНАЯ ФУНКЦИЯ ОТОБРАЖЕНИЯ]
             * @param {string} screenId - ID экрана для показа
             * @param {boolean} isBackNavigation - true, если это возврат (не пишем в историю)
             * @param {object} historyState - { renderFunc, param } для записи в историю
             * @param {boolean} clearStack - true, если нужно очистить всю историю (напр. "Домой")
             */
            showScreen(screenId, isBackNavigation = false, historyState = null, clearStack = false) {
                
                // [НОВОЕ ИСПРАВЛЕНИЕ №2]
                // Если мы уходим с экрана истории, ставим аудио на паузу.
                if (this.currentScreenId === 'content-viewer-screen' && screenId !== 'content-viewer-screen') {
                    const audio = document.getElementById('story-audio-player');
                    if (audio && !audio.paused) {
                        audio.pause();
                        // Обновляем UI кнопки (Play/Pause), чтобы при возврате
                        // она была в правильном состоянии
                        window.StoryApp.updateAudioUi(false);
                    }
                }
                
                // 1. Логика истории навигации
                if (clearStack) {
                    this.navigationHistory = [];
                }
                if (!isBackNavigation && historyState) {
                    this.navigationHistory.push(historyState);
                }
                // На home-screen всегда сбрасываем историю до одного элемента
                if (screenId === 'home-screen' && historyState) {
                     this.navigationHistory = [historyState];
                }

                // 2. Логика отображения Экрана
                this.currentScreenId = screenId;
                ['loading-screen', 'home-screen', 'list-screen', 'study-screen', 'finish-screen', 'video-content-screen', 'external-link-screen', 'content-viewer-screen', 'carousel-list-screen', 'image-carousel-screen'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.classList.add('hidden');
                });
                const screen = document.getElementById(screenId);
                if (screen) {
                    screen.classList.remove('hidden');
                }

                // 3. Логика кнопок Telegram
                if (!this.tg) return; // Безопасность, если tg еще не готов
                
                if (screenId === 'home-screen') {
                    // Главный экран: Показываем "Schließen", прячем "Zurück"
                    this.tg.BackButton.hide();
                    this.tg.MainButton.setText('Schließen'); // "Закрыть"
                    this.tg.MainButton.onClick(() => this.tg.close());
                    this.tg.MainButton.show();
                } else {
                    // Любой другой экран: Показываем "Zurück", прячем "Schließen"
                    this.tg.BackButton.show();
                    this.tg.MainButton.hide();
                }
            },
            
            showError(message) {
                this.showScreen('loading-screen'); // Показываем на экране загрузки
                document.getElementById('loading-screen').innerHTML = `<p class="text-red-500 font-semibold">${message}</p>`;
            },
            
            getTodayDateString() {
                return new Date().toISOString().split('T')[0];
            },

            getFutureDateString(daysToAdd) {
                const date = new Date();
                date.setDate(date.getDate() + daysToAdd);
                return date.toISOString().split('T')[0];
            }
        };
        
        // ==========================================================
        // 3. ЗАПУСК ПРИЛОЖЕНИЯ (Conceptual Bootstrap)
        // ==========================================================

        window.addEventListener('load', () => {
            // Предзагрузка голосов для синтеза речи
            if ('speechSynthesis' in window) {
                window.speechSynthesis.getVoices(); 
                if (window.speechSynthesis.onvoiceschanged !== undefined) {
                    window.speechSynthesis.onvoiceschanged = () => window.speechSynthesis.getVoices();
                }
            }
            // Запускаем приложение
            window.App.init();
        });

    </script>
    
</body>
</html>
