<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–ò–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω–æ–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º API Telegram -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        /* –°—Ç–∏–ª–∏ –∏–∑ index.html */
        .card { perspective: 1000px; }
        .card-inner {
            position: relative;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .card.is-flipped .card-inner {
            transform: rotateY(180deg);
        }
        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            top: 0; left: 0;
        }
        .card-back {
            transform: rotateY(180deg);
        }
        
        @keyframes slide-left {
            0% { transform: translateX(0); opacity: 1; }
            100% { transform: translateX(-100%); opacity: 0; }
        }
        @keyframes slide-in-right {
            0% { transform: translateX(100%); opacity: 0; }
            100% { transform: translateX(0); opacity: 1; }
        }

        .card.slide-out {
            animation: slide-left 0.4s ease forwards;
        }
        .card.slide-in {
            animation: slide-in-right 0.4s ease;
        }

        .modal {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
            transform: scale(0.95);
        }
        .modal.is-open {
            opacity: 1;
        }
        .modal.is-open .modal-content {
            transform: scale(1);
        }

        .button-locked {
            background-color: #e5e7eb; /* gray-200 */
            color: #6b7280; /* gray-500 */
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        .promo-button {
            background: linear-gradient(to right, #F97316, #FBBF24); /* Orange/Amber */
            color: white;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .promo-button:hover {
            box-shadow: 0 10px 15px -3px rgba(249, 115, 22, 0.5), 0 4px 6px -2px rgba(249, 115, 22, 0.2);
            transform: translateY(-2px);
        }
        
        .active-week-button {
            background: linear-gradient(to right, #3B82F6, #2563EB); /* Blue */
            color: white;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .active-week-button:hover {
            box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.5), 0 4px 6px -2px rgba(59, 130, 246, 0.2);
            transform: translateY(-2px);
        }

        .video-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
            height: 0;
            overflow: hidden;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        .carousel-card {
            min-height: 250px;
        }

        /* –°—Ç–∏–ª–∏ –∏–∑ text1.html (–¥–æ–±–∞–≤–ª–µ–Ω—ã —Å—é–¥–∞, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç–æ–≤) */
        .quiz-option { transition: all 0.15s ease; outline: none; }
        .quiz-option:hover { transform: translateY(-2px); box-shadow: 0 6px 10px -2px rgba(0,0,0,0.1); }
        .quiz-selected {
          background-color:#A5B4FC!important;
          color:#1E3A8A!important;
          border-color:#6366F1!important;
          box-shadow:0 4px 6px -1px rgba(99,102,241,0.3)!important;
        }
        .next-button-disabled {
          background-color:#D1D5DB!important;
          color:#6B7280!important;
          cursor:not-allowed;
          box-shadow:none!important;
        }
        .next-button-active {
          background:linear-gradient(to right,#4F46E5,#6366F1)!important;
          color:#fff!important;
          box-shadow:0 4px 10px -2px rgba(79,70,229,0.5);
          transition:all 0.2s ease;
        }
        .next-button-active:hover { opacity:.9; transform:translateY(-1px); }
        #question-box { border-left:5px solid #6366F1; }

        .story-visual-container img {
          width:100%;
          height:auto;
          display:block;
        }

        #audio-bar.fixed-audio-bar {
            position: fixed;
            top: env(safe-area-inset-top, 0px);
            left: 0;
            right: 0;
            z-index: 999;
            background: rgba(243, 244, 246, 0.97);
            backdrop-filter: blur(6px);
            padding-top: 0.5rem;
            padding-bottom: 0.75rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        #audio-bar.fixed-audio-bar {
            width: 100% !important;
            left: 0 !important;
            right: 0 !important;
            padding: 0.5rem 1rem !important;
            box-sizing: border-box;
        }

        #audio-bar.fixed-audio-bar > div {
            max-width: none !important;
            width: 100% !important;
            margin: 0 auto;
        }
        #audio-bar-placeholder.fixed-visible {
            height: 120px;
        }

        .audio-main-button {
          transition: transform 0.15s ease, box-shadow 0.15s ease, opacity 0.15s ease;
        }
        .audio-main-button:hover {
          transform: translateY(-1px);
          box-shadow: 0 8px 18px rgba(37,99,235,0.55);
          opacity:.95;
        }

        input[type="range"] { width:100%; cursor:pointer; }

        .accordion-content {
          max-height:0;
          overflow:hidden;
          transition:max-height 0.4s ease-in-out,opacity 0.4s ease-in-out;
          opacity:0;
          visibility:hidden;
        }
        .accordion-content.is-open {
          max-height:90vh;
          opacity:1;
          visibility:visible;
          overflow-y:auto;
        }
    </style>
</head>

<body class="min-h-screen bg-gray-100 font-sans p-4 pb-28">

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
    <div id="app" class="max-w-xl mx-auto">
        
        <!-- 1. –≠–∫—Ä–∞–Ω –ó–∞–≥—Ä—É–∑–∫–∏ (–≤–∏–¥–µ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
        <div id="loading-screen" class="text-center py-20">
            <p class="text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
        </div>

        <!-- 2. –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ (Home Screen) -->
        <div id="home-screen" class="hidden">
            <h1 class="text-2xl font-bold text-center mb-8 text-gray-800">–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</h1>
            <div class="space-y-4">

                <!-- –î–ò–ù–ê–ú–ò–ß–ï–°–ö–ò–ô –ë–õ–û–ö: –ü—Ä–æ–±–Ω—ã–π —É—Ä–æ–∫ –ò–õ–ò –ê–∫—Ç–∏–≤–Ω–∞—è –Ω–µ–¥–µ–ª—è/–£—Ä–æ–∫–∏ –ø–æ –Ω–µ–¥–µ–ª—è–º -->
                <div id="main-content-block">
                    <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JS (–≤–∫–ª—é—á–∞–µ—Ç –ü—Ä–æ–±–Ω—ã–π, –ü–æ–¥–±–æ—Ä–∫–∏ –∑–∞ –Ω–µ–¥–µ–ª—é –∏ –í—Å–µ –Ω–∞–±–æ—Ä—ã —Å–ª–æ–≤) -->
                    <!-- –ü—Ä–∏–º–µ—Ä –∫–Ω–æ–ø–∫–∏ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –∏—Å—Ç–æ—Ä–∏–∏ -->
                    <button class="active-week-button w-full py-3 px-4 rounded-lg" onclick="window.App.openStoryWeek(1, '–ò—Å—Ç–æ—Ä–∏—è –Ω–µ–¥–µ–ª–∏ 1 ‚Äî Arzttermin')">
                        –ò—Å—Ç–æ—Ä–∏—è –Ω–µ–¥–µ–ª–∏ 1 ‚Äî Arzttermin
                    </button>
                </div>
                
                <!-- –ù–û–í–ê–Ø –°–ï–ö–¶–ò–Ø: –ì–æ—Ä—è—â–∏–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è -->
                <div id="due-today-section" class="hidden pt-6 mt-4 border-t border-gray-200">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <span>üî• –ö –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—é —Å–µ–≥–æ–¥–Ω—è</span>
                    </h2>
                    <div id="due-today-list" class="space-y-3">
                        <!-- –°—é–¥–∞ JS –¥–æ–±–∞–≤–∏—Ç –≥–æ—Ä—è—â–∏–µ —Å–µ—Ç—ã -->
                    </div>
                </div>

            </div>
        </div>

        <!-- –î—Ä—É–≥–∏–µ —ç–∫—Ä–∞–Ω—ã –∏–∑ index.html (study-screen, finish-screen –∏ —Ç.–¥.) –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π -->
         <!-- –≠–∫—Ä–∞–Ω –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏—è (Study Screen) -->
        <div id="study-screen" class="hidden">
            <!-- –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" –£–î–ê–õ–ï–ù–ê. -->
            <div id="study-back-button-container" class="mt-4"></div>
            <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä -->
            <div class="bg-gray-200 rounded-full h-2.5 mb-4">
                <div id="progress-bar" class="bg-blue-500 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
            
            <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ -->
            <div id="card" class="card h-64 w-full mb-4">
                <div id="card-inner" class="card-inner h-full w-full" onclick="window.App.showAnswer()">
                    <!-- –ü–µ—Ä–µ–¥–Ω—è—è —Å—Ç–æ—Ä–æ–Ω–∞ -->
                    <div id="card-front" class="card-front flex items-center justify-center p-6 bg-white rounded-xl shadow-lg text-center">
                        <div id="card-front-text" class="text-2xl font-semibold"></div>
                    </div>
                    <!-- –ó–∞–¥–Ω—è—è —Å—Ç–æ—Ä–æ–Ω–∞ -->
                    <div id="card-back" class="card-back flex items-center justify-center p-6 bg-blue-100 rounded-xl shadow-lg text-center">
                        <div id="card-back-text" class="text-2xl font-semibold"></div>
                    </div>
                </div>
            </div>

        </div>
        <!-- 10. –≠–∫—Ä–∞–Ω –ó–∞–≤–µ—Ä—à–µ–Ω–∏—è (Finish Screen) -->
         <div id="finish-screen" class="hidden text-center py-20">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</h2>
            <p id="finish-screen-text" class="text-gray-600 mb-6">–í—ã –ø—Ä–æ—à–ª–∏ –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏.</p>
            <!-- –ò–ó–ú–ï–ù–ï–ù–û: –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä clearStack=true -->
            <button onclick="window.App.renderHomeScreen(false, true)" class="py-3 px-6 bg-blue-500 text-white font-bold rounded-xl shadow-md hover:bg-blue-600">
                –í –º–µ–Ω—é
            </button>
        </div>

    </div>
        <!-- –ù–æ–≤—ã–π —ç–∫—Ä–∞–Ω –¥–ª—è –ò—Å—Ç–æ—Ä–∏–π –Ω–µ–¥–µ–ª–∏ -->
        <div id="story-week-screen" class="hidden">
            <div id="story-content"></div> <!-- –ó–¥–µ—Å—å –±—É–¥–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç –∏—Å—Ç–æ—Ä–∏–∏ -->
        </div>

    </div>

    <!-- JS –∏–∑ index.html + –Ω–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è -->
    <script>
        window.App = {
            // ... –≤–µ—Å—å –∫–æ–¥ –∏–∑ —Ç–≤–æ–µ–≥–æ index.html (init, showScreen, handleTelegramBackClick –∏ —Ç.–¥.) ...

            openStoryWeek(weekNumber, title) {
                const storyContent = document.getElementById('story-content');
                storyContent.innerHTML = '';

                const stories = {
                    1: `
                        <div class="p-4 space-y-6">
                            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –∏–∑ text1.html -->
                            <div class="story-visual-container rounded-xl shadow-xl overflow-hidden">
                                <img src="Woche1_text.png" alt="–ò–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—è –∫ –∏—Å—Ç–æ—Ä–∏–∏" onclick="event.preventDefault();event.stopPropagation();">
                                <audio id="story-audio-player" src="Woche1_text.mp3"></audio>
                            </div>

                            <h1 class="text-2xl font-bold text-center text-gray-900">Der Termin beim Arzt</h1>

                            <!-- –ê—É–¥–∏–æ-–±–∞—Ä -->
                            <div id="audio-bar-wrapper">
                                <div id="audio-bar">
                                    <div class="max-w-md mx-auto">
                                        <div class="bg-white rounded-2xl px-4 py-3 shadow-lg border border-gray-200 flex flex-col gap-2">
                                            <!-- ... –≤–µ—Å—å HTML –∞—É–¥–∏–æ-–±–∞—Ä–∞, –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–æ–≤, –∫–≤–∏–∑–∞ –∏–∑ text1.html ... -->
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- –ê–∫–∫–æ—Ä–¥–µ–æ–Ω—ã, –∫–≤–∏–∑ –∏ –æ—Å—Ç–∞–ª—å–Ω–æ–µ –∏–∑ text1.html -->

                            <!-- –°–∫—Ä–∏–ø—Ç StoryApp –≤ –∫–æ–Ω—Ü–µ -->
                            <script>
                                window.StoryApp = {
                                    // ... –≤–µ—Å—å JS –∏–∑ text1.html (init, playAudio, toggleAccordion, –∫–≤–∏–∑ –∏ —Ç.–¥.) ...
                                };
                                window.StoryApp.init();
                            <\/script>
                        </div>
                    `
                    // –î–æ–±–∞–≤—å –¥—Ä—É–≥–∏–µ –Ω–µ–¥–µ–ª–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ
                };

                storyContent.innerHTML = stories[weekNumber] || '<p class="text-red-500">–ò—Å—Ç–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</p>';

                this.showScreen('story-week-screen', false, { renderFunc: 'openStoryWeek', param: {weekNumber, title} });
            },

            db: null,
            auth: null, 
            userId: null,
            isAuthReady: false, 
            userProgress: {}, 
            
            // –ü–û–õ–Ø –î–õ–Ø –ü–û–î–ü–ò–°–ö–ò –ò –ê–ö–¢–ò–í–ê–¶–ò–ò
            isSubscriber: false, 
            activationDate: null, 
            selectedWeek: 0, 
            
            unlockedWeek: 1, 
            sessionCards: [], 
            currentCardIndex: 0,
            isPracticeMode: false,
            isAdvancing: false,
            currentDirection: 'ru-de', 
            tempSetId: null, 
            tempMode: null,
            currentScreenId: 'loading-screen', 
            
            // –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
            currentWeekFilter: 'All', 
            currentThemeFilter: 'All', 
            
            // --- –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê –ù–ê–í–ò–ì–ê–¶–ò–ò ---
            tg: null, // –û–±—ä–µ–∫—Ç Telegram Web App
            navigationHistory: [], // –°—Ç–µ–∫ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏
            // { renderFunc: 'renderHomeScreen', param: null }
            // { renderFunc: 'renderWeekContent', param: 1 }
            // { renderFunc: 'renderVideoContentScreen', param: { title: '...', videoUrl: '...' } }
            // -------------------------------

            // –î–∞–Ω–Ω—ã–µ –∫–∞—Ä—É—Å–µ–ª–∏
            carouselSetsMetadata: [],
            carouselCards: [],
            currentCarouselIndex: 0,
            
            /**
             * –í–ê–ñ–ù–û: –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø—É—Ç—å –∫ –¥–æ–∫—É–º–µ–Ω—Ç—É –≤ Firestore, –∏—Å–ø–æ–ª—å–∑—É—è –í–ê–®–£ –ö–û–õ–õ–ï–ö–¶–ò–Æ –ò ID
             */
            getUserDocRef() {
                 if (!this.db || !this.userId) return null;
                 // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –í–ê–®–ï–ô –ö–û–õ–õ–ï–ö–¶–ò–ò (MY_COLLECTION_NAME) –∏ Telegram ID (this.userId)
                 return doc(this.db, MY_COLLECTION_NAME, this.userId);
            },


            // [–ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø] –¥–ª—è (–ø–µ—Ä–µ)—É—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ Telegram
            setupTelegramHandlers() {
                if (!this.tg) {
                    this.tg = window.Telegram.WebApp;
                    this.tg.ready(); 
                }
                // (–ü–µ—Ä–µ)–Ω–∞–∑–Ω–∞—á–∞–µ–º –Ω–∞—à –≥–ª–∞–≤–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ "–ù–∞–∑–∞–¥"
                this.tg.BackButton.onClick(() => this.handleTelegramBackClick());
            },

            async init() {
                try {
                    // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø TELEGRAM API ---
                    // –î–µ–ª–∞–µ–º —ç—Ç–æ *–ø–µ—Ä–≤—ã–º*, —á—Ç–æ–±—ã API –±—ã–ª–æ –¥–æ—Å—Ç—É–ø–Ω–æ
                    // [–ò–ó–ú–ï–ù–ï–ù–û] –í—ã–∑—ã–≤–∞–µ–º –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é
                    this.setupTelegramHandlers();
                    // ------------------------------------

                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
                    if (Object.keys(firebaseConfig).length > 0 && firebaseConfig.apiKey !== "YOUR_FIREBASE_CONFIG_HERE") {
                        const app = initializeApp(firebaseConfig);
                        this.db = getFirestore(app);
                        this.userId = MY_USER_ID_SOURCE;
                        this.isAuthReady = true;
                    } else {
                         console.error("Firebase configuration not found or not set. Progress will not be saved.");
                         this.isAuthReady = false;
                         this.userId = MY_USER_ID_SOURCE; 
                    }

                    this.disableZoom();
                    await this.loadCarouselMetadata(); 

                    if (this.isAuthReady) {
                        await this.loadProgress();
                    } else {
                        // –í –ª–æ–∫–∞–ª—å–Ω–æ–º —Ä–µ–∂–∏–º–µ
                        this.isSubscriber = false; 
                        this.selectedWeek = 0; 
                        this.unlockedWeek = this.getMaxAvailableWeek(); 
                        this.renderHomeScreen(); // <-- –ü–µ—Ä–≤—ã–π –≤—ã–∑–æ–≤, –∫–æ—Ç–æ—Ä—ã–π –∑–∞–ø—É—Å—Ç–∏—Ç showScreen
                    }

                } catch (error) {
                    this.showError(`–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏/–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏: ${error.message}`);
                    console.error(error);
                }
            },
            
            disableZoom() {
                document.addEventListener('touchstart', (event) => {
                    if (event.touches.length > 1) {
                        event.preventDefault();
                    }
                }, { passive: false });

                let lastTouchEnd = 0;
                document.addEventListener('touchend', function (event) {
                    const now = (new Date()).getTime();
                    if (now - lastTouchEnd <= 300) {
                        event.preventDefault();
                    }
                    lastTouchEnd = now;
                }, false);
            },


            async loadProgress() {
                this.showScreen('loading-screen'); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
                if (!this.isAuthReady) return; 

                try {
                    const docRef = this.getUserDocRef();
                    if (!docRef) {
                        console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç Firestore.");
                        return;
                    }
                    const docSnap = await getDoc(docRef);

                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        this.userProgress = data.cards || {};
                        this.isSubscriber = data.isSubscriber || false;
                        this.activationDate = data.activationDate; 
                        this.selectedWeek = data.selectedWeek || 0; 
                        this.unlockedWeek = this.getMaxAvailableWeek(); 
                    } else {
                        // –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                        this.userProgress = {};
                        this.isSubscriber = false;
                        this.selectedWeek = 0; 
                        this.unlockedWeek = 1; 
                        await this.saveProgress(); 
                    }
                } catch (error) {
                    console.error("Error loading progress:", error);
                } finally {
                    this.renderHomeScreen(); // <-- –ü–µ—Ä–≤—ã–π —Ä–µ–Ω–¥–µ—Ä –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
                }
            },
            
            async saveProgress() {
                if (!this.isAuthReady) return; 
                try {
                    const docRef = this.getUserDocRef();
                    if (!docRef) {
                        console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç Firestore.");
                        return;
                    }
                    await setDoc(docRef, { 
                        cards: this.userProgress,
                        isSubscriber: this.isSubscriber,
                        activationDate: this.activationDate,
                        selectedWeek: this.selectedWeek
                    }, { merge: true });
                    console.log('–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ Firebase');
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:', error);
                }
            },

            getMaxAvailableWeek() {
                if (!this.isSubscriber || !this.activationDate) {
                    return 1; 
                }
                const activationTime = new Date(this.activationDate).getTime();
                const currentTime = new Date().getTime();
                const daysDiff = Math.floor((currentTime - activationTime) / (1000 * 60 * 60 * 24));
                let maxWeek = Math.floor(daysDiff / 7) + 1;
                return Math.min(ALL_WEEKS.length, Math.max(1, maxWeek));
            },
            
            async activateSubscription() {
                if (this.isSubscriber) return; 
                this.isSubscriber = true;
                this.activationDate = this.getTodayDateString();
                this.selectedWeek = 1; 
                this.unlockedWeek = this.getMaxAvailableWeek(); 
                await this.saveProgress();
                this.renderHomeScreen(false, true); // –†–µ–Ω–¥–µ—Ä–∏–º —Å –æ—á–∏—Å—Ç–∫–æ–π —Å—Ç–µ–∫–∞
            },

            // ==================== –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê –ù–ê–í–ò–ì–ê–¶–ò–ò ====================

            /**
             * [–ù–û–í–´–ô] –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ "Zur√ºck" –≤ —Ö–µ–¥–µ—Ä–µ Telegram.
             */
            handleTelegramBackClick() {
                // –í —Å—Ç–µ–∫–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–Ω—å—à–µ 2 —ç–∫—Ä–∞–Ω–æ–≤ (home + —Ç–µ–∫—É—â–∏–π)
                if (this.navigationHistory.length < 2) {
                    // –≠—Ç–æ–≥–æ –Ω–µ –¥–æ–ª–∂–Ω–æ —Å–ª—É—á–∏—Ç—å—Å—è, —Ç–∞–∫ –∫–∞–∫ –∫–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å–∫—Ä—ã—Ç–∞ –Ω–∞ home-screen
                    return; 
                }
                
                // 1. –£–¥–∞–ª—è–µ–º *—Ç–µ–∫—É—â–∏–π* —ç–∫—Ä–∞–Ω –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
                this.navigationHistory.pop();
                
                // 2. –ü–æ–ª—É—á–∞–µ–º *–ø—Ä–µ–¥—ã–¥—É—â–µ–µ* —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                const prevState = this.navigationHistory[this.navigationHistory.length - 1];
                
                // 3. –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                // true = "—ç—Ç–æ –Ω–∞–≤–∏–≥–∞—Ü–∏—è –Ω–∞–∑–∞–¥", –Ω–µ –Ω—É–∂–Ω–æ —Å–Ω–æ–≤–∞ –ø—É—à–∏—Ç—å –≤ –∏—Å—Ç–æ—Ä–∏—é
                this.reRenderState(prevState, true);
            },

            /**
             * [–ù–û–í–´–ô] "–†–æ—É—Ç–µ—Ä", –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ—Ç —ç–∫—Ä–∞–Ω –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ –∏—Å—Ç–æ—Ä–∏–∏.
             */
            reRenderState(state, isBackNavigation = false) {
                if (!state) {
                    this.renderHomeScreen(isBackNavigation); // –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç
                    return;
                }

                const { renderFunc, param } = state;
                
                // –í—ã–∑—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
                switch (renderFunc) {
                    case 'renderHomeScreen':
                        this.renderHomeScreen(isBackNavigation);
                        break;
                    case 'renderWeeklySelections':
                        this.renderWeeklySelections(isBackNavigation);
                        break;
                    case 'renderWeekContent':
                        this.renderWeekContent(param, isBackNavigation);
                        break;
                    case 'renderAllSetsScreen':
                        this.renderAllSetsScreen(isBackNavigation);
                        break;
                    case 'renderVideoContentScreen':
                        this.renderVideoContentScreen(param.title, param.videoUrl, param.textContent, isBackNavigation);
                        break;
                    case 'renderExternalLinkScreen':
                        this.renderExternalLinkScreen(param.title, param.url, isBackNavigation);
                        break;
                    case 'renderStoryScreen':
                        this.renderStoryScreen(param.title, param.url, isBackNavigation);
                        break;
                    case 'renderCarouselListScreen':
                        this.renderCarouselListScreen(isBackNavigation);
                        break;
                    case 'startCarouselSession':
                        this.startCarouselSession(param.setId, param.setTitle, param.filepath, isBackNavigation);
                        break;
                    case 'startSession':
                        this.startSession(param.setId, param.mode, isBackNavigation);
                        break;
                    default:
                        this.renderHomeScreen(isBackNavigation); // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
                }
            },


            // ==================== –†–ï–ù–î–ï–†–ò–ù–ì –≠–ö–†–ê–ù–û–í (–ò–ó–ú–ï–ù–ï–ù–û) ====================

            // isBack - —Ñ–ª–∞–≥, —á—Ç–æ –º—ã –ø—Ä–∏—à–ª–∏ —Å—é–¥–∞ –ø–æ –∫–Ω–æ–ø–∫–µ "–ù–∞–∑–∞–¥"
            // clearStack - —Ñ–ª–∞–≥, —á—Ç–æ –Ω—É–∂–Ω–æ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é (–Ω–∞–ø—Ä. –ø—Ä–∏ –∫–ª–∏–∫–µ "–î–æ–º–æ–π" –≤ —Ñ—É—Ç–µ—Ä–µ)
            renderHomeScreen(isBack = false, clearStack = false) {
                this.renderDueTodaySection();
                
                const mainBlock = document.getElementById('main-content-block');
                mainBlock.innerHTML = '';
                
                if (!this.isSubscriber && this.selectedWeek === 0) { 
                    mainBlock.innerHTML += `
                        <button onclick="window.App.renderWeekContent(1)" class="promo-button w-full py-4 px-5 rounded-xl shadow-lg text-left text-lg font-bold flex justify-between items-center transition duration-150">
                            <span>üöÄ –ü—Ä–æ–±–Ω—ã–π —É—Ä–æ–∫</span>
                            <span>–ù–∞—á–∞—Ç—å &rarr;</span>
                        </button>
                    `;
                } else {
                    const activeWeek = this.selectedWeek;
                    const weekTitle = activeWeek === 1 && !this.isSubscriber 
                                    ? '–ü—Ä–æ–±–Ω—ã–π —É—Ä–æ–∫ (–ù–µ–¥–µ–ª—è 1)' 
                                    : `–ù–µ–¥–µ–ª—è ${activeWeek}`;
                    
                    if (activeWeek >= 1 && activeWeek <= ALL_WEEKS.length) {
                        mainBlock.innerHTML += `
                            <button onclick="window.App.renderWeekContent(${activeWeek})" class="active-week-button w-full py-4 px-5 rounded-xl shadow-lg text-left text-lg font-bold flex justify-between items-center transition duration-150">
                                <span>üìÖ –ê–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–±–æ—Ä–∫–∞: ${weekTitle}</span>
                                <span>–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å &rarr;</span>
                            </button>
                        `;
                    }
                }
                
                mainBlock.innerHTML += `
                    <button onclick="window.App.renderWeeklySelections()" class="w-full py-4 px-5 bg-white rounded-xl shadow-lg text-left text-lg font-semibold text-gray-800 hover:bg-gray-50 flex justify-between items-center transition duration-150 mt-4 border border-gray-200">
                        <span>üìö –ü–æ–¥–±–æ—Ä–∫–∏ –∑–∞ –Ω–µ–¥–µ–ª—é</span>
                        <span>&rarr;</span>
                    </button>
                `;

                mainBlock.innerHTML += `
                    <button onclick="window.App.renderAllSetsScreen()" class="w-full py-4 px-5 bg-white rounded-xl shadow-lg text-left text-lg font-semibold text-gray-800 hover:bg-gray-50 flex justify-between items-center transition duration-150 mt-4">
                        <span>üìö –í—Å–µ –Ω–∞–±–æ—Ä—ã —Å–ª–æ–≤</span>
                        <span>&rarr;</span>
                    </button>
                `;
                
                this.renderDueTodaySection();
                
                // [–ò–ó–ú–ï–ù–ï–ù–û] –í—ã–∑—ã–≤–∞–µ–º showScreen —Å —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
                this.showScreen('home-screen', isBack, { renderFunc: 'renderHomeScreen', param: null }, clearStack);
            },
            
            renderDueTodaySection() {
                const section = document.getElementById('due-today-section');
                const list = document.getElementById('due-today-list');
                if (!section || !list) return;

                const today = this.getTodayDateString();
                let dueSetsCount = 0;
                list.innerHTML = '';

                WORD_SETS.forEach(set => {
                    if (this.isSubscriber && set.week > this.unlockedWeek) return;
                    if (!this.isSubscriber && set.week > 1) return;

                    let dueCount = 0;
                    set.cards.forEach(card => {
                        const progress = this.userProgress[card.id];
                        if (!progress || (progress.nextReview && progress.nextReview <= today)) {
                            dueCount++;
                        }
                    });

                    if (dueCount > 0) {
                        dueSetsCount++;
                        const setEl = document.createElement('div');
                        setEl.className = "bg-white p-4 rounded-xl shadow-md border-l-4 border-orange-500 flex justify-between items-center transform transition hover:-translate-y-1";
                        setEl.innerHTML = `
                            <div>
                                <span class="font-bold text-gray-800">${set.name}</span>
                                <span class="text-sm text-orange-600 font-medium block">–î–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è: ${dueCount}</span>
                            </div>
                            <button onclick="window.App.promptForDirection('${set.id}', 'review')"
                                    class="py-2 px-4 bg-orange-100 text-orange-700 font-bold rounded-xl hover:bg-orange-200 transition duration-150 flex items-center">
                                –ù–∞—á–∞—Ç—å
                                <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            </button>
                        `;
                        list.appendChild(setEl);
                    }
                });

                if (dueSetsCount > 0) {
                    section.classList.remove('hidden');
                } else {
                    section.classList.add('hidden');
                }
            },

            renderWeeklySelections(isBack = false) {
                // [–ò–ó–ú–ï–ù–ï–ù–û] –£–±—Ä–∞–Ω—ã this.returnContext –∏ this.renderBackButton
                document.getElementById('list-title').innerText = 'üìö –ü–æ–¥–±–æ—Ä–∫–∏ –∑–∞ –Ω–µ–¥–µ–ª—é';
                document.getElementById('filter-controls').innerHTML = '';

                const contentListDiv = document.getElementById('content-list');
                contentListDiv.innerHTML = '';
                this.unlockedWeek = this.getMaxAvailableWeek(); 

                ALL_WEEKS.forEach(i => {
                    const isSubscriber = this.isSubscriber;
                    const maxAvailableWeek = this.unlockedWeek;
                    const isCurrentSelected = i === this.selectedWeek; 
                    const isAvailable = isSubscriber ? (i <= maxAvailableWeek) : (i === 1); 
                    const weekData = WEEKLY_CONTENT_MAP[i];
                    
                    let statusText = '–î–æ—Å—Ç—É–ø–Ω–æ';
                    let buttonClass = 'bg-white hover:bg-gray-50';

                    if (!isAvailable) {
                        buttonClass = 'button-locked';
                        if (!isSubscriber) {
                            statusText = 'üîí –û—Ñ–æ—Ä–º–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É';
                        } else {
                            const activationTime = new Date(this.activationDate).getTime();
                            const currentTime = new Date().getTime();
                            const daysDiff = Math.floor((currentTime - activationTime) / (1000 * 60 * 60 * 24));
                            const daysNeeded = (i - 1) * 7;
                            const daysLeft = daysNeeded - daysDiff;
                            statusText = `üîí –î–æ—Å—Ç—É–ø–Ω–æ —á–µ—Ä–µ–∑ ${daysLeft} –¥–Ω.`;
                        }
                    } else if (i === 1 && !isSubscriber) {
                        buttonClass = 'bg-green-100 border-2 border-green-500';
                        statusText = '–ü—Ä–æ–±–Ω—ã–π —É—Ä–æ–∫';
                    } else if (isCurrentSelected) {
                        buttonClass = 'bg-yellow-100 border-2 border-yellow-500';
                        statusText = '–ê–∫—Ç–∏–≤–Ω–æ';
                    }

                    const weekContainer = document.createElement('div');
                    weekContainer.className = `w-full p-4 rounded-xl shadow-md ${buttonClass}`;
                    weekContainer.innerHTML = `
                        <div class="flex justify-between items-center mb-3">
                            <div>
                                <span class="font-bold text-lg ${!isAvailable ? 'text-gray-500' : 'text-gray-800'}">–ù–µ–¥–µ–ª—è ${i}</span>
                                <span class="block text-sm ${!isAvailable ? 'text-orange-600' : 'text-gray-500'}">${statusText}</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="window.App.showWeekDetails(${i}, '${weekData.description.replace(/'/g, "\\'")}')" 
                                    class="w-full py-2 px-3 bg-gray-200 text-gray-700 font-semibold rounded-xl text-sm hover:bg-gray-300 transition duration-150">
                                –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                            </button>
                            <button id="week-learn-${i}" 
                                    class="w-full py-2 px-3 text-white font-semibold rounded-xl text-sm transition duration-150 ${isAvailable ? 'bg-blue-500 hover:bg-blue-600' : 'button-locked'}"
                                    onclick="${isAvailable ? `window.App.selectAndRenderWeek(${i})` : 'void(0)'}">
                                –£—á–∏—Ç—å
                            </button>
                        </div>
                    `;
                    contentListDiv.appendChild(weekContainer);
                });
                
                // [–ò–ó–ú–ï–ù–ï–ù–û] –í—ã–∑—ã–≤–∞–µ–º showScreen —Å —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
                this.showScreen('list-screen', isBack, { renderFunc: 'renderWeeklySelections', param: null });
            },
            
            showWeekDetails(weekNum, description) {
                document.getElementById('week-details-title').textContent = `–ù–µ–¥–µ–ª—è ${weekNum}`;
                document.getElementById('week-details-body').textContent = description;
                this.openModal('week-details-modal');
            },

            async selectAndRenderWeek(weekNum) {
                this.selectedWeek = weekNum;
                await this.saveProgress();
                this.renderWeekContent(weekNum); // –≠—Ç–æ —É–∂–µ –Ω–µ 'isBack'
            },
            
            renderMenuCard(container, title, subtitle, onClickAction, style = 'bg-white hover:bg-gray-50') {
                const button = document.createElement('button');
                button.className = `w-full text-left p-4 ${style} rounded-xl shadow-md flex justify-between items-center transition duration-150`;
                button.setAttribute('onclick', onClickAction);
                button.innerHTML = `
                    <div>
                        <span class="font-semibold text-lg text-gray-800">${title}</span>
                        <span class="block text-sm text-gray-500">${subtitle}</span>
                    </div>
                    <span>&rarr;</span>
                `;
                container.appendChild(button);
            },
            
            renderWeekContent(weekNum, isBack = false) {
                const weekData = WEEKLY_CONTENT_MAP[weekNum];
                if (!weekData) return;
                
                const isTrialLesson = !this.isSubscriber && weekNum === 1;
                
                if (isTrialLesson) {
                    document.getElementById('list-title').innerText = `üöÄ –ö–æ–Ω—Ç–µ–Ω—Ç –ü—Ä–æ–±–Ω–æ–≥–æ —É—Ä–æ–∫–∞`;
                } else {
                    document.getElementById('list-title').innerText = `üìö –ö–æ–Ω—Ç–µ–Ω—Ç –ù–µ–¥–µ–ª–∏ ${weekNum}`;
                }

                // [–ò–ó–ú–ï–ù–ï–ù–û] –£–±—Ä–∞–Ω—ã this.returnContext –∏ this.renderBackButton
                document.getElementById('filter-controls').innerHTML = '';
                const contentListDiv = document.getElementById('content-list');
                contentListDiv.innerHTML = '';
                
                // 1. –ê—Å—Å–æ—Ü–∏–∞—Ü–∏–∏ –Ω–∞ –Ω–µ–¥–µ–ª—é (–í–∏–¥–µ–æ)
                this.renderMenuCard(contentListDiv, 
                    `üß† –í–∏–¥–µ–æ –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–∏`, 
                    weekData.associationTitle,
                    `window.App.renderVideoContentScreen('${weekData.associationTitle.replace(/'/g, "\\'")}', '${weekData.associationVideo}', null)`
                );
                
                // 2. –ö–∞—Ä—É—Å–µ–ª—å –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–π
                const carouselSet = this.carouselSetsMetadata.find(set => set.id === weekData.carouselId);
                if (carouselSet) {
                    this.renderMenuCard(contentListDiv, 
                        `üñºÔ∏è –ö–∞—Ä—É—Å–µ–ª—å –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–π: ${carouselSet.title}`, 
                        `–í–∏–∑—É–∞–ª—å–Ω–æ–µ –∏–∑—É—á–µ–Ω–∏–µ ${carouselSet.wordCount} —Å–ª–æ–≤`,
                        `window.App.startCarouselSession('${carouselSet.id}', '${carouselSet.title}', '${carouselSet.filepath}')`,
                        'bg-purple-100 hover:bg-purple-200'
                    );
                } else {
                     this.renderMenuCard(contentListDiv, 
                        `üñºÔ∏è –ö–∞—Ä—É—Å–µ–ª—å –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–π (–û—à–∏–±–∫–∞)`, 
                        `–ù–∞–±–æ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω.`,
                        `void(0)`,
                        'button-locked'
                    );
                }

                // 3. –ò—Å—Ç–æ—Ä–∏—è –Ω–µ–¥–µ–ª–∏
                let storyAction;
                if (weekNum === 1 && weekData.storyLink === 'text1.html') {
                    storyAction = `window.App.renderStoryScreen('üìñ –ò—Å—Ç–æ—Ä–∏—è –Ω–µ–¥–µ–ª–∏ ${weekNum}', '${getBaseUrl() + 'text1.html'}')`; 
                } else {
                    storyAction = `window.App.renderExternalLinkScreen('üìñ –ò—Å—Ç–æ—Ä–∏—è –Ω–µ–¥–µ–ª–∏ ${weekNum}', '${weekData.storyLink}')`; 
                }
                
                this.renderMenuCard(contentListDiv, 
                    `üìñ –ò—Å—Ç–æ—Ä–∏—è –Ω–µ–¥–µ–ª–∏`, 
                    `–í–∏–¥–µ–æ + –∫–≤–∏–∑`,
                    storyAction 
                );

                // 4. –°–ª–æ–≤–∞ –Ω–∞ –Ω–µ–¥–µ–ª—é
                this.renderMenuCard(contentListDiv, 
                    `üìö –°–ª–æ–≤–∞ –Ω–∞ –Ω–µ–¥–µ–ª—é`, 
                    `–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ ${WORD_SETS.find(s => s.id === weekData.wordSetId)?.cards.length || 0} —Å–ª–æ–≤`,
                    `window.App.promptForDirection('${weekData.wordSetId}', 'practice')`,
                    'bg-green-100 hover:bg-green-200'
                );
                
                // 5. –ü–æ–ª–µ–∑–Ω—ã–µ —Ñ—Ä–∞–∑—ã
                this.renderMenuCard(contentListDiv, 
                    `üó£Ô∏è –ü–æ–ª–µ–∑–Ω—ã–µ —Ñ—Ä–∞–∑—ã / –î–∏–∞–ª–æ–≥–∏ –Ω–∞ —Ç–µ–º—É`, 
                    `–í–Ω–µ—à–Ω—è—è —Å—Å—ã–ª–∫–∞`,
                    `window.App.renderExternalLinkScreen('üó£Ô∏è –î–∏–∞–ª–æ–≥–∏ –ù–µ–¥–µ–ª–∏ ${weekNum}', '${weekData.dialoguesLink}')` 
                );

                // [–ò–ó–ú–ï–ù–ï–ù–û] –í—ã–∑—ã–≤–∞–µ–º showScreen —Å —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
                this.showScreen('list-screen', isBack, { renderFunc: 'renderWeekContent', param: weekNum });
                
                if (this.carouselSetsMetadata.length === 0) {
                     this.loadCarouselMetadata().then(() => {
                         this.renderWeekContent(weekNum, true); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º, –Ω–æ –æ—Ç–º–µ—á–∞–µ–º –∫–∞–∫ isBack, —á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é
                     });
                }
            },
            
            renderVideoContentScreen(title, videoUrl, textContent, isBack = false) {
                // [–ò–ó–ú–ï–ù–ï–ù–û] –£–±—Ä–∞–Ω—ã this.returnContext –∏ this.renderBackButton
                document.getElementById('video-title').textContent = title;
                const videoIframe = document.getElementById('video-embed');
                const extraTextDiv = document.getElementById('video-extra-text');

                videoIframe.src = videoUrl ? videoUrl : '';
                videoIframe.style.display = videoUrl ? 'block' : 'none';
                
                extraTextDiv.innerHTML = textContent ? `<p>${textContent}</p>` : '';
                extraTextDiv.style.display = textContent ? 'block' : 'none';
                
                // [–ò–ó–ú–ï–ù–ï–ù–û] –í—ã–∑—ã–≤–∞–µ–º showScreen —Å —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
                this.showScreen('video-content-screen', isBack, { 
                    renderFunc: 'renderVideoContentScreen', 
                    param: {title, videoUrl, textContent} 
                });
            },
            
            renderExternalLinkScreen(title, url, isBack = false) {
                // [–ò–ó–ú–ï–ù–ï–ù–û] –£–±—Ä–∞–Ω—ã this.returnContext –∏ this.renderBackButton
                document.getElementById('external-link-title').textContent = title;
                document.getElementById('external-link-button').href = url;
                document.getElementById('external-link-url-display').textContent = url;
                
                // [–ò–ó–ú–ï–ù–ï–ù–û] –í—ã–∑—ã–≤–∞–µ–º showScreen —Å —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
                this.showScreen('external-link-screen', isBack, { 
                    renderFunc: 'renderExternalLinkScreen', 
                    param: {title, url} 
                });

                if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.openLink) {
                    window.Telegram.WebApp.openLink(url);
                }
            },
        };

window.addEventListener('load', () => {
            // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –≥–æ–ª–æ—Å–æ–≤ –¥–ª—è —Å–∏–Ω—Ç–µ–∑–∞ —Ä–µ—á–∏
            if ('speechSynthesis' in window) {
                window.speechSynthesis.getVoices(); 
                if (window.speechSynthesis.onvoiceschanged !== undefined) {
                    window.speechSynthesis.onvoiceschanged = () => window.speechSynthesis.getVoices();
                }
            }
            // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
            window.App.init();
        });

    </script>

</body>
</html>
